<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing System - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Kolory jasne (domy≈õlne) */
            --primary-color: #4a5568;
            --primary-light: #718096;
            --bg-gradient-start: #e2e8f0;
            --bg-gradient-end: #cbd5e0;
            --card-bg: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --hover-bg: #f7fafc;
            --water-color: #4299e1;
            --gas-color: #f4c574;
            --electricity-color: #d47474;
            --edit-color: #90cdf4;
            --delete-color: #fcb3b3;
            --warning-bg: #fef5e7;
            --warning-border: #f4c574;
            --warning-text: #744210;
        }

        body.dark-mode {
            --primary-color: #e2e8f0;
            --primary-light: #cbd5e0;
            --bg-gradient-start: #2d3748;
            --bg-gradient-end: #1a202c;
            --card-bg: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #cbd5e0;
            --border-color: #4a5568;
            --hover-bg: #2d3748;
            --water-color: #63b3ed;
            --gas-color: #ffd574;
            --electricity-color: #e47474;
            --edit-color: #7dd3fc;
            --delete-color: #fca5a5;
            --warning-bg: #78350f;
            --warning-border: #ffd574;
            --warning-text: #fef3c7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            text-transform: uppercase;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* WyjƒÖtki - nie przekszta≈Çcaj na wielkie litery dla warto≈õci liczbowych i niekt√≥rych element√≥w */
        input, textarea, .number-value, .data-value,
        h3, .stat-card h3, /* Warto≈õci statystyk - liczby */
        td, /* Kom√≥rki tabeli - mogƒÖ zawieraƒá liczby */
        .data-table td {
            text-transform: none !important;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: background 0.3s ease;
        }

        header h1 {
            color: var(--primary-color);
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .theme-toggle {
            position: fixed;
            top: 30px;
            right: 30px;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        header p {
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .stat-card:not(.clickable) {
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .stat-card.clickable {
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(22, 163, 74, 0.55);
        }

        .stat-card.clickable:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 10px rgba(22, 163, 74, 0.65);
            border-color: var(--primary-light);
            background: var(--hover-bg);
        }

        /* Cienie w kolorach medium dla stat-card */
        #medium-water .stat-card.clickable {
            box-shadow: 0 2px 6px rgba(66, 153, 225, 0.4);
        }

        #medium-water .stat-card.clickable:hover {
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.5);
        }

        #medium-gas .stat-card.clickable {
            box-shadow: 0 2px 6px rgba(244, 197, 116, 0.4);
        }

        #medium-gas .stat-card.clickable:hover {
            box-shadow: 0 4px 10px rgba(244, 197, 116, 0.5);
        }

        #medium-electricity .stat-card.clickable {
            box-shadow: 0 2px 6px rgba(212, 116, 116, 0.4);
        }

        #medium-electricity .stat-card.clickable:hover {
            box-shadow: 0 4px 10px rgba(212, 116, 116, 0.5);
        }

        .stat-card:not(.clickable) {
            cursor: default;
        }

        .stat-card:not(.clickable):hover {
            transform: none !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08) !important;
            border-color: transparent !important;
            background: var(--card-bg) !important;
        }

        .stat-card h3 {
            color: var(--primary-color);
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: background 0.3s ease;
        }

        .section h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: var(--hover-bg);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            color: var(--text-primary);
        }

        .tab:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .tab.water-tab.active {
            background: linear-gradient(135deg, #6b8fc7 0%, #5a7fb8 100%);
            color: white;
        }

        .tab.gas-tab.active {
            background: linear-gradient(135deg, #f4c574 0%, #e4b564 100%);
            color: white;
        }

        .tab.electricity-tab.active {
            background: linear-gradient(135deg, #d47474 0%, #c46464 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Specjalny layout dla formularza weryfikacji faktury gazu - 4 kolumny */
        #form-gas-invoice-verify {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        /* Puste miejsca w formularzu */
        .form-group.empty {
            visibility: hidden;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: transparent;
            color: var(--delete-color);
            border: 1px solid var(--delete-color);
        }

        .btn-danger:hover {
            background: var(--delete-color);
            color: var(--text-primary);
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--hover-bg);
            font-weight: 600;
            color: var(--primary-color);
        }

        .data-table tr:hover {
            background: var(--hover-bg);
        }

        .data-table tr.clickable {
            cursor: pointer;
        }

        .data-table tr.clickable:hover {
            background: var(--hover-bg);
        }

        body.dark-mode .data-table tr.clickable:hover {
            background: #3a4554;
        }

        .details-row {
            display: none;
        }

        .details-row.expanded {
            display: table-row;
        }

        .details-cell {
            padding: 20px;
            background: var(--hover-bg);
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .details-item {
            padding: 8px;
            background: var(--card-bg);
            border-radius: 5px;
            border-left: 3px solid var(--primary-color);
        }

        .details-item label {
            font-weight: 600;
            color: var(--primary-color);
            display: block;
            margin-bottom: 5px;
            font-size: 0.85em;
        }

        .details-item .value {
            color: var(--text-primary);
            font-size: 1em;
        }

        .btn-edit {
            background: transparent;
            color: var(--edit-color);
            border: 1px solid var(--edit-color);
        }

        .btn-edit:hover {
            background: var(--edit-color);
            color: var(--text-primary);
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .alert.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .verification-banner {
            background: transparent;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .verification-banner h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.1em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .verification-banner p {
            margin-bottom: 10px;
            color: var(--text-primary);
            text-transform: none;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .period-selector input {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        /* Styl dla input file */
        input[type="file"] {
            display: none;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 10px;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: #10b981;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.3s;
            border: none;
        }

        .file-input-label:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .file-input-label:active {
            transform: translateY(0);
        }

        .file-name-display {
            display: inline-block;
            margin-left: 10px;
            color: var(--text-secondary);
            font-size: 0.9em;
            text-transform: uppercase;
            font-weight: 500;
        }

        .file-name-display:empty::before {
            content: "NIE WYBRANO PLIKU";
            color: var(--text-secondary);
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="theme-toggle" onclick="toggleTheme()" title="Prze≈ÇƒÖcz tryb nocny">
            <span id="theme-icon">üåô</span>
        </button>
        
        <header>
            <h1>Billing System</h1>
            <p>System rozliczania rachunk√≥w za wodƒô, ≈õcieki, gaz i prƒÖd</p>
            <p style="font-size: 0.95em; color: var(--text-secondary); margin-top: 5px;">Billing system for water, sewage, gas and electricity</p>
            <div style="margin-top: 15px;">
                <a href="/docs" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">üìö Dokumentacja API (Swagger UI)</a>
            </div>
            <div style="margin-top: 10px; font-size: 0.9em; color: var(--text-secondary);">
                Autor: <strong>Arkadiusz Mickiewicz</strong>
            </div>
        </header>

        <div id="alert" class="alert"></div>

        <!-- G≈Ç√≥wna strona z wyborem medium -->
        <div id="main-page" class="section">
            <h2>Wybierz medium do zarzƒÖdzania</h2>
            <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: -15px; margin-bottom: 20px;">Select medium to manage</p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 30px;">
                <!-- Karta Wody -->
                <div class="medium-card" onclick="openMedium('water')" style="cursor: pointer; background: linear-gradient(135deg, #6b8fc7 0%, #5a7fb8 100%); color: white; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="font-size: 4em; margin-bottom: 20px; font-weight: 300; opacity: 0.9;">‚óØ</div>
                    <h2 style="margin-bottom: 10px; font-size: 2em; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">Woda</h2>
                    <p style="font-size: 1.1em; opacity: 0.95; margin-bottom: 20px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">Water</p>
                    <div id="main-water-stats" class="stats-grid" style="margin-top: 20px; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-water-invoices">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Faktury</div>
                            <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">Invoices</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-water-bills">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Rachunki</div>
                            <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">Bills</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-water-total">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Suma brutto</div>
                            <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">Total gross</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-water-period">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Najnowszy okres</div>
                            <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">Latest period</div>
                        </div>
                    </div>
                </div>
                
                <!-- Karta Gazu -->
                <div class="medium-card" onclick="openMedium('gas')" style="cursor: pointer; background: linear-gradient(135deg, #f4c574 0%, #e4b564 100%); color: white; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="font-size: 4em; margin-bottom: 20px; font-weight: 300; opacity: 0.9;">‚ñ≥</div>
                    <h2 style="margin-bottom: 10px; font-size: 2em; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">Gaz</h2>
                    <p style="font-size: 1.1em; opacity: 0.95; margin-bottom: 20px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">Gas</p>
                    <div id="main-gas-stats" class="stats-grid" style="margin-top: 20px; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-gas-invoices">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Faktury</div>
                            <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">Invoices</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-gas-bills">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Rachunki</div>
                            <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">Bills</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-gas-total">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Suma brutto</div>
                            <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">Total gross</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-gas-period">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Najnowszy okres</div>
                            <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">Latest period</div>
                        </div>
                    </div>
                </div>
                
                <div class="medium-card" onclick="openMedium('electricity')" style="cursor: pointer; background: linear-gradient(135deg, #d47474 0%, #c46464 100%); color: white; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="font-size: 4em; margin-bottom: 20px; font-weight: 300; opacity: 0.9;">‚óá</div>
                    <h2 style="margin-bottom: 10px; font-size: 2em; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">PrƒÖd</h2>
                    <p style="font-size: 1.1em; opacity: 0.95; margin-bottom: 20px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">Electricity</p>
                    <div id="main-electricity-stats" class="stats-grid" style="margin-top: 20px; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-electricity-readings">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Odczyty</div>
                            <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">Readings</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-electricity-invoices">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Faktury</div>
                            <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">Invoices</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-electricity-bills">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Rachunki</div>
                            <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">Bills</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-electricity-period">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Najnowszy okres</div>
                            <div style="font-size: 0.75em; opacity: 0.8; margin-top: 3px;">Latest period</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- G≈Ç√≥wne sekcje (ukryte domy≈õlnie) -->
        <div id="medium-sections" class="section" style="display: none;">
            <!-- Przycisk powrotu -->
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="backToMain()" style="display: flex; align-items: center; gap: 10px; text-transform: uppercase;">
                    <span>‚Üê</span> POWR√ìT DO G≈Å√ìWNEJ STRONY
                </button>
            </div>
            
            <!-- Zak≈Çadki wyboru medium -->
            <div class="tabs" style="margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
                <button class="tab water-tab" id="tab-water" onclick="showMedium('water')" style="text-transform: uppercase;">‚óØ WODA</button>
                <button class="tab gas-tab" id="tab-gas" onclick="showMedium('gas')" style="text-transform: uppercase;">‚ñ≥ GAZ</button>
                <button class="tab electricity-tab" id="tab-electricity" onclick="showMedium('electricity')" style="text-transform: uppercase;">PRƒÑD</button>
            </div>

            <!-- Sekcje dla Wody -->
            <div id="medium-water" class="medium-content" style="display: none;">
                <!-- Statystyki wody -->
                <div class="stats-grid" id="water-stats" style="margin-bottom: 25px;">
                    <div class="stat-card clickable" onclick="showTab('locals')">
                        <h3 id="water-stat-locals">-</h3>
                        <p>Lokale</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Locals</p>
                    </div>
                    <div class="stat-card clickable" onclick="showTab('readings')">
                        <h3 id="water-stat-readings">-</h3>
                        <p>Odczyty</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Readings</p>
                    </div>
                    <div class="stat-card clickable" onclick="showTab('invoices')">
                        <h3 id="water-stat-invoices">-</h3>
                        <p>Faktury</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Invoices</p>
                    </div>
                    <div class="stat-card clickable" onclick="showTab('bills')">
                        <h3 id="water-stat-bills">-</h3>
                        <p>Rachunki</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Bills</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="water-stat-total">-</h3>
                        <p>Suma brutto</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Total gross</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="water-stat-latest-period">-</h3>
                        <p>Najnowszy okres</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Latest period</p>
                    </div>
                </div>

            <!-- Sekcja Lokale -->
            <div id="tab-locals" class="tab-content active">
                <h2>Lokale</h2>
                <form id="form-local" class="form-grid">
                    <div class="form-group">
                        <label>Nazwa licznika</label>
                        <select name="water_meter_name" required>
                            <option value="water_meter_5">water_meter_5</option>
                            <option value="water_meter_5b">water_meter_5b</option>
                            <option value="water_meter_5a">water_meter_5a</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Najemca</label>
                        <input type="text" name="tenant" required>
                    </div>
                    <div class="form-group">
                        <label>Lokal</label>
                        <input type="text" name="local" required>
                    </div>
                </form>
                <button class="btn btn-success" onclick="addLocal()" style="text-transform: uppercase;">DODAJ LOKAL</button>
                
                <div id="locals-list" class="loading">≈Åadowanie...</div>
            </div>

            <!-- Sekcja Odczyty -->
            <div id="tab-readings" class="tab-content">
                <h2>Odczyty licznik√≥w</h2>
                <form id="form-reading" class="form-grid">
                    <div class="form-group">
                        <label>Okres (YYYY-MM)</label>
                        <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                    </div>
                    <div class="form-group">
                        <label>Licznik g≈Ç√≥wny</label>
                        <input type="number" step="0.01" name="water_meter_main" required>
                    </div>
                    <div class="form-group">
                        <label>Licznik 5</label>
                        <input type="number" step="0.01" name="water_meter_5" required>
                    </div>
                    <div class="form-group">
                        <label>Licznik 5b</label>
                        <input type="number" step="0.01" name="water_meter_5b" required>
                    </div>
                </form>
                <button class="btn btn-success" onclick="addReading()" style="text-transform: uppercase;">DODAJ ODCZYT</button>
                
                <div id="readings-list" class="loading">≈Åadowanie...</div>
            </div>

            <!-- Sekcja Faktury -->
            <div id="tab-invoices" class="tab-content">
                <h2>Faktury</h2>
                
                <div style="background: var(--hover-bg); border-left: 4px solid var(--primary-color); padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                    <h3 style="margin-top: 0; color: var(--primary-color);">üí° Wa≈ºne: Wiele faktur dla jednego okresu</h3>
                    <p style="margin-bottom: 10px; color: var(--text-primary);">
                        <strong>Gdy okres rozliczeniowy (2 miesiƒÖce) ma zmianƒô stawki w po≈Çowie:</strong>
                    </p>
                    <ul style="margin-left: 20px; color: var(--text-secondary);">
                        <li><strong>Okres (YYYY-MM)</strong> - u≈ºywaj tego samego dla obu faktur (np. "2025-02")</li>
                        <li><strong>Data poczƒÖtku/ko≈Ñca</strong> - wpisz faktyczne daty ka≈ºdej faktury</li>
                        <li>System automatycznie obliczy <strong>≈õredniƒÖ wa≈ºonƒÖ koszt√≥w</strong> z obu faktur</li>
                        <li>Abonamenty zostanƒÖ <strong>zsumowane</strong> z wszystkich faktur</li>
                    </ul>
                    <p style="margin-top: 10px; margin-bottom: 0; color: var(--text-secondary); font-size: 0.9em;">
                        <strong>Przyk≈Çad:</strong> Okres "2025-02" ma dwie faktury:<br>
                        Faktura 1: 01.01-31.01, koszt 10 z≈Ç/m¬≥, zu≈ºycie 20 m¬≥<br>
                        Faktura 2: 01.02-28.02, koszt 12 z≈Ç/m¬≥, zu≈ºycie 25 m¬≥<br>
                        ‚Üí System u≈ºyje ≈õredniej wa≈ºonej: (10√ó20 + 12√ó25) / 45 = 11.11 z≈Ç/m¬≥
                    </p>
                </div>
                
                <div class="verification-banner">
                    <h3>‚ö†Ô∏è Weryfikacja faktur</h3>
                    <p>
                        Po wczytaniu faktury PDF, dane zostanƒÖ wy≈õwietlone poni≈ºej do weryfikacji i ewentualnej zmiany przed zapisem do bazy danych.
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="text-transform: uppercase;">WCZYTAJ FAKTURƒò PDF</h3>
                    <div class="file-input-wrapper">
                        <label for="invoice-file" class="file-input-label">WYBIERZ PLIK</label>
                        <input type="file" id="invoice-file" accept=".pdf" onchange="updateFileName('invoice-file', 'invoice-file-name')">
                        <span id="invoice-file-name" class="file-name-display"></span>
                    </div>
                    <button class="btn btn-success" onclick="uploadInvoice()" style="text-transform: uppercase; margin-top: 10px;">WCZYTAJ PDF</button>
                </div>

                <!-- Formularz weryfikacji faktury (ukryty do momentu parsowania) -->
                <div id="invoice-verification" style="display: none; background: var(--hover-bg); border: 2px solid var(--primary-color); padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                    <h3>Weryfikuj dane faktury przed zapisem</h3>
                    <form id="form-invoice-verify" class="form-grid">
                        <div class="form-group">
                            <label>Okres (YYYY-MM)</label>
                            <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                        </div>
                        <div class="form-group">
                            <label>Zu≈ºycie (m¬≥)</label>
                            <input type="number" step="0.01" name="usage" required>
                        </div>
                        <div class="form-group">
                            <label>Koszt wody za m¬≥</label>
                            <input type="number" step="0.01" name="water_cost_m3" required>
                        </div>
                        <div class="form-group">
                            <label>Koszt ≈õciek√≥w za m¬≥</label>
                            <input type="number" step="0.01" name="sewage_cost_m3" required>
                        </div>
                        <div class="form-group">
                            <label>Liczba miesiƒôcy abonamentu</label>
                            <input type="number" name="nr_of_subscription" required>
                        </div>
                        <div class="form-group">
                            <label>Abonament woda (za miesiƒÖc)</label>
                            <input type="number" step="0.01" name="water_subscr_cost" required>
                        </div>
                        <div class="form-group">
                            <label>Abonament ≈õcieki (za miesiƒÖc)</label>
                            <input type="number" step="0.01" name="sewage_subscr_cost" required>
                        </div>
                        <div class="form-group">
                            <label>VAT (np. 0.08 dla 8%)</label>
                            <input type="number" step="0.01" name="vat" required>
                        </div>
                        <div class="form-group">
                            <label>Data poczƒÖtku okresu</label>
                            <input type="date" name="period_start" required>
                        </div>
                        <div class="form-group">
                            <label>Data ko≈Ñca okresu</label>
                            <input type="date" name="period_stop" required>
                        </div>
                        <div class="form-group">
                            <label>Numer faktury</label>
                            <input type="text" name="invoice_number" required>
                        </div>
                        <div class="form-group">
                            <label>Suma brutto</label>
                            <input type="number" step="0.01" name="gross_sum" required>
                        </div>
                    </form>
                    <button class="btn btn-success" onclick="verifyAndSaveInvoice()">Zatwierd≈∫ i zapisz</button>
                    <button class="btn btn-secondary" onclick="cancelInvoiceVerification()">Anuluj</button>
                </div>
                
                    <!-- Przycisk do pokazania formularza rƒôcznego -->
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="toggleManualInvoiceForm()" id="btn-show-manual-invoice" style="text-transform: uppercase;">
                            LUB DODAJ RƒòCZNIE
                        </button>
                    </div>

                <!-- Formularz rƒôcznego dodawania faktury (ukryty domy≈õlnie) -->
                <div id="invoice-manual-form" style="display: none;">
                    <h3>Dodaj fakturƒô rƒôcznie</h3>
                    <form id="form-invoice" class="form-grid">
                        <div class="form-group">
                            <label>Okres (YYYY-MM)</label>
                            <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                        </div>
                        <div class="form-group">
                            <label>Zu≈ºycie (m¬≥)</label>
                            <input type="number" step="0.01" name="usage" required>
                        </div>
                        <div class="form-group">
                            <label>Koszt wody za m¬≥</label>
                            <input type="number" step="0.01" name="water_cost_m3" required>
                        </div>
                        <div class="form-group">
                            <label>Koszt ≈õciek√≥w za m¬≥</label>
                            <input type="number" step="0.01" name="sewage_cost_m3" required>
                        </div>
                        <div class="form-group">
                            <label>Liczba miesiƒôcy abonamentu</label>
                            <input type="number" name="nr_of_subscription" required>
                        </div>
                        <div class="form-group">
                            <label>Abonament woda (za miesiƒÖc)</label>
                            <input type="number" step="0.01" name="water_subscr_cost" required>
                        </div>
                        <div class="form-group">
                            <label>Abonament ≈õcieki (za miesiƒÖc)</label>
                            <input type="number" step="0.01" name="sewage_subscr_cost" required>
                        </div>
                        <div class="form-group">
                            <label>VAT (np. 0.08 dla 8%)</label>
                            <input type="number" step="0.01" name="vat" required>
                        </div>
                        <div class="form-group">
                            <label>Data poczƒÖtku okresu</label>
                            <input type="date" name="period_start" required>
                        </div>
                        <div class="form-group">
                            <label>Data ko≈Ñca okresu</label>
                            <input type="date" name="period_stop" required>
                        </div>
                        <div class="form-group">
                            <label>Numer faktury</label>
                            <input type="text" name="invoice_number" required>
                        </div>
                        <div class="form-group">
                            <label>Suma brutto</label>
                            <input type="number" step="0.01" name="gross_sum" required>
                        </div>
                    </form>
                    <button class="btn btn-primary" onclick="addInvoice()">Dodaj fakturƒô</button>
                    <button class="btn btn-secondary" onclick="toggleManualInvoiceForm()" style="margin-left: 10px;">Ukryj formularz</button>
                </div>
                
                <div id="invoices-list" class="loading">≈Åadowanie...</div>
            </div>

            <!-- Sekcja Rachunki -->
            <div id="tab-bills" class="tab-content">
                <h2>Rachunki</h2>
                <div class="period-selector">
                    <label>Okres (YYYY-MM):</label>
                    <input type="text" id="bill-period" placeholder="2025-02" pattern="\d{4}-\d{2}" list="available-periods">
                    <datalist id="available-periods"></datalist>
                    <button class="btn btn-success" onclick="generateBills()" style="text-transform: uppercase;">GENERUJ RACHUNKI</button>
                    <button class="btn btn-success" onclick="regenerateBills()" style="text-transform: uppercase;">REGENERUJ RACHUNKI</button>
                </div>
                <p style="color: #666; margin-bottom: 20px; font-size: 0.9em;">
                    üí° Podaj okres w formacie YYYY-MM. System automatycznie wygeneruje rachunki dla wszystkich lokali na podstawie faktur i odczyt√≥w.
                </p>
                
                <div id="bills-list" class="loading">≈Åadowanie...</div>
            </div>
            </div>  <!-- koniec medium-water -->

            <!-- Sekcje dla Gazu -->
            <div id="medium-gas" class="medium-content" style="display: none;">
                <!-- Statystyki gazu -->
                <div class="stats-grid" id="gas-stats" style="margin-bottom: 25px;">
                    <div class="stat-card clickable" onclick="showGasTab('gas-tab-invoices')">
                        <h3 id="gas-stat-invoices">-</h3>
                        <p>Faktury gazu</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Gas invoices</p>
                    </div>
                    <div class="stat-card clickable" onclick="showGasTab('gas-tab-bills')">
                        <h3 id="gas-stat-bills">-</h3>
                        <p>Rachunki gazu</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Gas bills</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="gas-stat-total">-</h3>
                        <p>Suma brutto</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Total gross</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="gas-stat-latest-period">-</h3>
                        <p>Najnowszy okres</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Latest period</p>
                    </div>
                </div>

                <!-- Sekcja Faktury gazu -->
                <div id="gas-tab-invoices" class="tab-content active">
                    <h2>Faktury gazu (PGNiG)</h2>
                    
                    <div class="verification-banner">
                        <h3>‚ö†Ô∏è Weryfikacja faktur</h3>
                        <p>
                            Po wczytaniu faktury PDF, dane zostanƒÖ wy≈õwietlone poni≈ºej do weryfikacji i ewentualnej zmiany przed zapisem do bazy danych.
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="text-transform: uppercase;">WCZYTAJ FAKTURƒò PDF</h3>
                        <div class="file-input-wrapper">
                            <label for="gas-invoice-file" class="file-input-label">WYBIERZ PLIK</label>
                            <input type="file" id="gas-invoice-file" accept=".pdf" onchange="updateFileName('gas-invoice-file', 'gas-invoice-file-name')">
                            <span id="gas-invoice-file-name" class="file-name-display"></span>
                        </div>
                        <button class="btn btn-success" onclick="uploadGasInvoice()" style="text-transform: uppercase; margin-top: 10px;">WCZYTAJ PDF</button>
                    </div>

                    <!-- Formularz weryfikacji faktury (ukryty do momentu parsowania) -->
                    <div id="gas-invoice-verification" style="display: none !important; background: var(--hover-bg); border: 2px solid var(--primary-color); padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                        <h3>Weryfikuj dane faktury przed zapisem</h3>
                        <form id="form-gas-invoice-verify" class="form-grid">
                            <!-- RzƒÖd 1: Okres, Numer Faktury, Data poczƒÖtku okresu, Data ko≈Ñca okresu -->
                            <div class="form-group">
                                <label>Okres (YYYY-MM)</label>
                                <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                            </div>
                            <div class="form-group">
                                <label>Numer faktury</label>
                                <input type="text" name="invoice_number" required>
                            </div>
                            <div class="form-group">
                                <label>Data poczƒÖtku okresu</label>
                                <input type="date" name="period_start" required>
                            </div>
                            <div class="form-group">
                                <label>Data ko≈Ñca okresu</label>
                                <input type="date" name="period_stop" required>
                            </div>
                            
                            <!-- RzƒÖd 2: puste, Paliwo zu≈ºycie (m¬≥), Odczyt poprzedni, Odczyt obecny -->
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label>Paliwo zu≈ºycie (m¬≥)</label>
                                <input type="number" step="0.01" name="fuel_usage_m3" required>
                            </div>
                            <div class="form-group">
                                <label>Odczyt poprzedni (m¬≥)</label>
                                <input type="number" step="0.01" name="previous_reading" required>
                            </div>
                            <div class="form-group">
                                <label>Odczyt obecny (m¬≥)</label>
                                <input type="number" step="0.01" name="current_reading" required>
                            </div>
                            
                            <!-- RzƒÖd 3: Paliwo - Wsp√≥≈Çczynnik konwersji, Paliwo - Zu≈ºycie (kWh), Paliwo - Cena netto za kWh, Paliwo - Warto≈õƒá netto -->
                            <div class="form-group">
                                <label>Paliwo - Wsp√≥≈Çczynnik konwersji (kWh/m¬≥)</label>
                                <input type="number" step="0.0001" name="fuel_conversion_factor" required>
                            </div>
                            <div class="form-group">
                                <label>Paliwo - Zu≈ºycie (kWh)</label>
                                <input type="number" step="0.01" name="fuel_usage_kwh" required>
                            </div>
                            <div class="form-group">
                                <label>Paliwo - Cena netto za kWh</label>
                                <input type="number" step="0.00001" name="fuel_price_net" required>
                            </div>
                            <div class="form-group">
                                <label>Paliwo - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="fuel_value_net" required>
                            </div>
                            
                            <!-- RzƒÖd 4: puste, Abonament - Ilo≈õƒá miesiƒôcy, Abonament - Cena netto za miesiƒÖc, Abonament - Warto≈õƒá netto -->
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label>Abonament - Ilo≈õƒá miesiƒôcy</label>
                                <input type="number" name="subscription_quantity" required>
                            </div>
                            <div class="form-group">
                                <label>Abonament - Cena netto za miesiƒÖc</label>
                                <input type="number" step="0.01" name="subscription_price_net" required>
                            </div>
                            <div class="form-group">
                                <label>Abonament - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="subscription_value_net" required>
                            </div>
                            
                            <!-- RzƒÖd 5: puste, Dystrybucja sta≈Ça - Ilo≈õƒá miesiƒôcy, Dystrybucja sta≈Ça - Cena netto za miesiƒÖc, Dystrybucja sta≈Ça - Warto≈õƒá netto -->
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label>Dystrybucja sta≈Ça - Ilo≈õƒá miesiƒôcy</label>
                                <input type="number" name="distribution_fixed_quantity" required>
                            </div>
                            <div class="form-group">
                                <label>Dystrybucja sta≈Ça - Cena netto za miesiƒÖc</label>
                                <input type="number" step="0.01" name="distribution_fixed_price_net" required>
                            </div>
                            <div class="form-group">
                                <label>Dystrybucja sta≈Ça - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="distribution_fixed_value_net" required>
                            </div>
                            
                            <!-- RzƒÖd 6: puste, Dystrybucja zmienna - Zu≈ºycie (m¬≥), Dystrybucja zmienna - Wsp. konw., Dystrybucja zmienna - Zu≈ºycie (kWh) -->
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label>Dystrybucja zmienna - Zu≈ºycie (m¬≥)</label>
                                <input type="number" step="0.01" name="distribution_variable_usage_m3" required>
                            </div>
                            <div class="form-group">
                                <label>Dystrybucja zmienna - Wsp. konw.</label>
                                <input type="number" step="0.0001" name="distribution_variable_conversion_factor" required>
                            </div>
                            <div class="form-group">
                                <label>Dystrybucja zmienna - Zu≈ºycie (kWh)</label>
                                <input type="number" step="0.01" name="distribution_variable_usage_kwh" required>
                            </div>
                            
                            <!-- RzƒÖd 7: puste, puste, Dystrybucja zmienna - Cena netto za kWh, Dystrybucja zmienna - Warto≈õƒá netto -->
                            <div class="form-group empty"></div>
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label>Dystrybucja zmienna - Cena netto za kWh</label>
                                <input type="number" step="0.00001" name="distribution_variable_price_net" required>
                            </div>
                            <div class="form-group">
                                <label>Dystrybucja zmienna - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="distribution_variable_value_net" required>
                            </div>
                            
                            <!-- RzƒÖd 8: puste, Dystrybucja zmienna 2 - Zu≈ºycie (m¬≥), Dystrybucja zmienna 2 - Wsp. konw., Dystrybucja zmienna 2 - Zu≈ºycie (kWh) -->
                            <div class="form-group empty" id="dist-var-2-empty-1"></div>
                            <div class="form-group" id="distribution-variable-2-group" style="display: none;">
                                <label>Dystrybucja zmienna 2 - Zu≈ºycie (m¬≥)</label>
                                <input type="number" step="0.01" name="distribution_variable_2_usage_m3">
                            </div>
                            <div class="form-group" id="distribution-variable-2-conv-group" style="display: none;">
                                <label>Dystrybucja zmienna 2 - Wsp. konw.</label>
                                <input type="number" step="0.0001" name="distribution_variable_2_conversion_factor">
                            </div>
                            <div class="form-group" id="distribution-variable-2-kwh-group" style="display: none;">
                                <label>Dystrybucja zmienna 2 - Zu≈ºycie (kWh)</label>
                                <input type="number" step="0.01" name="distribution_variable_2_usage_kwh">
                            </div>
                            
                            <!-- RzƒÖd 9: puste, puste, Dystr. zm. 2 - cena netto za kWh, Dystrybucja zmienna 2 - Warto≈õƒá netto -->
                            <div class="form-group empty"></div>
                            <div class="form-group empty"></div>
                            <div class="form-group" id="distribution-variable-2-price-group" style="display: none;">
                                <label>Dystr. zm. 2 - cena netto za kWh</label>
                                <input type="number" step="0.00001" name="distribution_variable_2_price_net">
                            </div>
                            <div class="form-group" id="distribution-variable-2-value-group" style="display: none;">
                                <label>Dystrybucja zmienna 2 - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="distribution_variable_2_value_net">
                            </div>
                            
                            <!-- RzƒÖd 11: Warto≈õƒá netto og√≥≈Çem, VAT, Kwota VAT, Warto≈õƒá brutto ca≈Ço≈õƒá -->
                            <div class="form-group">
                                <label>Warto≈õƒá netto og√≥≈Çem</label>
                                <input type="number" step="0.01" name="total_net_sum" required>
                            </div>
                            <div class="form-group">
                                <label>VAT (np. 0.23 dla 23%)</label>
                                <input type="number" step="0.01" name="vat_rate" value="0.23" required>
                            </div>
                            <div class="form-group">
                                <label>Kwota VAT og√≥≈Çem</label>
                                <input type="number" step="0.01" name="vat_amount" required>
                            </div>
                            <div class="form-group">
                                <label>Warto≈õƒá brutto ca≈Ço≈õƒá</label>
                                <input type="number" step="0.01" name="total_gross_sum" required>
                            </div>
                            
                            <!-- RzƒÖd 12: Odsetki za nieterminowe wp≈Çaty, Termin p≈Çatno≈õci, puste, Do zap≈Çaty -->
                            <div class="form-group">
                                <label>Odsetki za nieterminowe wp≈Çaty</label>
                                <input type="number" step="0.01" name="late_payment_interest" value="0" required>
                            </div>
                            <div class="form-group">
                                <label>Termin p≈Çatno≈õci</label>
                                <input type="date" name="payment_due_date" required>
                            </div>
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label>Do zap≈Çaty</label>
                                <input type="number" step="0.01" name="amount_to_pay" required>
                            </div>
                        </form>
                        <button class="btn btn-success" onclick="verifyAndSaveGasInvoice()">Zatwierd≈∫ i zapisz</button>
                        <button class="btn btn-secondary" onclick="cancelGasInvoiceVerification()">Anuluj</button>
                    </div>

                    <!-- Przycisk do pokazania formularza rƒôcznego -->
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="toggleManualGasInvoiceForm()" id="btn-show-manual-gas-invoice" style="text-transform: uppercase;">
                            LUB DODAJ RƒòCZNIE
                        </button>
                    </div>

                    <!-- Formularz rƒôcznego dodawania faktury (ukryty domy≈õlnie) -->
                    <div id="gas-invoice-manual-form" style="display: none;">
                        <h3>Dodaj fakturƒô rƒôcznie</h3>
                        <form id="form-gas-invoice" class="form-grid">
                        <div class="form-group">
                            <label>Okres (YYYY-MM)</label>
                            <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                        </div>
                        <div class="form-group">
                            <label>Data poczƒÖtku okresu</label>
                            <input type="date" name="period_start" required>
                        </div>
                        <div class="form-group">
                            <label>Data ko≈Ñca okresu</label>
                            <input type="date" name="period_stop" required>
                        </div>
                        <div class="form-group">
                            <label>Odczyt poprzedni (m¬≥)</label>
                            <input type="number" step="0.01" name="previous_reading" required>
                        </div>
                        <div class="form-group">
                            <label>Odczyt obecny (m¬≥)</label>
                            <input type="number" step="0.01" name="current_reading" required>
                        </div>
                        <div class="form-group">
                            <label>Numer faktury</label>
                            <input type="text" name="invoice_number" required>
                        </div>
                        <div class="form-group">
                            <label>Paliwo - Warto≈õƒá brutto</label>
                            <input type="number" step="0.01" name="fuel_value_gross" required>
                        </div>
                        <div class="form-group">
                            <label>Abonament - Warto≈õƒá brutto</label>
                            <input type="number" step="0.01" name="subscription_value_gross" required>
                        </div>
                        <div class="form-group">
                            <label>Dystrybucja sta≈Ça - Warto≈õƒá brutto</label>
                            <input type="number" step="0.01" name="distribution_fixed_value_gross" required>
                        </div>
                        <div class="form-group">
                            <label>Dystrybucja zmienna - Warto≈õƒá brutto</label>
                            <input type="number" step="0.01" name="distribution_variable_value_gross" required>
                        </div>
                        <div class="form-group">
                            <label>Suma brutto ca≈Çej faktury</label>
                            <input type="number" step="0.01" name="total_gross_sum" required>
                        </div>
                        </form>
                        <button class="btn btn-primary" onclick="addGasInvoice()">Dodaj fakturƒô</button>
                        <button class="btn btn-secondary" onclick="toggleManualGasInvoiceForm()" style="margin-left: 10px;">Ukryj formularz</button>
                    </div>
                    
                    <div id="gas-invoices-list" class="loading">≈Åadowanie...</div>
                </div>

                <!-- Sekcja Rachunki gazu -->
                <div id="gas-tab-bills" class="tab-content">
                    <h2>Rachunki gazu</h2>
                    <div class="period-selector">
                        <label>Okres (YYYY-MM):</label>
                        <input type="text" id="gas-bill-period" placeholder="2025-02" pattern="\d{4}-\d{2}" list="available-gas-periods">
                        <datalist id="available-gas-periods"></datalist>
                        <button class="btn btn-success" onclick="generateGasBills()" style="text-transform: uppercase;">GENERUJ RACHUNKI</button>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9em;">
                        üí° Podaj okres w formacie YYYY-MM. System automatycznie wygeneruje rachunki dla wszystkich lokali na podstawie faktur gazu (58% gora, 25% dol, 17% gabinet).
                    </p>
                    
                    <div id="gas-bills-list" class="loading">≈Åadowanie...</div>
                </div>
            </div>  <!-- koniec medium-gas -->

            <!-- Sekcje dla PrƒÖdu -->
            <div id="medium-electricity" class="medium-content" style="display: none;">
                <!-- Statystyki prƒÖdu -->
                <div class="stats-grid" id="electricity-stats" style="margin-bottom: 25px;">
                    <div class="stat-card clickable" onclick="showElectricityTab('electricity-tab-readings')">
                        <h3 id="electricity-stat-readings">-</h3>
                        <p>Odczyty</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Readings</p>
                    </div>
                    <div class="stat-card clickable" onclick="showElectricityTab('electricity-tab-invoices')">
                        <h3 id="electricity-stat-invoices">-</h3>
                        <p>Faktury</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Invoices</p>
                    </div>
                    <div class="stat-card clickable" onclick="showElectricityTab('electricity-tab-bills')">
                        <h3 id="electricity-stat-bills">-</h3>
                        <p>Rachunki</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Bills</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="electricity-stat-total">-</h3>
                        <p>Suma brutto</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Total gross</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="electricity-stat-latest-period">-</h3>
                        <p>Najnowszy okres</p>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Latest period</p>
                    </div>
                </div>

                <!-- Sekcja Odczyty prƒÖdu -->
                <div id="electricity-tab-readings" class="tab-content active">
                    <h2>Odczyty licznik√≥w prƒÖdu</h2>
                    <form id="form-electricity-reading" class="form-grid">
                        <div class="form-group">
                            <label>Okres (YYYY-MM)</label>
                            <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                        </div>
                        <div class="form-group">
                            <label>Licznik DOM - Jednotaryfowy?</label>
                            <select name="licznik_dom_jednotaryfowy" onchange="toggleDomMeterType()">
                                <option value="true">Tak (jednotaryfowy)</option>
                                <option value="false">Nie (dwutaryfowy)</option>
                            </select>
                        </div>
                        <div class="form-group" id="dom-jednotaryfowy-group">
                            <label>Odczyt DOM (jednotaryfowy)</label>
                            <input type="number" step="0.01" name="odczyt_dom">
                        </div>
                        <div class="form-group" id="dom-dwutaryfowy-group" style="display: none;">
                            <label>Odczyt DOM - Taryfa I</label>
                            <input type="number" step="0.01" name="odczyt_dom_I">
                        </div>
                        <div class="form-group" id="dom-dwutaryfowy-group-2" style="display: none;">
                            <label>Odczyt DOM - Taryfa II</label>
                            <input type="number" step="0.01" name="odczyt_dom_II">
                        </div>
                        <div class="form-group">
                            <label>Licznik D√ì≈Å - Jednotaryfowy?</label>
                            <select name="licznik_dol_jednotaryfowy" onchange="toggleDolMeterType()">
                                <option value="true">Tak (jednotaryfowy)</option>
                                <option value="false">Nie (dwutaryfowy)</option>
                            </select>
                        </div>
                        <div class="form-group" id="dol-jednotaryfowy-group">
                            <label>Odczyt D√ì≈Å (jednotaryfowy)</label>
                            <input type="number" step="0.01" name="odczyt_dol">
                        </div>
                        <div class="form-group" id="dol-dwutaryfowy-group" style="display: none;">
                            <label>Odczyt D√ì≈Å - Taryfa I</label>
                            <input type="number" step="0.01" name="odczyt_dol_I">
                        </div>
                        <div class="form-group" id="dol-dwutaryfowy-group-2" style="display: none;">
                            <label>Odczyt D√ì≈Å - Taryfa II</label>
                            <input type="number" step="0.01" name="odczyt_dol_II">
                        </div>
                        <div class="form-group">
                            <label>Odczyt GABINET (zawsze jednotaryfowy)</label>
                            <input type="number" step="0.01" name="odczyt_gabinet" required>
                        </div>
                    </form>
                    <button class="btn btn-success" onclick="addElectricityReading()" style="text-transform: uppercase;">DODAJ ODCZYT</button>
                    
                    <div id="electricity-readings-list" class="loading">≈Åadowanie...</div>
                </div>

                <!-- Sekcja Faktury prƒÖdu -->
                <div id="electricity-tab-invoices" class="tab-content">
                    <h2>Faktury prƒÖdu (ENEA)</h2>
                    
                    <div class="verification-banner">
                        <h3>‚ö†Ô∏è Weryfikacja faktur</h3>
                        <p>
                            Po wczytaniu faktury PDF, dane zostanƒÖ wy≈õwietlone poni≈ºej do weryfikacji i ewentualnej zmiany przed zapisem do bazy danych.
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="text-transform: uppercase;">WCZYTAJ FAKTURƒò PDF</h3>
                        <div class="file-input-wrapper">
                            <label for="electricity-invoice-file" class="file-input-label">WYBIERZ PLIK</label>
                            <input type="file" id="electricity-invoice-file" accept=".pdf" onchange="updateFileName('electricity-invoice-file', 'electricity-invoice-file-name')">
                            <span id="electricity-invoice-file-name" class="file-name-display"></span>
                        </div>
                        <button class="btn btn-success" onclick="uploadElectricityInvoice()" style="text-transform: uppercase; margin-top: 10px;">WCZYTAJ PDF</button>
                    </div>

                    <!-- Formularz weryfikacji faktury (ukryty do momentu parsowania) -->
                    <div id="electricity-invoice-verification" style="display: none; background: var(--hover-bg); border: 2px solid var(--primary-color); padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                        <h3>Weryfikuj dane faktury przed zapisem</h3>
                        <form id="form-electricity-invoice-verify" class="form-grid">
                            <div class="form-group">
                                <label>Rok</label>
                                <input type="number" name="rok" placeholder="2021" required>
                            </div>
                            <div class="form-group">
                                <label>Numer faktury</label>
                                <input type="text" name="numer_faktury" required>
                            </div>
                            <div class="form-group">
                                <label>Data wystawienia</label>
                                <input type="date" name="data_wystawienia" required>
                            </div>
                            <div class="form-group">
                                <label>Data poczƒÖtku okresu</label>
                                <input type="date" name="data_poczatku_okresu" required>
                            </div>
                            <div class="form-group">
                                <label>Data ko≈Ñca okresu</label>
                                <input type="date" name="data_konca_okresu" required>
                            </div>
                            <div class="form-group">
                                <label>Nale≈ºno≈õƒá za okres</label>
                                <input type="number" step="0.01" name="naleznosc_za_okres" required>
                            </div>
                            <div class="form-group">
                                <label>Warto≈õƒá prognozy</label>
                                <input type="number" step="0.01" name="wartosc_prognozy" required>
                            </div>
                            <div class="form-group">
                                <label>Faktury korygujƒÖce</label>
                                <input type="number" step="0.01" name="faktury_korygujace" value="0" required>
                            </div>
                            <div class="form-group">
                                <label>Odsetki</label>
                                <input type="number" step="0.01" name="odsetki" value="0" required>
                            </div>
                            <div class="form-group">
                                <label>Wynik rozliczenia</label>
                                <input type="number" step="0.01" name="wynik_rozliczenia" required>
                            </div>
                            <div class="form-group">
                                <label>Kwota nadp≈Çacona</label>
                                <input type="number" step="0.01" name="kwota_nadplacona" value="0" required>
                            </div>
                            <div class="form-group">
                                <label>Saldo z rozliczenia</label>
                                <input type="number" step="0.01" name="saldo_z_rozliczenia" required>
                            </div>
                            <div class="form-group">
                                <label>Niedop≈Çata/Nadp≈Çata</label>
                                <input type="number" step="0.01" name="niedoplata_nadplata" required>
                            </div>
                            <div class="form-group">
                                <label>Energia do akcyzy (kWh)</label>
                                <input type="number" name="energia_do_akcyzy_kwh" required>
                            </div>
                            <div class="form-group">
                                <label>Akcyza</label>
                                <input type="number" step="0.01" name="akcyza" required>
                            </div>
                            <div class="form-group">
                                <label>Do zap≈Çaty</label>
                                <input type="number" step="0.01" name="do_zaplaty" required>
                            </div>
                            <div class="form-group">
                                <label>Zu≈ºycie (kWh)</label>
                                <input type="number" name="zuzycie_kwh" required>
                            </div>
                            <div class="form-group">
                                <label>Og√≥≈Çem sprzeda≈º energii</label>
                                <input type="number" step="0.01" name="ogolem_sprzedaz_energii" required>
                            </div>
                            <div class="form-group">
                                <label>Og√≥≈Çem us≈Çuga dystrybucji</label>
                                <input type="number" step="0.01" name="ogolem_usluga_dystrybucji" required>
                            </div>
                            <div class="form-group">
                                <label>Grupa taryfowa</label>
                                <input type="text" name="grupa_taryfowa" placeholder="G12" required>
                            </div>
                            <div class="form-group">
                                <label>Typ taryfy</label>
                                <select name="typ_taryfy" required>
                                    <option value="DWUTARYFOWA">Dwutaryfowa (dzienna/nocna)</option>
                                    <option value="CA≈ÅODOBOWA">Ca≈Çodobowa (jednotaryfowa)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Energia ≈ÇƒÖcznie zu≈ºyta w roku (kWh)</label>
                                <input type="number" name="energia_lacznie_zuzyta_w_roku_kwh" required>
                            </div>
                        </form>
                        
                        <!-- Sekcje dla pozosta≈Çych tabel szczeg√≥≈Çowych -->
                        <div style="margin-top: 30px; border-top: 2px solid var(--primary-color); padding-top: 20px;">
                            <h4 style="color: var(--primary-color); margin-bottom: 15px;">üìã Szczeg√≥≈Çowe dane faktury</h4>
                            
                            <!-- Blankiety prognozowe -->
                            <div id="electricity-blankiety-section" style="margin-bottom: 20px; display: none;">
                                <h5 style="margin-bottom: 10px;">Blankiety prognozowe</h5>
                                <div id="electricity-blankiety-list" style="overflow-x: auto;">
                                    <div id="electricity-blankiety-editable"></div>
                                </div>
                            </div>
                            
                            <!-- Odczyty licznik√≥w -->
                            <div id="electricity-odczyty-section" style="margin-bottom: 20px; display: none;">
                                <h5 style="margin-bottom: 10px;">Odczyty licznik√≥w</h5>
                                <div id="electricity-odczyty-list" style="overflow-x: auto;">
                                    <div id="electricity-odczyty-editable"></div>
                                </div>
                            </div>
                            
                            <!-- Sprzeda≈º energii -->
                            <div id="electricity-sprzedaz-section" style="margin-bottom: 20px; display: none;">
                                <h5 style="margin-bottom: 10px;">Sprzeda≈º energii (szczeg√≥≈Çowa)</h5>
                                <div id="electricity-sprzedaz-list" style="overflow-x: auto;">
                                    <div id="electricity-sprzedaz-editable"></div>
                                </div>
                            </div>
                            
                            <!-- Op≈Çaty dystrybucyjne -->
                            <div id="electricity-oplaty-section" style="margin-bottom: 20px; display: none;">
                                <h5 style="margin-bottom: 10px;">Op≈Çaty dystrybucyjne (szczeg√≥≈Çowe)</h5>
                                <div id="electricity-oplaty-list" style="overflow-x: auto;">
                                    <div id="electricity-oplaty-editable"></div>
                                </div>
                            </div>
                            
                            <!-- Rozliczenie okres√≥w -->
                            <div id="electricity-rozliczenie-section" style="margin-bottom: 20px; display: none;">
                                <h5 style="margin-bottom: 10px;">Rozliczenie okres√≥w</h5>
                                <div id="electricity-rozliczenie-list" style="overflow-x: auto;">
                                    <div id="electricity-rozliczenie-editable"></div>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="verifyAndSaveElectricityInvoice()">Zatwierd≈∫ i zapisz</button>
                        <button class="btn btn-secondary" onclick="cancelElectricityInvoiceVerification()">Anuluj</button>
                    </div>

                    <!-- Przycisk do pokazania formularza rƒôcznego -->
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="toggleManualElectricityInvoiceForm()" id="btn-show-manual-electricity-invoice" style="text-transform: uppercase;">
                            LUB DODAJ RƒòCZNIE
                        </button>
                    </div>

                    <!-- Formularz rƒôcznego dodawania faktury (ukryty domy≈õlnie) -->
                    <div id="electricity-invoice-manual-form" style="display: none;">
                        <h3>Dodaj fakturƒô rƒôcznie</h3>
                        <form id="form-electricity-invoice" class="form-grid">
                            <div class="form-group">
                                <label>Okres (YYYY-MM)</label>
                                <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                            </div>
                            <div class="form-group">
                                <label>Numer faktury</label>
                                <input type="text" name="invoice_number" required>
                            </div>
                            <div class="form-group">
                                <label>Data poczƒÖtku okresu</label>
                                <input type="date" name="period_start" required>
                            </div>
                            <div class="form-group">
                                <label>Data ko≈Ñca okresu</label>
                                <input type="date" name="period_stop" required>
                            </div>
                            <div class="form-group">
                                <label>Zu≈ºycie (kWh)</label>
                                <input type="number" step="0.01" name="usage_kwh" required>
                            </div>
                            <div class="form-group">
                                <label>Cena energii netto za kWh</label>
                                <input type="number" step="0.0001" name="energy_price_net" required>
                            </div>
                            <div class="form-group">
                                <label>Warto≈õƒá energii netto</label>
                                <input type="number" step="0.01" name="energy_value_net" required>
                            </div>
                            <div class="form-group">
                                <label>VAT energii</label>
                                <input type="number" step="0.01" name="energy_vat_amount" required>
                            </div>
                            <div class="form-group">
                                <label>Warto≈õƒá energii brutto</label>
                                <input type="number" step="0.01" name="energy_value_gross" required>
                            </div>
                            <div class="form-group">
                                <label>Op≈Çaty dystrybucyjne netto</label>
                                <input type="number" step="0.01" name="distribution_fees_net" value="0">
                            </div>
                            <div class="form-group">
                                <label>Op≈Çaty dystrybucyjne VAT</label>
                                <input type="number" step="0.01" name="distribution_fees_vat" value="0">
                            </div>
                            <div class="form-group">
                                <label>Op≈Çaty dystrybucyjne brutto</label>
                                <input type="number" step="0.01" name="distribution_fees_gross" value="0">
                            </div>
                            <div class="form-group">
                                <label>VAT (np. 0.23 dla 23%)</label>
                                <input type="number" step="0.01" name="vat_rate" value="0.23" required>
                            </div>
                            <div class="form-group">
                                <label>Kwota VAT og√≥≈Çem</label>
                                <input type="number" step="0.01" name="vat_amount" required>
                            </div>
                            <div class="form-group">
                                <label>Suma netto</label>
                                <input type="number" step="0.01" name="total_net_sum" required>
                            </div>
                            <div class="form-group">
                                <label>Suma brutto</label>
                                <input type="number" step="0.01" name="total_gross_sum" required>
                            </div>
                            <div class="form-group">
                                <label>Do zap≈Çaty</label>
                                <input type="number" step="0.01" name="amount_to_pay" required>
                            </div>
                            <div class="form-group">
                                <label>Termin p≈Çatno≈õci</label>
                                <input type="date" name="payment_due_date" required>
                            </div>
                        </form>
                        <button class="btn btn-primary" onclick="addElectricityInvoice()">Dodaj fakturƒô</button>
                        <button class="btn btn-secondary" onclick="toggleManualElectricityInvoiceForm()" style="margin-left: 10px;">Ukryj formularz</button>
                    </div>
                    
                    <div id="electricity-invoices-list" class="loading">≈Åadowanie...</div>
                </div>

                <!-- Sekcja Rachunki prƒÖdu -->
                <div id="electricity-tab-bills" class="tab-content">
                    <h2>Rachunki prƒÖdu</h2>
                    <div class="period-selector">
                        <label>Okres (YYYY-MM):</label>
                        <input type="text" id="electricity-bill-period" placeholder="2025-02" pattern="\d{4}-\d{2}" list="available-electricity-periods">
                        <datalist id="available-electricity-periods"></datalist>
                        <button class="btn btn-success" onclick="generateElectricityBills()" style="text-transform: uppercase;">GENERUJ RACHUNKI</button>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9em;">
                        üí° Podaj okres w formacie YYYY-MM. System automatycznie wygeneruje rachunki dla wszystkich lokali na podstawie faktur i odczyt√≥w.
                    </p>
                    
                    <div id="electricity-bills-list" class="loading">≈Åadowanie...</div>
                </div>
            </div>  <!-- koniec medium-electricity -->
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // Tab switching
        function showTab(tabName) {
            // Usu≈Ñ aktywne z wszystkich zak≈Çadek
            document.querySelectorAll('#medium-water .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#medium-water .tab-content').forEach(t => t.classList.remove('active'));
            
            // Znajd≈∫ odpowiedni przycisk i ustaw go jako aktywny
            const tabButtons = document.querySelectorAll('#medium-water .tab');
            tabButtons.forEach(btn => {
                if ((tabName === 'locals' && btn.textContent.includes('Lokale')) ||
                    (tabName === 'readings' && btn.textContent.includes('Odczyty')) ||
                    (tabName === 'invoices' && btn.textContent.includes('Faktury')) ||
                    (tabName === 'bills' && btn.textContent.includes('Rachunki'))) {
                    btn.classList.add('active');
                }
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Od≈õwie≈º dane dla aktywnej zak≈Çadki
            if (tabName === 'locals') loadLocals();
            if (tabName === 'readings') loadReadings();
            if (tabName === 'invoices') loadInvoices();
            if (tabName === 'bills') loadBills();
        }

        // Aktualizacja nazwy pliku
        function updateFileName(inputId, displayId) {
            const fileInput = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            if (fileInput.files && fileInput.files.length > 0) {
                display.textContent = fileInput.files[0].name;
            } else {
                display.textContent = '';
            }
        }

        // Alerty
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type} show`;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        // Statystyki wody
        async function loadWaterStats() {
            try {
                const res = await fetch(`${API_BASE}/api/water/stats`);
                const stats = await res.json();
                document.getElementById('water-stat-locals').textContent = stats.locals_count || 0;
                document.getElementById('water-stat-readings').textContent = stats.readings_count || 0;
                document.getElementById('water-stat-invoices').textContent = stats.invoices_count || 0;
                document.getElementById('water-stat-bills').textContent = stats.bills_count || 0;
                document.getElementById('water-stat-total').textContent = (stats.total_gross_sum || 0).toFixed(2) + ' z≈Ç';
                document.getElementById('water-stat-latest-period').textContent = stats.latest_period || '-';
                
                // Aktualizuj listƒô dostƒôpnych okres√≥w
                const datalist = document.getElementById('available-periods');
                datalist.innerHTML = '';
                if (stats.available_periods && stats.available_periods.length > 0) {
                    stats.available_periods.forEach(period => {
                        const option = document.createElement('option');
                        option.value = period;
                        datalist.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania statystyk wody:', error);
            }
        }

        // Lokale
        async function loadLocals() {
            try {
                const res = await fetch(`${API_BASE}/api/water/locals/`);
                const locals = await res.json();
                const listEl = document.getElementById('locals-list');
                
                if (locals.length === 0) {
                    listEl.innerHTML = '<p>Brak lokali</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Licznik</th><th>Najemca</th><th>Lokal</th><th>Akcje</th></tr></thead><tbody>';
                locals.forEach(l => {
                    html += `<tr>
                        <td>${l.water_meter_name}</td>
                        <td>${l.tenant}</td>
                        <td>${l.local}</td>
                        <td class="actions">
                            <button class="btn btn-danger btn-small" onclick="deleteLocal(${l.id})" title="Usu≈Ñ lokal">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                document.getElementById('locals-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania lokali</p>';
            }
        }

        async function addLocal() {
            const form = document.getElementById('form-local');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                params.append(key, value);
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/locals/?${params}`, { method: 'POST' });
                if (res.ok) {
                    showAlert('Lokal dodany pomy≈õlnie!');
                    form.reset();
                    loadLocals();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd dodawania lokalu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Odczyty
        async function loadReadings() {
            try {
                const res = await fetch(`${API_BASE}/api/water/readings/`);
                const readings = await res.json();
                const listEl = document.getElementById('readings-list');
                
                if (readings.length === 0) {
                    listEl.innerHTML = '<p>Brak odczyt√≥w</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Okres</th><th>Licznik g≈Ç√≥wny</th><th>Licznik 5 (gora)</th><th>Licznik 5b (dol)</th><th>Akcje</th></tr></thead><tbody>';
                readings.forEach(r => {
                    html += `<tr class="clickable" onclick="toggleReadingDetails('${r.data}')" data-reading-period="${r.data}">
                        <td>${r.data}</td>
                        <td>${r.water_meter_main}</td>
                        <td>${r.water_meter_5}</td>
                        <td>${r.water_meter_5b}</td>
                        <td class="actions" onclick="event.stopPropagation()">
                            <button class="btn btn-edit btn-small" onclick="editReading('${r.data}')" title="Edytuj odczyt">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteReading('${r.data}')" title="Usu≈Ñ odczyt i rachunki dla tego okresu">üóëÔ∏è</button>
                        </td>
                    </tr>
                    <tr class="details-row" id="reading-details-${r.data}" data-reading-period="${r.data}">
                        <td colspan="5" class="details-cell">
                            <div class="details-grid">
                                <div class="details-item"><label>Okres:</label><span class="value">${r.data}</span></div>
                                <div class="details-item"><label>Licznik g≈Ç√≥wny:</label><span class="value">${r.water_meter_main}</span></div>
                                <div class="details-item"><label>Licznik 5 (gora):</label><span class="value">${r.water_meter_5}</span></div>
                                <div class="details-item"><label>Licznik 5b (dol):</label><span class="value">${r.water_meter_5b}</span></div>
                                <div class="details-item"><label>Licznik 5a (gabinet):</label><span class="value">${(r.water_meter_main - r.water_meter_5 - r.water_meter_5b).toFixed(2)}</span></div>
                            </div>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                document.getElementById('readings-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania odczyt√≥w</p>';
            }
        }

        async function addReading() {
            const form = document.getElementById('form-reading');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                params.append(key, value);
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/readings/?${params}`, { method: 'POST' });
                if (res.ok) {
                    showAlert('Odczyt dodany pomy≈õlnie!');
                    form.reset();
                    loadReadings();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd dodawania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Faktury
        async function loadInvoices() {
            try {
                const res = await fetch(`${API_BASE}/api/water/invoices/`);
                const invoices = await res.json();
                const listEl = document.getElementById('invoices-list');
                
                if (invoices.length === 0) {
                    listEl.innerHTML = '<p>Brak faktur</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Okres</th><th>Numer faktury</th><th>Zu≈ºycie (m¬≥)</th><th>Koszt wody/m¬≥</th><th>Koszt ≈õciek√≥w/m¬≥</th><th>Suma brutto</th><th>Akcje</th></tr></thead><tbody>';
                invoices.forEach(i => {
                    html += `<tr class="clickable" onclick="toggleInvoiceDetails(${i.id})" data-invoice-id="${i.id}">
                        <td>${i.data}</td>
                        <td>${i.invoice_number}</td>
                        <td>${i.usage}</td>
                        <td>${i.water_cost_m3}</td>
                        <td>${i.sewage_cost_m3}</td>
                        <td>${i.gross_sum.toFixed(2)} z≈Ç</td>
                        <td class="actions" onclick="event.stopPropagation()">
                            <button class="btn btn-edit btn-small" onclick="editInvoice(${i.id})" title="Edytuj fakturƒô">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteInvoice(${i.id})" title="Usu≈Ñ fakturƒô i rachunki dla tego okresu (je≈õli to ostatnia faktura)">üóëÔ∏è</button>
                        </td>
                    </tr>
                    <tr class="details-row" id="invoice-details-${i.id}" data-invoice-id="${i.id}">
                        <td colspan="7" class="details-cell">
                            <div class="details-grid">
                                <div class="details-item"><label>Okres:</label><span class="value">${i.data}</span></div>
                                <div class="details-item"><label>Numer faktury:</label><span class="value">${i.invoice_number}</span></div>
                                <div class="details-item"><label>Zu≈ºycie (m¬≥):</label><span class="value">${i.usage}</span></div>
                                <div class="details-item"><label>Koszt wody/m¬≥:</label><span class="value">${i.water_cost_m3} z≈Ç</span></div>
                                <div class="details-item"><label>Koszt ≈õciek√≥w/m¬≥:</label><span class="value">${i.sewage_cost_m3} z≈Ç</span></div>
                                <div class="details-item"><label>Abonament (miesiƒôcy):</label><span class="value">${i.nr_of_subscription}</span></div>
                                <div class="details-item"><label>Abonament woda/miesiƒÖc:</label><span class="value">${i.water_subscr_cost} z≈Ç</span></div>
                                <div class="details-item"><label>Abonament ≈õcieki/miesiƒÖc:</label><span class="value">${i.sewage_subscr_cost} z≈Ç</span></div>
                                <div class="details-item"><label>VAT:</label><span class="value">${(i.vat * 100).toFixed(0)}%</span></div>
                                <div class="details-item"><label>Okres od:</label><span class="value">${i.period_start || '-'}</span></div>
                                <div class="details-item"><label>Okres do:</label><span class="value">${i.period_stop || '-'}</span></div>
                                <div class="details-item"><label>Suma brutto:</label><span class="value">${i.gross_sum.toFixed(2)} z≈Ç</span></div>
                            </div>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                document.getElementById('invoices-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania faktur</p>';
            }
        }

        async function uploadInvoice() {
            const fileInput = document.getElementById('invoice-file');
            if (!fileInput.files[0]) {
                showAlert('Wybierz plik PDF', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch(`${API_BASE}/api/water/invoices/parse`, {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    const result = await res.json();
                    // Wype≈Çnij formularz weryfikacji danymi
                    const verifyForm = document.getElementById('form-invoice-verify');
                    Object.keys(result).forEach(key => {
                        const input = verifyForm.querySelector(`[name="${key}"]`);
                        if (input && result[key] !== null && result[key] !== undefined) {
                            // Dla p√≥l typu date, upewnij siƒô ≈ºe format jest poprawny
                            if (input.type === 'date' && typeof result[key] === 'string') {
                                input.value = result[key];
                            } else if (input.type !== 'date') {
                                input.value = result[key];
                            }
                        }
                    });
                    // Poka≈º formularz weryfikacji
                    document.getElementById('invoice-verification').style.display = 'block';
                    showAlert('Faktura sparsowana - zweryfikuj dane przed zapisem');
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd parsowania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function verifyAndSaveInvoice() {
            const form = document.getElementById('form-invoice-verify');
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                // Konwertuj warto≈õci numeryczne
                if (['usage', 'water_cost_m3', 'sewage_cost_m3', 'water_subscr_cost', 
                     'sewage_subscr_cost', 'vat', 'gross_sum'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else if (key === 'nr_of_subscription') {
                    data[key] = parseInt(value) || 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/invoices/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Faktura zapisana pomy≈õlnie!');
                    form.reset();
                    document.getElementById('invoice-verification').style.display = 'none';
                    document.getElementById('invoice-file').value = '';
                    document.getElementById('invoice-file-name').textContent = '';
                    // Przywr√≥ƒá oryginalny przycisk
                    const verifyTitle = document.querySelector('#invoice-verification h3');
                    if (verifyTitle) verifyTitle.textContent = 'Weryfikuj dane faktury przed zapisem';
                    const verifyBtn = document.querySelector('#invoice-verification .btn-success');
                    if (verifyBtn) {
                        verifyBtn.textContent = 'Zatwierd≈∫ i zapisz';
                        verifyBtn.onclick = verifyAndSaveInvoice;
                    }
                    loadInvoices();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd zapisywania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function cancelInvoiceVerification() {
            document.getElementById('invoice-verification').style.display = 'none';
            document.getElementById('form-invoice-verify').reset();
            document.getElementById('invoice-file').value = '';
            document.getElementById('invoice-file-name').textContent = '';
            // Przywr√≥ƒá oryginalny przycisk
            const verifyTitle = document.querySelector('#invoice-verification h3');
            if (verifyTitle) verifyTitle.textContent = 'Weryfikuj dane faktury przed zapisem';
            const verifyBtn = document.querySelector('#invoice-verification .btn-success');
            if (verifyBtn) {
                verifyBtn.textContent = 'Zatwierd≈∫ i zapisz';
                verifyBtn.onclick = verifyAndSaveInvoice;
            }
        }

        function toggleManualInvoiceForm() {
            const formDiv = document.getElementById('invoice-manual-form');
            const btn = document.getElementById('btn-show-manual-invoice');
            
            if (formDiv.style.display === 'none' || formDiv.style.display === '') {
                formDiv.style.display = 'block';
                btn.textContent = 'Ukryj formularz rƒôczny';
            } else {
                formDiv.style.display = 'none';
                btn.textContent = 'LUB DODAJ RƒòCZNIE';
            }
        }

        async function addInvoice() {
            const form = document.getElementById('form-invoice');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                params.append(key, value);
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/invoices/?${params}`, { method: 'POST' });
                if (res.ok) {
                    showAlert('Faktura dodana pomy≈õlnie!');
                    form.reset();
                    // Ukryj formularz rƒôczny po dodaniu faktury
                    const formDiv = document.getElementById('invoice-manual-form');
                    const btn = document.getElementById('btn-show-manual-invoice');
                    formDiv.style.display = 'none';
                    btn.textContent = 'LUB DODAJ RƒòCZNIE';
                    loadInvoices();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd dodawania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Rachunki
        async function loadBills() {
            try {
                const res = await fetch(`${API_BASE}/api/water/bills/`);
                const bills = await res.json();
                const listEl = document.getElementById('bills-list');
                
                if (bills.length === 0) {
                    listEl.innerHTML = '<p>Brak rachunk√≥w. Wygeneruj rachunki dla okresu z fakturƒÖ i odczytami.</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Okres</th><th>Lokal</th><th>Zu≈ºycie (m¬≥)</th><th>Suma brutto</th><th>Akcje</th></tr></thead><tbody>';
                bills.forEach(b => {
                    html += `<tr class="clickable" onclick="toggleBillDetails(${b.id})" data-bill-id="${b.id}">
                        <td>${b.data}</td>
                        <td>${b.local}</td>
                        <td>${b.usage_m3}</td>
                        <td>${b.gross_sum.toFixed(2)} z≈Ç</td>
                        <td class="actions" onclick="event.stopPropagation()">
                            <a href="${API_BASE}/api/water/bills/download/${b.id}" target="_blank" class="btn btn-success btn-small">üì• PDF</a>
                            <button class="btn btn-edit btn-small" onclick="editBill(${b.id})" title="Edytuj rachunek">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteBill(${b.id})" title="Usu≈Ñ rachunek">üóëÔ∏è</button>
                        </td>
                    </tr>
                    <tr class="details-row" id="bill-details-${b.id}" data-bill-id="${b.id}">
                        <td colspan="5" class="details-cell">
                            <div class="details-grid">
                                <div class="details-item"><label>Okres:</label><span class="value">${b.data}</span></div>
                                <div class="details-item"><label>Lokal:</label><span class="value">${b.local}</span></div>
                                <div class="details-item"><label>Warto≈õƒá odczytu:</label><span class="value">${(b.reading_value || 0).toFixed(2)}</span></div>
                                <div class="details-item"><label>Zu≈ºycie (m¬≥):</label><span class="value">${b.usage_m3}</span></div>
                                <div class="details-item"><label>Koszt wody:</label><span class="value">${b.cost_water.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label>Koszt ≈õciek√≥w:</label><span class="value">${b.cost_sewage.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label>Koszt zu≈ºycia ≈ÇƒÖcznie:</label><span class="value">${b.cost_usage_total.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label>Abonament woda:</label><span class="value">${b.abonament_water_share.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label>Abonament ≈õcieki:</label><span class="value">${b.abonament_sewage_share.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label>Abonament ≈ÇƒÖcznie:</label><span class="value">${b.abonament_total.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label>Suma netto:</label><span class="value">${b.net_sum.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label>Suma brutto:</label><span class="value">${b.gross_sum.toFixed(2)} z≈Ç</span></div>
                            </div>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                document.getElementById('bills-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania rachunk√≥w</p>';
            }
        }

        async function generateBills() {
            const period = document.getElementById('bill-period').value.trim();
            if (!period || !period.match(/^\d{4}-\d{2}$/)) {
                showAlert('Podaj prawid≈Çowy okres (YYYY-MM)', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/bills/generate/${period}`, { method: 'POST' });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Wygenerowano ${result.bills_count} rachunk√≥w dla okresu ${period}`);
                    loadBills();
                    loadWaterStats();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd generowania rachunk√≥w', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function regenerateBills() {
            const period = document.getElementById('bill-period').value.trim();
            if (!period || !period.match(/^\d{4}-\d{2}$/)) {
                showAlert('Podaj prawid≈Çowy okres (YYYY-MM)', 'error');
                return;
            }

            if (!confirm(`Czy na pewno chcesz zregenerowaƒá rachunki dla okresu ${period}?`)) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/bills/regenerate/${period}`, { method: 'POST' });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Zregenerowano ${result.bills_count} rachunk√≥w dla okresu ${period}`);
                    loadBills();
                    loadWaterStats();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd regenerowania rachunk√≥w', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function deleteBill(billId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten rachunek?')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/bills/${billId}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('Rachunek usuniƒôty');
                    loadBills();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function deleteLocal(localId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten lokal? ZostanƒÖ r√≥wnie≈º usuniƒôte wszystkie powiƒÖzane rachunki.')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/locals/${localId}`, { method: 'DELETE' });
                if (res.ok) {
                    const result = await res.json();
                    showAlert(`Lokal usuniƒôty. Usuniƒôto r√≥wnie≈º ${result.deleted_bills_count} powiƒÖzanych rachunk√≥w.`);
                    loadLocals();
                    loadBills();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania lokalu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function toggleReadingDetails(period) {
            const detailsRow = document.getElementById(`reading-details-${period}`);
            if (detailsRow) {
                detailsRow.classList.toggle('expanded');
            }
        }

        async function editReading(period) {
            try {
                const res = await fetch(`${API_BASE}/api/water/readings/${period}`);
                if (res.ok) {
                    const reading = await res.json();
                    // Utw√≥rz formularz edycji
                    const formHtml = `
                        <div style="background: #f0f9ff; border: 2px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 8px;">
                            <h3>Edytuj odczyt</h3>
                            <form id="form-reading-edit-${period}" class="form-grid">
                                <div class="form-group">
                                    <label>Okres (YYYY-MM)</label>
                                    <input type="text" name="data" value="${reading.data}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Licznik g≈Ç√≥wny</label>
                                    <input type="number" step="0.01" name="water_meter_main" value="${reading.water_meter_main}" required>
                                </div>
                                <div class="form-group">
                                    <label>Licznik 5 (gora)</label>
                                    <input type="number" name="water_meter_5" value="${reading.water_meter_5}" required>
                                </div>
                                <div class="form-group">
                                    <label>Licznik 5b (dol)</label>
                                    <input type="number" name="water_meter_5b" value="${reading.water_meter_5b}" required>
                                </div>
                            </form>
                            <button class="btn btn-success" onclick="updateReading('${period}')">Zapisz zmiany</button>
                            <button class="btn btn-secondary" onclick="cancelReadingEdit('${period}')">Anuluj</button>
                        </div>
                    `;
                    // Znajd≈∫ szczeg√≥≈Çy odczytu i dodaj formularz
                    const detailsRow = document.getElementById(`reading-details-${period}`);
                    if (detailsRow) {
                        const detailsCell = detailsRow.querySelector('.details-cell');
                        if (detailsCell) {
                            const existingForm = detailsCell.querySelector(`#form-reading-edit-${period}`);
                            if (existingForm) {
                                existingForm.parentElement.remove();
                            } else {
                                detailsCell.insertAdjacentHTML('beforeend', formHtml);
                                detailsRow.classList.add('expanded');
                            }
                        }
                    } else {
                        // Je≈õli szczeg√≥≈Çy nie istniejƒÖ, utw√≥rz wiersz szczeg√≥≈Ç√≥w
                        const readingRow = document.querySelector(`tr[data-reading-period="${period}"]`);
                        if (readingRow) {
                            const newRow = document.createElement('tr');
                            newRow.className = 'details-row expanded';
                            newRow.id = `reading-details-${period}`;
                            newRow.setAttribute('data-reading-period', period);
                            newRow.innerHTML = `<td colspan="5" class="details-cell">${formHtml}</td>`;
                            readingRow.parentElement.insertBefore(newRow, readingRow.nextSibling);
                        }
                    }
                    // Scroll do formularza
                    document.getElementById(`reading-details-${period}`)?.scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert('B≈ÇƒÖd pobierania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function updateReading(period) {
            const form = document.getElementById(`form-reading-edit-${period}`);
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                if (key !== 'data') {  // Nie wysy≈Çaj okresu jako parametru
                    params.append(key, value);
                }
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/readings/${period}?${params}`, {
                    method: 'PUT'
                });
                if (res.ok) {
                    showAlert('Odczyt zaktualizowany pomy≈õlnie!');
                    cancelReadingEdit(period);
                    loadReadings();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function cancelReadingEdit(period) {
            const formDiv = document.querySelector(`#form-reading-edit-${period}`)?.parentElement;
            if (formDiv) {
                formDiv.remove();
            }
            // Od≈õwie≈º szczeg√≥≈Çy odczytu
            const detailsRow = document.getElementById(`reading-details-${period}`);
            if (detailsRow && detailsRow.dataset.loaded !== 'true') {
                detailsRow.classList.remove('expanded');
            }
        }

        async function deleteReading(period) {
            if (!confirm(`Czy na pewno chcesz usunƒÖƒá odczyt dla okresu ${period}? ZostanƒÖ r√≥wnie≈º usuniƒôte wszystkie rachunki dla tego okresu.`)) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/readings/${period}`, { method: 'DELETE' });
                if (res.ok) {
                    const result = await res.json();
                    showAlert(`Odczyt dla okresu ${period} usuniƒôty. Usuniƒôto r√≥wnie≈º ${result.deleted_bills_count} rachunk√≥w.`);
                    loadReadings();
                    loadBills();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Funkcje rozwijania szczeg√≥≈Ç√≥w
        function toggleInvoiceDetails(invoiceId) {
            const detailsRow = document.getElementById(`invoice-details-${invoiceId}`);
            if (detailsRow) {
                detailsRow.classList.toggle('expanded');
            }
        }

        function toggleBillDetails(billId) {
            const detailsRow = document.getElementById(`bill-details-${billId}`);
            if (detailsRow) {
                // Sprawd≈∫ czy formularz edycji jest otwarty - je≈õli tak, nie zamykaj
                const editForm = detailsRow.querySelector(`#form-bill-edit-${billId}`);
                if (!editForm) {
                    detailsRow.classList.toggle('expanded');
                }
            }
        }

        async function toggleGasInvoiceDetails(invoiceId) {
            const detailsRow = document.getElementById(`gas-invoice-details-${invoiceId}`);
            if (detailsRow) {
                const isExpanded = detailsRow.classList.contains('expanded');
                detailsRow.classList.toggle('expanded');
                
                // Je≈õli rozwijamy i szczeg√≥≈Çy nie sƒÖ za≈Çadowane, pobierz pe≈Çne dane
                if (!isExpanded && !detailsRow.dataset.loaded) {
                    try {
                        const res = await fetch(`${API_BASE}/api/gas/invoices/${invoiceId}`);
                        if (res.ok) {
                            const invoice = await res.json();
                            const detailsGrid = detailsRow.querySelector('.details-grid');
                            if (detailsGrid) {
                                detailsGrid.innerHTML = `
                                    <div class="details-item"><label>Okres:</label><span class="value">${invoice.data}</span></div>
                                    <div class="details-item"><label>Numer faktury:</label><span class="value">${invoice.invoice_number}</span></div>
                                    <div class="details-item"><label>Okres od:</label><span class="value">${invoice.period_start || '-'}</span></div>
                                    <div class="details-item"><label>Okres do:</label><span class="value">${invoice.period_stop || '-'}</span></div>
                                    <div class="details-item"><label>Odczyt poprzedni:</label><span class="value">${invoice.previous_reading?.toFixed(2) || '-'} m¬≥</span></div>
                                    <div class="details-item"><label>Odczyt obecny:</label><span class="value">${invoice.current_reading?.toFixed(2) || '-'} m¬≥</span></div>
                                    <div class="details-item"><label>Zu≈ºycie paliwa:</label><span class="value">${invoice.fuel_usage_m3?.toFixed(2) || '-'} m¬≥</span></div>
                                    <div class="details-item"><label>Zu≈ºycie paliwa (kWh):</label><span class="value">${invoice.fuel_usage_kwh?.toFixed(2) || '-'} kWh</span></div>
                                    <div class="details-item"><label>Paliwo - Warto≈õƒá netto:</label><span class="value">${invoice.fuel_value_net?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label>Paliwo - Warto≈õƒá brutto:</label><span class="value">${invoice.fuel_value_gross?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label>Abonament - Warto≈õƒá netto:</label><span class="value">${invoice.subscription_value_net?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label>Abonament - Warto≈õƒá brutto:</label><span class="value">${invoice.subscription_value_gross?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label>Dystrybucja sta≈Ça - Warto≈õƒá netto:</label><span class="value">${invoice.distribution_fixed_value_net?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label>Dystrybucja sta≈Ça - Warto≈õƒá brutto:</label><span class="value">${invoice.distribution_fixed_value_gross?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label>Dystrybucja zmienna - Warto≈õƒá netto:</label><span class="value">${invoice.distribution_variable_value_net?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label>Dystrybucja zmienna - Warto≈õƒá brutto:</label><span class="value">${invoice.distribution_variable_value_gross?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label>Suma netto:</label><span class="value">${invoice.total_net_sum?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label>VAT:</label><span class="value">${invoice.vat_rate ? (invoice.vat_rate * 100).toFixed(0) + '%' : '-'}</span></div>
                                    <div class="details-item"><label>Kwota VAT:</label><span class="value">${invoice.vat_amount?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label>Suma brutto:</label><span class="value">${invoice.total_gross_sum?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label>Odsetki za sp√≥≈∫nienie:</label><span class="value">${invoice.late_payment_interest?.toFixed(2) || '0.00'} z≈Ç</span></div>
                                    <div class="details-item"><label>Termin p≈Çatno≈õci:</label><span class="value">${invoice.payment_due_date || '-'}</span></div>
                                    <div class="details-item"><label>Do zap≈Çaty:</label><span class="value">${invoice.amount_to_pay?.toFixed(2) || '-'} z≈Ç</span></div>
                                `;
                                detailsRow.dataset.loaded = 'true';
                            }
                        }
                    } catch (error) {
                        console.error('B≈ÇƒÖd pobierania szczeg√≥≈Ç√≥w faktury:', error);
                    }
                }
            }
        }

        function toggleGasBillDetails(billId) {
            const detailsRow = document.getElementById(`gas-bill-details-${billId}`);
            if (detailsRow) {
                detailsRow.classList.toggle('expanded');
            }
        }

        // Funkcje edycji
        async function editInvoice(invoiceId) {
            try {
                        const res = await fetch(`${API_BASE}/api/water/invoices/${invoiceId}`);
                if (res.ok) {
                    const invoice = await res.json();
                    // Wype≈Çnij formularz weryfikacji danymi faktury
                    const verifyForm = document.getElementById('form-invoice-verify');
                    Object.keys(invoice).forEach(key => {
                        const input = verifyForm.querySelector(`[name="${key}"]`);
                        if (input && invoice[key] !== null && invoice[key] !== undefined) {
                            if (input.type === 'date' && typeof invoice[key] === 'string') {
                                input.value = invoice[key];
                            } else if (input.type !== 'date') {
                                input.value = invoice[key];
                            }
                        }
                    });
                    // Poka≈º formularz weryfikacji
                    document.getElementById('invoice-verification').style.display = 'block';
                    // Zmie≈Ñ tytu≈Ç i przycisk
                    const verifyTitle = document.querySelector('#invoice-verification h3');
                    if (verifyTitle) verifyTitle.textContent = 'Edytuj fakturƒô';
                    const verifyBtn = document.querySelector('#invoice-verification .btn-success');
                    if (verifyBtn) verifyBtn.textContent = 'Zapisz zmiany';
                    verifyBtn.onclick = () => updateInvoice(invoiceId);
                    // Scroll do formularza
                    document.getElementById('invoice-verification').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert('B≈ÇƒÖd pobierania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function updateInvoice(invoiceId) {
            const form = document.getElementById('form-invoice-verify');
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                if (['usage', 'water_cost_m3', 'sewage_cost_m3', 'water_subscr_cost', 
                     'sewage_subscr_cost', 'vat', 'gross_sum'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else if (key === 'nr_of_subscription') {
                    data[key] = parseInt(value) || 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/invoices/${invoiceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Faktura zaktualizowana pomy≈õlnie!');
                    form.reset();
                    document.getElementById('invoice-verification').style.display = 'none';
                    // Przywr√≥ƒá oryginalny przycisk
                    const verifyTitle = document.querySelector('#invoice-verification h3');
                    if (verifyTitle) verifyTitle.textContent = 'Weryfikuj dane faktury przed zapisem';
                    const verifyBtn = document.querySelector('#invoice-verification .btn-success');
                    if (verifyBtn) {
                        verifyBtn.textContent = 'Zatwierd≈∫ i zapisz';
                        verifyBtn.onclick = verifyAndSaveInvoice;
                    }
                    loadInvoices();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function editBill(billId) {
            try {
                const res = await fetch(`${API_BASE}/api/water/bills/${billId}`);
                if (res.ok) {
                    const bill = await res.json();
                    // Utw√≥rz formularz edycji
                    const formHtml = `
                        <div style="background: #f0f9ff; border: 2px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 8px;">
                            <h3>Edytuj rachunek</h3>
                            <form id="form-bill-edit-${billId}" class="form-grid">
                                <div class="form-group">
                                    <label>Okres</label>
                                    <input type="text" name="data" value="${bill.data}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Lokal</label>
                                    <input type="text" name="local" value="${bill.local}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Warto≈õƒá odczytu</label>
                                    <input type="number" step="0.01" name="reading_value" value="${bill.reading_value}" required>
                                </div>
                                <div class="form-group">
                                    <label>Zu≈ºycie (m¬≥)</label>
                                    <input type="number" step="0.01" name="usage_m3" value="${bill.usage_m3}" required>
                                </div>
                                <div class="form-group">
                                    <label>Koszt wody</label>
                                    <input type="number" step="0.01" name="cost_water" value="${bill.cost_water}" required>
                                </div>
                                <div class="form-group">
                                    <label>Koszt ≈õciek√≥w</label>
                                    <input type="number" step="0.01" name="cost_sewage" value="${bill.cost_sewage}" required>
                                </div>
                                <div class="form-group">
                                    <label>Koszt zu≈ºycia ≈ÇƒÖcznie</label>
                                    <input type="number" step="0.01" name="cost_usage_total" value="${bill.cost_usage_total}" required>
                                </div>
                                <div class="form-group">
                                    <label>Abonament woda</label>
                                    <input type="number" step="0.01" name="abonament_water_share" value="${bill.abonament_water_share}" required>
                                </div>
                                <div class="form-group">
                                    <label>Abonament ≈õcieki</label>
                                    <input type="number" step="0.01" name="abonament_sewage_share" value="${bill.abonament_sewage_share}" required>
                                </div>
                                <div class="form-group">
                                    <label>Abonament ≈ÇƒÖcznie</label>
                                    <input type="number" step="0.01" name="abonament_total" value="${bill.abonament_total}" required>
                                </div>
                                <div class="form-group">
                                    <label>Suma netto</label>
                                    <input type="number" step="0.01" name="net_sum" value="${bill.net_sum}" required>
                                </div>
                                <div class="form-group">
                                    <label>Suma brutto</label>
                                    <input type="number" step="0.01" name="gross_sum" value="${bill.gross_sum}" required>
                                </div>
                            </form>
                            <button class="btn btn-success" onclick="updateBill(${billId})">Zapisz zmiany</button>
                            <button class="btn btn-secondary" onclick="cancelBillEdit(${billId})">Anuluj</button>
                        </div>
                    `;
                    // Znajd≈∫ szczeg√≥≈Çy rachunku i dodaj formularz
                    const detailsRow = document.getElementById(`bill-details-${billId}`);
                    if (detailsRow) {
                        const detailsCell = detailsRow.querySelector('.details-cell');
                        if (detailsCell) {
                            const existingForm = detailsCell.querySelector(`#form-bill-edit-${billId}`);
                            if (existingForm) {
                                existingForm.parentElement.remove();
                            } else {
                                detailsCell.insertAdjacentHTML('beforeend', formHtml);
                                detailsRow.classList.add('expanded');
                            }
                        }
                    } else {
                        // Je≈õli szczeg√≥≈Çy nie istniejƒÖ, utw√≥rz wiersz szczeg√≥≈Ç√≥w
                        const billRow = document.querySelector(`tr[data-bill-id="${billId}"]`);
                        if (billRow) {
                            const newRow = document.createElement('tr');
                            newRow.className = 'details-row expanded';
                            newRow.id = `bill-details-${billId}`;
                            newRow.setAttribute('data-bill-id', billId);
                            newRow.innerHTML = `<td colspan="5" class="details-cell">${formHtml}</td>`;
                            billRow.parentElement.insertBefore(newRow, billRow.nextSibling);
                        }
                    }
                    // Scroll do formularza
                    document.getElementById(`bill-details-${billId}`)?.scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert('B≈ÇƒÖd pobierania rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function updateBill(billId) {
            const form = document.getElementById(`form-bill-edit-${billId}`);
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                if (['reading_value', 'usage_m3', 'cost_water', 'cost_sewage', 'cost_usage_total',
                     'abonament_water_share', 'abonament_sewage_share', 'abonament_total',
                     'net_sum', 'gross_sum'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/bills/${billId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Rachunek zaktualizowany pomy≈õlnie!');
                    cancelBillEdit(billId);
                    loadBills();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function cancelBillEdit(billId) {
            const formDiv = document.querySelector(`#form-bill-edit-${billId}`)?.parentElement;
            if (formDiv) {
                formDiv.remove();
            }
            // Od≈õwie≈º szczeg√≥≈Çy rachunku
            const detailsRow = document.getElementById(`bill-details-${billId}`);
            if (detailsRow && detailsRow.dataset.loaded !== 'true') {
                detailsRow.classList.remove('expanded');
            }
        }

        async function editGasInvoice(invoiceId) {
            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/${invoiceId}`);
                if (res.ok) {
                    const invoice = await res.json();
                    // Wype≈Çnij formularz weryfikacji danymi faktury
                    const verifyForm = document.getElementById('form-gas-invoice-verify');
                    Object.keys(invoice).forEach(key => {
                        const input = verifyForm.querySelector(`[name="${key}"]`);
                        if (input && invoice[key] !== null && invoice[key] !== undefined) {
                            if (input.type === 'date' && typeof invoice[key] === 'string') {
                                input.value = invoice[key].substring(0, 10);
                            } else if (input.type !== 'date') {
                                input.value = invoice[key];
                            }
                        }
                    });
                    // Poka≈º formularz weryfikacji
                    const verificationDiv = document.getElementById('gas-invoice-verification');
                    verificationDiv.style.display = 'block';
                    // Zmie≈Ñ tytu≈Ç i przycisk
                    const verifyTitle = verificationDiv.querySelector('h3');
                    if (verifyTitle) verifyTitle.textContent = 'Edytuj fakturƒô gazu';
                    const verifyBtn = verificationDiv.querySelector('.btn-success');
                    if (verifyBtn) verifyBtn.textContent = 'Zapisz zmiany';
                    verifyBtn.onclick = () => updateGasInvoice(invoiceId);
                    // Scroll do formularza
                    verificationDiv.scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert('B≈ÇƒÖd pobierania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function updateGasInvoice(invoiceId) {
            const form = document.getElementById('form-gas-invoice-verify');
            const formData = new FormData(form);
            const data = {};
            const numericFields = [
                'previous_reading', 'current_reading',
                'fuel_usage_m3', 'fuel_conversion_factor', 'fuel_usage_kwh', 'fuel_price_net', 
                'fuel_value_net', 'fuel_value_gross',
                'subscription_quantity', 'subscription_price_net', 'subscription_value_net', 
                'subscription_value_gross',
                'distribution_fixed_quantity', 'distribution_fixed_price_net', 
                'distribution_fixed_value_net', 'distribution_fixed_value_gross',
                'distribution_variable_usage_m3', 'distribution_variable_conversion_factor',
                'distribution_variable_usage_kwh', 'distribution_variable_price_net', 'distribution_variable_value_net',
                'distribution_variable_value_gross',
                'distribution_variable_2_usage_m3', 'distribution_variable_2_conversion_factor',
                'distribution_variable_2_usage_kwh', 'distribution_variable_2_price_net', 'distribution_variable_2_value_net',
                'total_net_sum', 'vat_rate', 'vat_amount', 'total_gross_sum',
                'late_payment_interest', 'amount_to_pay'
            ];
            
            for (const [key, value] of formData.entries()) {
                if (key.startsWith('distribution_variable_2_')) {
                    if (value && value.trim() !== '') {
                        const numValue = value.toString().replace(',', '.');
                        data[key] = parseFloat(numValue);
                    } else {
                        data[key] = null;
                    }
                } else if (numericFields.includes(key)) {
                    if (value) {
                        const numValue = value.toString().replace(',', '.');
                        data[key] = parseFloat(numValue) || 0;
                    } else {
                        data[key] = 0;
                    }
                } else if (key === 'subscription_quantity' || key === 'distribution_fixed_quantity') {
                    data[key] = value ? parseInt(value) : 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/${invoiceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Faktura gazu zaktualizowana pomy≈õlnie!');
                    form.reset();
                    const verificationDiv = document.getElementById('gas-invoice-verification');
                    verificationDiv.style.display = 'none';
                    // Przywr√≥ƒá oryginalny przycisk
                    const verifyTitle = verificationDiv.querySelector('h3');
                    if (verifyTitle) verifyTitle.textContent = 'Weryfikuj dane faktury przed zapisem';
                    const verifyBtn = verificationDiv.querySelector('.btn-success');
                    if (verifyBtn) {
                        verifyBtn.textContent = 'Zatwierd≈∫ i zapisz';
                        verifyBtn.onclick = verifyAndSaveGasInvoice;
                    }
                    loadGasInvoices();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function editGasBill(billId) {
            try {
                const res = await fetch(`${API_BASE}/api/gas/bills/${billId}`);
                if (res.ok) {
                    const bill = await res.json();
                    // Utw√≥rz formularz edycji
                    const formHtml = `
                        <div style="background: #f0f9ff; border: 2px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 8px;">
                            <h3>Edytuj rachunek gazu</h3>
                            <form id="form-gas-bill-edit-${billId}" class="form-grid">
                                <div class="form-group">
                                    <label>Okres</label>
                                    <input type="text" name="data" value="${bill.data}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Lokal</label>
                                    <input type="text" name="local" value="${bill.local}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Udzia≈Ç</label>
                                    <input type="number" step="0.01" name="cost_share" value="${bill.cost_share}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Paliwo (brutto)</label>
                                    <input type="number" step="0.01" name="fuel_cost_gross" value="${bill.fuel_cost_gross}" required>
                                </div>
                                <div class="form-group">
                                    <label>Abonament (brutto)</label>
                                    <input type="number" step="0.01" name="subscription_cost_gross" value="${bill.subscription_cost_gross}" required>
                                </div>
                                <div class="form-group">
                                    <label>Dystrybucja sta≈Ça (brutto)</label>
                                    <input type="number" step="0.01" name="distribution_fixed_cost_gross" value="${bill.distribution_fixed_cost_gross}" required>
                                </div>
                                <div class="form-group">
                                    <label>Dystrybucja zmienna (brutto)</label>
                                    <input type="number" step="0.01" name="distribution_variable_cost_gross" value="${bill.distribution_variable_cost_gross}" required>
                                </div>
                                <div class="form-group">
                                    <label>Suma netto</label>
                                    <input type="number" step="0.01" name="total_net_sum" value="${bill.total_net_sum}" required>
                                </div>
                                <div class="form-group">
                                    <label>Lokal brutto</label>
                                    <input type="number" step="0.01" name="total_gross_sum" value="${bill.total_gross_sum}" required>
                                </div>
                            </form>
                            <button class="btn btn-success" onclick="updateGasBill(${billId})">Zapisz zmiany</button>
                            <button class="btn btn-secondary" onclick="cancelGasBillEdit(${billId})">Anuluj</button>
                        </div>
                    `;
                    // Znajd≈∫ szczeg√≥≈Çy rachunku i dodaj formularz
                    const detailsRow = document.getElementById(`gas-bill-details-${billId}`);
                    if (detailsRow) {
                        const detailsCell = detailsRow.querySelector('.details-cell');
                        if (detailsCell) {
                            const existingForm = detailsCell.querySelector(`#form-gas-bill-edit-${billId}`);
                            if (existingForm) {
                                existingForm.parentElement.remove();
                            } else {
                                detailsCell.insertAdjacentHTML('beforeend', formHtml);
                                detailsRow.classList.add('expanded');
                            }
                        }
                    } else {
                        // Je≈õli szczeg√≥≈Çy nie istniejƒÖ, utw√≥rz wiersz szczeg√≥≈Ç√≥w
                        const billRow = document.querySelector(`tr[data-gas-bill-id="${billId}"]`);
                        if (billRow) {
                            const newRow = document.createElement('tr');
                            newRow.className = 'details-row expanded';
                            newRow.id = `gas-bill-details-${billId}`;
                            newRow.setAttribute('data-gas-bill-id', billId);
                            newRow.innerHTML = `<td colspan="5" class="details-cell">${formHtml}</td>`;
                            billRow.parentElement.insertBefore(newRow, billRow.nextSibling);
                        }
                    }
                    // Scroll do formularza
                    document.getElementById(`gas-bill-details-${billId}`)?.scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert('B≈ÇƒÖd pobierania rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function updateGasBill(billId) {
            const form = document.getElementById(`form-gas-bill-edit-${billId}`);
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                if (['cost_share', 'fuel_cost_gross', 'subscription_cost_gross', 
                     'distribution_fixed_cost_gross', 'distribution_variable_cost_gross',
                     'total_net_sum', 'total_gross_sum'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/bills/${billId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Rachunek gazu zaktualizowany pomy≈õlnie!');
                    cancelGasBillEdit(billId);
                    loadGasBills();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function cancelGasBillEdit(billId) {
            const formDiv = document.querySelector(`#form-gas-bill-edit-${billId}`)?.parentElement;
            if (formDiv) {
                formDiv.remove();
            }
            // Od≈õwie≈º szczeg√≥≈Çy rachunku
            const detailsRow = document.getElementById(`gas-bill-details-${billId}`);
            if (detailsRow && detailsRow.dataset.loaded !== 'true') {
                detailsRow.classList.remove('expanded');
            }
        }

        async function deleteGasBill(billId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten rachunek gazu?')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/bills/${billId}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('Rachunek gazu usuniƒôty');
                    loadGasBills();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function deleteInvoice(invoiceId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô fakturƒô? Je≈õli to ostatnia faktura dla tego okresu, zostanƒÖ r√≥wnie≈º usuniƒôte wszystkie rachunki dla tego okresu.')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/invoices/${invoiceId}`, { method: 'DELETE' });
                if (res.ok) {
                    const result = await res.json();
                    if (result.deleted_bills_count > 0) {
                        showAlert(`Faktura usuniƒôta. Usuniƒôto r√≥wnie≈º ${result.deleted_bills_count} rachunk√≥w dla okresu ${result.period}.`);
                    } else {
                        showAlert('Faktura usuniƒôta. Rachunki pozostajƒÖ (istniejƒÖ inne faktury dla tego okresu).');
                    }
                    loadInvoices();
                    loadBills();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // ========== FUNKCJE DLA GAZU ==========
        
        // Statystyki gazu
        async function loadGasStats() {
            try {
                const res = await fetch(`${API_BASE}/api/gas/stats`);
                const stats = await res.json();
                document.getElementById('gas-stat-invoices').textContent = stats.invoices_count || 0;
                document.getElementById('gas-stat-bills').textContent = stats.bills_count || 0;
                document.getElementById('gas-stat-total').textContent = (stats.total_gross_sum || 0).toFixed(2) + ' z≈Ç';
                document.getElementById('gas-stat-latest-period').textContent = stats.latest_period || '-';
                
                // Aktualizuj listƒô dostƒôpnych okres√≥w dla rachunk√≥w gazu
                const datalist = document.getElementById('available-gas-periods');
                datalist.innerHTML = '';
                if (stats.available_periods && stats.available_periods.length > 0) {
                    stats.available_periods.forEach(period => {
                        const option = document.createElement('option');
                        option.value = period;
                        datalist.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania statystyk gazu:', error);
            }
        }
        
        // ≈Åadowanie statystyk na g≈Ç√≥wnej stronie
        async function loadMainStats() {
            try {
                // Statystyki wody
                const waterRes = await fetch(`${API_BASE}/api/water/stats`);
                if (waterRes.ok) {
                    const waterStats = await waterRes.json();
                    document.getElementById('main-water-invoices').textContent = waterStats.invoices_count || 0;
                    document.getElementById('main-water-bills').textContent = waterStats.bills_count || 0;
                    document.getElementById('main-water-total').textContent = (waterStats.total_gross_sum || 0).toFixed(2) + ' z≈Ç';
                    document.getElementById('main-water-period').textContent = waterStats.latest_period || '-';
                }
                
                // Statystyki gazu
                const gasRes = await fetch(`${API_BASE}/api/gas/stats`);
                if (gasRes.ok) {
                    const gasStats = await gasRes.json();
                    document.getElementById('main-gas-invoices').textContent = gasStats.invoices_count || 0;
                    document.getElementById('main-gas-bills').textContent = gasStats.bills_count || 0;
                    document.getElementById('main-gas-total').textContent = (gasStats.total_gross_sum || 0).toFixed(2) + ' z≈Ç';
                    document.getElementById('main-gas-period').textContent = gasStats.latest_period || '-';
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania statystyk:', error);
            }
        }

        // Otwieranie medium z g≈Ç√≥wnej strony
        function openMedium(medium) {
            // Ukryj g≈Ç√≥wnƒÖ stronƒô
            document.getElementById('main-page').style.display = 'none';
            // Poka≈º sekcje medium
            document.getElementById('medium-sections').style.display = 'block';
            // Wywo≈Çaj showMedium
            showMedium(medium);
        }

        // Powr√≥t do g≈Ç√≥wnej strony
        function backToMain() {
            // Ukryj sekcje medium
            document.getElementById('medium-sections').style.display = 'none';
            // Poka≈º g≈Ç√≥wnƒÖ stronƒô
            document.getElementById('main-page').style.display = 'block';
            // Od≈õwie≈º statystyki
            loadMainStats();
        }

        // Prze≈ÇƒÖczanie miƒôdzy medium (Woda/Gaz/PrƒÖd)
        function showMedium(medium) {
            // Aktualizuj zak≈Çadki
            document.querySelectorAll('#medium-sections .tab').forEach(t => {
                if (t.textContent.includes('WODA') || t.textContent.includes('Woda') || 
                    t.textContent.includes('GAZ') || t.textContent.includes('Gaz') ||
                    t.textContent.includes('PRƒÑD') || t.textContent.includes('PrƒÖd')) {
                    t.classList.remove('active');
                }
            });
            if (medium === 'water') {
                document.getElementById('tab-water').classList.add('active');
            } else if (medium === 'gas') {
                document.getElementById('tab-gas').classList.add('active');
            } else if (medium === 'electricity') {
                document.getElementById('tab-electricity').classList.add('active');
            }
            
            // Poka≈º odpowiedniƒÖ sekcjƒô
            document.getElementById('medium-water').style.display = medium === 'water' ? 'block' : 'none';
            document.getElementById('medium-gas').style.display = medium === 'gas' ? 'block' : 'none';
            document.getElementById('medium-electricity').style.display = medium === 'electricity' ? 'block' : 'none';
            
            // Za≈Çaduj dane
            if (medium === 'water') {
                loadWaterStats();
                loadLocals();
            } else if (medium === 'gas') {
                loadGasStats();
                loadGasInvoices();
                loadGasBills();
            } else if (medium === 'electricity') {
                loadElectricityStats();
                loadElectricityReadings();
                loadElectricityInvoices();
                loadElectricityBills();
            }
        }

        // Prze≈ÇƒÖczanie zak≈Çadek dla gazu
        function showGasTab(tabName) {
            document.querySelectorAll('#medium-gas .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#medium-gas .tab-content').forEach(t => t.classList.remove('active'));
            // Znajd≈∫ odpowiedni przycisk i ustaw go jako aktywny
            const tabButtons = document.querySelectorAll('#medium-gas .tab');
            tabButtons.forEach(btn => {
                if ((tabName === 'gas-tab-invoices' && btn.textContent.includes('Faktury')) ||
                    (tabName === 'gas-tab-bills' && btn.textContent.includes('Rachunki'))) {
                    btn.classList.add('active');
                }
            });
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'gas-tab-invoices') loadGasInvoices();
            if (tabName === 'gas-tab-bills') loadGasBills();
        }

        // Prze≈ÇƒÖczanie zak≈Çadek dla prƒÖdu
        function showElectricityTab(tabName) {
            document.querySelectorAll('#medium-electricity .tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'electricity-tab-readings') loadElectricityReadings();
            if (tabName === 'electricity-tab-invoices') loadElectricityInvoices();
            if (tabName === 'electricity-tab-bills') loadElectricityBills();
        }

        // Funkcje pomocnicze dla formularza odczyt√≥w prƒÖdu
        function toggleDomMeterType() {
            const select = document.querySelector('[name="licznik_dom_jednotaryfowy"]');
            const isJednotaryfowy = select.value === 'true';
            document.getElementById('dom-jednotaryfowy-group').style.display = isJednotaryfowy ? 'flex' : 'none';
            document.getElementById('dom-dwutaryfowy-group').style.display = isJednotaryfowy ? 'none' : 'flex';
            document.getElementById('dom-dwutaryfowy-group-2').style.display = isJednotaryfowy ? 'none' : 'flex';
        }

        function toggleDolMeterType() {
            const select = document.querySelector('[name="licznik_dol_jednotaryfowy"]');
            const isJednotaryfowy = select.value === 'true';
            document.getElementById('dol-jednotaryfowy-group').style.display = isJednotaryfowy ? 'flex' : 'none';
            document.getElementById('dol-dwutaryfowy-group').style.display = isJednotaryfowy ? 'none' : 'flex';
            document.getElementById('dol-dwutaryfowy-group-2').style.display = isJednotaryfowy ? 'none' : 'flex';
        }

        // Prze≈ÇƒÖczanie trybu nocnego
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const isDark = body.classList.contains('dark-mode');
            
            if (isDark) {
                body.classList.remove('dark-mode');
                themeIcon.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-mode');
                themeIcon.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Za≈Çaduj zapisany tryb
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
            }
        });

        // Faktury gazu
        async function loadGasInvoices() {
            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/`);
                const invoices = await res.json();
                const listEl = document.getElementById('gas-invoices-list');
                
                if (invoices.length === 0) {
                    listEl.innerHTML = '<p>Brak faktur gazu</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Okres</th><th>Numer faktury</th><th>Suma brutto</th><th>Akcje</th></tr></thead><tbody>';
                invoices.forEach(i => {
                    html += `<tr class="clickable" onclick="toggleGasInvoiceDetails(${i.id})" data-gas-invoice-id="${i.id}">
                        <td>${i.data}</td>
                        <td>${i.invoice_number}</td>
                        <td>${i.total_gross_sum.toFixed(2)} z≈Ç</td>
                        <td class="actions" onclick="event.stopPropagation()">
                            <button class="btn btn-edit btn-small" onclick="editGasInvoice(${i.id})" title="Edytuj fakturƒô">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteGasInvoice(${i.id})" title="Usu≈Ñ fakturƒô i rachunki dla tego okresu (je≈õli to ostatnia faktura)">üóëÔ∏è</button>
                        </td>
                    </tr>
                    <tr class="details-row" id="gas-invoice-details-${i.id}" data-gas-invoice-id="${i.id}">
                        <td colspan="4" class="details-cell">
                            <div class="details-grid">
                                <div class="details-item"><label>Okres:</label><span class="value">${i.data}</span></div>
                                <div class="details-item"><label>Numer faktury:</label><span class="value">${i.invoice_number}</span></div>
                                <div class="details-item"><label>Suma brutto:</label><span class="value">${i.total_gross_sum.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label>Okres od:</label><span class="value">${i.period_start || '-'}</span></div>
                                <div class="details-item"><label>Okres do:</label><span class="value">${i.period_stop || '-'}</span></div>
                            </div>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                document.getElementById('gas-invoices-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania faktur</p>';
            }
        }

        async function uploadGasInvoice() {
            const fileInput = document.getElementById('gas-invoice-file');
            if (!fileInput.files[0]) {
                showAlert('Wybierz plik PDF', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/parse`, {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    const result = await res.json();
                    // Wype≈Çnij formularz weryfikacji danymi
                    const verifyForm = document.getElementById('form-gas-invoice-verify');
                    Object.keys(result).forEach(key => {
                        const input = verifyForm.querySelector(`[name="${key}"]`);
                        if (input) {
                            if (result[key] !== null && result[key] !== undefined && result[key] !== '') {
                                // Dla dat (type="date") upewnij siƒô ≈ºe format jest YYYY-MM-DD
                                if (input.type === 'date') {
                                    if (typeof result[key] === 'string') {
                                        // Je≈õli data jest ju≈º w formacie YYYY-MM-DD
                                        input.value = result[key].substring(0, 10);
                                    } else if (result[key] && result[key].isoformat) {
                                        input.value = result[key].isoformat().substring(0, 10);
                                    }
                                } else {
                                    // Dla innych p√≥l po prostu przypisz warto≈õƒá
                                    // Upewnij siƒô, ≈ºe pole jest widoczne (nie ukryte przez display: none)
                                    const formGroup = input.closest('.form-group');
                                    if (formGroup && formGroup.style.display === 'none') {
                                        formGroup.style.display = 'flex';
                                    }
                                    // Wype≈Çnij pole - upewnij siƒô ≈ºe warto≈õƒá jest liczbƒÖ lub stringiem
                                    const value = result[key];
                                    if (typeof value === 'number' || (typeof value === 'string' && value.trim() !== '')) {
                                        input.value = value;
                                    }
                                }
                            }
                        }
                    });
                    
                    // Poka≈º pola dla dystrybucji zmiennej 2 je≈õli istniejƒÖ
                    if (result.distribution_variable_2_usage_m3) {
                        document.getElementById('distribution-variable-2-group').style.display = 'flex';
                        document.getElementById('distribution-variable-2-conv-group').style.display = 'flex';
                        document.getElementById('distribution-variable-2-kwh-group').style.display = 'flex';
                        document.getElementById('distribution-variable-2-price-group').style.display = 'flex';
                        document.getElementById('distribution-variable-2-value-group').style.display = 'flex';
                    } else {
                        // Ukryj wszystkie pola dystrybucji zmiennej 2
                        document.getElementById('distribution-variable-2-group').style.display = 'none';
                        document.getElementById('distribution-variable-2-conv-group').style.display = 'none';
                        document.getElementById('distribution-variable-2-kwh-group').style.display = 'none';
                        document.getElementById('distribution-variable-2-price-group').style.display = 'none';
                        document.getElementById('distribution-variable-2-value-group').style.display = 'none';
                    }
                    // Poka≈º formularz weryfikacji
                    const verificationDiv = document.getElementById('gas-invoice-verification');
                    verificationDiv.style.display = 'block';
                    showAlert('Faktura sparsowana - zweryfikuj dane przed zapisem');
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd parsowania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function verifyAndSaveGasInvoice() {
            const form = document.getElementById('form-gas-invoice-verify');
            const formData = new FormData(form);
            const data = {};
            // Lista p√≥l numerycznych
            const numericFields = [
                'previous_reading', 'current_reading',
                'fuel_usage_m3', 'fuel_conversion_factor', 'fuel_usage_kwh', 'fuel_price_net', 
                'fuel_value_net', 'fuel_value_gross',
                'subscription_quantity', 'subscription_price_net', 'subscription_value_net', 
                'subscription_value_gross',
                'distribution_fixed_quantity', 'distribution_fixed_price_net', 
                'distribution_fixed_value_net', 'distribution_fixed_value_gross',
                'distribution_variable_usage_m3', 'distribution_variable_conversion_factor',
                'distribution_variable_usage_kwh', 'distribution_variable_price_net', 'distribution_variable_value_net',
                'distribution_variable_value_gross',
                'distribution_variable_2_usage_m3', 'distribution_variable_2_conversion_factor',
                'distribution_variable_2_usage_kwh', 'distribution_variable_2_price_net', 'distribution_variable_2_value_net',
                'total_net_sum', 'vat_rate', 'vat_amount', 'total_gross_sum',
                'late_payment_interest', 'amount_to_pay'
            ];
            
            for (const [key, value] of formData.entries()) {
                if (key.startsWith('distribution_variable_2_')) {
                    // Pola dystrybucji zmiennej 2 sƒÖ opcjonalne - je≈õli sƒÖ puste, ustaw null
                    if (value && value.trim() !== '') {
                        // Zamie≈Ñ przecinki na kropki dla liczb
                        const numValue = value.toString().replace(',', '.');
                        data[key] = parseFloat(numValue);
                    } else {
                        data[key] = null;
                    }
                } else if (numericFields.includes(key)) {
                    if (value) {
                        // Zamie≈Ñ przecinki na kropki dla liczb
                        const numValue = value.toString().replace(',', '.');
                        data[key] = parseFloat(numValue) || 0;
                    } else {
                        data[key] = 0;
                    }
                } else if (key === 'subscription_quantity' || key === 'distribution_fixed_quantity') {
                    data[key] = value ? parseInt(value) : 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Faktura gazu zapisana pomy≈õlnie!');
                    form.reset();
                    const verificationDiv = document.getElementById('gas-invoice-verification');
                    verificationDiv.style.display = 'none';
                    document.getElementById('gas-invoice-file').value = '';
                    document.getElementById('gas-invoice-file-name').textContent = '';
                    // Przywr√≥ƒá oryginalny przycisk
                    const verifyTitle = verificationDiv.querySelector('h3');
                    if (verifyTitle) verifyTitle.textContent = 'Weryfikuj dane faktury przed zapisem';
                    const verifyBtn = verificationDiv.querySelector('.btn-success');
                    if (verifyBtn) {
                        verifyBtn.textContent = 'Zatwierd≈∫ i zapisz';
                        verifyBtn.onclick = verifyAndSaveGasInvoice;
                    }
                    loadGasInvoices();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd zapisywania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function cancelGasInvoiceVerification() {
            const verificationDiv = document.getElementById('gas-invoice-verification');
            verificationDiv.style.display = 'none';
            document.getElementById('form-gas-invoice-verify').reset();
            document.getElementById('gas-invoice-file').value = '';
            document.getElementById('gas-invoice-file-name').textContent = '';
            // Przywr√≥ƒá oryginalny przycisk
            const verifyTitle = verificationDiv.querySelector('h3');
            if (verifyTitle) verifyTitle.textContent = 'Weryfikuj dane faktury przed zapisem';
            const verifyBtn = verificationDiv.querySelector('.btn-success');
            if (verifyBtn) {
                verifyBtn.textContent = 'Zatwierd≈∫ i zapisz';
                verifyBtn.onclick = verifyAndSaveGasInvoice;
            }
        }

        function toggleManualGasInvoiceForm() {
            const formDiv = document.getElementById('gas-invoice-manual-form');
            const btn = document.getElementById('btn-show-manual-gas-invoice');
            
            if (formDiv.style.display === 'none' || formDiv.style.display === '') {
                formDiv.style.display = 'block';
                btn.textContent = 'Ukryj formularz rƒôczny';
            } else {
                formDiv.style.display = 'none';
                btn.textContent = 'LUB DODAJ RƒòCZNIE';
            }
        }

        async function addGasInvoice() {
            const form = document.getElementById('form-gas-invoice');
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                // Konwertuj warto≈õci numeryczne
                if (['previous_reading', 'current_reading', 'fuel_value_gross', 
                     'subscription_value_gross', 'distribution_fixed_value_gross', 
                     'distribution_variable_value_gross', 'total_gross_sum'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else {
                    data[key] = value;
                }
            }
            
            // Ustaw domy≈õlny VAT je≈õli nie podano
            if (!data.vat_rate) data.vat_rate = 0.23;

            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    showAlert('Faktura gazu dodana pomy≈õlnie!');
                    form.reset();
                    // Ukryj formularz rƒôczny po dodaniu faktury
                    const formDiv = document.getElementById('gas-invoice-manual-form');
                    const btn = document.getElementById('btn-show-manual-gas-invoice');
                    formDiv.style.display = 'none';
                    btn.textContent = 'LUB DODAJ RƒòCZNIE';
                    loadGasInvoices();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    console.error('B≈ÇƒÖd API:', error);
                    // Wy≈õwietl szczeg√≥≈Çy b≈Çƒôdu je≈õli sƒÖ dostƒôpne
                    if (error.detail) {
                        if (Array.isArray(error.detail)) {
                            showAlert(error.detail.map(e => e.msg || e).join(', '), 'error');
                        } else {
                            showAlert(error.detail, 'error');
                        }
                    } else {
                        showAlert('B≈ÇƒÖd dodawania faktury', 'error');
                    }
                }
            } catch (error) {
                console.error('B≈ÇƒÖd po≈ÇƒÖczenia:', error);
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Rachunki gazu
        async function loadGasBills() {
            try {
                const res = await fetch(`${API_BASE}/api/gas/bills/`);
                const bills = await res.json();
                const listEl = document.getElementById('gas-bills-list');
                
                if (bills.length === 0) {
                    listEl.innerHTML = '<p>Brak rachunk√≥w gazu. Wygeneruj rachunki dla okresu z fakturƒÖ.</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Okres</th><th>Lokal</th><th>Udzia≈Ç</th><th>Lokal brutto</th><th>Akcje</th></tr></thead><tbody>';
                bills.forEach(b => {
                    html += `<tr class="clickable" onclick="toggleGasBillDetails(${b.id})" data-gas-bill-id="${b.id}">
                        <td>${b.data}</td>
                        <td>${b.local}</td>
                        <td>${(b.cost_share * 100).toFixed(0)}%</td>
                        <td>${(b.total_gross_sum || 0).toFixed(2)} z≈Ç</td>
                        <td class="actions" onclick="event.stopPropagation()">
                            <a href="${API_BASE}/api/gas/bills/download/${b.id}" target="_blank" class="btn btn-success btn-small">üì• PDF</a>
                            <button class="btn btn-edit btn-small" onclick="editGasBill(${b.id})" title="Edytuj rachunek">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteGasBill(${b.id})" title="Usu≈Ñ rachunek">üóëÔ∏è</button>
                        </td>
                    </tr>
                    <tr class="details-row" id="gas-bill-details-${b.id}" data-gas-bill-id="${b.id}">
                        <td colspan="5" class="details-cell">
                            <div class="details-grid">
                                <div class="details-item"><label>Okres:</label><span class="value">${b.data}</span></div>
                                <div class="details-item"><label>Lokal:</label><span class="value">${b.local}</span></div>
                                <div class="details-item"><label>Udzia≈Ç:</label><span class="value">${(b.cost_share * 100).toFixed(0)}%</span></div>
                                <div class="details-item"><label>Paliwo (brutto):</label><span class="value">${(b.fuel_cost_gross || 0).toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label>Abonament (brutto):</label><span class="value">${(b.subscription_cost_gross || 0).toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label>Dystrybucja sta≈Ça (brutto):</label><span class="value">${(b.distribution_fixed_cost_gross || 0).toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label>Dystrybucja zmienna (brutto):</label><span class="value">${(b.distribution_variable_cost_gross || 0).toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label>Suma netto:</label><span class="value">${(b.total_net_sum || 0).toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label>Lokal brutto:</label><span class="value">${(b.total_gross_sum || 0).toFixed(2)} z≈Ç</span></div>
                            </div>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                document.getElementById('gas-bills-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania rachunk√≥w</p>';
            }
        }

        async function deleteGasInvoice(invoiceId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô fakturƒô gazu? Je≈õli to ostatnia faktura dla tego okresu, zostanƒÖ r√≥wnie≈º usuniƒôte wszystkie rachunki dla tego okresu.')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/${invoiceId}`, { method: 'DELETE' });
                if (res.ok) {
                    const result = await res.json();
                    if (result.deleted_bills_count > 0) {
                        showAlert(`Faktura gazu usuniƒôta. Usuniƒôto r√≥wnie≈º ${result.deleted_bills_count} rachunk√≥w dla okresu ${result.period}.`);
                    } else {
                        showAlert('Faktura gazu usuniƒôta. Rachunki pozostajƒÖ (istniejƒÖ inne faktury dla tego okresu).');
                    }
                    loadGasInvoices();
                    loadGasBills();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function generateGasBills() {
            const period = document.getElementById('gas-bill-period').value.trim();
            if (!period || !period.match(/^\d{4}-\d{2}$/)) {
                showAlert('Podaj prawid≈Çowy okres (YYYY-MM)', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/bills/generate/${period}`, { method: 'POST' });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Wygenerowano ${result.bills_count} rachunk√≥w gazu dla okresu ${period}`);
                    loadGasBills();
                    loadGasStats();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd generowania rachunk√≥w', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // ========== FUNKCJE DLA PRƒÑDU ==========
        
        // Statystyki prƒÖdu
        async function loadElectricityStats() {
            try {
                const res = await fetch(`${API_BASE}/api/electricity/stats`);
                const stats = await res.json();
                document.getElementById('electricity-stat-readings').textContent = stats.readings_count || 0;
                document.getElementById('electricity-stat-invoices').textContent = stats.invoices_count || 0;
                document.getElementById('electricity-stat-bills').textContent = stats.bills_count || 0;
                document.getElementById('electricity-stat-total').textContent = (stats.total_gross_sum || 0).toFixed(2) + ' z≈Ç';
                document.getElementById('electricity-stat-latest-period').textContent = stats.latest_period || '-';
                
                // Statystyki na g≈Ç√≥wnej stronie
                document.getElementById('main-electricity-readings').textContent = stats.readings_count || 0;
                document.getElementById('main-electricity-invoices').textContent = stats.invoices_count || 0;
                document.getElementById('main-electricity-bills').textContent = stats.bills_count || 0;
                document.getElementById('main-electricity-period').textContent = stats.latest_period || '-';
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania statystyk prƒÖdu:', error);
            }
        }

        // Odczyty prƒÖdu
        async function loadElectricityReadings() {
            try {
                const res = await fetch(`${API_BASE}/api/electricity/readings`);
                const readings = await res.json();
                const listEl = document.getElementById('electricity-readings-list');
                
                if (readings.length === 0) {
                    listEl.innerHTML = '<p>Brak odczyt√≥w prƒÖdu</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Okres</th><th>DOM</th><th>D√ì≈Å</th><th>GABINET</th><th>Akcje</th></tr></thead><tbody>';
                readings.forEach(r => {
                    // Debug - sprawd≈∫ warto≈õci
                    console.log('Reading data:', r);
                    
                    // Formatowanie DOM
                    let domStr = '-';
                    if (r.is_main_meter_single_tariff === true || r.is_main_meter_single_tariff === 1) {
                        // Licznik jednotaryfowy
                        if (r.main_reading != null && r.main_reading !== undefined && !isNaN(r.main_reading)) {
                            domStr = parseFloat(r.main_reading).toFixed(2);
                        }
                    } else {
                        // Licznik dwutaryfowy
                        const t1 = (r.main_reading_t1 != null && r.main_reading_t1 !== undefined && !isNaN(r.main_reading_t1)) 
                            ? parseFloat(r.main_reading_t1).toFixed(2) : '-';
                        const t2 = (r.main_reading_t2 != null && r.main_reading_t2 !== undefined && !isNaN(r.main_reading_t2)) 
                            ? parseFloat(r.main_reading_t2).toFixed(2) : '-';
                        domStr = `${t1} / ${t2}`;
                    }
                    
                    // Formatowanie D√ì≈Å
                    let dolStr = '-';
                    if (r.is_dol_meter_single_tariff === true || r.is_dol_meter_single_tariff === 1) {
                        // Licznik jednotaryfowy
                        if (r.dol_reading != null && r.dol_reading !== undefined && !isNaN(r.dol_reading)) {
                            dolStr = parseFloat(r.dol_reading).toFixed(2);
                        }
                    } else {
                        // Licznik dwutaryfowy
                        const t1 = (r.dol_reading_t1 != null && r.dol_reading_t1 !== undefined && !isNaN(r.dol_reading_t1)) 
                            ? parseFloat(r.dol_reading_t1).toFixed(2) : '-';
                        const t2 = (r.dol_reading_t2 != null && r.dol_reading_t2 !== undefined && !isNaN(r.dol_reading_t2)) 
                            ? parseFloat(r.dol_reading_t2).toFixed(2) : '-';
                        dolStr = `${t1} / ${t2}`;
                    }
                    
                    // Formatowanie GABINET
                    let gabinetStr = '-';
                    if (r.gabinet_reading != null && r.gabinet_reading !== undefined && !isNaN(r.gabinet_reading)) {
                        gabinetStr = parseFloat(r.gabinet_reading).toFixed(2);
                    }
                    
                    html += `<tr data-reading-data="${r.data}">
                        <td>${r.data}</td>
                        <td>${domStr}</td>
                        <td>${dolStr}</td>
                        <td>${gabinetStr}</td>
                        <td class="actions" onclick="event.stopPropagation()">
                            <button class="btn btn-edit btn-small" onclick="editElectricityReading('${r.data}')" title="Edytuj odczyt">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteElectricityReading('${r.data}')" title="Usu≈Ñ odczyt">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                document.getElementById('electricity-readings-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania odczyt√≥w</p>';
            }
        }

        async function addElectricityReading() {
            const form = document.getElementById('form-electricity-reading');
            const formData = new FormData(form);
            const data = {};
            
            // Konwersja warto≈õci
            data['data'] = formData.get('data');
            data['is_main_meter_single_tariff'] = formData.get('licznik_dom_jednotaryfowy') === 'true';
            data['is_dol_meter_single_tariff'] = formData.get('licznik_dol_jednotaryfowy') === 'true';
            data['gabinet_reading'] = parseFloat(formData.get('odczyt_gabinet')) || 0;
            
            if (data['is_main_meter_single_tariff']) {
                data['main_reading'] = parseFloat(formData.get('odczyt_dom')) || null;
                data['main_reading_t1'] = null;
                data['main_reading_t2'] = null;
            } else {
                data['main_reading'] = null;
                data['main_reading_t1'] = parseFloat(formData.get('odczyt_dom_I')) || null;
                data['main_reading_t2'] = parseFloat(formData.get('odczyt_dom_II')) || null;
            }
            
            if (data['is_dol_meter_single_tariff']) {
                data['dol_reading'] = parseFloat(formData.get('odczyt_dol')) || null;
                data['dol_reading_t1'] = null;
                data['dol_reading_t2'] = null;
            } else {
                data['dol_reading'] = null;
                data['dol_reading_t1'] = parseFloat(formData.get('odczyt_dol_I')) || null;
                data['dol_reading_t2'] = parseFloat(formData.get('odczyt_dol_II')) || null;
            }
            
            // local_id - domy≈õlnie 1 (g≈Ç√≥wny lokal)
            data['local_id'] = 1;

            try {
                const res = await fetch(`${API_BASE}/api/electricity/readings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Odczyt prƒÖdu dodany pomy≈õlnie!');
                    form.reset();
                    loadElectricityReadings();
                    loadElectricityStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd dodawania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Edycja odczytu prƒÖdu
        async function editElectricityReading(data) {
            try {
                const res = await fetch(`${API_BASE}/api/electricity/readings/${data}`);
                if (res.ok) {
                    const reading = await res.json();
                    // Utw√≥rz formularz edycji
                    const formHtml = `
                        <div style="background: #f0f9ff; border: 2px solid #d47474; padding: 20px; margin: 20px 0; border-radius: 8px;">
                            <h3>Edytuj odczyt prƒÖdu</h3>
                            <form id="form-electricity-reading-edit-${data}" class="form-grid">
                                <div class="form-group">
                                    <label>Okres (YYYY-MM)</label>
                                    <input type="text" name="data" value="${reading.data}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Licznik DOM - Jednotaryfowy?</label>
                                    <select name="licznik_dom_jednotaryfowy" id="edit-dom-meter-type-${data}" onchange="toggleEditDomMeterType('${data}')">
                                        <option value="true" ${reading.is_main_meter_single_tariff ? 'selected' : ''}>Tak (jednotaryfowy)</option>
                                        <option value="false" ${!reading.is_main_meter_single_tariff ? 'selected' : ''}>Nie (dwutaryfowy)</option>
                                    </select>
                                </div>
                                <div class="form-group" id="edit-dom-jednotaryfowy-group-${data}" style="display: ${reading.is_main_meter_single_tariff ? 'flex' : 'none'};">
                                    <label>Odczyt DOM (jednotaryfowy)</label>
                                    <input type="number" step="0.01" name="odczyt_dom" value="${reading.main_reading || ''}">
                                </div>
                                <div class="form-group" id="edit-dom-dwutaryfowy-group-${data}" style="display: ${!reading.is_main_meter_single_tariff ? 'flex' : 'none'};">
                                    <label>Odczyt DOM - Taryfa I</label>
                                    <input type="number" step="0.01" name="odczyt_dom_I" value="${reading.main_reading_t1 || ''}">
                                </div>
                                <div class="form-group" id="edit-dom-dwutaryfowy-group-2-${data}" style="display: ${!reading.is_main_meter_single_tariff ? 'flex' : 'none'};">
                                    <label>Odczyt DOM - Taryfa II</label>
                                    <input type="number" step="0.01" name="odczyt_dom_II" value="${reading.main_reading_t2 || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Licznik D√ì≈Å - Jednotaryfowy?</label>
                                    <select name="licznik_dol_jednotaryfowy" id="edit-dol-meter-type-${data}" onchange="toggleEditDolMeterType('${data}')">
                                        <option value="true" ${reading.is_dol_meter_single_tariff ? 'selected' : ''}>Tak (jednotaryfowy)</option>
                                        <option value="false" ${!reading.is_dol_meter_single_tariff ? 'selected' : ''}>Nie (dwutaryfowy)</option>
                                    </select>
                                </div>
                                <div class="form-group" id="edit-dol-jednotaryfowy-group-${data}" style="display: ${reading.is_dol_meter_single_tariff ? 'flex' : 'none'};">
                                    <label>Odczyt D√ì≈Å (jednotaryfowy)</label>
                                    <input type="number" step="0.01" name="odczyt_dol" value="${reading.dol_reading || ''}">
                                </div>
                                <div class="form-group" id="edit-dol-dwutaryfowy-group-${data}" style="display: ${!reading.is_dol_meter_single_tariff ? 'flex' : 'none'};">
                                    <label>Odczyt D√ì≈Å - Taryfa I</label>
                                    <input type="number" step="0.01" name="odczyt_dol_I" value="${reading.dol_reading_t1 || ''}">
                                </div>
                                <div class="form-group" id="edit-dol-dwutaryfowy-group-2-${data}" style="display: ${!reading.is_dol_meter_single_tariff ? 'flex' : 'none'};">
                                    <label>Odczyt D√ì≈Å - Taryfa II</label>
                                    <input type="number" step="0.01" name="odczyt_dol_II" value="${reading.dol_reading_t2 || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Odczyt GABINET</label>
                                    <input type="number" step="0.01" name="odczyt_gabinet" value="${reading.gabinet_reading || 0}" required>
                                </div>
                            </form>
                            <button class="btn btn-success" onclick="updateElectricityReading('${data}')">Zapisz zmiany</button>
                            <button class="btn btn-secondary" onclick="cancelElectricityReadingEdit('${data}')">Anuluj</button>
                        </div>
                    `;
                    // Znajd≈∫ wiersz z odczytem i dodaj formularz
                    const readingRow = document.querySelector(`tr[data-reading-data="${data}"]`);
                    if (readingRow) {
                        const existingForm = document.getElementById(`form-electricity-reading-edit-${data}`);
                        if (existingForm) {
                            existingForm.parentElement.remove();
                        } else {
                            readingRow.insertAdjacentHTML('afterend', `<tr><td colspan="5">${formHtml}</td></tr>`);
                        }
                    } else {
                        // Je≈õli nie ma wiersza, dodaj na ko≈Ñcu listy
                        const listEl = document.getElementById('electricity-readings-list');
                        listEl.insertAdjacentHTML('beforeend', `<tr><td colspan="5">${formHtml}</td></tr>`);
                    }
                } else {
                    showAlert('B≈ÇƒÖd pobierania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function toggleEditDomMeterType(data) {
            const select = document.getElementById(`edit-dom-meter-type-${data}`);
            const isJednotaryfowy = select.value === 'true';
            document.getElementById(`edit-dom-jednotaryfowy-group-${data}`).style.display = isJednotaryfowy ? 'flex' : 'none';
            document.getElementById(`edit-dom-dwutaryfowy-group-${data}`).style.display = isJednotaryfowy ? 'none' : 'flex';
            document.getElementById(`edit-dom-dwutaryfowy-group-2-${data}`).style.display = isJednotaryfowy ? 'none' : 'flex';
        }

        function toggleEditDolMeterType(data) {
            const select = document.getElementById(`edit-dol-meter-type-${data}`);
            const isJednotaryfowy = select.value === 'true';
            document.getElementById(`edit-dol-jednotaryfowy-group-${data}`).style.display = isJednotaryfowy ? 'flex' : 'none';
            document.getElementById(`edit-dol-dwutaryfowy-group-${data}`).style.display = isJednotaryfowy ? 'none' : 'flex';
            document.getElementById(`edit-dol-dwutaryfowy-group-2-${data}`).style.display = isJednotaryfowy ? 'none' : 'flex';
        }

        async function updateElectricityReading(data) {
            const form = document.getElementById(`form-electricity-reading-edit-${data}`);
            const formData = new FormData(form);
            const readingData = {};
            
            // Konwersja warto≈õci
            readingData['data'] = formData.get('data');
            readingData['is_main_meter_single_tariff'] = formData.get('licznik_dom_jednotaryfowy') === 'true';
            readingData['is_dol_meter_single_tariff'] = formData.get('licznik_dol_jednotaryfowy') === 'true';
            readingData['gabinet_reading'] = parseFloat(formData.get('odczyt_gabinet')) || 0;
            
            if (readingData['is_main_meter_single_tariff']) {
                readingData['main_reading'] = parseFloat(formData.get('odczyt_dom')) || null;
                readingData['main_reading_t1'] = null;
                readingData['main_reading_t2'] = null;
            } else {
                readingData['main_reading'] = null;
                readingData['main_reading_t1'] = parseFloat(formData.get('odczyt_dom_I')) || null;
                readingData['main_reading_t2'] = parseFloat(formData.get('odczyt_dom_II')) || null;
            }
            
            if (readingData['is_dol_meter_single_tariff']) {
                readingData['dol_reading'] = parseFloat(formData.get('odczyt_dol')) || null;
                readingData['dol_reading_t1'] = null;
                readingData['dol_reading_t2'] = null;
            } else {
                readingData['dol_reading'] = null;
                readingData['dol_reading_t1'] = parseFloat(formData.get('odczyt_dol_I')) || null;
                readingData['dol_reading_t2'] = parseFloat(formData.get('odczyt_dol_II')) || null;
            }

            try {
                const res = await fetch(`${API_BASE}/api/electricity/readings/${data}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(readingData)
                });
                if (res.ok) {
                    showAlert('Odczyt prƒÖdu zaktualizowany pomy≈õlnie!');
                    cancelElectricityReadingEdit(data);
                    loadElectricityReadings();
                    loadElectricityStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function cancelElectricityReadingEdit(data) {
            const formDiv = document.getElementById(`form-electricity-reading-edit-${data}`);
            if (formDiv) {
                formDiv.closest('tr').remove();
            }
        }

        async function deleteElectricityReading(data) {
            if (!confirm(`Czy na pewno chcesz usunƒÖƒá odczyt dla okresu ${data}? ZostanƒÖ r√≥wnie≈º usuniƒôte wszystkie rachunki dla tego okresu.`)) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/electricity/readings/${data}`, { method: 'DELETE' });
                if (res.ok) {
                    const result = await res.json();
                    showAlert(`Odczyt dla okresu ${data} usuniƒôty. Usuniƒôto r√≥wnie≈º ${result.deleted_bills_count} rachunk√≥w.`);
                    loadElectricityReadings();
                    loadElectricityBills();
                    loadElectricityStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Faktury prƒÖdu
        async function loadElectricityInvoices() {
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/`);
                const invoices = await res.json();
                const listEl = document.getElementById('electricity-invoices-list');
                
                if (invoices.length === 0) {
                    listEl.innerHTML = '<p>Brak faktur prƒÖdu</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Rok</th><th>Numer faktury</th><th>Okres</th><th>Zu≈ºycie (kWh)</th><th>Typ taryfy</th><th>Do zap≈Çaty</th><th>Akcje</th></tr></thead><tbody>';
                invoices.forEach(i => {
                    const okres = i.data_poczatku_okresu ? 
                        `${i.data_poczatku_okresu.substring(0, 7)}` : 
                        `${i.rok}`;
                    html += `<tr class="clickable" onclick="showElectricityInvoiceDetails(${i.id})" data-invoice-id="${i.id}">
                        <td>${i.rok}</td>
                        <td>${i.numer_faktury}</td>
                        <td>${okres}</td>
                        <td>${(i.zuzycie_kwh || 0)}</td>
                        <td>${i.typ_taryfy || '-'}</td>
                        <td>${(i.do_zaplaty || 0).toFixed(2)} z≈Ç</td>
                        <td class="actions" onclick="event.stopPropagation()">
                            <button class="btn btn-edit btn-small" onclick="editElectricityInvoice(${i.id})" title="Edytuj fakturƒô">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteElectricityInvoice(${i.id})" title="Usu≈Ñ fakturƒô">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania faktur:', error);
                document.getElementById('electricity-invoices-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania faktur</p>';
            }
        }
        
        async function showElectricityInvoiceDetails(invoiceId) {
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/${invoiceId}`);
                if (res.ok) {
                    const data = await res.json();
                    const invoice = data.invoice;
                    
                    // Poka≈º szczeg√≥≈Çy w modalnym oknie lub rozwi≈Ñ wiersz
                    alert(`Faktura: ${invoice.numer_faktury}\nRok: ${invoice.rok}\nOkres: ${invoice.data_poczatku_okresu} - ${invoice.data_konca_okresu}\nZu≈ºycie: ${invoice.zuzycie_kwh} kWh\nDo zap≈Çaty: ${invoice.do_zaplaty} z≈Ç`);
                }
            } catch (error) {
                console.error('B≈ÇƒÖd pobierania szczeg√≥≈Ç√≥w faktury:', error);
            }
        }

        async function uploadElectricityInvoice() {
            const fileInput = document.getElementById('electricity-invoice-file');
            if (!fileInput.files[0]) {
                showAlert('Wybierz plik PDF', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/parse`, {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    const result = await res.json();
                    console.log('Sparsowane dane faktury:', result);
                    
                    // Wype≈Çnij formularz weryfikacji
                    const verifyForm = document.getElementById('form-electricity-invoice-verify');
                    if (!verifyForm) {
                        showAlert('Nie znaleziono formularza weryfikacji', 'error');
                        return;
                    }
                    
                    // Mapowanie starych p√≥l na nowe (je≈õli parser zwraca stare nazwy)
                    const fieldMapping = {
                        'data': 'rok',  // Okres -> Rok (wyciƒÖgnij rok z okresu)
                        'invoice_number': 'numer_faktury',
                        'period_start': 'data_poczatku_okresu',
                        'period_stop': 'data_konca_okresu',
                        'usage_kwh': 'zuzycie_kwh',
                        'total_gross_sum': 'do_zaplaty',
                        'amount_to_pay': 'do_zaplaty'
                    };
                    
                    // WyciƒÖgnij rok z okresu je≈õli jest
                    if (result.data && !result.rok) {
                        const yearMatch = result.data.match(/^(\d{4})/);
                        if (yearMatch) {
                            result.rok = parseInt(yearMatch[1]);
                        }
                    }
                    
                    // Je≈õli nie ma rok, wyciƒÖgnij z daty poczƒÖtku okresu
                    if (!result.rok && result.period_start) {
                        const yearMatch = result.period_start.toString().match(/^(\d{4})/);
                        if (yearMatch) {
                            result.rok = parseInt(yearMatch[1]);
                        }
                    }
                    
                    // Je≈õli nie ma data_wystawienia, u≈ºyj data_poczatku_okresu lub period_start
                    if (!result.data_wystawienia) {
                        if (result.data_poczatku_okresu) {
                            result.data_wystawienia = result.data_poczatku_okresu;
                        } else if (result.period_start) {
                            result.data_wystawienia = result.period_start;
                        }
                    }
                    
                    // Mapuj period_start/period_stop na data_poczatku_okresu/data_konca_okresu je≈õli brakuje
                    if (!result.data_poczatku_okresu && result.period_start) {
                        result.data_poczatku_okresu = result.period_start;
                    }
                    if (!result.data_konca_okresu && result.period_stop) {
                        result.data_konca_okresu = result.period_stop;
                    }
                    
                    // Mapuj invoice_number na numer_faktury je≈õli brakuje
                    if (!result.numer_faktury && result.invoice_number) {
                        result.numer_faktury = result.invoice_number;
                    }
                    
                    // Mapuj usage_kwh na zuzycie_kwh je≈õli brakuje
                    if (!result.zuzycie_kwh && result.usage_kwh !== undefined) {
                        result.zuzycie_kwh = result.usage_kwh;
                    }
                    
                    // Mapuj amount_to_pay na do_zaplaty je≈õli brakuje
                    if (!result.do_zaplaty && result.amount_to_pay !== undefined) {
                        result.do_zaplaty = result.amount_to_pay;
                    }
                    if (!result.do_zaplaty && result.total_gross_sum !== undefined) {
                        result.do_zaplaty = result.total_gross_sum;
                    }
                    
                    // Funkcja pomocnicza do konwersji daty
                    function convertDateToISO(dateValue) {
                        if (!dateValue) return null;
                        
                        // Je≈õli to ju≈º obiekt Date
                        if (dateValue instanceof Date) {
                            return dateValue.toISOString().substring(0, 10);
                        }
                        
                        // Je≈õli to string
                        if (typeof dateValue === 'string') {
                            // Format YYYY-MM-DD
                            if (dateValue.match(/^\d{4}-\d{2}-\d{2}/)) {
                                return dateValue.substring(0, 10);
                            }
                            // Format DD/MM/YYYY
                            if (dateValue.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
                                const parts = dateValue.split('/');
                                const day = parts[0].padStart(2, '0');
                                const month = parts[1].padStart(2, '0');
                                const year = parts[2];
                                return `${year}-${month}-${day}`;
                            }
                            // Spr√≥buj sparsowaƒá jako Date
                            try {
                                const date = new Date(dateValue);
                                if (!isNaN(date.getTime())) {
                                    return date.toISOString().substring(0, 10);
                                }
                            } catch (e) {
                                console.warn(`Nie mo≈ºna sparsowaƒá daty:`, dateValue);
                            }
                        }
                        return null;
                    }
                    
                    // Wype≈Çnij wszystkie pola formularza
                    // Najpierw wype≈Çnij pola z result
                    Object.keys(result).forEach(key => {
                        // Pomi≈Ñ pola pomocnicze i szczeg√≥≈Çowe (bƒôdƒÖ obs≈Çu≈ºone osobno)
                        if (key.startsWith('_')) return;
                        if (['blankiety', 'odczyty', 'sprzedaz_energii', 'oplaty_dystrybucyjne', 'rozliczenie_okresy'].includes(key)) return;
                        
                        const fieldName = fieldMapping[key] || key;
                        const input = verifyForm.querySelector(`[name="${fieldName}"]`);
                        
                        if (input) {
                            const value = result[key];
                            
                            // Sprawd≈∫ czy warto≈õƒá istnieje (nawet je≈õli to 0 lub pusty string)
                            if (value !== null && value !== undefined) {
                                if (input.type === 'date') {
                                    const isoDate = convertDateToISO(value);
                                    if (isoDate) {
                                        input.value = isoDate;
                                    }
                                } else if (input.type === 'number') {
                                    const numValue = parseFloat(value);
                                    if (!isNaN(numValue)) {
                                        input.value = numValue;
                                    } else if (value === '' || value === 0) {
                                        // Dla p√≥l numerycznych, 0 jest wa≈ºnƒÖ warto≈õciƒÖ
                                        input.value = 0;
                                    }
                                } else if (input.tagName === 'SELECT') {
                                    // Dla select√≥w sprawd≈∫ czy warto≈õƒá pasuje
                                    const strValue = String(value);
                                    if (Array.from(input.options).some(opt => opt.value === strValue)) {
                                        input.value = strValue;
                                    }
                                } else {
                                    // Dla p√≥l tekstowych
                                    input.value = String(value);
                                }
                            }
                        }
                    });
                    
                    // Upewnij siƒô, ≈ºe wszystkie wymagane pola majƒÖ warto≈õci (nawet je≈õli 0)
                    const requiredFields = {
                        'rok': result.rok || new Date().getFullYear(),
                        'numer_faktury': result.numer_faktury || result.invoice_number || '',
                        'data_wystawienia': result.data_wystawienia || result.data_poczatku_okresu || result.period_start || '',
                        'data_poczatku_okresu': result.data_poczatku_okresu || result.period_start || '',
                        'data_konca_okresu': result.data_konca_okresu || result.period_stop || '',
                        'naleznosc_za_okres': result.naleznosc_za_okres || 0,
                        'wartosc_prognozy': result.wartosc_prognozy || 0,
                        'faktury_korygujace': result.faktury_korygujace || 0,
                        'odsetki': result.odsetki || 0,
                        'wynik_rozliczenia': result.wynik_rozliczenia || 0,
                        'kwota_nadplacona': result.kwota_nadplacona || 0,
                        'saldo_z_rozliczenia': result.saldo_z_rozliczenia || result.do_zaplaty || 0,
                        'niedoplata_nadplata': result.niedoplata_nadplata || 0,
                        'energia_do_akcyzy_kwh': result.energia_do_akcyzy_kwh || 0,
                        'akcyza': result.akcyza || 0,
                        'do_zaplaty': result.do_zaplaty || result.amount_to_pay || result.total_gross_sum || 0,
                        'zuzycie_kwh': result.zuzycie_kwh || result.usage_kwh || 0,
                        'ogolem_sprzedaz_energii': result.ogolem_sprzedaz_energii || 0,
                        'ogolem_usluga_dystrybucji': result.ogolem_usluga_dystrybucji || 0,
                        'grupa_taryfowa': result.grupa_taryfowa || 'G12',
                        'typ_taryfy': result.typ_taryfy || 'DWUTARYFOWA',
                        'energia_lacznie_zuzyta_w_roku_kwh': result.energia_lacznie_zuzyta_w_roku_kwh || 0
                    };
                    
                    // Wype≈Çnij wszystkie wymagane pola
                    Object.keys(requiredFields).forEach(fieldName => {
                        const input = verifyForm.querySelector(`[name="${fieldName}"]`);
                        if (input) {
                            const value = requiredFields[fieldName];
                            if (input.type === 'date') {
                                const isoDate = convertDateToISO(value);
                                if (isoDate) {
                                    input.value = isoDate;
                                }
                            } else if (input.type === 'number') {
                                input.value = parseFloat(value) || 0;
                            } else if (input.tagName === 'SELECT') {
                                const strValue = String(value);
                                if (Array.from(input.options).some(opt => opt.value === strValue)) {
                                    input.value = strValue;
                                }
                            } else {
                                input.value = String(value);
                            }
                        }
                    });
                    
                    // Wy≈õwietl sekcje szczeg√≥≈Çowe
                    displayElectricityInvoiceDetails(result);
                    
                    document.getElementById('electricity-invoice-verification').style.display = 'block';
                    showAlert('Faktura sparsowana - zweryfikuj dane przed zapisem');
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd parsowania faktury', 'error');
                }
            } catch (error) {
                console.error('B≈ÇƒÖd parsowania faktury:', error);
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }

        // Funkcja pomocnicza do parsowania warto≈õci numerycznych (globalna)
        function parseNumericValue(value, isInt = false) {
            if (!value || value === '' || value === null || value === undefined) {
                return isInt ? 0 : 0.0;
            }
            // Usu≈Ñ spacje i zamie≈Ñ przecinki na kropki
            const cleaned = String(value).replace(/\s/g, '').replace(',', '.');
            const parsed = isInt ? parseInt(cleaned) : parseFloat(cleaned);
            return isNaN(parsed) ? (isInt ? 0 : 0.0) : parsed;
        }
        
        // Funkcja pomocnicza do zbierania danych z edytowalnych formularzy szczeg√≥≈Çowych
        function collectDetailedData() {
            const detailedData = {
                blankiety: [],
                odczyty: [],
                sprzedaz_energii: [],
                oplaty_dystrybucyjne: [],
                rozliczenie_okresy: []
            };
            
            // Zbierz blankiety
            const blankietyInputs = document.querySelectorAll('[name^="blankiety["]');
            const blankietyMap = {};
            blankietyInputs.forEach(input => {
                const match = input.name.match(/blankiety\[(\d+)\]\[(.+)\]/);
                if (match) {
                    const idx = parseInt(match[1]);
                    const field = match[2];
                    if (!blankietyMap[idx]) blankietyMap[idx] = {};
                    blankietyMap[idx][field] = input.value;
                }
            });
            
            Object.keys(blankietyMap).forEach(idx => {
                const b = blankietyMap[idx];
                if (b.nr_blankietu || b.okres_od || b.okres_do) { // Tylko je≈õli sƒÖ jakie≈õ dane
                    detailedData.blankiety.push({
                        id: b.id || null,
                        nr_blankietu: b.nr_blankietu || '',
                        okres_od: b.okres_od || null,
                        okres_do: b.okres_do || null,
                        ilosc_d: b.ilosc_d ? parseNumericValue(b.ilosc_d, true) : null,
                        ilosc_c: b.ilosc_c ? parseNumericValue(b.ilosc_c, true) : null,
                        ilosc_calodobowa: b.ilosc_calodobowa ? parseNumericValue(b.ilosc_calodobowa, true) : null,
                        kwota_brutto: parseNumericValue(b.kwota_brutto, false),
                        akcyza: parseNumericValue(b.akcyza, false),
                        energia_do_akcyzy: parseNumericValue(b.energia_do_akcyzy, true),
                        nadplata_niedoplata: parseNumericValue(b.nadplata_niedoplata, false),
                        odsetki: parseNumericValue(b.odsetki, false),
                        termin_platnosci: b.termin_platnosci || null,
                        do_zaplaty: parseNumericValue(b.do_zaplaty, false)
                    });
                }
            });
            
            // Zbierz odczyty
            const odczytyInputs = document.querySelectorAll('[name^="odczyty["]');
            const odczytyMap = {};
            odczytyInputs.forEach(input => {
                const match = input.name.match(/odczyty\[(\d+)\]\[(.+)\]/);
                if (match) {
                    const idx = parseInt(match[1]);
                    const field = match[2];
                    if (!odczytyMap[idx]) odczytyMap[idx] = {};
                    odczytyMap[idx][field] = input.value;
                }
            });
            Object.keys(odczytyMap).forEach(idx => {
                const o = odczytyMap[idx];
                if (o.data || o.biezace || o.poprzednie) { // Tylko je≈õli sƒÖ jakie≈õ dane
                    detailedData.odczyty.push({
                        id: o.id || null,
                        typ: o.typ || 'pobrana',
                        strefa: o.strefa || null,
                        data: o.data || null,
                        biezace: parseNumericValue(o.biezace, true),
                        poprzednie: parseNumericValue(o.poprzednie, true),
                        mnozna: parseNumericValue(o.mnozna, true) || 1,
                        ilosc: parseNumericValue(o.ilosc, true),
                        straty: parseNumericValue(o.straty, true),
                        razem: parseNumericValue(o.razem, true)
                    });
                }
            });
            
            // Zbierz sprzeda≈º energii
            const sprzedazInputs = document.querySelectorAll('[name^="sprzedaz_energii["]');
            const sprzedazMap = {};
            sprzedazInputs.forEach(input => {
                const match = input.name.match(/sprzedaz_energii\[(\d+)\]\[(.+)\]/);
                if (match) {
                    const idx = parseInt(match[1]);
                    const field = match[2];
                    if (!sprzedazMap[idx]) sprzedazMap[idx] = {};
                    sprzedazMap[idx][field] = input.value;
                }
            });
            Object.keys(sprzedazMap).forEach(idx => {
                const s = sprzedazMap[idx];
                // Sprawd≈∫ czy sƒÖ jakie≈õ dane (nawet je≈õli warto≈õci to 0)
                if (s.ilosc_kwh !== undefined && s.ilosc_kwh !== '' || 
                    s.cena !== undefined && s.cena !== '' || 
                    s.naleznosc !== undefined && s.naleznosc !== '') {
                    detailedData.sprzedaz_energii.push({
                        id: s.id || null,
                        strefa: s.strefa || null,
                        ilosc_kwh: parseNumericValue(s.ilosc_kwh, true),
                        cena: parseNumericValue(s.cena, false),
                        naleznosc: parseNumericValue(s.naleznosc, false),
                        vat: parseNumericValue(s.vat, false) || 23.0
                    });
                }
            });
            
            // Zbierz op≈Çaty dystrybucyjne
            const oplatyInputs = document.querySelectorAll('[name^="oplaty_dystrybucyjne["]');
            const oplatyMap = {};
            oplatyInputs.forEach(input => {
                const match = input.name.match(/oplaty_dystrybucyjne\[(\d+)\]\[(.+)\]/);
                if (match) {
                    const idx = parseInt(match[1]);
                    const field = match[2];
                    if (!oplatyMap[idx]) oplatyMap[idx] = {};
                    oplatyMap[idx][field] = input.value;
                }
            });
            Object.keys(oplatyMap).forEach(idx => {
                const op = oplatyMap[idx];
                // Sprawd≈∫ czy sƒÖ jakie≈õ dane (nawet je≈õli warto≈õci to 0)
                if (op.nazwa !== undefined && op.nazwa !== '' || 
                    op.cena !== undefined && op.cena !== '' || 
                    op.naleznosc !== undefined && op.naleznosc !== '') {
                    detailedData.oplaty_dystrybucyjne.push({
                        id: op.id || null,
                        nazwa: op.nazwa || '',
                        strefa: op.strefa || null,
                        jednostka: op.jednostka || 'kWh',
                        data: op.data || null,
                        ilosc_kwh: op.ilosc_kwh ? parseNumericValue(op.ilosc_kwh, true) : null,
                        ilosc_miesiecy: op.ilosc_miesiecy ? parseNumericValue(op.ilosc_miesiecy, false) : null,
                        wspolczynnik: op.wspolczynnik ? parseNumericValue(op.wspolczynnik, false) : null,
                        cena: parseNumericValue(op.cena, false),
                        naleznosc: parseNumericValue(op.naleznosc, false),
                        vat: parseNumericValue(op.vat, false) || 23.0
                    });
                }
            });
            
            // Zbierz rozliczenie okres√≥w
            const rozliczenieInputs = document.querySelectorAll('[name^="rozliczenie_okresy["]');
            const rozliczenieMap = {};
            rozliczenieInputs.forEach(input => {
                const match = input.name.match(/rozliczenie_okresy\[(\d+)\]\[(.+)\]/);
                if (match) {
                    const idx = parseInt(match[1]);
                    const field = match[2];
                    if (!rozliczenieMap[idx]) rozliczenieMap[idx] = {};
                    rozliczenieMap[idx][field] = input.value;
                }
            });
            Object.keys(rozliczenieMap).forEach(idx => {
                const r = rozliczenieMap[idx];
                if (r.data_okresu || r.numer_okresu) { // Tylko je≈õli sƒÖ jakie≈õ dane
                    detailedData.rozliczenie_okresy.push({
                        id: r.id || null,
                        numer_okresu: r.numer_okresu ? parseInt(r.numer_okresu) : parseInt(idx) + 1,
                        data_okresu: r.data_okresu || null
                    });
                }
            });
            
            return detailedData;
        }
        
        async function verifyAndSaveElectricityInvoice() {
            const form = document.getElementById('form-electricity-invoice-verify');
            const formData = new FormData(form);
            const data = {};
            
            // Funkcja pomocnicza do parsowania warto≈õci numerycznych
            function parseNumericValue(value, isInt = false) {
                if (!value || value === '' || value === null || value === undefined) {
                    return isInt ? 0 : 0.0;
                }
                // Usu≈Ñ spacje i zamie≈Ñ przecinki na kropki
                const cleaned = String(value).replace(/\s/g, '').replace(',', '.');
                const parsed = isInt ? parseInt(cleaned) : parseFloat(cleaned);
                return isNaN(parsed) ? (isInt ? 0 : 0.0) : parsed;
            }
            
            // Lista p√≥l numerycznych
            const numericFields = ['rok', 'naleznosc_za_okres', 'wartosc_prognozy', 'faktury_korygujace', 
                'odsetki', 'wynik_rozliczenia', 'kwota_nadplacona', 'saldo_z_rozliczenia', 
                'niedoplata_nadplata', 'energia_do_akcyzy_kwh', 'akcyza', 'do_zaplaty', 
                'zuzycie_kwh', 'ogolem_sprzedaz_energii', 'ogolem_usluga_dystrybucji', 
                'energia_lacznie_zuzyta_w_roku_kwh'];
            
            for (const [key, value] of formData.entries()) {
                // Pomi≈Ñ pola szczeg√≥≈Çowe (bƒôdƒÖ zbierane osobno)
                if (key.startsWith('blankiety[') || key.startsWith('odczyty[') || 
                    key.startsWith('sprzedaz_energii[') || key.startsWith('oplaty_dystrybucyjne[') ||
                    key.startsWith('rozliczenie_okresy[')) {
                    continue;
                }
                
                if (numericFields.includes(key)) {
                    if (key.includes('kwh') || key === 'rok') {
                        data[key] = parseNumericValue(value, true);
                    } else {
                        data[key] = parseNumericValue(value, false);
                    }
                } else {
                    data[key] = value || '';
                }
            }
            
            // Upewnij siƒô, ≈ºe wszystkie wymagane pola majƒÖ warto≈õci
            if (!data.rok) data.rok = new Date().getFullYear();
            if (!data.numer_faktury) data.numer_faktury = '';
            if (!data.grupa_taryfowa) data.grupa_taryfowa = '';
            if (!data.typ_taryfy) data.typ_taryfy = 'DWUTARYFOWA';
            
            // Zbierz szczeg√≥≈Çowe dane z edytowalnych formularzy
            const detailedData = collectDetailedData();
            data.blankiety = detailedData.blankiety;
            data.odczyty = detailedData.odczyty;
            data.sprzedaz_energii = detailedData.sprzedaz_energii;
            data.oplaty_dystrybucyjne = detailedData.oplaty_dystrybucyjne;
            data.rozliczenie_okresy = detailedData.rozliczenie_okresy;

            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                // Sprawd≈∫ typ odpowiedzi
                const contentType = res.headers.get('content-type');
                let errorData = null;
                
                if (res.ok) {
                    showAlert('Faktura prƒÖdu zapisana pomy≈õlnie ze wszystkimi szczeg√≥≈Çami!');
                    form.reset();
                    document.getElementById('electricity-invoice-verification').style.display = 'none';
                    document.getElementById('electricity-invoice-file').value = '';
                    document.getElementById('electricity-invoice-file-name').textContent = '';
                    
                    // Wyczy≈õƒá zmiennƒÖ globalnƒÖ
                    currentInvoiceDetails = null;
                    
                    // Wyczy≈õƒá sekcje szczeg√≥≈Çowe
                    cancelElectricityInvoiceVerification();
                    
                    loadElectricityInvoices();
                    loadElectricityStats();
                } else {
                    // Spr√≥buj sparsowaƒá odpowied≈∫ jako JSON
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            errorData = await res.json();
                            showAlert(errorData?.detail || errorData?.message || `B≈ÇƒÖd zapisywania faktury (${res.status})`, 'error');
                        } catch (e) {
                            const text = await res.text();
                            showAlert(`B≈ÇƒÖd serwera (${res.status}): ${text.substring(0, 200)}`, 'error');
                            console.error('B≈ÇƒÖd odpowiedzi:', text);
                        }
                    } else {
                        const text = await res.text();
                        showAlert(`B≈ÇƒÖd serwera (${res.status}): ${text.substring(0, 200)}`, 'error');
                        console.error('B≈ÇƒÖd odpowiedzi (nie JSON):', text);
                    }
                }
            } catch (error) {
                console.error('B≈ÇƒÖd zapisywania faktury:', error);
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }

        function cancelElectricityInvoiceVerification() {
            document.getElementById('electricity-invoice-verification').style.display = 'none';
            document.getElementById('form-electricity-invoice-verify').reset();
            document.getElementById('electricity-invoice-file').value = '';
            document.getElementById('electricity-invoice-file-name').textContent = '';
            
            // Wyczy≈õƒá zmiennƒÖ globalnƒÖ
            currentInvoiceDetails = null;
            window.editingInvoiceId = null;
            
            // Przywr√≥ƒá przycisk zapisu
            const saveBtn = document.querySelector('#electricity-invoice-verification .btn-success');
            if (saveBtn) {
                saveBtn.textContent = 'Zatwierd≈∫ i zapisz';
                saveBtn.onclick = verifyAndSaveElectricityInvoice;
            }
            
            // Ukryj sekcje szczeg√≥≈Çowe
            document.getElementById('electricity-blankiety-section').style.display = 'none';
            document.getElementById('electricity-odczyty-section').style.display = 'none';
            document.getElementById('electricity-sprzedaz-section').style.display = 'none';
            document.getElementById('electricity-oplaty-section').style.display = 'none';
            document.getElementById('electricity-rozliczenie-section').style.display = 'none';
            
            // Wyczy≈õƒá kontenery edytowalne
            document.getElementById('electricity-blankiety-editable').innerHTML = '';
            document.getElementById('electricity-odczyty-editable').innerHTML = '';
            document.getElementById('electricity-sprzedaz-editable').innerHTML = '';
            document.getElementById('electricity-oplaty-editable').innerHTML = '';
            document.getElementById('electricity-rozliczenie-editable').innerHTML = '';
        }

        // Zmienna globalna do przechowywania szczeg√≥≈Çowych danych faktury
        let currentInvoiceDetails = null;
        
        // Funkcja pomocnicza do konwersji daty DD/MM/YYYY na ISO
        function convertDDMMYYYYToISO(dateStr) {
            if (!dateStr) return '';
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
            }
            // Je≈õli ju≈º w formacie ISO, zwr√≥ƒá jak jest
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}/)) {
                return dateStr.substring(0, 10);
            }
            return dateStr;
        }
        
        // Funkcja pomocnicza do konwersji warto≈õci numerycznej z formatu polskiego (przecinek) na format angielski (kropka)
        function convertNumericValue(value) {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            // Je≈õli to ju≈º liczba, zwr√≥ƒá jako string
            if (typeof value === 'number') {
                return String(value);
            }
            // Je≈õli to string, zamie≈Ñ przecinki na kropki i usu≈Ñ spacje
            const str = String(value).replace(/\s/g, '').replace(',', '.');
            // Sprawd≈∫ czy to poprawna liczba
            const num = parseFloat(str);
            if (!isNaN(num)) {
                return String(num);
            }
            return str;
        }
        
        // Funkcja do wy≈õwietlania szczeg√≥≈Çowych danych faktury jako edytowalnych formularzy
        function displayElectricityInvoiceDetails(invoiceData) {
            // Zapisz szczeg√≥≈Çowe dane do zmiennej globalnej
            currentInvoiceDetails = {
                blankiety: invoiceData.blankiety || [],
                odczyty: invoiceData.odczyty || [],
                sprzedaz_energii: invoiceData.sprzedaz_energii || [],
                oplaty_dystrybucyjne: invoiceData.oplaty_dystrybucyjne || [],
                rozliczenie_okresy: invoiceData.rozliczenie_okresy || []
            };
            
            // Blankiety prognozowe - edytowalne formularze
            const blankietyContainer = document.getElementById('electricity-blankiety-editable');
            if (invoiceData.blankiety && invoiceData.blankiety.length > 0) {
                blankietyContainer.innerHTML = '';
                invoiceData.blankiety.forEach((blankiet, idx) => {
                    if (blankiet.ogolem) return; // Pomi≈Ñ "Og√≥≈Çem"
                    
                    const blankietDiv = document.createElement('div');
                    blankietDiv.className = 'editable-record';
                    blankietDiv.style.cssText = 'border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px; border-radius: 5px; background: var(--hover-bg);';
                    blankietDiv.innerHTML = `
                        <h6 style="margin-top: 0; color: var(--primary-color);">Blankiet ${idx + 1}</h6>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div class="form-group">
                                <label>Nr blankietu</label>
                                <input type="text" name="blankiety[${idx}][nr_blankietu]" value="${blankiet.nr_blankietu || ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Okres od</label>
                                <input type="date" name="blankiety[${idx}][okres_od]" value="${blankiet.okres_od ? convertDDMMYYYYToISO(blankiet.okres_od) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Okres do</label>
                                <input type="date" name="blankiety[${idx}][okres_do]" value="${blankiet.okres_do ? convertDDMMYYYYToISO(blankiet.okres_do) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Ilo≈õƒá dzienna (kWh)</label>
                                <input type="number" name="blankiety[${idx}][ilosc_d]" value="${blankiet.ilosc_d ? convertNumericValue(blankiet.ilosc_d) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Ilo≈õƒá nocna (kWh)</label>
                                <input type="number" name="blankiety[${idx}][ilosc_c]" value="${blankiet.ilosc_c ? convertNumericValue(blankiet.ilosc_c) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Ilo≈õƒá ca≈Çodobowa (kWh)</label>
                                <input type="number" name="blankiety[${idx}][ilosc_calodobowa]" value="${blankiet.ilosc_calodobowa ? convertNumericValue(blankiet.ilosc_calodobowa) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Kwota brutto</label>
                                <input type="number" step="0.01" name="blankiety[${idx}][kwota_brutto]" value="${blankiet.kwota_brutto ? convertNumericValue(blankiet.kwota_brutto) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Akcyza</label>
                                <input type="number" step="0.01" name="blankiety[${idx}][akcyza]" value="${blankiet.akcyza ? convertNumericValue(blankiet.akcyza) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Energia do akcyzy (kWh)</label>
                                <input type="number" name="blankiety[${idx}][energia_do_akcyzy]" value="${blankiet.energia_do_akcyzy ? convertNumericValue(blankiet.energia_do_akcyzy) : '0'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Nadp≈Çata/Niedop≈Çata</label>
                                <input type="number" step="0.01" name="blankiety[${idx}][nadplata_niedoplata]" value="${blankiet.nadplata_niedoplata ? convertNumericValue(blankiet.nadplata_niedoplata) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Odsetki</label>
                                <input type="number" step="0.01" name="blankiety[${idx}][odsetki]" value="${blankiet.odsetki ? convertNumericValue(blankiet.odsetki) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Termin p≈Çatno≈õci</label>
                                <input type="date" name="blankiety[${idx}][termin_platnosci]" value="${blankiet.termin_platnosci ? convertDDMMYYYYToISO(blankiet.termin_platnosci) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Do zap≈Çaty</label>
                                <input type="number" step="0.01" name="blankiety[${idx}][do_zaplaty]" value="${blankiet.do_zaplaty ? convertNumericValue(blankiet.do_zaplaty) : '0.00'}" class="form-control">
                            </div>
                        </div>
                        <input type="hidden" name="blankiety[${idx}][id]" value="${blankiet.id || ''}">
                    `;
                    blankietyContainer.appendChild(blankietDiv);
                });
                document.getElementById('electricity-blankiety-section').style.display = 'block';
            }
            
            // Odczyty licznik√≥w - edytowalne formularze
            const odczytyContainer = document.getElementById('electricity-odczyty-editable');
            if (invoiceData.odczyty && invoiceData.odczyty.length > 0) {
                odczytyContainer.innerHTML = '';
                invoiceData.odczyty.forEach((odczyt, idx) => {
                    const odczytDiv = document.createElement('div');
                    odczytDiv.className = 'editable-record';
                    odczytDiv.style.cssText = 'border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px; border-radius: 5px; background: var(--hover-bg);';
                    odczytDiv.innerHTML = `
                        <h6 style="margin-top: 0; color: var(--primary-color);">Odczyt ${idx + 1}</h6>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div class="form-group">
                                <label>Typ energii</label>
                                <select name="odczyty[${idx}][typ]" class="form-control">
                                    <option value="pobrana" ${odczyt.typ === 'pobrana' ? 'selected' : ''}>POBRANA</option>
                                    <option value="oddana" ${odczyt.typ === 'oddana' ? 'selected' : ''}>ODDANA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Strefa</label>
                                <select name="odczyty[${idx}][strefa]" class="form-control">
                                    <option value="">-</option>
                                    <option value="dzienna" ${odczyt.strefa && odczyt.strefa.toLowerCase() === 'dzienna' ? 'selected' : ''}>DZIENNA</option>
                                    <option value="nocna" ${odczyt.strefa && odczyt.strefa.toLowerCase() === 'nocna' ? 'selected' : ''}>NOCNA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Data odczytu</label>
                                <input type="date" name="odczyty[${idx}][data]" value="${odczyt.data ? convertDDMMYYYYToISO(odczyt.data) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Bie≈ºƒÖcy odczyt</label>
                                <input type="number" name="odczyty[${idx}][biezace]" value="${odczyt.biezace || '0'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Poprzedni odczyt</label>
                                <input type="number" name="odczyty[${idx}][poprzednie]" value="${odczyt.poprzednie || '0'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Mno≈ºna</label>
                                <input type="number" name="odczyty[${idx}][mnozna]" value="${odczyt.mnozna || '1'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Ilo≈õƒá (kWh)</label>
                                <input type="number" name="odczyty[${idx}][ilosc]" value="${odczyt.ilosc || '0'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Straty (kWh)</label>
                                <input type="number" name="odczyty[${idx}][straty]" value="${odczyt.straty || '0'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Razem (kWh)</label>
                                <input type="number" name="odczyty[${idx}][razem]" value="${odczyt.razem || '0'}" class="form-control">
                            </div>
                        </div>
                        <input type="hidden" name="odczyty[${idx}][id]" value="${odczyt.id || ''}">
                    `;
                    odczytyContainer.appendChild(odczytDiv);
                });
                document.getElementById('electricity-odczyty-section').style.display = 'block';
            }
            
            // Sprzeda≈º energii - edytowalne formularze
            const sprzedazContainer = document.getElementById('electricity-sprzedaz-editable');
            if (invoiceData.sprzedaz_energii && invoiceData.sprzedaz_energii.length > 0) {
                sprzedazContainer.innerHTML = '';
                invoiceData.sprzedaz_energii.forEach((sprzedaz, idx) => {
                    if (sprzedaz.typ === 'upust') return; // Pomi≈Ñ upusty
                    
                    const sprzedazDiv = document.createElement('div');
                    sprzedazDiv.className = 'editable-record';
                    sprzedazDiv.style.cssText = 'border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px; border-radius: 5px; background: var(--hover-bg);';
                    sprzedazDiv.innerHTML = `
                        <h6 style="margin-top: 0; color: var(--primary-color);">Pozycja sprzeda≈ºy ${idx + 1}</h6>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div class="form-group">
                                <label>Strefa</label>
                                <select name="sprzedaz_energii[${idx}][strefa]" class="form-control">
                                    <option value="">-</option>
                                    <option value="dzienna" ${sprzedaz.strefa && sprzedaz.strefa.toLowerCase() === 'dzienna' ? 'selected' : ''}>DZIENNA</option>
                                    <option value="nocna" ${sprzedaz.strefa && sprzedaz.strefa.toLowerCase() === 'nocna' ? 'selected' : ''}>NOCNA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ilo≈õƒá (kWh)</label>
                                <input type="number" name="sprzedaz_energii[${idx}][ilosc_kwh]" value="${(sprzedaz.ilosc_kwh || sprzedaz.ilosc) ? convertNumericValue(sprzedaz.ilosc_kwh || sprzedaz.ilosc) : '0'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Cena za kWh</label>
                                <input type="number" step="0.0001" name="sprzedaz_energii[${idx}][cena]" value="${sprzedaz.cena ? convertNumericValue(sprzedaz.cena) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Nale≈ºno≈õƒá</label>
                                <input type="number" step="0.01" name="sprzedaz_energii[${idx}][naleznosc]" value="${sprzedaz.naleznosc ? convertNumericValue(sprzedaz.naleznosc) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>VAT (%)</label>
                                <input type="number" step="0.01" name="sprzedaz_energii[${idx}][vat]" value="${sprzedaz.vat ? convertNumericValue(sprzedaz.vat) : '23'}" class="form-control">
                            </div>
                        </div>
                        <input type="hidden" name="sprzedaz_energii[${idx}][id]" value="${sprzedaz.id || ''}">
                    `;
                    sprzedazContainer.appendChild(sprzedazDiv);
                });
                document.getElementById('electricity-sprzedaz-section').style.display = 'block';
            }
            
            // Op≈Çaty dystrybucyjne - edytowalne formularze
            const oplatyContainer = document.getElementById('electricity-oplaty-editable');
            if (invoiceData.oplaty_dystrybucyjne && invoiceData.oplaty_dystrybucyjne.length > 0) {
                oplatyContainer.innerHTML = '';
                invoiceData.oplaty_dystrybucyjne.forEach((oplata, idx) => {
                    const oplataDiv = document.createElement('div');
                    oplataDiv.className = 'editable-record';
                    oplataDiv.style.cssText = 'border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px; border-radius: 5px; background: var(--hover-bg);';
                    oplataDiv.innerHTML = `
                        <h6 style="margin-top: 0; color: var(--primary-color);">Op≈Çata ${idx + 1}</h6>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div class="form-group">
                                <label>Typ op≈Çaty</label>
                                <input type="text" name="oplaty_dystrybucyjne[${idx}][nazwa]" value="${oplata.nazwa || ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Strefa</label>
                                <select name="oplaty_dystrybucyjne[${idx}][strefa]" class="form-control">
                                    <option value="">-</option>
                                    <option value="dzienna" ${oplata.strefa && oplata.strefa.toLowerCase() === 'dzienna' ? 'selected' : ''}>DZIENNA</option>
                                    <option value="nocna" ${oplata.strefa && oplata.strefa.toLowerCase() === 'nocna' ? 'selected' : ''}>NOCNA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Jednostka</label>
                                <select name="oplaty_dystrybucyjne[${idx}][jednostka]" class="form-control">
                                    <option value="kWh" ${oplata.jednostka === 'kWh' ? 'selected' : ''}>kWh</option>
                                    <option value="z≈Ç/mc" ${oplata.jednostka === 'z≈Ç/mc' ? 'selected' : ''}>z≈Ç/mc</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Data</label>
                                <input type="date" name="oplaty_dystrybucyjne[${idx}][data]" value="${oplata.data ? convertDDMMYYYYToISO(oplata.data) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Ilo≈õƒá kWh</label>
                                <input type="number" name="oplaty_dystrybucyjne[${idx}][ilosc_kwh]" value="${(oplata.ilosc_kwh || oplata.ilosc) ? convertNumericValue(oplata.ilosc_kwh || oplata.ilosc) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Ilo≈õƒá miesiƒôcy</label>
                                <input type="number" step="0.0001" name="oplaty_dystrybucyjne[${idx}][ilosc_miesiecy]" value="${oplata.ilosc_miesiecy ? convertNumericValue(oplata.ilosc_miesiecy) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Wsp√≥≈Çczynnik</label>
                                <input type="number" step="0.0001" name="oplaty_dystrybucyjne[${idx}][wspolczynnik]" value="${(oplata.wspolczynnik || oplata.wspolczynnik1) ? convertNumericValue(oplata.wspolczynnik || oplata.wspolczynnik1) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Cena</label>
                                <input type="number" step="0.0001" name="oplaty_dystrybucyjne[${idx}][cena]" value="${oplata.cena ? convertNumericValue(oplata.cena) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Nale≈ºno≈õƒá</label>
                                <input type="number" step="0.01" name="oplaty_dystrybucyjne[${idx}][naleznosc]" value="${oplata.naleznosc ? convertNumericValue(oplata.naleznosc) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>VAT (%)</label>
                                <input type="number" step="0.01" name="oplaty_dystrybucyjne[${idx}][vat]" value="${oplata.vat ? convertNumericValue(oplata.vat) : '23'}" class="form-control">
                            </div>
                        </div>
                        <input type="hidden" name="oplaty_dystrybucyjne[${idx}][id]" value="${oplata.id || ''}">
                    `;
                    oplatyContainer.appendChild(oplataDiv);
                });
                document.getElementById('electricity-oplaty-section').style.display = 'block';
            }
            
            // Rozliczenie okres√≥w - edytowalne formularze
            const rozliczenieContainer = document.getElementById('electricity-rozliczenie-editable');
            if (invoiceData.rozliczenie_okresy && invoiceData.rozliczenie_okresy.length > 0) {
                rozliczenieContainer.innerHTML = '';
                invoiceData.rozliczenie_okresy.forEach((okres, idx) => {
                    const okresDiv = document.createElement('div');
                    okresDiv.className = 'editable-record';
                    okresDiv.style.cssText = 'border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px; border-radius: 5px; background: var(--hover-bg);';
                    okresDiv.innerHTML = `
                        <h6 style="margin-top: 0; color: var(--primary-color);">Okres ${idx + 1}</h6>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <div class="form-group">
                                <label>Numer okresu</label>
                                <input type="number" name="rozliczenie_okresy[${idx}][numer_okresu]" value="${okres.numer_okresu || idx + 1}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Data okresu</label>
                                <input type="date" name="rozliczenie_okresy[${idx}][data_okresu]" value="${okres.data_okresu ? convertDDMMYYYYToISO(okres.data_okresu) : ''}" class="form-control">
                            </div>
                        </div>
                        <input type="hidden" name="rozliczenie_okresy[${idx}][id]" value="${okres.id || ''}">
                    `;
                    rozliczenieContainer.appendChild(okresDiv);
                });
                document.getElementById('electricity-rozliczenie-section').style.display = 'block';
            } else if (invoiceData.blankiety && invoiceData.blankiety.length > 0) {
                // Fallback: generuj z blankiet√≥w je≈õli nie ma rozliczenie_okresy
                rozliczenieContainer.innerHTML = '';
                let okresNum = 1;
                invoiceData.blankiety.forEach((blankiet, idx) => {
                    if (blankiet.ogolem || !blankiet.okres_do) return;
                    const okresDiv = document.createElement('div');
                    okresDiv.className = 'editable-record';
                    okresDiv.style.cssText = 'border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px; border-radius: 5px; background: var(--hover-bg);';
                    okresDiv.innerHTML = `
                        <h6 style="margin-top: 0; color: var(--primary-color);">Okres ${okresNum}</h6>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <div class="form-group">
                                <label>Numer okresu</label>
                                <input type="number" name="rozliczenie_okresy[${idx}][numer_okresu]" value="${okresNum}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Data okresu</label>
                                <input type="date" name="rozliczenie_okresy[${idx}][data_okresu]" value="${blankiet.okres_do ? convertDDMMYYYYToISO(blankiet.okres_do) : ''}" class="form-control">
                            </div>
                        </div>
                    `;
                    rozliczenieContainer.appendChild(okresDiv);
                    okresNum++;
                });
                if (okresNum > 1) {
                    document.getElementById('electricity-rozliczenie-section').style.display = 'block';
                }
            }
        }
        
        // Funkcje edycji i usuwania faktur
        async function editElectricityInvoice(invoiceId) {
            try {
                // Pobierz dane faktury
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/${invoiceId}`);
                if (!res.ok) {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd pobierania faktury', 'error');
                    return;
                }
                
                const invoiceData = await res.json();
                
                // Endpoint zwraca dane w formacie {invoice: {...}, blankiety: [...], odczyty: [...], etc.}
                const invoice = invoiceData.invoice || invoiceData;
                
                // Wype≈Çnij formularz weryfikacji danymi faktury
                const verifyForm = document.getElementById('form-electricity-invoice-verify');
                if (!verifyForm) {
                    showAlert('Nie znaleziono formularza weryfikacji', 'error');
                    return;
                }
                
                // Funkcja pomocnicza do konwersji daty
                function convertDateToISO(dateValue) {
                    if (!dateValue) return null;
                    if (typeof dateValue === 'string') {
                        if (dateValue.match(/^\d{4}-\d{2}-\d{2}/)) {
                            return dateValue.substring(0, 10);
                        }
                    }
                    return dateValue;
                }
                
                // Wype≈Çnij wszystkie pola formularza
                Object.keys(invoice).forEach(key => {
                    if (key.startsWith('_')) return;
                    
                    const input = verifyForm.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (input.type === 'date') {
                            const isoDate = convertDateToISO(invoice[key]);
                            if (isoDate) {
                                input.value = isoDate;
                            }
                        } else if (input.type === 'number') {
                            const numValue = parseFloat(invoice[key]);
                            if (!isNaN(numValue)) {
                                input.value = numValue;
                            }
                        } else if (input.tagName === 'SELECT') {
                            const value = String(invoice[key]);
                            if (Array.from(input.options).some(opt => opt.value === value)) {
                                input.value = value;
                            }
                        } else {
                            input.value = String(invoice[key] || '');
                        }
                    }
                });
                
                // Funkcja pomocnicza do formatowania daty DD/MM/YYYY (globalna)
                window.formatDateDDMMYYYY = function(dateStr) {
                    if (!dateStr) return null;
                    const date = new Date(dateStr);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                };
                
                // Funkcja pomocnicza do formatowania daty DD/MM/YYYY
                function formatDateDDMMYYYY(dateStr) {
                    return window.formatDateDDMMYYYY(dateStr);
                }
                
                // Przygotuj dane szczeg√≥≈Çowe w formacie dla displayElectricityInvoiceDetails
                const detailsData = {
                    blankiety: invoiceData.blankiety ? invoiceData.blankiety.map(b => ({
                        id: b.id,
                        nr_blankietu: b.numer_blankietu,
                        okres_od: formatDateDDMMYYYY(b.poczatek_podokresu),
                        okres_do: formatDateDDMMYYYY(b.koniec_podokresu),
                        ilosc_d: b.ilosc_dzienna_kwh,
                        ilosc_c: b.ilosc_nocna_kwh,
                        ilosc_calodobowa: b.ilosc_calodobowa_kwh,
                        kwota_brutto: b.kwota_brutto,
                        akcyza: b.akcyza,
                        energia_do_akcyzy: b.energia_do_akcyzy_kwh,
                        nadplata_niedoplata: b.nadplata_niedoplata,
                        odsetki: b.odsetki,
                        termin_platnosci: formatDateDDMMYYYY(b.termin_platnosci),
                        do_zaplaty: b.do_zaplaty
                    })) : [],
                    odczyty: invoiceData.odczyty ? invoiceData.odczyty.map(o => ({
                        id: o.id,
                        typ: o.typ_energii === 'POBRANA' ? 'pobrana' : 'oddana',
                        strefa: o.strefa ? o.strefa.toLowerCase() : null,
                        data: formatDateDDMMYYYY(o.data_odczytu),
                        biezace: o.biezacy_odczyt,
                        poprzednie: o.poprzedni_odczyt,
                        mnozna: o.mnozna,
                        ilosc: o.ilosc_kwh,
                        straty: o.straty_kwh,
                        razem: o.razem_kwh
                    })) : [],
                    sprzedaz_energii: invoiceData.sprzedaz_energii ? invoiceData.sprzedaz_energii.map(s => ({
                        id: s.id,
                        strefa: s.strefa ? s.strefa.toLowerCase() : null,
                        ilosc_kwh: s.ilosc_kwh,
                        cena: s.cena_za_kwh,
                        naleznosc: s.naleznosc,
                        vat: s.vat_procent
                    })) : [],
                    oplaty_dystrybucyjne: invoiceData.oplaty_dystrybucyjne ? invoiceData.oplaty_dystrybucyjne.map(op => ({
                        id: op.id,
                        nazwa: op.typ_oplaty,
                        strefa: op.strefa ? op.strefa.toLowerCase() : null,
                        jednostka: op.jednostka,
                        data: formatDateDDMMYYYY(op.data),
                        ilosc_kwh: op.ilosc_kwh,
                        ilosc_miesiecy: op.ilosc_miesiecy,
                        wspolczynnik: op.wspolczynnik,
                        cena: op.cena,
                        naleznosc: op.naleznosc,
                        vat: op.vat_procent
                    })) : [],
                    rozliczenie_okresy: invoiceData.rozliczenie_okresy ? invoiceData.rozliczenie_okresy.map(r => ({
                        id: r.id,
                        numer_okresu: r.numer_okresu,
                        data_okresu: r.data_okresu
                    })) : []
                };
                
                // Zapisz szczeg√≥≈Çowe dane do zmiennej globalnej
                currentInvoiceDetails = detailsData;
                
                // Wy≈õwietl szczeg√≥≈Çowe dane
                displayElectricityInvoiceDetails(detailsData);
                
                // Zapisz ID faktury do zmiennej globalnej (dla zapisu)
                window.editingInvoiceId = invoiceId;
                
                // Poka≈º formularz weryfikacji
                document.getElementById('electricity-invoice-verification').style.display = 'block';
                
                // Zmie≈Ñ przycisk zapisu na "Zaktualizuj"
                const saveBtn = document.querySelector('#electricity-invoice-verification .btn-success');
                if (saveBtn) {
                    saveBtn.textContent = 'Zaktualizuj fakturƒô';
                    saveBtn.onclick = () => updateElectricityInvoice(invoiceId);
                }
                
                showAlert('Faktura za≈Çadowana do edycji');
                
                // Przewi≈Ñ do formularza
                document.getElementById('electricity-invoice-verification').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('B≈ÇƒÖd pobierania faktury:', error);
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        async function updateElectricityInvoice(invoiceId) {
            const form = document.getElementById('form-electricity-invoice-verify');
            const formData = new FormData(form);
            const data = {};
            
            // Lista p√≥l numerycznych
            const numericFields = ['rok', 'naleznosc_za_okres', 'wartosc_prognozy', 'faktury_korygujace', 
                'odsetki', 'wynik_rozliczenia', 'kwota_nadplacona', 'saldo_z_rozliczenia', 
                'niedoplata_nadplata', 'energia_do_akcyzy_kwh', 'akcyza', 'do_zaplaty', 
                'zuzycie_kwh', 'ogolem_sprzedaz_energii', 'ogolem_usluga_dystrybucji', 
                'energia_lacznie_zuzyta_w_roku_kwh'];
            
            for (const [key, value] of formData.entries()) {
                // Pomi≈Ñ pola szczeg√≥≈Çowe (bƒôdƒÖ zbierane osobno)
                if (key.startsWith('blankiety[') || key.startsWith('odczyty[') || 
                    key.startsWith('sprzedaz_energii[') || key.startsWith('oplaty_dystrybucyjne[') ||
                    key.startsWith('rozliczenie_okresy[')) {
                    continue;
                }
                
                if (numericFields.includes(key)) {
                    if (key.includes('kwh') || key === 'rok') {
                        data[key] = parseInt(value) || 0;
                    } else {
                        data[key] = parseFloat(value) || 0;
                    }
                } else {
                    data[key] = value;
                }
            }
            
            // Zbierz szczeg√≥≈Çowe dane z edytowalnych formularzy
            const detailedData = collectDetailedData();
            data.blankiety = detailedData.blankiety;
            data.odczyty = detailedData.odczyty;
            data.sprzedaz_energii = detailedData.sprzedaz_energii;
            data.oplaty_dystrybucyjne = detailedData.oplaty_dystrybucyjne;
            data.rozliczenie_okresy = detailedData.rozliczenie_okresy;
            
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/${invoiceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Faktura zaktualizowana pomy≈õlnie!');
                    form.reset();
                    document.getElementById('electricity-invoice-verification').style.display = 'none';
                    
                    // Wyczy≈õƒá zmiennƒÖ globalnƒÖ
                    currentInvoiceDetails = null;
                    window.editingInvoiceId = null;
                    
                    // Przywr√≥ƒá przycisk zapisu
                    const saveBtn = document.querySelector('#electricity-invoice-verification .btn-success');
                    if (saveBtn) {
                        saveBtn.textContent = 'Zatwierd≈∫ i zapisz';
                        saveBtn.onclick = verifyAndSaveElectricityInvoice;
                    }
                    
                    // Wyczy≈õƒá sekcje szczeg√≥≈Çowe
                    cancelElectricityInvoiceVerification();
                    
                    loadElectricityInvoices();
                    loadElectricityStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji faktury', 'error');
                }
            } catch (error) {
                console.error('B≈ÇƒÖd aktualizacji faktury:', error);
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        async function deleteElectricityInvoice(invoiceId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô fakturƒô? ZostanƒÖ r√≥wnie≈º usuniƒôte wszystkie powiƒÖzane dane (blankiety, odczyty, sprzeda≈º, op≈Çaty, rozliczenia).')) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/${invoiceId}`, {
                    method: 'DELETE'
                });
                if (res.ok) {
                    const result = await res.json();
                    showAlert(result.message || 'Faktura usuniƒôta pomy≈õlnie!');
                    loadElectricityInvoices();
                    loadElectricityStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania faktury', 'error');
                }
            } catch (error) {
                console.error('B≈ÇƒÖd usuwania faktury:', error);
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        // Funkcje edycji/usuwania dla blankiet√≥w
        async function editElectricityBlankiet(blankietId, invoiceId) {
            if (typeof blankietId === 'string' && blankietId.startsWith('new-')) {
                showAlert('Nowe blankiety mo≈ºna edytowaƒá tylko po zapisaniu faktury', 'error');
                return;
            }
            
            // Pobierz dane blankietu z currentInvoiceDetails
            const blankiet = currentInvoiceDetails?.blankiety?.find(b => b.id === blankietId);
            if (!blankiet) {
                showAlert('Nie znaleziono blankietu', 'error');
                return;
            }
            
            // Poka≈º formularz edycji inline
            const row = document.querySelector(`tr[data-blankiet-id="${blankietId}"]`);
            if (!row) return;
            
            const formHtml = `
                <td colspan="9">
                    <form id="form-edit-blankiet-${blankietId}" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; background: var(--hover-bg);">
                        <div class="form-group">
                            <label>Nr blankietu</label>
                            <input type="text" name="numer_blankietu" value="${blankiet.nr_blankietu || ''}" required>
                        </div>
                        <div class="form-group">
                            <label>Okres od</label>
                            <input type="date" name="poczatek_podokresu" value="${blankiet.okres_od ? convertDDMMYYYYToISO(blankiet.okres_od) : ''}">
                        </div>
                        <div class="form-group">
                            <label>Okres do</label>
                            <input type="date" name="koniec_podokresu" value="${blankiet.okres_do ? convertDDMMYYYYToISO(blankiet.okres_do) : ''}">
                        </div>
                        <div class="form-group">
                            <label>Ilo≈õƒá dzienna (kWh)</label>
                            <input type="number" name="ilosc_dzienna_kwh" value="${blankiet.ilosc_d || ''}">
                        </div>
                        <div class="form-group">
                            <label>Ilo≈õƒá nocna (kWh)</label>
                            <input type="number" name="ilosc_nocna_kwh" value="${blankiet.ilosc_c || ''}">
                        </div>
                        <div class="form-group">
                            <label>Ilo≈õƒá ca≈Çodobowa (kWh)</label>
                            <input type="number" name="ilosc_calodobowa_kwh" value="${blankiet.ilosc_calodobowa || ''}">
                        </div>
                        <div class="form-group">
                            <label>Kwota brutto</label>
                            <input type="number" step="0.01" name="kwota_brutto" value="${blankiet.kwota_brutto || '0.00'}" required>
                        </div>
                        <div class="form-group">
                            <label>Akcyza</label>
                            <input type="number" step="0.01" name="akcyza" value="${blankiet.akcyza || '0.00'}" required>
                        </div>
                        <div class="form-group">
                            <label>Energia do akcyzy (kWh)</label>
                            <input type="number" name="energia_do_akcyzy_kwh" value="${blankiet.energia_do_akcyzy || '0'}" required>
                        </div>
                        <div class="form-group">
                            <label>Nadp≈Çata/Niedop≈Çata</label>
                            <input type="number" step="0.01" name="nadplata_niedoplata" value="${blankiet.nadplata_niedoplata || '0.00'}" required>
                        </div>
                        <div class="form-group">
                            <label>Odsetki</label>
                            <input type="number" step="0.01" name="odsetki" value="${blankiet.odsetki || '0.00'}" required>
                        </div>
                        <div class="form-group">
                            <label>Termin p≈Çatno≈õci</label>
                            <input type="date" name="termin_platnosci" value="${blankiet.termin_platnosci ? convertDDMMYYYYToISO(blankiet.termin_platnosci) : ''}" required>
                        </div>
                        <div class="form-group">
                            <label>Do zap≈Çaty</label>
                            <input type="number" step="0.01" name="do_zaplaty" value="${blankiet.do_zaplaty || '0.00'}" required>
                        </div>
                        <div class="form-group" style="grid-column: span 3;">
                            <button type="button" class="btn btn-success" onclick="saveElectricityBlankiet(${blankietId}, ${invoiceId})">Zapisz</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEditElectricityBlankiet(${blankietId})">Anuluj</button>
                        </div>
                    </form>
                </td>
            `;
            
            const editRow = document.createElement('tr');
            editRow.id = `edit-blankiet-${blankietId}`;
            editRow.innerHTML = formHtml;
            row.insertAdjacentElement('afterend', editRow);
            row.style.display = 'none';
        }
        
        function convertDDMMYYYYToISO(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return dateStr;
        }
        
        async function saveElectricityBlankiet(blankietId, invoiceId) {
            const form = document.getElementById(`form-edit-blankiet-${blankietId}`);
            const formData = new FormData(form);
            const data = {};
            
            for (const [key, value] of formData.entries()) {
                if (key.includes('kwh') || key === 'energia_do_akcyzy_kwh') {
                    data[key] = parseInt(value) || null;
                } else if (key.includes('date') || key.includes('podokresu') || key.includes('platnosci')) {
                    data[key] = value || null;
                } else {
                    data[key] = parseFloat(value) || 0;
                }
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/blankiety/${blankietId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Blankiet zaktualizowany!');
                    cancelEditElectricityBlankiet(blankietId);
                    // Od≈õwie≈º dane faktury
                    if (invoiceId) {
                        editElectricityInvoice(invoiceId);
                    }
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji blankietu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        function cancelEditElectricityBlankiet(blankietId) {
            const editRow = document.getElementById(`edit-blankiet-${blankietId}`);
            const row = document.querySelector(`tr[data-blankiet-id="${blankietId}"]`);
            if (editRow) editRow.remove();
            if (row) row.style.display = '';
        }
        
        async function deleteElectricityBlankiet(blankietId, invoiceId) {
            if (typeof blankietId === 'string' && blankietId.startsWith('new-')) {
                // Usu≈Ñ z currentInvoiceDetails
                if (currentInvoiceDetails?.blankiety) {
                    currentInvoiceDetails.blankiety = currentInvoiceDetails.blankiety.filter(b => b.id !== blankietId);
                    displayElectricityInvoiceDetails(currentInvoiceDetails);
                }
                return;
            }
            
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten blankiet?')) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/blankiety/${blankietId}`, {
                    method: 'DELETE'
                });
                if (res.ok) {
                    showAlert('Blankiet usuniƒôty!');
                    if (invoiceId) {
                        editElectricityInvoice(invoiceId);
                    }
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania blankietu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        // Podobne funkcje dla pozosta≈Çych tabel - uproszczone wersje
        async function editElectricityOdczyt(odczytId, invoiceId) {
            if (typeof odczytId === 'string' && odczytId.startsWith('new-')) {
                showAlert('Nowe odczyty mo≈ºna edytowaƒá tylko po zapisaniu faktury', 'error');
                return;
            }
            showAlert('Edycja odczyt√≥w - funkcja w przygotowaniu. U≈ºyj edycji ca≈Çej faktury.', 'info');
        }
        
        async function deleteElectricityOdczyt(odczytId, invoiceId) {
            if (typeof odczytId === 'string' && odczytId.startsWith('new-')) {
                if (currentInvoiceDetails?.odczyty) {
                    currentInvoiceDetails.odczyty = currentInvoiceDetails.odczyty.filter(o => o.id !== odczytId);
                    displayElectricityInvoiceDetails(currentInvoiceDetails);
                }
                return;
            }
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten odczyt?')) return;
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/odczyty/${odczytId}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('Odczyt usuniƒôty!');
                    if (invoiceId) editElectricityInvoice(invoiceId);
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        async function editElectricitySprzedaz(sprzedazId, invoiceId) {
            if (typeof sprzedazId === 'string' && sprzedazId.startsWith('new-')) {
                showAlert('Nowe pozycje mo≈ºna edytowaƒá tylko po zapisaniu faktury', 'error');
                return;
            }
            showAlert('Edycja sprzeda≈ºy - funkcja w przygotowaniu. U≈ºyj edycji ca≈Çej faktury.', 'info');
        }
        
        async function deleteElectricitySprzedaz(sprzedazId, invoiceId) {
            if (typeof sprzedazId === 'string' && sprzedazId.startsWith('new-')) {
                if (currentInvoiceDetails?.sprzedaz_energii) {
                    currentInvoiceDetails.sprzedaz_energii = currentInvoiceDetails.sprzedaz_energii.filter(s => s.id !== sprzedazId);
                    displayElectricityInvoiceDetails(currentInvoiceDetails);
                }
                return;
            }
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô pozycjƒô sprzeda≈ºy?')) return;
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/sprzedaz/${sprzedazId}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('Pozycja sprzeda≈ºy usuniƒôta!');
                    if (invoiceId) editElectricityInvoice(invoiceId);
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania pozycji', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        async function editElectricityOplata(oplataId, invoiceId) {
            if (typeof oplataId === 'string' && oplataId.startsWith('new-')) {
                showAlert('Nowe op≈Çaty mo≈ºna edytowaƒá tylko po zapisaniu faktury', 'error');
                return;
            }
            showAlert('Edycja op≈Çat - funkcja w przygotowaniu. U≈ºyj edycji ca≈Çej faktury.', 'info');
        }
        
        async function deleteElectricityOplata(oplataId, invoiceId) {
            if (typeof oplataId === 'string' && oplataId.startsWith('new-')) {
                if (currentInvoiceDetails?.oplaty_dystrybucyjne) {
                    currentInvoiceDetails.oplaty_dystrybucyjne = currentInvoiceDetails.oplaty_dystrybucyjne.filter(op => op.id !== oplataId);
                    displayElectricityInvoiceDetails(currentInvoiceDetails);
                }
                return;
            }
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô op≈Çatƒô?')) return;
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/oplaty/${oplataId}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('Op≈Çata usuniƒôta!');
                    if (invoiceId) editElectricityInvoice(invoiceId);
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania op≈Çaty', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        async function editElectricityRozliczenieOkres(okresId, invoiceId) {
            if (typeof okresId === 'string' && okresId.startsWith('new-')) {
                showAlert('Nowe okresy mo≈ºna edytowaƒá tylko po zapisaniu faktury', 'error');
                return;
            }
            showAlert('Edycja okres√≥w - funkcja w przygotowaniu. U≈ºyj edycji ca≈Çej faktury.', 'info');
        }
        
        async function deleteElectricityRozliczenieOkres(okresId, invoiceId) {
            if (typeof okresId === 'string' && okresId.startsWith('new-')) {
                // Okresy sƒÖ generowane z blankiet√≥w, wiƒôc nie ma sensu ich usuwaƒá osobno
                return;
            }
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten okres?')) return;
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/rozliczenie-okresy/${okresId}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('Okres usuniƒôty!');
                    if (invoiceId) editElectricityInvoice(invoiceId);
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania okresu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        // Funkcje dodawania nowych rekord√≥w (placeholder)
        function addElectricityBlankiet() {
            showAlert('Aby dodaƒá blankiet, edytuj fakturƒô i dodaj go rƒôcznie w formularzu weryfikacji', 'info');
        }
        
        function addElectricityOdczyt() {
            showAlert('Aby dodaƒá odczyt, edytuj fakturƒô i dodaj go rƒôcznie w formularzu weryfikacji', 'info');
        }
        
        function addElectricitySprzedaz() {
            showAlert('Aby dodaƒá pozycjƒô sprzeda≈ºy, edytuj fakturƒô i dodaj jƒÖ rƒôcznie w formularzu weryfikacji', 'info');
        }
        
        function addElectricityOplata() {
            showAlert('Aby dodaƒá op≈Çatƒô, edytuj fakturƒô i dodaj jƒÖ rƒôcznie w formularzu weryfikacji', 'info');
        }
        
        function addElectricityRozliczenieOkres() {
            showAlert('Okresy sƒÖ automatycznie generowane z blankiet√≥w', 'info');
        }
        
        function toggleManualElectricityInvoiceForm() {
            const formDiv = document.getElementById('electricity-invoice-manual-form');
            const btn = document.getElementById('btn-show-manual-electricity-invoice');
            if (formDiv.style.display === 'none' || formDiv.style.display === '') {
                formDiv.style.display = 'block';
                btn.textContent = 'Ukryj formularz rƒôczny';
            } else {
                formDiv.style.display = 'none';
                btn.textContent = 'LUB DODAJ RƒòCZNIE';
            }
        }

        async function addElectricityInvoice() {
            const form = document.getElementById('form-electricity-invoice');
            const formData = new FormData(form);
            const data = {};
            
            for (const [key, value] of formData.entries()) {
                if (['usage_kwh', 'energy_price_net', 'energy_value_net', 'energy_vat_amount',
                     'energy_value_gross', 'distribution_fees_net', 'distribution_fees_vat',
                     'distribution_fees_gross', 'vat_rate', 'vat_amount', 'total_net_sum',
                     'total_gross_sum', 'amount_to_pay'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Faktura prƒÖdu dodana pomy≈õlnie!');
                    form.reset();
                    toggleManualElectricityInvoiceForm();
                    loadElectricityInvoices();
                    loadElectricityStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd dodawania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Rachunki prƒÖdu
        async function loadElectricityBills() {
            try {
                const res = await fetch(`${API_BASE}/api/electricity/bills/`);
                const bills = await res.json();
                const listEl = document.getElementById('electricity-bills-list');
                
                if (bills.length === 0) {
                    listEl.innerHTML = '<p>Brak rachunk√≥w prƒÖdu. Wygeneruj rachunki dla okresu z fakturƒÖ i odczytami.</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Okres</th><th>Lokal</th><th>Zu≈ºycie (kWh)</th><th>Suma brutto</th><th>Akcje</th></tr></thead><tbody>';
                bills.forEach(b => {
                    html += `<tr>
                        <td>${b.data}</td>
                        <td>${b.local || '-'}</td>
                        <td>${(b.usage_kwh || 0).toFixed(2)}</td>
                        <td>${(b.total_gross_sum || 0).toFixed(2)} z≈Ç</td>
                        <td class="actions">
                            <button class="btn btn-edit btn-small" onclick="editElectricityBill(${b.id})" title="Edytuj rachunek">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteElectricityBill(${b.id})" title="Usu≈Ñ rachunek">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                document.getElementById('electricity-bills-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania rachunk√≥w</p>';
            }
        }

        async function generateElectricityBills() {
            const period = document.getElementById('electricity-bill-period').value.trim();
            if (!period || !period.match(/^\d{4}-\d{2}$/)) {
                showAlert('Podaj prawid≈Çowy okres (YYYY-MM)', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/electricity/bills/generate/${period}`, { method: 'POST' });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Wygenerowano ${result.bills_count || 0} rachunk√≥w prƒÖdu dla okresu ${period}`);
                    loadElectricityBills();
                    loadElectricityStats();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd generowania rachunk√≥w', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Inicjalizacja - za≈Çaduj statystyki na g≈Ç√≥wnej stronie
        loadMainStats();
        
        // Od≈õwie≈ºanie statystyk
        setInterval(() => {
            // Je≈õli g≈Ç√≥wna strona jest widoczna, od≈õwie≈º jej statystyki
            if (document.getElementById('main-page').style.display !== 'none') {
                loadMainStats();
            }
            // Je≈õli sekcja wody jest widoczna, od≈õwie≈º jej statystyki
            if (document.getElementById('medium-water').style.display !== 'none') {
                loadWaterStats();
            }
            // Je≈õli sekcja gazu jest widoczna, od≈õwie≈º jej statystyki
            if (document.getElementById('medium-gas').style.display !== 'none') {
                loadGasStats();
            }
            // Je≈õli sekcja prƒÖdu jest widoczna, od≈õwie≈º jej statystyki
            if (document.getElementById('medium-electricity').style.display !== 'none') {
                loadElectricityStats();
            }
        }, 30000); // Od≈õwie≈º statystyki co 30 sekund
    </script>
</body>
</html>
