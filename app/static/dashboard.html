<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing System - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Kolory jasne (domy≈õlne) */
            --primary-color: #4a5568;
            --primary-light: #718096;
            --bg-gradient-start: #e2e8f0;
            --bg-gradient-end: #cbd5e0;
            --card-bg: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --hover-bg: #f7fafc;
            --water-color: #4299e1;
            --gas-color: #f4c574;
            --electricity-color: #d47474;
            --edit-color: #90cdf4;
            --delete-color: #fcb3b3;
            --warning-bg: #fef5e7;
            --warning-border: #f4c574;
            --warning-text: #744210;
        }

        body.dark-mode {
            --primary-color: #e2e8f0;
            --primary-light: #cbd5e0;
            --bg-gradient-start: #2d3748;
            --bg-gradient-end: #1a202c;
            --card-bg: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #cbd5e0;
            --border-color: #4a5568;
            --hover-bg: #2d3748;
            --water-color: #63b3ed;
            --gas-color: #ffd574;
            --electricity-color: #e47474;
            --edit-color: #7dd3fc;
            --delete-color: #fca5a5;
            --warning-bg: #78350f;
            --warning-border: #ffd574;
            --warning-text: #fef3c7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            text-transform: uppercase;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* WyjƒÖtki - nie przekszta≈Çcaj na wielkie litery dla warto≈õci liczbowych i niekt√≥rych element√≥w */
        input, textarea, .number-value, .data-value,
        h3, .stat-card h3, /* Warto≈õci statystyk - liczby */
        td, /* Kom√≥rki tabeli - mogƒÖ zawieraƒá liczby */
        .data-table td {
            text-transform: none !important;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: background 0.3s ease;
        }

        header h1 {
            color: var(--primary-color);
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .control-buttons {
            position: fixed;
            top: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .control-button {
            background: transparent;
            border: none;
            border-radius: 50%;
            width: auto;
            height: auto;
            min-width: 40px;
            min-height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            transition: all 0.3s ease;
            color: var(--text-primary);
            padding: 5px;
        }

        .control-button:hover {
            transform: scale(1.15);
            opacity: 0.8;
        }

        #language-icon {
            font-size: 0.7em;
            font-weight: 600;
        }


        /* Sidebar ustawie≈Ñ */
        .settings-sidebar {
            display: none;
            position: fixed;
            z-index: 2000;
            right: 0;
            top: 0;
            width: 400px;
            max-width: 90vw;
            height: 100vh;
            background-color: var(--card-bg);
            box-shadow: -5px 0 20px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
            transform: translateX(100%);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .settings-sidebar.open {
            display: block;
            transform: translateX(0);
        }

        .settings-sidebar-overlay {
            display: none;
            position: fixed;
            z-index: 1999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        .settings-sidebar-overlay.open {
            display: block;
        }

        .settings-sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            background-color: var(--card-bg);
            z-index: 10;
        }

        .settings-sidebar-header h2 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.5em;
        }

        .close-sidebar {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-sidebar:hover {
            color: var(--text-primary);
        }

        .settings-menu {
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .settings-menu-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settings-menu-item:hover {
            background-color: var(--hover-bg);
        }

        .settings-menu-item.active {
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 600;
        }

        .settings-menu-item span {
            flex: 1;
        }

        .settings-menu-item::after {
            content: '‚Ä∫';
            font-size: 1.5em;
            color: var(--text-secondary);
        }

        .settings-content {
            padding: 20px;
            display: none;
        }

        .settings-content.active {
            display: block;
        }

        .settings-content-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .settings-content-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.3em;
        }

        .settings-back-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px 0;
            margin-bottom: 15px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.2s;
        }

        .settings-back-button:hover {
            color: var(--text-primary);
        }

        .settings-back-button::before {
            content: '‚Üê';
            margin-right: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-modal-primary {
            background: var(--button-bg);
            color: white;
        }

        .btn-modal-primary:hover {
            background: var(--button-hover);
        }

        .btn-modal-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-modal-secondary:hover {
            border-color: var(--primary-color);
        }

        header p {
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .stat-card:not(.clickable) {
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .stat-card.clickable {
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(22, 163, 74, 0.55);
        }

        .stat-card.clickable:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 10px rgba(22, 163, 74, 0.65);
            border-color: var(--primary-light);
            background: var(--hover-bg);
        }

        /* Cienie w kolorach medium dla stat-card */
        #medium-water .stat-card.clickable {
            box-shadow: 0 2px 6px rgba(66, 153, 225, 0.4);
        }

        #medium-water .stat-card.clickable:hover {
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.5);
        }

        #medium-gas .stat-card.clickable {
            box-shadow: 0 2px 6px rgba(244, 197, 116, 0.4);
        }

        #medium-gas .stat-card.clickable:hover {
            box-shadow: 0 4px 10px rgba(244, 197, 116, 0.5);
        }

        #medium-electricity .stat-card.clickable {
            box-shadow: 0 2px 6px rgba(212, 116, 116, 0.4);
        }

        #medium-electricity .stat-card.clickable:hover {
            box-shadow: 0 4px 10px rgba(212, 116, 116, 0.5);
        }

        .stat-card:not(.clickable) {
            cursor: default;
        }

        .stat-card:not(.clickable):hover {
            transform: none !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08) !important;
            border-color: transparent !important;
            background: var(--card-bg) !important;
        }

        .stat-card h3 {
            color: var(--primary-color);
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: background 0.3s ease;
        }

        .section h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: var(--hover-bg);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            color: var(--text-primary);
        }

        .tab:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .tab.water-tab.active {
            background: linear-gradient(135deg, #6b8fc7 0%, #5a7fb8 100%);
            color: white;
        }

        .tab.gas-tab.active {
            background: linear-gradient(135deg, #f4c574 0%, #e4b564 100%);
            color: white;
        }

        .tab.electricity-tab.active {
            background: linear-gradient(135deg, #d47474 0%, #c46464 100%);
            color: white;
        }

        /* Nieaktywne przyciski medium - zdesaturowane, wyszarzone */
        .tab:not(.active) {
            filter: grayscale(100%);
            opacity: 0.5;
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Specjalny layout dla formularza weryfikacji faktury gazu - 4 kolumny */
        #form-gas-invoice-verify {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        /* Puste miejsca w formularzu */
        .form-group.empty {
            visibility: hidden;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* Styl dla przycisku RACHUNKI ≈ÅƒÑCZONE */
        button.btn-primary[onclick="openCombinedBills()"]:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: transparent;
            color: var(--delete-color);
            border: 1px solid var(--delete-color);
        }

        .btn-danger:hover {
            background: var(--delete-color);
            color: var(--text-primary);
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--hover-bg);
            font-weight: 600;
            color: var(--primary-color);
        }

        .data-table tr:hover {
            background: var(--hover-bg);
        }

        .data-table tr.clickable {
            cursor: pointer;
        }

        .data-table tr.clickable:hover {
            background: var(--hover-bg);
        }

        body.dark-mode .data-table tr.clickable:hover {
            background: #3a4554;
        }

        .details-row {
            display: none;
        }

        .details-row.expanded {
            display: table-row;
        }

        .details-cell {
            padding: 20px;
            background: var(--hover-bg);
        }
        
        /* Usu≈Ñ szare t≈Ço dla szczeg√≥≈Ç√≥w rachunk√≥w ≈ÇƒÖczonych */
        #combined-bills-section .details-cell {
            background: transparent;
        }
        
        /* Styl dla rozwiniƒôtych wierszy w RACHUNKI ≈ÅƒÑCZONE - pod≈õwietlenie */
        #combined-bills-section .data-table tr.clickable.expanded {
            background: rgba(74, 85, 104, 0.1) !important;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(74, 85, 104, 0.2);
        }
        
        body.dark-mode #combined-bills-section .data-table tr.clickable.expanded {
            background: rgba(226, 232, 240, 0.1) !important;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(226, 232, 240, 0.2);
        }
        
        /* Bezbarwne ikony w rozwiniƒôtych wierszach */
        #combined-bills-section .data-table tr.clickable.expanded .btn {
            opacity: 0.5;
            filter: grayscale(100%);
        }
        
        #combined-bills-section .data-table tr.clickable.expanded .btn:hover {
            opacity: 0.7;
            filter: grayscale(80%);
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .details-item {
            padding: 8px;
            background: var(--card-bg);
            border-radius: 5px;
            border-left: 3px solid var(--primary-color);
        }

        .details-item label {
            font-weight: 600;
            color: var(--primary-color);
            display: block;
            margin-bottom: 5px;
            font-size: 0.85em;
        }

        .details-item .value {
            color: var(--text-primary);
            font-size: 1em;
        }

        .details-item .value.error-value {
            color: #dc2626;
            font-weight: bold;
        }

        .btn-edit {
            background: transparent;
            color: var(--edit-color);
            border: 1px solid var(--edit-color);
        }

        .btn-edit:hover {
            background: var(--edit-color);
            color: var(--text-primary);
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .alert.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .verification-banner {
            background: transparent;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .verification-banner h3 {
            margin-top: 0;
            color: #666;
            font-size: 1.1em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .verification-banner p {
            margin-bottom: 10px;
            color: #666;
            text-transform: none;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .period-selector input {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background: var(--card-bg);
            color: var(--text-primary);
        }
        
        .period-selector input[type="month"] {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.3s;
        }
        
        .period-selector input[type="month"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 85, 104, 0.1);
        }
        
        .period-selector input[type="month"].invalid {
            border-color: #dc3545;
            background-color: #ffe6e6;
        }
        
        #electricity-periods-buttons button {
            padding: 10px 20px;
            margin: 5px;
            text-transform: none;
            font-size: 1em;
            background: transparent;
            border: 1px solid #10b981;
            color: #10b981;
            font-weight: normal;
            border-radius: 4px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        #electricity-periods-buttons button:hover {
            transform: translateY(-2px);
            background: rgba(16, 185, 129, 0.1);
        }
        
        #electricity-periods-buttons button.btn-selected {
            background: transparent;
            border: 1px solid #10b981;
            color: #10b981;
            font-weight: normal;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        /* Styl dla input file */
        input[type="file"] {
            display: none;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 10px;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: #10b981;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.3s;
            border: none;
        }

        .file-input-label:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .file-input-label:active {
            transform: translateY(0);
        }

        .file-name-display {
            display: inline-block;
            margin-left: 10px;
            color: var(--text-secondary);
            font-size: 0.9em;
            text-transform: uppercase;
            font-weight: 500;
        }

        .file-name-display:empty::before {
            content: "NIE WYBRANO PLIKU";
            color: var(--text-secondary);
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="control-buttons">
            <button class="control-button" id="languageToggle" onclick="toggleLanguage()" title="Prze≈ÇƒÖcz jƒôzyk / Switch language">
                <span id="language-icon">EN</span>
            </button>
            <button class="control-button theme-toggle" onclick="toggleTheme()" title="Prze≈ÇƒÖcz tryb nocny / Toggle dark mode">
                <span id="theme-icon">‚òæ</span>
            </button>
            <button class="control-button" onclick="openPreferences()" title="Preferencje / Preferences">
                <span>‚öô</span>
            </button>
            <button class="control-button" onclick="logout()" title="Wyloguj siƒô / Logout">
                <span>‚Ü™</span>
            </button>
        </div>
        
        <header>
            <h1 data-i18n="header.title">Billing System</h1>
            <p data-i18n="header.subtitle">System rozliczania rachunk√≥w za wodƒô, ≈õcieki, gaz i prƒÖd</p>
            <div style="margin-top: 15px;">
                <a href="/docs" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: 500;" data-i18n="header.api_docs">üìö Dokumentacja API (Swagger UI)</a>
            </div>
            <div style="margin-top: 10px; font-size: 0.9em; color: var(--text-secondary);">
                <span data-i18n="header.author">Autor</span>: <strong>Arkadiusz Mickiewicz</strong>
            </div>
        </header>

        <div id="alert" class="alert"></div>

        <!-- G≈Ç√≥wna strona z wyborem medium -->
        <div id="main-page" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 data-i18n="main.select_medium" style="margin: 0;">Wybierz medium do zarzƒÖdzania</h2>
                <button class="btn btn-primary" onclick="openCombinedBills()" style="text-transform: uppercase; padding: 10px 20px; background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color);" data-i18n="button.combined_bills">
                    RACHUNKI ≈ÅƒÑCZONE
                </button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 30px;">
                <!-- Karta Wody -->
                <div class="medium-card" onclick="openMedium('water')" style="cursor: pointer; background: linear-gradient(135deg, #6b8fc7 0%, #5a7fb8 100%); color: white; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="font-size: 4em; margin-bottom: 20px; font-weight: 300; opacity: 0.9;">‚óØ</div>
                    <h2 style="margin-bottom: 10px; font-size: 2em; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2);" data-i18n="medium.water">Woda</h2>
                    <div id="main-water-stats" class="stats-grid" style="margin-top: 20px; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-water-invoices">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;" data-i18n="stats.invoices">Faktury</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-water-bills">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;" data-i18n="stats.bills">Rachunki</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-water-total">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;" data-i18n="stats.total_gross">Suma brutto</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-water-period">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;" data-i18n="stats.latest_period">Najnowszy okres</div>
                        </div>
                    </div>
                </div>
                
                <!-- Karta Gazu -->
                <div class="medium-card" onclick="openMedium('gas')" style="cursor: pointer; background: linear-gradient(135deg, #f4c574 0%, #e4b564 100%); color: white; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="font-size: 4em; margin-bottom: 20px; font-weight: 300; opacity: 0.9;">‚ñ≥</div>
                    <h2 style="margin-bottom: 10px; font-size: 2em; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2);" data-i18n="medium.gas">Gaz</h2>
                    <div id="main-gas-stats" class="stats-grid" style="margin-top: 20px; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-gas-invoices">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;" data-i18n="stats.invoices">Faktury</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-gas-bills">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;" data-i18n="stats.bills">Rachunki</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-gas-total">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;" data-i18n="stats.total_gross">Suma brutto</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-gas-period">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;" data-i18n="stats.latest_period">Najnowszy okres</div>
                        </div>
                    </div>
                </div>
                
                <div class="medium-card" onclick="openMedium('electricity')" style="cursor: pointer; background: linear-gradient(135deg, #d47474 0%, #c46464 100%); color: white; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="font-size: 4em; margin-bottom: 20px; font-weight: 300; opacity: 0.9;">‚óá</div>
                    <h2 style="margin-bottom: 10px; font-size: 2em; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2);" data-i18n="medium.electricity">PrƒÖd</h2>
                    <div id="main-electricity-stats" class="stats-grid" style="margin-top: 20px; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-electricity-readings">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;" data-i18n="stats.readings">Odczyty</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-electricity-invoices">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;" data-i18n="stats.invoices">Faktury</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-electricity-bills">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;" data-i18n="stats.bills">Rachunki</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.5em; font-weight: bold;" id="main-electricity-period">-</div>
                            <div style="font-size: 0.9em; opacity: 0.9;" data-i18n="stats.latest_period">Najnowszy okres</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- G≈Ç√≥wne sekcje (ukryte domy≈õlnie) -->
        <div id="medium-sections" class="section" style="display: none;">
            <!-- Przycisk powrotu -->
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="backToMain()" style="display: flex; align-items: center; gap: 10px; text-transform: uppercase;">
                    <span>‚Üê</span> <span data-i18n="button.back">POWR√ìT DO G≈Å√ìWNEJ STRONY</span>
                </button>
            </div>
            
            <!-- Zak≈Çadki wyboru medium -->
            <div class="tabs" style="margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
                <button class="tab water-tab" id="tab-water" onclick="showMedium('water')" style="text-transform: uppercase;" data-i18n="button.water">‚óØ WODA</button>
                <button class="tab gas-tab" id="tab-gas" onclick="showMedium('gas')" style="text-transform: uppercase;" data-i18n="button.gas">‚ñ≥ GAZ</button>
                <button class="tab electricity-tab" id="tab-electricity" onclick="showMedium('electricity')" style="text-transform: uppercase;" data-i18n="button.electricity">PRƒÑD</button>
            </div>

            <!-- Sekcje dla Wody -->
            <div id="medium-water" class="medium-content" style="display: none;">
                <!-- Statystyki wody -->
                <div class="stats-grid" id="water-stats" style="margin-bottom: 25px;">
                    <div class="stat-card clickable" onclick="showTab('locals')">
                        <h3 id="water-stat-locals">-</h3>
                        <p data-i18n="stats.locals">Lokale</p>
                    </div>
                    <div class="stat-card clickable" onclick="showTab('readings')">
                        <h3 id="water-stat-readings">-</h3>
                        <p data-i18n="stats.readings">Odczyty</p>
                    </div>
                    <div class="stat-card clickable" onclick="showTab('invoices')">
                        <h3 id="water-stat-invoices">-</h3>
                        <p data-i18n="stats.invoices">Faktury</p>
                    </div>
                    <div class="stat-card clickable" onclick="showTab('bills')">
                        <h3 id="water-stat-bills">-</h3>
                        <p data-i18n="stats.bills">Rachunki</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="water-stat-total">-</h3>
                        <p data-i18n="stats.total_gross">Suma brutto</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="water-stat-latest-period">-</h3>
                        <p data-i18n="stats.latest_period">Najnowszy okres</p>
                    </div>
                </div>

            <!-- Sekcja Lokale -->
            <div id="tab-locals" class="tab-content active">
                <h2 data-i18n="section.locals">Lokale</h2>
                <form id="form-local" class="form-grid">
                    <div class="form-group">
                        <label data-i18n="label.meter_name">Nazwa licznika</label>
                        <select name="water_meter_name" required>
                            <option value="water_meter_5">water_meter_5</option>
                            <option value="water_meter_5b">water_meter_5b</option>
                            <option value="water_meter_5a">water_meter_5a</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="label.tenant">Najemca</label>
                        <input type="text" name="tenant" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="label.local">Lokal</label>
                        <input type="text" name="local" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" placeholder="email@example.com">
                    </div>
                </form>
                <button class="btn btn-success" onclick="addLocal()" style="text-transform: uppercase;" data-i18n="button.add_local">DODAJ LOKAL</button>
                
                <div id="locals-list" class="loading">≈Åadowanie...</div>
            </div>

            <!-- Sekcja Odczyty -->
            <div id="tab-readings" class="tab-content">
                <h2 data-i18n="section.readings">Odczyty licznik√≥w</h2>
                <form id="form-reading" class="form-grid">
                    <div class="form-group">
                        <label data-i18n="label.period">Okres (YYYY-MM)</label>
                        <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                    </div>
                    <div class="form-group">
                        <label>Licznik g≈Ç√≥wny (DOM)</label>
                        <input type="number" step="0.01" name="water_meter_main" required>
                    </div>
                    <div class="form-group">
                        <label>Licznik 5 (gora)</label>
                        <input type="number" step="0.01" name="water_meter_5" required>
                    </div>
                    <div class="form-group">
                        <label>Licznik 5a (gabinet)</label>
                        <input type="number" step="0.01" name="water_meter_5a" required>
                    </div>
                    <div class="form-group">
                        <label>LICZNIK 5B (DOL) - AUTOM.</label>
                        <input type="text" id="calculated_dol" readonly style="background: transparent; border: 1px solid #ffcccc; cursor: not-allowed;">
                    </div>
                </form>
                <script>
                    // Calculate dol value in real-time
                    document.addEventListener('DOMContentLoaded', function() {
                        const form = document.getElementById('form-reading');
                        if (form) {
                            const mainInput = form.querySelector('[name="water_meter_main"]');
                            const goraInput = form.querySelector('[name="water_meter_5"]');
                            const gabinetInput = form.querySelector('[name="water_meter_5a"]');
                            const calculatedInput = document.getElementById('calculated_dol');
                            
                            function updateCalculatedDol() {
                                const main = parseFloat(mainInput.value) || 0;
                                const gora = parseFloat(goraInput.value) || 0;
                                const gabinet = parseFloat(gabinetInput.value) || 0;
                                const dol = main - gora - gabinet;
                                calculatedInput.value = dol.toFixed(2);
                            }
                            
                            [mainInput, goraInput, gabinetInput].forEach(input => {
                                if (input) input.addEventListener('input', updateCalculatedDol);
                            });
                        }
                    });
                </script>
                <button class="btn btn-success" onclick="addReading()" style="text-transform: uppercase;" data-i18n="button.add_reading">DODAJ ODCZYT</button>
                
                <!-- Przycisk do wysy≈Çania stanu licznika do dostawcy (pokazuje siƒô po zapisaniu) -->
                <div id="send-to-provider-container" style="display: none; margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="sendReadingToProvider()" style="text-transform: uppercase; margin-right: 10px;" data-i18n="button.send_to_provider">Wy≈õlij stan licznika do dostawcy</button>
                    <button class="btn btn-secondary" onclick="showCredentialsManually()" style="text-transform: uppercase;" data-i18n="button.show_credentials">Poka≈º dane logowania</button>
                </div>
                
                <div id="readings-list" class="loading">≈Åadowanie...</div>
            </div>

            <!-- Sekcja Faktury -->
            <div id="tab-invoices" class="tab-content">
                <h2 data-i18n="section.invoices">Faktury</h2>
                
                <div style="background: var(--hover-bg); padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                    <h3 style="margin-top: 0; color: #666; text-transform: uppercase; font-size: 0.9em; font-weight: normal;" data-i18n="info.multiple_invoices">WA≈ªNE: WIELE FAKTUR DLA JEDNEGO OKRESU</h3>
                    <p style="margin-bottom: 10px; color: #666; text-transform: uppercase; font-size: 0.85em; font-weight: normal;">
                        <strong data-i18n="info.multiple_invoices_desc">Gdy okres rozliczeniowy (2 miesiƒÖce) ma zmianƒô stawki w po≈Çowie:</strong>
                    </p>
                    <ul style="margin-left: 20px; color: #666; text-transform: uppercase; font-size: 0.85em; font-weight: normal;">
                        <li><strong data-i18n="info.multiple_invoices_period">Okres (YYYY-MM) - u≈ºywaj tego samego dla obu faktur (np. "2025-02")</strong></li>
                        <li><strong data-i18n="info.multiple_invoices_dates">Data poczƒÖtku/ko≈Ñca - wpisz faktyczne daty ka≈ºdej faktury</strong></li>
                        <li data-i18n="info.multiple_invoices_weighted">System automatycznie obliczy ≈õredniƒÖ wa≈ºonƒÖ koszt√≥w z obu faktur</li>
                        <li data-i18n="info.multiple_invoices_subscription">Abonamenty zostanƒÖ zsumowane z wszystkich faktur</li>
                    </ul>
                    <p style="margin-top: 10px; margin-bottom: 0; color: #666; font-size: 0.85em; text-transform: uppercase; font-weight: normal;">
                        <strong data-i18n="info.multiple_invoices_example">Przyk≈Çad: Okres "2025-02" ma dwie faktury:</strong><br>
                        <span data-i18n="info.multiple_invoices_example1">Faktura 1: 01.01-31.01, koszt 10 z≈Ç/m¬≥, zu≈ºycie 20 m¬≥</span><br>
                        <span data-i18n="info.multiple_invoices_example2">Faktura 2: 01.02-28.02, koszt 12 z≈Ç/m¬≥, zu≈ºycie 25 m¬≥</span><br>
                        <span data-i18n="info.multiple_invoices_example3">‚Üí System u≈ºyje ≈õredniej wa≈ºonej: (10√ó20 + 12√ó25) / 45 = 11.11 z≈Ç/m¬≥</span>
                    </p>
                </div>
                
                <div class="verification-banner">
                    <h3 style="text-transform: uppercase; font-size: 0.9em; font-weight: normal; color: #666;" data-i18n="info.verification">WERYFIKACJA FAKTUR</h3>
                    <p style="text-transform: uppercase; font-size: 0.85em; font-weight: normal; color: #666;" data-i18n="info.verification_text">
                        Po wczytaniu faktury PDF, dane zostanƒÖ wy≈õwietlone poni≈ºej do weryfikacji i ewentualnej zmiany przed zapisem do bazy danych.
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="text-transform: uppercase;">WCZYTAJ FAKTURƒò PDF</h3>
                    <div class="file-input-wrapper">
                        <label for="invoice-file" class="file-input-label" data-i18n="button.select_file">WYBIERZ PLIK</label>
                        <input type="file" id="invoice-file" accept=".pdf" onchange="updateFileName('invoice-file', 'invoice-file-name')">
                        <span id="invoice-file-name" class="file-name-display"></span>
                    </div>
                    <button class="btn btn-success" onclick="uploadInvoice()" style="text-transform: uppercase; margin-top: 10px;" data-i18n="button.upload_pdf">WCZYTAJ PDF</button>
                </div>

                <!-- Formularz weryfikacji faktury (ukryty do momentu parsowania) -->
                <div id="invoice-verification" style="display: none; background: var(--hover-bg); border: 2px solid var(--primary-color); padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                    <h3>Weryfikuj dane faktury przed zapisem</h3>
                    <form id="form-invoice-verify" class="form-grid">
                        <div class="form-group">
                            <label data-i18n="label.period">Okres (YYYY-MM)</label>
                            <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                        </div>
                        <div class="form-group">
                            <label>Zu≈ºycie (m¬≥)</label>
                            <input type="number" step="0.01" name="usage" required>
                        </div>
                        <div class="form-group">
                            <label>Koszt wody za m¬≥</label>
                            <input type="number" step="0.01" name="water_cost_m3" required>
                        </div>
                        <div class="form-group">
                            <label>Koszt ≈õciek√≥w za m¬≥</label>
                            <input type="number" step="0.01" name="sewage_cost_m3" required>
                        </div>
                        <div class="form-group">
                            <label>Liczba miesiƒôcy abonamentu</label>
                            <input type="number" name="nr_of_subscription" required>
                        </div>
                        <div class="form-group">
                            <label>Abonament woda (za miesiƒÖc)</label>
                            <input type="number" step="0.01" name="water_subscr_cost" required>
                        </div>
                        <div class="form-group">
                            <label>Abonament ≈õcieki (za miesiƒÖc)</label>
                            <input type="number" step="0.01" name="sewage_subscr_cost" required>
                        </div>
                        <div class="form-group">
                            <label>VAT (np. 0.08 dla 8%)</label>
                            <input type="number" step="0.01" name="vat" required>
                        </div>
                        <div class="form-group">
                            <label>Data poczƒÖtku okresu</label>
                            <input type="date" name="period_start" required>
                        </div>
                        <div class="form-group">
                            <label>Data ko≈Ñca okresu</label>
                            <input type="date" name="period_stop" required>
                        </div>
                        <div class="form-group">
                            <label>Numer faktury</label>
                            <input type="text" name="invoice_number" required>
                        </div>
                        <div class="form-group">
                            <label>Suma brutto</label>
                            <input type="number" step="0.01" name="gross_sum" required>
                        </div>
                    </form>
                    <button class="btn btn-success" onclick="verifyAndSaveInvoice()" data-i18n="button.verify_save">Zatwierd≈∫ i zapisz</button>
                    <button class="btn btn-secondary" onclick="cancelInvoiceVerification()" data-i18n="button.cancel">Anuluj</button>
                </div>
                
                    <!-- Przycisk do pokazania formularza rƒôcznego -->
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="toggleManualInvoiceForm()" id="btn-show-manual-invoice" style="text-transform: uppercase;" data-i18n="button.add_manual">LUB DODAJ RƒòCZNIE</button>
                    </div>

                <!-- Formularz rƒôcznego dodawania faktury (ukryty domy≈õlnie) -->
                <div id="invoice-manual-form" style="display: none;">
                    <h3 data-i18n="section.add_manual_invoice">Dodaj fakturƒô rƒôcznie</h3>
                    <form id="form-invoice" class="form-grid">
                        <div class="form-group">
                            <label data-i18n="label.period">Okres (YYYY-MM)</label>
                            <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                        </div>
                        <div class="form-group">
                            <label>Zu≈ºycie (m¬≥)</label>
                            <input type="number" step="0.01" name="usage" required>
                        </div>
                        <div class="form-group">
                            <label>Koszt wody za m¬≥</label>
                            <input type="number" step="0.01" name="water_cost_m3" required>
                        </div>
                        <div class="form-group">
                            <label>Koszt ≈õciek√≥w za m¬≥</label>
                            <input type="number" step="0.01" name="sewage_cost_m3" required>
                        </div>
                        <div class="form-group">
                            <label>Liczba miesiƒôcy abonamentu</label>
                            <input type="number" name="nr_of_subscription" required>
                        </div>
                        <div class="form-group">
                            <label>Abonament woda (za miesiƒÖc)</label>
                            <input type="number" step="0.01" name="water_subscr_cost" required>
                        </div>
                        <div class="form-group">
                            <label>Abonament ≈õcieki (za miesiƒÖc)</label>
                            <input type="number" step="0.01" name="sewage_subscr_cost" required>
                        </div>
                        <div class="form-group">
                            <label>VAT (np. 0.08 dla 8%)</label>
                            <input type="number" step="0.01" name="vat" required>
                        </div>
                        <div class="form-group">
                            <label>Data poczƒÖtku okresu</label>
                            <input type="date" name="period_start" required>
                        </div>
                        <div class="form-group">
                            <label>Data ko≈Ñca okresu</label>
                            <input type="date" name="period_stop" required>
                        </div>
                        <div class="form-group">
                            <label>Numer faktury</label>
                            <input type="text" name="invoice_number" required>
                        </div>
                        <div class="form-group">
                            <label>Suma brutto</label>
                            <input type="number" step="0.01" name="gross_sum" required>
                        </div>
                    </form>
                    <button class="btn btn-primary" onclick="addInvoice()" data-i18n="button.add_invoice">Dodaj fakturƒô</button>
                    <button class="btn btn-secondary" onclick="toggleManualInvoiceForm()" style="margin-left: 10px;" data-i18n="button.hide_form">Ukryj formularz</button>
                </div>
                
                <div id="invoices-list" class="loading">≈Åadowanie...</div>
            </div>

            <!-- Sekcja Rachunki -->
            <div id="tab-bills" class="tab-content">
                <h2 data-i18n="section.bills">Rachunki</h2>
                <div class="period-selector">
                    <label>Okres (YYYY-MM):</label>
                    <input type="text" id="bill-period" placeholder="2025-02" pattern="\d{4}-\d{2}" list="available-periods">
                    <datalist id="available-periods"></datalist>
                    <button class="btn btn-success" onclick="generateBills()" style="text-transform: uppercase;" data-i18n="button.generate_bills">GENERUJ RACHUNKI</button>
                    <button class="btn btn-success" onclick="regenerateBills()" style="text-transform: uppercase;" data-i18n="button.regenerate_bills">REGENERUJ RACHUNKI</button>
                </div>
                <p style="color: #666; margin-bottom: 20px; font-size: 0.85em; text-transform: uppercase; font-weight: normal;" data-i18n="info.period_format_water">
                    Podaj okres w formacie YYYY-MM. System automatycznie wygeneruje rachunki dla wszystkich lokali na podstawie faktur i odczyt√≥w.
                </p>
                
                <div id="bills-list" class="loading">≈Åadowanie...</div>
            </div>
            </div>  <!-- koniec medium-water -->

            <!-- Sekcje dla Gazu -->
            <div id="medium-gas" class="medium-content" style="display: none;">
                <!-- Statystyki gazu -->
                <div class="stats-grid" id="gas-stats" style="margin-bottom: 25px;">
                    <div class="stat-card clickable" onclick="showGasTab('gas-tab-invoices')">
                        <h3 id="gas-stat-invoices">-</h3>
                        <p data-i18n="stats.gas_invoices">Faktury gazu</p>
                    </div>
                    <div class="stat-card clickable" onclick="showGasTab('gas-tab-bills')">
                        <h3 id="gas-stat-bills">-</h3>
                        <p data-i18n="stats.gas_bills">Rachunki gazu</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="gas-stat-total">-</h3>
                        <p data-i18n="stats.total_gross">Suma brutto</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="gas-stat-latest-period">-</h3>
                        <p data-i18n="stats.latest_period">Najnowszy okres</p>
                    </div>
                </div>

                <!-- Sekcja Faktury gazu -->
                <div id="gas-tab-invoices" class="tab-content active">
                    <h2 data-i18n="section.gas_invoices">Faktury gazu (PGNiG)</h2>
                    
                    <div class="verification-banner">
                        <h3 style="text-transform: uppercase; font-size: 0.9em; font-weight: normal; color: #666;" data-i18n="info.verification">WERYFIKACJA FAKTUR</h3>
                        <p style="text-transform: uppercase; font-size: 0.85em; font-weight: normal; color: #666;" data-i18n="info.verification_text">
                            Po wczytaniu faktury PDF, dane zostanƒÖ wy≈õwietlone poni≈ºej do weryfikacji i ewentualnej zmiany przed zapisem do bazy danych.
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="text-transform: uppercase;" data-i18n="button.upload_pdf">WCZYTAJ FAKTURƒò PDF</h3>
                        <div class="file-input-wrapper">
                            <label for="gas-invoice-file" class="file-input-label" data-i18n="button.select_file">WYBIERZ PLIK</label>
                            <input type="file" id="gas-invoice-file" accept=".pdf" onchange="updateFileName('gas-invoice-file', 'gas-invoice-file-name')">
                            <span id="gas-invoice-file-name" class="file-name-display"></span>
                        </div>
                        <button class="btn btn-success" onclick="uploadGasInvoice()" style="text-transform: uppercase; margin-top: 10px;" data-i18n="button.upload_pdf">WCZYTAJ PDF</button>
                    </div>

                    <!-- Formularz weryfikacji faktury (ukryty do momentu parsowania) -->
                    <div id="gas-invoice-verification" style="display: none !important; background: var(--hover-bg); border: 2px solid var(--primary-color); padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                        <h3 data-i18n="label.verify_invoice">Weryfikuj dane faktury przed zapisem</h3>
                        <form id="form-gas-invoice-verify" class="form-grid">
                            <!-- RzƒÖd 1: Okres, Numer Faktury, Data poczƒÖtku okresu, Data ko≈Ñca okresu -->
                            <div class="form-group">
                                <label data-i18n="label.period">Okres (YYYY-MM)</label>
                                <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.invoice_number">Numer faktury</label>
                                <input type="text" name="invoice_number" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.period_start">Data poczƒÖtku okresu</label>
                                <input type="date" name="period_start" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.period_end">Data ko≈Ñca okresu</label>
                                <input type="date" name="period_stop" required>
                            </div>
                            
                            <!-- RzƒÖd 2: puste, Paliwo zu≈ºycie m¬≥, Odczyt poprzedni, Odczyt obecny -->
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label data-i18n="label.fuel_usage_m3">Paliwo zu≈ºycie (m¬≥)</label>
                                <input type="number" step="0.01" name="fuel_usage_m3" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.previous_reading">Odczyt poprzedni (m¬≥)</label>
                                <input type="number" step="0.01" name="previous_reading" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.current_reading">Odczyt obecny (m¬≥)</label>
                                <input type="number" step="0.01" name="current_reading" required>
                            </div>
                            
                            <!-- RzƒÖd 3: Paliwo - Wsp√≥≈Çczynnik konwersji, Paliwo - Zu≈ºycie kWh, Paliwo - Cena netto za kWh, Paliwo - Warto≈õƒá netto -->
                            <div class="form-group">
                                <label data-i18n="label.fuel_conversion_factor">Paliwo - Wsp√≥≈Çczynnik konwersji (kWh/m¬≥)</label>
                                <input type="number" step="0.0001" name="fuel_conversion_factor" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.fuel_usage_kwh">Paliwo - Zu≈ºycie (kWh)</label>
                                <input type="number" step="0.01" name="fuel_usage_kwh" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.fuel_price_net">Paliwo - Cena netto za kWh</label>
                                <input type="number" step="0.00001" name="fuel_price_net" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.fuel_value_net">Paliwo - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="fuel_value_net" required>
                            </div>
                            
                            <!-- RzƒÖd 4: puste, Abonament - Ilo≈õƒá miesiƒôcy, Abonament - Cena netto za miesiƒÖc, Abonament - Warto≈õƒá netto -->
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label data-i18n="label.subscription_quantity">Abonament - Ilo≈õƒá miesiƒôcy</label>
                                <input type="number" name="subscription_quantity" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.subscription_price_net">Abonament - Cena netto za miesiƒÖc</label>
                                <input type="number" step="0.01" name="subscription_price_net" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.subscription_value_net">Abonament - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="subscription_value_net" required>
                            </div>
                            
                            <!-- RzƒÖd 5: puste, Dystrybucja sta≈Ça - Ilo≈õƒá miesiƒôcy, Dystrybucja sta≈Ça - Cena netto za miesiƒÖc, Dystrybucja sta≈Ça - Warto≈õƒá netto -->
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label data-i18n="label.distribution_fixed_quantity">Dystrybucja sta≈Ça - Ilo≈õƒá miesiƒôcy</label>
                                <input type="number" name="distribution_fixed_quantity" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.distribution_fixed_price_net">Dystrybucja sta≈Ça - Cena netto za miesiƒÖc</label>
                                <input type="number" step="0.01" name="distribution_fixed_price_net" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.distribution_fixed_value_net">Dystrybucja sta≈Ça - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="distribution_fixed_value_net" required>
                            </div>
                            
                            <!-- RzƒÖd 6: puste, Dystrybucja zmienna - Zu≈ºycie m¬≥, Dystrybucja zmienna - Wsp. konw., Dystrybucja zmienna - Zu≈ºycie kWh -->
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label data-i18n="label.distribution_variable_usage_m3">Dystrybucja zmienna - Zu≈ºycie (m¬≥)</label>
                                <input type="number" step="0.01" name="distribution_variable_usage_m3" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.distribution_variable_conversion">Dystrybucja zmienna - Wsp. konw.</label>
                                <input type="number" step="0.0001" name="distribution_variable_conversion_factor" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.distribution_variable_usage_kwh">Dystrybucja zmienna - Zu≈ºycie (kWh)</label>
                                <input type="number" step="0.01" name="distribution_variable_usage_kwh" required>
                            </div>
                            
                            <!-- RzƒÖd 7: puste, puste, Dystrybucja zmienna - Cena netto za kWh, Dystrybucja zmienna - Warto≈õƒá netto -->
                            <div class="form-group empty"></div>
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label data-i18n="label.distribution_variable_price_net">Dystrybucja zmienna - Cena netto za kWh</label>
                                <input type="number" step="0.00001" name="distribution_variable_price_net" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.distribution_variable_value_net">Dystrybucja zmienna - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="distribution_variable_value_net" required>
                            </div>
                            
                            <!-- RzƒÖd 8: puste, Dystrybucja zmienna 2 - Zu≈ºycie m¬≥, Dystrybucja zmienna 2 - Wsp. konw., Dystrybucja zmienna 2 - Zu≈ºycie kWh -->
                            <div class="form-group empty" id="dist-var-2-empty-1"></div>
                            <div class="form-group" id="distribution-variable-2-group" style="display: none;">
                                <label>Dystrybucja zmienna 2 - Zu≈ºycie (m¬≥)</label>
                                <input type="number" step="0.01" name="distribution_variable_2_usage_m3">
                            </div>
                            <div class="form-group" id="distribution-variable-2-conv-group" style="display: none;">
                                <label>Dystrybucja zmienna 2 - Wsp. konw.</label>
                                <input type="number" step="0.0001" name="distribution_variable_2_conversion_factor">
                            </div>
                            <div class="form-group" id="distribution-variable-2-kwh-group" style="display: none;">
                                <label>Dystrybucja zmienna 2 - Zu≈ºycie (kWh)</label>
                                <input type="number" step="0.01" name="distribution_variable_2_usage_kwh">
                            </div>
                            
                            <!-- RzƒÖd 9: puste, puste, Dystr. zm. 2 - cena netto za kWh, Dystrybucja zmienna 2 - Warto≈õƒá netto -->
                            <div class="form-group empty"></div>
                            <div class="form-group empty"></div>
                            <div class="form-group" id="distribution-variable-2-price-group" style="display: none;">
                                <label>Dystr. zm. 2 - cena netto za kWh</label>
                                <input type="number" step="0.00001" name="distribution_variable_2_price_net">
                            </div>
                            <div class="form-group" id="distribution-variable-2-value-group" style="display: none;">
                                <label>Dystrybucja zmienna 2 - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="distribution_variable_2_value_net">
                            </div>
                            
                            <!-- RzƒÖd 11: Warto≈õƒá netto og√≥≈Çem, VAT, Kwota VAT, Warto≈õƒá brutto ca≈Ço≈õƒá -->
                            <div class="form-group">
                                <label data-i18n="label.total_net_sum">Warto≈õƒá netto og√≥≈Çem</label>
                                <input type="number" step="0.01" name="total_net_sum" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.vat_rate">VAT (np. 0.23 dla 23%)</label>
                                <input type="number" step="0.01" name="vat_rate" value="0.23" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.vat_amount">Kwota VAT og√≥≈Çem</label>
                                <input type="number" step="0.01" name="vat_amount" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.total_gross_sum">Warto≈õƒá brutto ca≈Ço≈õƒá</label>
                                <input type="number" step="0.01" name="total_gross_sum" required>
                            </div>
                            
                            <!-- RzƒÖd 12: Odsetki za nieterminowe wp≈Çaty, Termin p≈Çatno≈õci, puste, Do zap≈Çaty -->
                            <div class="form-group">
                                <label data-i18n="label.late_payment_interest">Odsetki za nieterminowe wp≈Çaty</label>
                                <input type="number" step="0.01" name="late_payment_interest" value="0" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.payment_due_date">Termin p≈Çatno≈õci</label>
                                <input type="date" name="payment_due_date" required>
                            </div>
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label data-i18n="label.amount_to_pay">Do zap≈Çaty</label>
                                <input type="number" step="0.01" name="amount_to_pay" required>
                            </div>
                        </form>
                        <button class="btn btn-success" onclick="verifyAndSaveGasInvoice()" data-i18n="button.verify_save">Zatwierd≈∫ i zapisz</button>
                        <button class="btn btn-secondary" onclick="cancelGasInvoiceVerification()" data-i18n="button.cancel">Anuluj</button>
                    </div>

                    <!-- Przycisk do pokazania formularza rƒôcznego -->
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="toggleManualGasInvoiceForm()" id="btn-show-manual-gas-invoice" style="text-transform: uppercase;" data-i18n="button.add_manual">LUB DODAJ RƒòCZNIE</button>
                    </div>

                    <!-- Formularz rƒôcznego dodawania faktury (ukryty domy≈õlnie) -->
                    <div id="gas-invoice-manual-form" style="display: none;">
                        <h3 data-i18n="section.add_manual_invoice">Dodaj fakturƒô rƒôcznie</h3>
                        <form id="form-gas-invoice" class="form-grid">
                        <div class="form-group">
                            <label data-i18n="label.period">Okres (YYYY-MM)</label>
                            <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                        </div>
                        <div class="form-group">
                            <label>Data poczƒÖtku okresu</label>
                            <input type="date" name="period_start" required>
                        </div>
                        <div class="form-group">
                            <label>Data ko≈Ñca okresu</label>
                            <input type="date" name="period_stop" required>
                        </div>
                        <div class="form-group">
                            <label>Odczyt poprzedni (m¬≥)</label>
                            <input type="number" step="0.01" name="previous_reading" required>
                        </div>
                        <div class="form-group">
                            <label>Odczyt obecny (m¬≥)</label>
                            <input type="number" step="0.01" name="current_reading" required>
                        </div>
                        <div class="form-group">
                            <label>Numer faktury</label>
                            <input type="text" name="invoice_number" required>
                        </div>
                        <div class="form-group">
                            <label>Paliwo - Warto≈õƒá brutto</label>
                            <input type="number" step="0.01" name="fuel_value_gross" required>
                        </div>
                        <div class="form-group">
                            <label>Abonament - Warto≈õƒá brutto</label>
                            <input type="number" step="0.01" name="subscription_value_gross" required>
                        </div>
                        <div class="form-group">
                            <label>Dystrybucja sta≈Ça - Warto≈õƒá brutto</label>
                            <input type="number" step="0.01" name="distribution_fixed_value_gross" required>
                        </div>
                        <div class="form-group">
                            <label>Dystrybucja zmienna - Warto≈õƒá brutto</label>
                            <input type="number" step="0.01" name="distribution_variable_value_gross" required>
                        </div>
                        <div class="form-group">
                            <label>Suma brutto ca≈Çej faktury</label>
                            <input type="number" step="0.01" name="total_gross_sum" required>
                        </div>
                        </form>
                        <button class="btn btn-primary" onclick="addGasInvoice()">Dodaj fakturƒô</button>
                        <button class="btn btn-secondary" onclick="toggleManualGasInvoiceForm()" style="margin-left: 10px;" data-i18n="button.hide_form">Ukryj formularz</button>
                    </div>
                    
                    <div id="gas-invoices-list" class="loading">≈Åadowanie...</div>
                </div>

                <!-- Sekcja Rachunki gazu -->
                <div id="gas-tab-bills" class="tab-content">
                    <h2 data-i18n="section.gas_bills">Rachunki gazu</h2>
                    <div class="period-selector">
                        <label>Okres (YYYY-MM):</label>
                        <input type="text" id="gas-bill-period" placeholder="2025-02" pattern="\d{4}-\d{2}" list="available-gas-periods">
                        <datalist id="available-gas-periods"></datalist>
                        <button class="btn btn-success" onclick="generateGasBills()" style="text-transform: uppercase;">GENERUJ RACHUNKI</button>
                    </div>
                    <p style="color: #666; margin-bottom: 20px; font-size: 0.85em; text-transform: uppercase; font-weight: normal;" data-i18n="info.period_format_gas">
                        Podaj okres w formacie YYYY-MM. System automatycznie wygeneruje rachunki dla wszystkich lokali na podstawie faktur gazu (58% gora, 25% dol, 17% gabinet).
                    </p>
                    
                    <div id="gas-bills-list" class="loading">≈Åadowanie...</div>
                </div>
            </div>  <!-- koniec medium-gas -->

            <!-- Sekcje dla PrƒÖdu -->
            <div id="medium-electricity" class="medium-content" style="display: none;">
                <!-- Statystyki prƒÖdu -->
                <div class="stats-grid" id="electricity-stats" style="margin-bottom: 25px;">
                    <div class="stat-card clickable" onclick="showElectricityTab('electricity-tab-readings')">
                        <h3 id="electricity-stat-readings">-</h3>
                        <p data-i18n="stats.readings">Odczyty</p>
                    </div>
                    <div class="stat-card clickable" onclick="showElectricityTab('electricity-tab-invoices')">
                        <h3 id="electricity-stat-invoices">-</h3>
                        <p data-i18n="stats.invoices">Faktury</p>
                    </div>
                    <div class="stat-card clickable" onclick="showElectricityTab('electricity-tab-bills')">
                        <h3 id="electricity-stat-bills">-</h3>
                        <p data-i18n="stats.bills">Rachunki</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="electricity-stat-total">-</h3>
                        <p data-i18n="stats.total_gross">Suma brutto</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="electricity-stat-latest-period">-</h3>
                        <p data-i18n="stats.latest_period">Najnowszy okres</p>
                    </div>
                </div>

                <!-- Sekcja Odczyty prƒÖdu -->
                <div id="electricity-tab-readings" class="tab-content active">
                    <h2 data-i18n="section.electricity_readings">Odczyty licznik√≥w prƒÖdu</h2>
                    <form id="form-electricity-reading" class="form-grid">
                        <div class="form-group">
                            <label data-i18n="label.period">Okres (YYYY-MM)</label>
                            <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                        </div>
                        <div class="form-group">
                            <label data-i18n="label.reading_date">Data odczytu licznika</label>
                            <input type="date" name="data_odczytu_licznika">
                        </div>
                        <div class="form-group">
                            <label data-i18n="label.meter_dom_single">Licznik DOM - Jednotaryfowy?</label>
                            <select name="licznik_dom_jednotaryfowy" onchange="toggleDomMeterType()">
                                <option value="true" data-i18n="label.yes_single">Tak (jednotaryfowy)</option>
                                <option value="false" data-i18n="label.no_dual">Nie (dwutaryfowy)</option>
                            </select>
                        </div>
                        <div class="form-group" id="dom-jednotaryfowy-group">
                            <label data-i18n="label.reading_dom_single">Odczyt DOM (jednotaryfowy)</label>
                            <input type="number" step="0.01" name="odczyt_dom">
                        </div>
                        <div class="form-group" id="dom-dwutaryfowy-group" style="display: none;">
                            <label data-i18n="label.reading_dom_tariff1">Odczyt DOM - Taryfa I</label>
                            <input type="number" step="0.01" name="odczyt_dom_I">
                        </div>
                        <div class="form-group" id="dom-dwutaryfowy-group-2" style="display: none;">
                            <label data-i18n="label.reading_dom_tariff2">Odczyt DOM - Taryfa II</label>
                            <input type="number" step="0.01" name="odczyt_dom_II">
                        </div>
                        <div class="form-group">
                            <label data-i18n="label.meter_dol_single">Licznik D√ì≈Å - Jednotaryfowy?</label>
                            <select name="licznik_dol_jednotaryfowy" onchange="toggleDolMeterType()">
                                <option value="true" data-i18n="label.yes_single">Tak (jednotaryfowy)</option>
                                <option value="false" data-i18n="label.no_dual">Nie (dwutaryfowy)</option>
                            </select>
                        </div>
                        <div class="form-group" id="dol-jednotaryfowy-group">
                            <label data-i18n="label.reading_dol_single">Odczyt D√ì≈Å (jednotaryfowy)</label>
                            <input type="number" step="0.01" name="odczyt_dol">
                        </div>
                        <div class="form-group" id="dol-dwutaryfowy-group" style="display: none;">
                            <label data-i18n="label.reading_dol_tariff1">Odczyt D√ì≈Å - Taryfa I</label>
                            <input type="number" step="0.01" name="odczyt_dol_I">
                        </div>
                        <div class="form-group" id="dol-dwutaryfowy-group-2" style="display: none;">
                            <label data-i18n="label.reading_dol_tariff2">Odczyt D√ì≈Å - Taryfa II</label>
                            <input type="number" step="0.01" name="odczyt_dol_II">
                        </div>
                        <div class="form-group">
                            <label data-i18n="label.reading_gabinet">Odczyt GABINET (zawsze jednotaryfowy)</label>
                            <input type="number" step="0.01" name="odczyt_gabinet" required>
                        </div>
                    </form>
                    <button class="btn btn-success" onclick="addElectricityReading()" style="text-transform: uppercase;" data-i18n="button.add_reading">DODAJ ODCZYT</button>
                    
                    <div id="electricity-readings-list" class="loading">≈Åadowanie...</div>
                </div>

                <!-- Sekcja Faktury prƒÖdu -->
                <div id="electricity-tab-invoices" class="tab-content">
                    <h2 data-i18n="section.electricity_invoices">Faktury prƒÖdu (ENEA)</h2>
                    
                    <div class="verification-banner">
                        <h3 style="text-transform: uppercase; font-size: 0.9em; font-weight: normal; color: #666;" data-i18n="info.verification">WERYFIKACJA FAKTUR</h3>
                        <p style="text-transform: uppercase; font-size: 0.85em; font-weight: normal; color: #666;" data-i18n="info.verification_text">
                            Po wczytaniu faktury PDF, dane zostanƒÖ wy≈õwietlone poni≈ºej do weryfikacji i ewentualnej zmiany przed zapisem do bazy danych.
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="text-transform: uppercase;" data-i18n="button.upload_pdf">WCZYTAJ FAKTURƒò PDF</h3>
                        <div class="file-input-wrapper">
                            <label for="electricity-invoice-file" class="file-input-label" data-i18n="button.select_file">WYBIERZ PLIK</label>
                            <input type="file" id="electricity-invoice-file" accept=".pdf" onchange="updateFileName('electricity-invoice-file', 'electricity-invoice-file-name')">
                            <span id="electricity-invoice-file-name" class="file-name-display"></span>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-success" onclick="uploadElectricityInvoice()" style="text-transform: uppercase;" data-i18n="button.upload_pdf">WCZYTAJ PDF</button>
                            <button id="electricity-verify-btn-top" class="btn btn-success" onclick="verifyAndSaveElectricityInvoice()" style="text-transform: uppercase; display: none;" data-i18n="button.verify_save">ZATWIERD≈π I ZAPISZ</button>
                        </div>
                    </div>

                    <!-- Formularz weryfikacji faktury (ukryty do momentu parsowania) -->
                    <div id="electricity-invoice-verification" style="display: none; background: var(--hover-bg); border: 2px solid var(--primary-color); padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                        <h3 data-i18n="label.verify_invoice">Weryfikuj dane faktury przed zapisem</h3>
                        <form id="form-electricity-invoice-verify" class="form-grid">
                            <div class="form-group">
                                <label>Rok</label>
                                <input type="number" name="rok" placeholder="2021" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.invoice_number">Numer faktury</label>
                                <input type="text" name="numer_faktury" required>
                            </div>
                            <div class="form-group">
                                <label>Data wystawienia</label>
                                <input type="date" name="data_wystawienia" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.period_start">Data poczƒÖtku okresu</label>
                                <input type="date" name="data_poczatku_okresu" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.period_end">Data ko≈Ñca okresu</label>
                                <input type="date" name="data_konca_okresu" required>
                            </div>
                            <div class="form-group">
                                <label>Nale≈ºno≈õƒá za okres</label>
                                <input type="number" step="0.01" name="naleznosc_za_okres" required>
                            </div>
                            <div class="form-group">
                                <label>Warto≈õƒá prognozy</label>
                                <input type="number" step="0.01" name="wartosc_prognozy" required>
                            </div>
                            <div class="form-group">
                                <label>Faktury korygujƒÖce</label>
                                <input type="number" step="0.01" name="faktury_korygujace" value="0" required>
                            </div>
                            <div class="form-group">
                                <label>Odsetki</label>
                                <input type="number" step="0.01" name="odsetki" value="0" required>
                            </div>
                            <div class="form-group">
                                <label>Wynik rozliczenia</label>
                                <input type="number" step="0.01" name="wynik_rozliczenia" required>
                            </div>
                            <div class="form-group">
                                <label>Kwota nadp≈Çacona</label>
                                <input type="number" step="0.01" name="kwota_nadplacona" value="0" required>
                            </div>
                            <div class="form-group">
                                <label>Saldo z rozliczenia</label>
                                <input type="number" step="0.01" name="saldo_z_rozliczenia" required>
                            </div>
                            <div class="form-group">
                                <label>Niedop≈Çata/Nadp≈Çata</label>
                                <input type="number" step="0.01" name="niedoplata_nadplata" required>
                            </div>
                            <div class="form-group">
                                <label>Energia do akcyzy (kWh)</label>
                                <input type="number" name="energia_do_akcyzy_kwh" required>
                            </div>
                            <div class="form-group">
                                <label>Akcyza</label>
                                <input type="number" step="0.01" name="akcyza" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.amount_to_pay">Do zap≈Çaty</label>
                                <input type="number" step="0.01" name="do_zaplaty" required>
                            </div>
                            <div class="form-group">
                                <label>Zu≈ºycie (kWh)</label>
                                <input type="number" name="zuzycie_kwh" required>
                            </div>
                            <div class="form-group">
                                <label>Og√≥≈Çem sprzeda≈º energii</label>
                                <input type="number" step="0.01" name="ogolem_sprzedaz_energii" required>
                            </div>
                            <div class="form-group">
                                <label>Og√≥≈Çem us≈Çuga dystrybucji</label>
                                <input type="number" step="0.01" name="ogolem_usluga_dystrybucji" required>
                            </div>
                            <div class="form-group">
                                <label>Grupa taryfowa</label>
                                <input type="text" name="grupa_taryfowa" placeholder="G12" required>
                            </div>
                            <div class="form-group">
                                <label>Typ taryfy</label>
                                <select name="typ_taryfy" required>
                                    <option value="DWUTARYFOWA">Dwutaryfowa (dzienna/nocna)</option>
                                    <option value="CA≈ÅODOBOWA">Ca≈Çodobowa (jednotaryfowa)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Energia ≈ÇƒÖcznie zu≈ºyta w roku (kWh)</label>
                                <input type="number" name="energia_lacznie_zuzyta_w_roku_kwh" required>
                            </div>
                        </form>
                        
                        <!-- Sekcje dla pozosta≈Çych tabel szczeg√≥≈Çowych -->
                        <div style="margin-top: 30px; border-top: 2px solid var(--primary-color); padding-top: 20px;">
                            <h4 style="color: var(--primary-color); margin-bottom: 15px;">üìã Szczeg√≥≈Çowe dane faktury</h4>
                            
                            <!-- Blankiety prognozowe -->
                            <div id="electricity-blankiety-section" style="margin-bottom: 20px; display: none;">
                                <h5 style="margin-bottom: 10px;">Blankiety prognozowe</h5>
                                <div id="electricity-blankiety-list" style="overflow-x: auto;">
                                    <div id="electricity-blankiety-editable"></div>
                                </div>
                            </div>
                            
                            <!-- Odczyty licznik√≥w -->
                            <div id="electricity-odczyty-section" style="margin-bottom: 20px; display: none;">
                                <h5 style="margin-bottom: 10px;">Odczyty licznik√≥w</h5>
                                <div id="electricity-odczyty-list" style="overflow-x: auto;">
                                    <div id="electricity-odczyty-editable"></div>
                                </div>
                            </div>
                            
                            <!-- Sprzeda≈º energii -->
                            <div id="electricity-sprzedaz-section" style="margin-bottom: 20px; display: none;">
                                <h5 style="margin-bottom: 10px;">Sprzeda≈º energii (szczeg√≥≈Çowa)</h5>
                                <div id="electricity-sprzedaz-list" style="overflow-x: auto;">
                                    <div id="electricity-sprzedaz-editable"></div>
                                </div>
                            </div>
                            
                            <!-- Op≈Çaty dystrybucyjne -->
                            <div id="electricity-oplaty-section" style="margin-bottom: 20px; display: none;">
                                <h5 style="margin-bottom: 10px;">Op≈Çaty dystrybucyjne (szczeg√≥≈Çowe)</h5>
                                <div id="electricity-oplaty-list" style="overflow-x: auto;">
                                    <div id="electricity-oplaty-editable"></div>
                                </div>
                            </div>
                            
                            <!-- Rozliczenie okres√≥w -->
                            <div id="electricity-rozliczenie-section" style="margin-bottom: 20px; display: none;">
                                <h5 style="margin-bottom: 10px;">Rozliczenie okres√≥w</h5>
                                <div id="electricity-rozliczenie-list" style="overflow-x: auto;">
                                    <div id="electricity-rozliczenie-editable"></div>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="verifyAndSaveElectricityInvoice()" data-i18n="button.verify_save">Zatwierd≈∫ i zapisz</button>
                        <button class="btn btn-secondary" onclick="cancelElectricityInvoiceVerification()" data-i18n="button.cancel">Anuluj</button>
                    </div>

                    <!-- Przycisk do pokazania formularza rƒôcznego -->
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="toggleManualElectricityInvoiceForm()" id="btn-show-manual-electricity-invoice" style="text-transform: uppercase;" data-i18n="button.add_manual">LUB DODAJ RƒòCZNIE</button>
                    </div>

                    <!-- Formularz rƒôcznego dodawania faktury (ukryty domy≈õlnie) -->
                    <div id="electricity-invoice-manual-form" style="display: none;">
                        <h3 data-i18n="section.add_manual_invoice">Dodaj fakturƒô rƒôcznie</h3>
                        <form id="form-electricity-invoice" class="form-grid">
                            <div class="form-group">
                                <label data-i18n="label.period">Okres (YYYY-MM)</label>
                                <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.invoice_number">Numer faktury</label>
                                <input type="text" name="invoice_number" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.period_start">Data poczƒÖtku okresu</label>
                                <input type="date" name="period_start" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.period_end">Data ko≈Ñca okresu</label>
                                <input type="date" name="period_stop" required>
                            </div>
                            <div class="form-group">
                                <label>Zu≈ºycie (kWh)</label>
                                <input type="number" step="0.01" name="usage_kwh" required>
                            </div>
                            <div class="form-group">
                                <label>Cena energii netto za kWh</label>
                                <input type="number" step="0.0001" name="energy_price_net" required>
                            </div>
                            <div class="form-group">
                                <label>Warto≈õƒá energii netto</label>
                                <input type="number" step="0.01" name="energy_value_net" required>
                            </div>
                            <div class="form-group">
                                <label>VAT energii</label>
                                <input type="number" step="0.01" name="energy_vat_amount" required>
                            </div>
                            <div class="form-group">
                                <label>Warto≈õƒá energii brutto</label>
                                <input type="number" step="0.01" name="energy_value_gross" required>
                            </div>
                            <div class="form-group">
                                <label>Op≈Çaty dystrybucyjne netto</label>
                                <input type="number" step="0.01" name="distribution_fees_net" value="0">
                            </div>
                            <div class="form-group">
                                <label>Op≈Çaty dystrybucyjne VAT</label>
                                <input type="number" step="0.01" name="distribution_fees_vat" value="0">
                            </div>
                            <div class="form-group">
                                <label>Op≈Çaty dystrybucyjne brutto</label>
                                <input type="number" step="0.01" name="distribution_fees_gross" value="0">
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.vat_rate">VAT (np. 0.23 dla 23%)</label>
                                <input type="number" step="0.01" name="vat_rate" value="0.23" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.vat_amount">Kwota VAT og√≥≈Çem</label>
                                <input type="number" step="0.01" name="vat_amount" required>
                            </div>
                            <div class="form-group">
                                <label>Suma netto</label>
                                <input type="number" step="0.01" name="total_net_sum" required>
                            </div>
                            <div class="form-group">
                                <label>Suma brutto</label>
                                <input type="number" step="0.01" name="total_gross_sum" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.amount_to_pay">Do zap≈Çaty</label>
                                <input type="number" step="0.01" name="amount_to_pay" required>
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.payment_due_date">Termin p≈Çatno≈õci</label>
                                <input type="date" name="payment_due_date" required>
                            </div>
                        </form>
                        <button class="btn btn-primary" onclick="addElectricityInvoice()">Dodaj fakturƒô</button>
                        <button class="btn btn-secondary" onclick="toggleManualElectricityInvoiceForm()" style="margin-left: 10px;" data-i18n="button.hide_form">Ukryj formularz</button>
                    </div>
                    
                    <div id="electricity-invoices-list" class="loading">≈Åadowanie...</div>
                </div>

                <!-- Sekcja Rachunki prƒÖdu -->
                <div id="electricity-tab-bills" class="tab-content">
                    <h2 data-i18n="section.electricity_bills">Rachunki prƒÖdu</h2>
                    <div id="electricity-periods-info" style="margin-bottom: 15px; padding: 10px; background: var(--hover-bg); border-radius: 5px; font-size: 0.85em; text-transform: uppercase; font-weight: normal; color: #666;">
                        <span id="electricity-periods-status" style="color: #666;">≈Åadowanie dostƒôpnych okres√≥w...</span>
                    </div>
                    <div id="electricity-periods-calendar" style="margin-bottom: 20px; display: none;">
                        <div id="electricity-periods-buttons" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;"></div>
                    </div>
                    <div class="period-selector">
                        <input type="hidden" id="electricity-bill-period">
                        <button class="btn btn-success" onclick="generateElectricityBills()" style="text-transform: uppercase;">GENERUJ RACHUNKI</button>
                        <button class="btn btn-danger" onclick="deleteAllElectricityBills()" style="text-transform: uppercase; margin-left: 10px;">USU≈É WSZYSTKIE RACHUNKI</button>
                    </div>
                    <p style="color: #666; margin-bottom: 20px; font-size: 0.85em; text-transform: uppercase; font-weight: normal;" data-i18n="info.period_format_electricity">
                        Wybierz okres z dostƒôpnych powy≈ºej. Pokazane sƒÖ tylko okresy, dla kt√≥rych istniejƒÖ zar√≥wno faktury jak i odczyty.
                    </p>
                    
                    <div id="electricity-bills-list" class="loading">≈Åadowanie...</div>
                </div>
            </div>  <!-- koniec medium-electricity -->
        </div>

        <!-- Sekcja rachunk√≥w ≈ÇƒÖczonych -->
        <div id="combined-bills-section" class="section" style="display: none;">
            <!-- Przycisk powrotu -->
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="backToMain()" style="display: flex; align-items: center; gap: 10px; text-transform: uppercase;">
                    <span>‚Üê</span> <span data-i18n="button.back">POWR√ìT DO G≈Å√ìWNEJ STRONY</span>
                </button>
            </div>

            <h2 data-i18n="section.combined_bills">RACHUNKI ≈ÅƒÑCZONE (WODA, GAZ, PRƒÑD)</h2>
            
            <div id="combined-bills-list" class="loading">≈Åadowanie...</div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // Tab switching
        function showTab(tabName) {
            // Usu≈Ñ aktywne z wszystkich zak≈Çadek
            document.querySelectorAll('#medium-water .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#medium-water .tab-content').forEach(t => t.classList.remove('active'));
            
            // Znajd≈∫ odpowiedni przycisk i ustaw go jako aktywny
            const tabButtons = document.querySelectorAll('#medium-water .tab');
            tabButtons.forEach(btn => {
                if ((tabName === 'locals' && btn.textContent.includes('Lokale')) ||
                    (tabName === 'readings' && btn.textContent.includes('Odczyty')) ||
                    (tabName === 'invoices' && btn.textContent.includes('Faktury')) ||
                    (tabName === 'bills' && btn.textContent.includes('Rachunki'))) {
                    btn.classList.add('active');
                }
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Od≈õwie≈º dane dla aktywnej zak≈Çadki
            if (tabName === 'locals') loadLocals();
            if (tabName === 'readings') loadReadings();
            if (tabName === 'invoices') loadInvoices();
            if (tabName === 'bills') loadBills();
        }

        // Aktualizacja nazwy pliku
        function updateFileName(inputId, displayId) {
            const fileInput = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            if (fileInput.files && fileInput.files.length > 0) {
                display.textContent = fileInput.files[0].name;
            } else {
                display.textContent = '';
            }
        }

        // Alerty
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type} show`;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        // Statystyki wody
        async function loadWaterStats() {
            try {
                const res = await fetch(`${API_BASE}/api/water/stats`);
                const stats = await res.json();
                document.getElementById('water-stat-locals').textContent = stats.locals_count || 0;
                document.getElementById('water-stat-readings').textContent = stats.readings_count || 0;
                document.getElementById('water-stat-invoices').textContent = stats.invoices_count || 0;
                document.getElementById('water-stat-bills').textContent = stats.bills_count || 0;
                document.getElementById('water-stat-total').textContent = (stats.total_gross_sum || 0).toFixed(2) + ' z≈Ç';
                document.getElementById('water-stat-latest-period').textContent = stats.latest_period || '-';
                
                // Aktualizuj listƒô dostƒôpnych okres√≥w
                const datalist = document.getElementById('available-periods');
                datalist.innerHTML = '';
                if (stats.available_periods && stats.available_periods.length > 0) {
                    stats.available_periods.forEach(period => {
                        const option = document.createElement('option');
                        option.value = period;
                        datalist.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania statystyk wody:', error);
            }
        }

        // Lokale
        async function loadLocals() {
            try {
                const res = await fetch(`${API_BASE}/api/water/locals/`);
                const locals = await res.json();
                const listEl = document.getElementById('locals-list');
                
                if (locals.length === 0) {
                    listEl.innerHTML = '<p>Brak lokali</p>';
                    return;
                }

                let html = `<table class="data-table"><thead><tr><th data-i18n="table.meter">Licznik</th><th data-i18n="table.tenant">Najemca</th><th data-i18n="table.local">Lokal</th><th>Email</th><th data-i18n="table.actions">Akcje</th></tr></thead><tbody>`;
                locals.forEach(l => {
                    html += `<tr>
                        <td>${l.water_meter_name}</td>
                        <td>${l.tenant}</td>
                        <td>${l.local}</td>
                        <td>${l.email || '<span style="color: #999;">-</span>'}</td>
                        <td class="actions">
                            <button class="btn btn-edit btn-small" data-local-id="${l.id}" data-local-email="${(l.email || '').replace(/"/g, '&quot;')}" onclick="editLocalEmailFromButton(this)" title="Edytuj email">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteLocal(${l.id})" title="Usu≈Ñ lokal">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
                updateTexts();
            } catch (error) {
                document.getElementById('locals-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania lokali</p>';
            }
        }

        async function addLocal() {
            const form = document.getElementById('form-local');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                params.append(key, value);
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/locals/?${params}`, { method: 'POST' });
                if (res.ok) {
                    showAlert('Lokal dodany pomy≈õlnie!');
                    form.reset();
                    loadLocals();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    const errorMsg = error.detail || 'B≈ÇƒÖd dodawania lokalu';
                    // Je≈õli lokal ju≈º istnieje, poka≈º bardziej szczeg√≥≈Çowy komunikat
                    if (errorMsg.includes('ju≈º istnieje')) {
                        showAlert(errorMsg + ' U≈ºyj opcji edycji aby zaktualizowaƒá.', 'error');
                    } else {
                        showAlert(errorMsg, 'error');
                    }
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        function editLocalEmailFromButton(button) {
            const localId = button.getAttribute('data-local-id');
            const currentEmail = button.getAttribute('data-local-email') || '';
            editLocalEmail(localId, currentEmail);
        }
        
        function editLocalEmail(localId, currentEmail) {
            const newEmail = prompt('Wprowad≈∫ nowy email:', currentEmail || '');
            if (newEmail === null) {
                return; // U≈ºytkownik anulowa≈Ç
            }
            
            // Walidacja emaila (podstawowa)
            if (newEmail && !newEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                showAlert('Nieprawid≈Çowy format emaila', 'error');
                return;
            }
            
            // Wy≈õlij ≈ºƒÖdanie PUT
            const params = new URLSearchParams();
            params.append('email', newEmail || '');
            
            fetch(`${API_BASE}/api/water/locals/${localId}?${params}`, {
                method: 'PUT'
            })
            .then(res => res.json())
            .then(data => {
                if (data.message) {
                    showAlert('Email zaktualizowany pomy≈õlnie!');
                    loadLocals();
                } else {
                    showAlert('B≈ÇƒÖd aktualizacji emaila', 'error');
                }
            })
            .catch(error => {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            });
        }

        // Odczyty
        async function loadReadings() {
            try {
                const res = await fetch(`${API_BASE}/api/water/readings/`);
                const readings = await res.json();
                const listEl = document.getElementById('readings-list');
                
                if (readings.length === 0) {
                    listEl.innerHTML = '<p>Brak odczyt√≥w</p>';
                    return;
                }

                let html = `<table class="data-table"><thead><tr><th data-i18n="table.period">Okres</th><th data-i18n="table.main_meter">Licznik g≈Ç√≥wny</th><th data-i18n="table.meter_5">Licznik 5 (gora)</th><th data-i18n="table.meter_5a">Licznik 5a (gabinet)</th><th data-i18n="table.actions">Akcje</th></tr></thead><tbody>`;
                readings.forEach(r => {
                    html += `<tr class="clickable" onclick="toggleReadingDetails('${r.data}')" data-reading-period="${r.data}">
                        <td>${r.data}</td>
                        <td>${r.water_meter_main}</td>
                        <td>${r.water_meter_5}</td>
                        <td>${r.water_meter_5a || 0}</td>
                        <td class="actions" onclick="event.stopPropagation()">
                            <button class="btn btn-edit btn-small" onclick="editReading('${r.data}')" title="Edytuj odczyt">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteReading('${r.data}')" title="Usu≈Ñ odczyt i rachunki dla tego okresu">üóëÔ∏è</button>
                        </td>
                    </tr>
                    <tr class="details-row" id="reading-details-${r.data}" data-reading-period="${r.data}">
                        <td colspan="5" class="details-cell">
                            <div class="details-grid">
                                <div class="details-item"><label data-i18n="details.period">Okres:</label><span class="value">${r.data}</span></div>
                                <div class="details-item"><label data-i18n="details.main_meter">Licznik g≈Ç√≥wny (DOM):</label><span class="value">${r.water_meter_main}</span></div>
                                <div class="details-item"><label data-i18n="details.meter_5">Licznik 5 (gora):</label><span class="value">${r.water_meter_5}</span></div>
                                <div class="details-item"><label data-i18n="details.meter_5a">Licznik 5a (gabinet):</label><span class="value">${r.water_meter_5a || 0}</span></div>
                            </div>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
                updateTexts();
            } catch (error) {
                document.getElementById('readings-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania odczyt√≥w</p>';
            }
        }

        async function addReading() {
            const form = document.getElementById('form-reading');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            // Only send main, gora (5), and gabinet (5a) - dol (5b) is calculated on server
            params.append('data', formData.get('data'));
            params.append('water_meter_main', formData.get('water_meter_main'));
            params.append('water_meter_5', formData.get('water_meter_5'));
            params.append('water_meter_5a', formData.get('water_meter_5a'));

            try {
                const res = await fetch(`${API_BASE}/api/water/readings/?${params}`, { method: 'POST' });
                if (res.ok) {
                    showAlert('Odczyt dodany pomy≈õlnie!');
                    form.reset();
                    document.getElementById('calculated_dol').value = '';
                    loadReadings();
                    loadWaterStats();
                    
                    // Poka≈º przycisk do wysy≈Çania stanu licznika do dostawcy
                    document.getElementById('send-to-provider-container').style.display = 'block';
                    updateTexts(); // Zaktualizuj teksty przycisku
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd dodawania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function showCredentialsDialog(credentials) {
            // Utw√≥rz okno dialogowe z danymi logowania
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 10px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <h2 style="margin-top: 0; color: #333;">Dane logowania AQUANET</h2>
                <p style="color: #666; margin-bottom: 20px;">Skopiuj dane i wklej je w formularzu logowania:</p>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Login:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="cred-username" value="${credentials.username}" readonly 
                               style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                        <button onclick="copyToClipboard('cred-username')" 
                                style="padding: 10px 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Kopiuj
                        </button>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Has≈Ço:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="password" id="cred-password" value="${credentials.password}" readonly 
                               style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                        <button onclick="copyToClipboard('cred-password')" 
                                style="padding: 10px 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Kopiuj
                        </button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" 
                            style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Zamknij
                    </button>
                </div>
            `;
            
            dialog.appendChild(content);
            document.body.appendChild(dialog);
            
            // Zamknij po klikniƒôciu w t≈Ço
            dialog.addEventListener('click', (e) => {
                if (e.target === dialog) {
                    dialog.remove();
                }
            });
        }
        
        async function copyToClipboard(inputId) {
            const input = document.getElementById(inputId);
            const text = input.value;
            
            try {
                // U≈ºyj nowoczesnego API Clipboard
                await navigator.clipboard.writeText(text);
                
                // Poka≈º potwierdzenie
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Skopiowano!';
                button.style.background = '#45a049';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#4CAF50';
                }, 2000);
            } catch (err) {
                // Fallback dla starszych przeglƒÖdarek
                input.select();
                input.setSelectionRange(0, 99999);
                document.execCommand('copy');
                
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Skopiowano!';
                button.style.background = '#45a049';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#4CAF50';
                }, 2000);
            }
        }

        async function showCredentialsManually() {
            try {
                // Sprawd≈∫ czy dane logowania sƒÖ zapisane
                const checkRes = await fetch(`${API_BASE}/api/water/credentials/exists/`);
                const checkData = await checkRes.json();
                
                if (!checkData.exists) {
                    showAlert('Najpierw zapisz dane logowania do AQUANET w opcjach', 'error');
                    return;
                }
                
                // Pobierz dane logowania
                const credRes = await fetch(`${API_BASE}/api/water/credentials/`);
                if (!credRes.ok) {
                    showAlert('B≈ÇƒÖd pobierania danych logowania', 'error');
                    return;
                }
                const credentials = await credRes.json();
                
                // Poka≈º okno dialogowe z danymi logowania
                showCredentialsDialog(credentials);
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                showAlert('B≈ÇƒÖd pobierania danych logowania', 'error');
            }
        }

        async function sendReadingToProvider() {
            try {
                // Sprawd≈∫ czy dane logowania sƒÖ zapisane
                const checkRes = await fetch(`${API_BASE}/api/water/credentials/exists/`);
                const checkData = await checkRes.json();
                
                if (!checkData.exists) {
                    showAlert('Najpierw zapisz dane logowania do AQUANET w opcjach', 'error');
                    return;
                }
                
                // Pobierz dane logowania
                const credRes = await fetch(`${API_BASE}/api/water/credentials/`);
                if (!credRes.ok) {
                    showAlert('B≈ÇƒÖd pobierania danych logowania', 'error');
                    return;
                }
                const credentials = await credRes.json();
                
                // Otw√≥rz stronƒô logowania AQUANET w nowym oknie
                const aquanetUrl = 'https://ebok.aquanet.pl/user/login';
                const newWindow = window.open(aquanetUrl, '_blank');
                
                if (!newWindow) {
                    showAlert('Nie mo≈ºna otworzyƒá nowego okna. Sprawd≈∫ blokadƒô wyskakujƒÖcych okien.', 'error');
                    return;
                }
                
                showAlert('Otwieranie strony AQUANET...', 'info');
                
                // Poczekaj na za≈Çadowanie strony i automatycznie wype≈Çnij formularz
                let attempts = 0;
                const maxAttempts = 10; // 10 pr√≥b co 500ms = 5 sekund
                
                const tryAutoLogin = setInterval(() => {
                    attempts++;
                    try {
                        // Sprawd≈∫ czy okno jest nadal otwarte
                        if (newWindow.closed) {
                            clearInterval(tryAutoLogin);
                            return;
                        }
                        
                        // Spr√≥buj znale≈∫ƒá pola formularza (r√≥≈ºne mo≈ºliwe selektory)
                        const emailInput = newWindow.document.querySelector('input[name="email"]') || 
                                          newWindow.document.querySelector('input[type="email"]') ||
                                          newWindow.document.querySelector('input[id*="email"]') ||
                                          newWindow.document.querySelector('input[id*="login"]') ||
                                          newWindow.document.querySelector('input[id*="user"]') ||
                                          newWindow.document.querySelector('input[placeholder*="email" i]') ||
                                          newWindow.document.querySelector('input[placeholder*="login" i]') ||
                                          newWindow.document.querySelector('form input:not([type="password"]):not([type="submit"]):not([type="button"])');
                        
                        const passwordInput = newWindow.document.querySelector('input[name="password"]') || 
                                             newWindow.document.querySelector('input[type="password"]') ||
                                             newWindow.document.querySelector('input[id*="password"]') ||
                                             newWindow.document.querySelector('input[id*="pass"]') ||
                                             newWindow.document.querySelector('input[placeholder*="has≈Ço" i]') ||
                                             newWindow.document.querySelector('input[placeholder*="password" i]');
                        
                        if (emailInput && passwordInput) {
                            // Najpierw wyczy≈õƒá pola (aby usunƒÖƒá stare dane z autouzupe≈Çniania)
                            emailInput.value = '';
                            passwordInput.value = '';
                            
                            // Wywo≈Çaj eventy focus i blur, aby wyczy≈õciƒá autouzupe≈Çnianie
                            emailInput.focus();
                            emailInput.blur();
                            passwordInput.focus();
                            passwordInput.blur();
                            
                            // Poczekaj chwilƒô, a nastƒôpnie wype≈Çnij nowymi danymi
                            setTimeout(() => {
                                try {
                                    // Ustaw warto≈õci
                                    emailInput.value = credentials.username;
                                    passwordInput.value = credentials.password;
                                    
                                    // Wywo≈Çaj eventy zmiany warto≈õci (niekt√≥re strony ich wymagajƒÖ)
                                    emailInput.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
                                    emailInput.dispatchEvent(new Event('change', { bubbles: true, cancelable: true }));
                                    emailInput.dispatchEvent(new KeyboardEvent('keydown', { bubbles: true }));
                                    emailInput.dispatchEvent(new KeyboardEvent('keyup', { bubbles: true }));
                                    
                                    passwordInput.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
                                    passwordInput.dispatchEvent(new Event('change', { bubbles: true, cancelable: true }));
                                    passwordInput.dispatchEvent(new KeyboardEvent('keydown', { bubbles: true }));
                                    passwordInput.dispatchEvent(new KeyboardEvent('keyup', { bubbles: true }));
                                    
                                    // Ustaw focus na pole email, aby przeglƒÖdarka nie nadpisa≈Ça warto≈õci
                                    emailInput.focus();
                                    
                                    // Znajd≈∫ i kliknij przycisk logowania po kr√≥tkiej chwili
                                    setTimeout(() => {
                                        try {
                                            const loginButton = newWindow.document.querySelector('button[type="submit"]') || 
                                                               newWindow.document.querySelector('input[type="submit"]') ||
                                                               newWindow.document.querySelector('button.btn-primary') ||
                                                               newWindow.document.querySelector('button[class*="login"]') ||
                                                               newWindow.document.querySelector('form button') ||
                                                               newWindow.document.querySelector('button:not([type="button"])');
                                            
                                            if (loginButton) {
                                                loginButton.click();
                                                showAlert('Automatyczne logowanie zako≈Ñczone', 'success');
                                            } else {
                                                showAlert('Formularz wype≈Çniony. Kliknij przycisk logowania rƒôcznie.', 'info');
                                            }
                                        } catch (btnError) {
                                            console.error('B≈ÇƒÖd klikniƒôcia przycisku:', btnError);
                                            showAlert('Formularz wype≈Çniony. Kliknij przycisk logowania rƒôcznie.', 'info');
                                        }
                                    }, 300);
                                    
                                    clearInterval(tryAutoLogin);
                                } catch (fillError) {
                                    console.error('B≈ÇƒÖd wype≈Çniania formularza:', fillError);
                                    clearInterval(tryAutoLogin);
                                    showAlert('Nie mo≈ºna automatycznie wype≈Çniƒá formularza. Wype≈Çnij go rƒôcznie.', 'warning');
                                }
                            }, 200);
                            
                            return; // Wyjd≈∫ z funkcji, bo ju≈º obs≈Çu≈ºyli≈õmy wype≈Çnienie
                        } else if (attempts >= maxAttempts) {
                            clearInterval(tryAutoLogin);
                            showAlert('Nie mo≈ºna automatycznie wype≈Çniƒá formularza. Wype≈Çnij go rƒôcznie u≈ºywajƒÖc zapisanych danych logowania.', 'warning');
                        }
                    } catch (error) {
                        // B≈ÇƒÖd CORS - nie mo≈ºemy uzyskaƒá dostƒôpu do dokumentu innej domeny
                        if (attempts >= maxAttempts) {
                            clearInterval(tryAutoLogin);
                            // Poka≈º dane logowania w oknie dialogowym jako alternatywƒô
                            showCredentialsDialog(credentials);
                        }
                    }
                }, 500); // Sprawdzaj co 500ms
                
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                showAlert('B≈ÇƒÖd podczas otwierania strony dostawcy', 'error');
            }
        }

        // Faktury
        async function loadInvoices() {
            try {
                const res = await fetch(`${API_BASE}/api/water/invoices/`);
                const invoices = await res.json();
                const listEl = document.getElementById('invoices-list');
                
                if (invoices.length === 0) {
                    listEl.innerHTML = '<p>Brak faktur</p>';
                    return;
                }

                let html = `<table class="data-table"><thead><tr><th data-i18n="table.period">Okres</th><th data-i18n="table.invoice_number">Numer faktury</th><th data-i18n="table.usage">Zu≈ºycie (m¬≥)</th><th data-i18n="table.water_cost_m3">Koszt wody/m¬≥</th><th data-i18n="table.sewage_cost_m3">Koszt ≈õciek√≥w/m¬≥</th><th data-i18n="table.total_gross">Suma brutto</th><th data-i18n="table.actions">Akcje</th></tr></thead><tbody>`;
                invoices.forEach(i => {
                    html += `<tr class="clickable" onclick="toggleInvoiceDetails(${i.id})" data-invoice-id="${i.id}">
                        <td>${i.data}</td>
                        <td>${i.invoice_number}</td>
                        <td>${i.usage}</td>
                        <td>${i.water_cost_m3}</td>
                        <td>${i.sewage_cost_m3}</td>
                        <td>${i.gross_sum.toFixed(2)} z≈Ç</td>
                        <td class="actions" onclick="event.stopPropagation()">
                            <button class="btn btn-edit btn-small" onclick="editInvoice(${i.id})" title="Edytuj fakturƒô">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteInvoice(${i.id})" title="Usu≈Ñ fakturƒô i rachunki dla tego okresu (je≈õli to ostatnia faktura)">üóëÔ∏è</button>
                        </td>
                    </tr>
                    <tr class="details-row" id="invoice-details-${i.id}" data-invoice-id="${i.id}">
                        <td colspan="7" class="details-cell">
                            <div class="details-grid">
                                <div class="details-item"><label data-i18n="details.period">Okres:</label><span class="value">${i.data}</span></div>
                                <div class="details-item"><label data-i18n="details.invoice_number">Numer faktury:</label><span class="value">${i.invoice_number}</span></div>
                                <div class="details-item"><label data-i18n="details.usage_m3">Zu≈ºycie (m¬≥):</label><span class="value">${i.usage}</span></div>
                                <div class="details-item"><label data-i18n="details.water_cost_m3">Koszt wody/m¬≥:</label><span class="value">${i.water_cost_m3} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.sewage_cost_m3">Koszt ≈õciek√≥w/m¬≥:</label><span class="value">${i.sewage_cost_m3} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.subscription_months">Abonament (miesiƒôcy):</label><span class="value">${i.nr_of_subscription}</span></div>
                                <div class="details-item"><label data-i18n="details.subscription_water">Abonament woda/miesiƒÖc:</label><span class="value">${i.water_subscr_cost} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.subscription_sewage">Abonament ≈õcieki/miesiƒÖc:</label><span class="value">${i.sewage_subscr_cost} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.vat">VAT:</label><span class="value">${(i.vat * 100).toFixed(0)}%</span></div>
                                <div class="details-item"><label data-i18n="details.period_start">Okres od:</label><span class="value">${i.period_start || '-'}</span></div>
                                <div class="details-item"><label data-i18n="details.period_end">Okres do:</label><span class="value">${i.period_stop || '-'}</span></div>
                                <div class="details-item"><label data-i18n="details.total_gross">Suma brutto:</label><span class="value">${i.gross_sum.toFixed(2)} z≈Ç</span></div>
                            </div>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
                updateTexts();
            } catch (error) {
                document.getElementById('invoices-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania faktur</p>';
            }
        }

        async function uploadInvoice() {
            const fileInput = document.getElementById('invoice-file');
            if (!fileInput.files[0]) {
                showAlert('Wybierz plik PDF', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch(`${API_BASE}/api/water/invoices/parse`, {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    const result = await res.json();
                    // Wype≈Çnij formularz weryfikacji danymi
                    const verifyForm = document.getElementById('form-invoice-verify');
                    Object.keys(result).forEach(key => {
                        const input = verifyForm.querySelector(`[name="${key}"]`);
                        if (input && result[key] !== null && result[key] !== undefined) {
                            // Dla p√≥l typu date, upewnij siƒô ≈ºe format jest poprawny
                            if (input.type === 'date' && typeof result[key] === 'string') {
                                input.value = result[key];
                            } else if (input.type !== 'date') {
                                input.value = result[key];
                            }
                        }
                    });
                    // Poka≈º formularz weryfikacji
                    document.getElementById('invoice-verification').style.display = 'block';
                    showAlert('Faktura sparsowana - zweryfikuj dane przed zapisem');
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd parsowania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function verifyAndSaveInvoice() {
            const form = document.getElementById('form-invoice-verify');
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                // Konwertuj warto≈õci numeryczne
                if (['usage', 'water_cost_m3', 'sewage_cost_m3', 'water_subscr_cost', 
                     'sewage_subscr_cost', 'vat', 'gross_sum'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else if (key === 'nr_of_subscription') {
                    data[key] = parseInt(value) || 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/invoices/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Faktura zapisana pomy≈õlnie!');
                    form.reset();
                    document.getElementById('invoice-verification').style.display = 'none';
                    document.getElementById('invoice-file').value = '';
                    document.getElementById('invoice-file-name').textContent = '';
                    // Przywr√≥ƒá oryginalny przycisk
                    const verifyTitle = document.querySelector('#invoice-verification h3');
                    if (verifyTitle) verifyTitle.textContent = 'Weryfikuj dane faktury przed zapisem';
                    const verifyBtn = document.querySelector('#invoice-verification .btn-success');
                    if (verifyBtn) {
                        verifyBtn.textContent = 'Zatwierd≈∫ i zapisz';
                        verifyBtn.onclick = verifyAndSaveInvoice;
                    }
                    loadInvoices();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd zapisywania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function cancelInvoiceVerification() {
            document.getElementById('invoice-verification').style.display = 'none';
            document.getElementById('form-invoice-verify').reset();
            document.getElementById('invoice-file').value = '';
            document.getElementById('invoice-file-name').textContent = '';
            // Przywr√≥ƒá oryginalny przycisk
            const verifyTitle = document.querySelector('#invoice-verification h3');
            if (verifyTitle) verifyTitle.textContent = 'Weryfikuj dane faktury przed zapisem';
            const verifyBtn = document.querySelector('#invoice-verification .btn-success');
            if (verifyBtn) {
                verifyBtn.textContent = 'Zatwierd≈∫ i zapisz';
                verifyBtn.onclick = verifyAndSaveInvoice;
            }
        }

        function toggleManualInvoiceForm() {
            const formDiv = document.getElementById('invoice-manual-form');
            const btn = document.getElementById('btn-show-manual-invoice');
            
            if (formDiv.style.display === 'none' || formDiv.style.display === '') {
                formDiv.style.display = 'block';
                btn.textContent = 'Ukryj formularz rƒôczny';
            } else {
                formDiv.style.display = 'none';
                btn.textContent = 'LUB DODAJ RƒòCZNIE';
            }
        }

        async function addInvoice() {
            const form = document.getElementById('form-invoice');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                params.append(key, value);
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/invoices/?${params}`, { method: 'POST' });
                if (res.ok) {
                    showAlert('Faktura dodana pomy≈õlnie!');
                    form.reset();
                    // Ukryj formularz rƒôczny po dodaniu faktury
                    const formDiv = document.getElementById('invoice-manual-form');
                    const btn = document.getElementById('btn-show-manual-invoice');
                    formDiv.style.display = 'none';
                    btn.textContent = 'LUB DODAJ RƒòCZNIE';
                    loadInvoices();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd dodawania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Rachunki
        async function loadBills() {
            try {
                const res = await fetch(`${API_BASE}/api/water/bills/`);
                const bills = await res.json();
                const listEl = document.getElementById('bills-list');
                
                if (bills.length === 0) {
                    listEl.innerHTML = '<p>Brak rachunk√≥w. Wygeneruj rachunki dla okresu z fakturƒÖ i odczytami.</p>';
                    return;
                }

                let html = `<table class="data-table"><thead><tr><th data-i18n="table.period">Okres</th><th data-i18n="table.local">Lokal</th><th data-i18n="table.usage">Zu≈ºycie (m¬≥)</th><th data-i18n="table.total_gross">Suma brutto</th><th data-i18n="table.actions">Akcje</th></tr></thead><tbody>`;
                let previousPeriod = null;
                bills.forEach((b, index) => {
                    // Dodaj separator je≈õli okres siƒô zmieni≈Ç (i to nie jest pierwszy rachunek)
                    if (previousPeriod !== null && previousPeriod !== b.data) {
                        html += `<tr><td colspan="5" style="padding: 4px 0; border-bottom: 1px solid var(--border-color);"></td></tr>`;
                    }
                    previousPeriod = b.data;
                    
                    html += `<tr class="clickable" onclick="toggleBillDetails(${b.id})" data-bill-id="${b.id}">
                        <td>${b.data}</td>
                        <td>${b.local}</td>
                        <td>${b.usage_m3}</td>
                        <td>${b.gross_sum.toFixed(2)} z≈Ç</td>
                        <td class="actions" onclick="event.stopPropagation()">
                            <a href="${API_BASE}/api/water/bills/download/${b.id}" target="_blank" class="btn btn-success btn-small">üì• PDF</a>
                            <button class="btn btn-edit btn-small" onclick="editBill(${b.id})" title="Edytuj rachunek">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteBill(${b.id})" title="Usu≈Ñ rachunek">üóëÔ∏è</button>
                        </td>
                    </tr>
                    <tr class="details-row" id="bill-details-${b.id}" data-bill-id="${b.id}">
                        <td colspan="5" class="details-cell">
                            <div class="details-grid">
                                <div class="details-item"><label data-i18n="details.period">Okres:</label><span class="value">${b.data}</span></div>
                                <div class="details-item"><label data-i18n="details.local">Lokal:</label><span class="value">${b.local}</span></div>
                                <div class="details-item"><label data-i18n="details.reading_value">Warto≈õƒá odczytu:</label><span class="value">${(b.reading_value || 0).toFixed(2)}</span></div>
                                <div class="details-item"><label data-i18n="details.usage_m3">Zu≈ºycie (m¬≥):</label><span class="value">${b.usage_m3}</span></div>
                                <div class="details-item"><label data-i18n="details.water_cost">Koszt wody:</label><span class="value">${b.cost_water.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.sewage_cost">Koszt ≈õciek√≥w:</label><span class="value">${b.cost_sewage.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.usage_total">Koszt zu≈ºycia ≈ÇƒÖcznie:</label><span class="value">${b.cost_usage_total.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.subscription_water_share">Abonament woda:</label><span class="value">${b.abonament_water_share.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.subscription_sewage_share">Abonament ≈õcieki:</label><span class="value">${b.abonament_sewage_share.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.subscription_total">Abonament ≈ÇƒÖcznie:</label><span class="value">${b.abonament_total.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.total_net">Suma netto:</label><span class="value">${b.net_sum.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.total_gross">Suma brutto:</label><span class="value">${b.gross_sum.toFixed(2)} z≈Ç</span></div>
                            </div>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
                updateTexts();
            } catch (error) {
                document.getElementById('bills-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania rachunk√≥w</p>';
            }
        }

        async function generateBills() {
            const period = document.getElementById('bill-period').value.trim();
            if (!period || !period.match(/^\d{4}-\d{2}$/)) {
                showAlert('Podaj prawid≈Çowy okres (YYYY-MM)', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/bills/generate/${period}`, { method: 'POST' });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Wygenerowano ${result.bills_count} rachunk√≥w dla okresu ${period}`);
                    loadBills();
                    loadWaterStats();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd generowania rachunk√≥w', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function regenerateBills() {
            const period = document.getElementById('bill-period').value.trim();
            if (!period || !period.match(/^\d{4}-\d{2}$/)) {
                showAlert('Podaj prawid≈Çowy okres (YYYY-MM)', 'error');
                return;
            }

            if (!confirm(`Czy na pewno chcesz zregenerowaƒá rachunki dla okresu ${period}?`)) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/bills/regenerate/${period}`, { method: 'POST' });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Zregenerowano ${result.bills_count} rachunk√≥w dla okresu ${period}`);
                    loadBills();
                    loadWaterStats();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd regenerowania rachunk√≥w', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function deleteBill(billId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten rachunek?')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/bills/${billId}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('Rachunek usuniƒôty');
                    loadBills();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function deleteLocal(localId) {
            const confirmation = prompt('Czy na pewno chcesz usunƒÖƒá ten lokal? ZostanƒÖ r√≥wnie≈º usuniƒôte wszystkie powiƒÖzane rachunki.\n\nWpisz "tak" aby potwierdziƒá:');
            if (!confirmation || confirmation.toLowerCase() !== 'tak') {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/locals/${localId}`, { method: 'DELETE' });
                if (res.ok) {
                    const result = await res.json();
                    showAlert(`Lokal usuniƒôty. Usuniƒôto r√≥wnie≈º ${result.deleted_bills_count} powiƒÖzanych rachunk√≥w.`);
                    loadLocals();
                    loadBills();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania lokalu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function toggleReadingDetails(period) {
            const detailsRow = document.getElementById(`reading-details-${period}`);
            if (detailsRow) {
                detailsRow.classList.toggle('expanded');
            }
        }

        async function editReading(period) {
            try {
                const res = await fetch(`${API_BASE}/api/water/readings/${period}`);
                if (res.ok) {
                    const reading = await res.json();
                    // Utw√≥rz formularz edycji
                    const formHtml = `
                        <div style="background: #f0f9ff; border: 2px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 8px;">
                            <h3>Edytuj odczyt</h3>
                            <form id="form-reading-edit-${period}" class="form-grid">
                                <div class="form-group">
                                    <label data-i18n="label.period">Okres (YYYY-MM)</label>
                                    <input type="text" name="data" value="${reading.data}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Licznik g≈Ç√≥wny (DOM)</label>
                                    <input type="number" step="0.01" name="water_meter_main" value="${reading.water_meter_main}" required>
                                </div>
                                <div class="form-group">
                                    <label>Licznik 5 (gora)</label>
                                    <input type="number" name="water_meter_5" value="${reading.water_meter_5}" required>
                                </div>
                                <div class="form-group">
                                    <label>Licznik 5a (gabinet)</label>
                                    <input type="number" name="water_meter_5a" value="${reading.water_meter_5a || 0}" required>
                                </div>
                                <div class="form-group" style="background: #f0f0f0; padding: 10px; border-radius: 4px;">
                                    <label>Licznik 5b (dol) - obliczany</label>
                                    <input type="text" id="calculated_dol_edit_${period}" readonly style="background: #e0e0e0;">
                                    <small style="display: block; margin-top: 5px; color: #666;">Warto≈õƒá obliczana automatycznie: g≈Ç√≥wny - gora - gabinet</small>
                                </div>
                            </form>
                            <button class="btn btn-success" onclick="updateReading('${period}')">Zapisz zmiany</button>
                            <button class="btn btn-secondary" onclick="cancelReadingEdit('${period}')">Anuluj</button>
                        </div>
                    `;
                    // Znajd≈∫ szczeg√≥≈Çy odczytu i dodaj formularz
                    const detailsRow = document.getElementById(`reading-details-${period}`);
                    if (detailsRow) {
                        const detailsCell = detailsRow.querySelector('.details-cell');
                        if (detailsCell) {
                            const existingForm = detailsCell.querySelector(`#form-reading-edit-${period}`);
                            if (existingForm) {
                                existingForm.parentElement.remove();
                            } else {
                                detailsCell.insertAdjacentHTML('beforeend', formHtml);
                                detailsRow.classList.add('expanded');
                                // Initialize calculation after form is inserted
                                initDolCalculation(period);
                            }
                        }
                    } else {
                        // Je≈õli szczeg√≥≈Çy nie istniejƒÖ, utw√≥rz wiersz szczeg√≥≈Ç√≥w
                        const readingRow = document.querySelector(`tr[data-reading-period="${period}"]`);
                        if (readingRow) {
                            const newRow = document.createElement('tr');
                            newRow.className = 'details-row expanded';
                            newRow.id = `reading-details-${period}`;
                            newRow.setAttribute('data-reading-period', period);
                            newRow.innerHTML = `<td colspan="6" class="details-cell">${formHtml}</td>`;
                            readingRow.parentElement.insertBefore(newRow, readingRow.nextSibling);
                            // Initialize calculation after form is inserted
                            initDolCalculation(period);
                        }
                    }
                    // Scroll do formularza
                    document.getElementById(`reading-details-${period}`)?.scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert('B≈ÇƒÖd pobierania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function updateReading(period) {
            const form = document.getElementById(`form-reading-edit-${period}`);
            const formData = new FormData(form);
            const params = new URLSearchParams();
            // Only send main, gora (5), and gabinet (5a) - dol (5b) is calculated on server
            params.append('water_meter_main', formData.get('water_meter_main'));
            params.append('water_meter_5', formData.get('water_meter_5'));
            params.append('water_meter_5a', formData.get('water_meter_5a'));

            try {
                const res = await fetch(`${API_BASE}/api/water/readings/${period}?${params}`, {
                    method: 'PUT'
                });
                if (res.ok) {
                    showAlert('Odczyt zaktualizowany pomy≈õlnie!');
                    cancelReadingEdit(period);
                    loadReadings();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function initDolCalculation(period) {
            // Calculate dol value in real-time for edit form
            setTimeout(function() {
                const form = document.getElementById(`form-reading-edit-${period}`);
                if (form) {
                    const mainInput = form.querySelector('[name="water_meter_main"]');
                    const goraInput = form.querySelector('[name="water_meter_5"]');
                    const gabinetInput = form.querySelector('[name="water_meter_5a"]');
                    const calculatedInput = document.getElementById(`calculated_dol_edit_${period}`);
                    
                    function updateCalculatedDol() {
                        const main = parseFloat(mainInput?.value) || 0;
                        const gora = parseFloat(goraInput?.value) || 0;
                        const gabinet = parseFloat(gabinetInput?.value) || 0;
                        const dol = main - gora - gabinet;
                        if (calculatedInput) calculatedInput.value = dol.toFixed(2);
                    }
                    
                    // Initial calculation
                    updateCalculatedDol();
                    
                    [mainInput, goraInput, gabinetInput].forEach(input => {
                        if (input) input.addEventListener('input', updateCalculatedDol);
                    });
                }
            }, 100);
        }

        function cancelReadingEdit(period) {
            const formDiv = document.querySelector(`#form-reading-edit-${period}`)?.parentElement;
            if (formDiv) {
                formDiv.remove();
            }
            // Od≈õwie≈º szczeg√≥≈Çy odczytu
            const detailsRow = document.getElementById(`reading-details-${period}`);
            if (detailsRow && detailsRow.dataset.loaded !== 'true') {
                detailsRow.classList.remove('expanded');
            }
        }

        async function deleteReading(period) {
            if (!confirm(`Czy na pewno chcesz usunƒÖƒá odczyt dla okresu ${period}? ZostanƒÖ r√≥wnie≈º usuniƒôte wszystkie rachunki dla tego okresu.`)) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/readings/${period}`, { method: 'DELETE' });
                if (res.ok) {
                    const result = await res.json();
                    showAlert(`Odczyt dla okresu ${period} usuniƒôty. Usuniƒôto r√≥wnie≈º ${result.deleted_bills_count} rachunk√≥w.`);
                    loadReadings();
                    loadBills();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Funkcje rozwijania szczeg√≥≈Ç√≥w
        function toggleInvoiceDetails(invoiceId) {
            const detailsRow = document.getElementById(`invoice-details-${invoiceId}`);
            if (detailsRow) {
                detailsRow.classList.toggle('expanded');
            }
        }

        function toggleBillDetails(billId) {
            const detailsRow = document.getElementById(`bill-details-${billId}`);
            if (detailsRow) {
                // Sprawd≈∫ czy formularz edycji jest otwarty - je≈õli tak, nie zamykaj
                const editForm = detailsRow.querySelector(`#form-bill-edit-${billId}`);
                if (!editForm) {
                    detailsRow.classList.toggle('expanded');
                }
            }
        }

        async function toggleGasInvoiceDetails(invoiceId) {
            const detailsRow = document.getElementById(`gas-invoice-details-${invoiceId}`);
            if (detailsRow) {
                const isExpanded = detailsRow.classList.contains('expanded');
                detailsRow.classList.toggle('expanded');
                
                // Je≈õli rozwijamy i szczeg√≥≈Çy nie sƒÖ za≈Çadowane, pobierz pe≈Çne dane
                if (!isExpanded && !detailsRow.dataset.loaded) {
                    try {
                        const res = await fetch(`${API_BASE}/api/gas/invoices/${invoiceId}`);
                        if (res.ok) {
                            const invoice = await res.json();
                            const detailsGrid = detailsRow.querySelector('.details-grid');
                            if (detailsGrid) {
                                detailsGrid.innerHTML = `
                                    <div class="details-item"><label data-i18n="details.period">Okres:</label><span class="value">${invoice.data}</span></div>
                                    <div class="details-item"><label data-i18n="details.invoice_number">Numer faktury:</label><span class="value">${invoice.invoice_number}</span></div>
                                    <div class="details-item"><label data-i18n="details.period_start">Okres od:</label><span class="value">${invoice.period_start || '-'}</span></div>
                                    <div class="details-item"><label data-i18n="details.period_end">Okres do:</label><span class="value">${invoice.period_stop || '-'}</span></div>
                                    <div class="details-item"><label data-i18n="details.previous_reading">Odczyt poprzedni:</label><span class="value">${invoice.previous_reading?.toFixed(2) || '-'} m¬≥</span></div>
                                    <div class="details-item"><label data-i18n="details.current_reading">Odczyt obecny:</label><span class="value">${invoice.current_reading?.toFixed(2) || '-'} m¬≥</span></div>
                                    <div class="details-item"><label data-i18n="details.fuel_usage_m3">Zu≈ºycie paliwa:</label><span class="value">${invoice.fuel_usage_m3?.toFixed(2) || '-'} m¬≥</span></div>
                                    <div class="details-item"><label data-i18n="details.fuel_usage_kwh">Zu≈ºycie paliwa (kWh):</label><span class="value">${invoice.fuel_usage_kwh?.toFixed(2) || '-'} kWh</span></div>
                                    <div class="details-item"><label data-i18n="details.fuel_value_net">Paliwo - Warto≈õƒá netto:</label><span class="value">${invoice.fuel_value_net?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label data-i18n="details.fuel_value_gross">Paliwo - Warto≈õƒá brutto:</label><span class="value">${invoice.fuel_value_gross?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label data-i18n="details.subscription_value_net">Abonament - Warto≈õƒá netto:</label><span class="value">${invoice.subscription_value_net?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label data-i18n="details.subscription_value_gross">Abonament - Warto≈õƒá brutto:</label><span class="value">${invoice.subscription_value_gross?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label data-i18n="details.distribution_fixed_value_net">Dystrybucja sta≈Ça - Warto≈õƒá netto:</label><span class="value">${invoice.distribution_fixed_value_net?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label data-i18n="details.distribution_fixed_value_gross">Dystrybucja sta≈Ça - Warto≈õƒá brutto:</label><span class="value">${invoice.distribution_fixed_value_gross?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label data-i18n="details.distribution_variable_value_net">Dystrybucja zmienna - Warto≈õƒá netto:</label><span class="value">${invoice.distribution_variable_value_net?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label data-i18n="details.distribution_variable_value_gross">Dystrybucja zmienna - Warto≈õƒá brutto:</label><span class="value">${invoice.distribution_variable_value_gross?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label data-i18n="details.total_net_sum">Suma netto:</label><span class="value">${invoice.total_net_sum?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label data-i18n="details.vat">VAT:</label><span class="value">${invoice.vat_rate ? (invoice.vat_rate * 100).toFixed(0) + '%' : '-'}</span></div>
                                    <div class="details-item"><label data-i18n="details.vat_amount">Kwota VAT:</label><span class="value">${invoice.vat_amount?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label data-i18n="details.total_gross">Suma brutto:</label><span class="value">${invoice.total_gross_sum?.toFixed(2) || '-'} z≈Ç</span></div>
                                    <div class="details-item"><label data-i18n="details.late_payment_interest">Odsetki za sp√≥≈∫nienie:</label><span class="value">${invoice.late_payment_interest?.toFixed(2) || '0.00'} z≈Ç</span></div>
                                    <div class="details-item"><label data-i18n="details.payment_due_date">Termin p≈Çatno≈õci:</label><span class="value">${invoice.payment_due_date || '-'}</span></div>
                                    <div class="details-item"><label data-i18n="details.amount_to_pay">Do zap≈Çaty:</label><span class="value">${invoice.amount_to_pay?.toFixed(2) || '-'} z≈Ç</span></div>
                                `;
                                detailsRow.dataset.loaded = 'true';
                                updateTexts(); // Przet≈Çumacz etykiety po za≈Çadowaniu szczeg√≥≈Ç√≥w
                            }
                        }
                    } catch (error) {
                        console.error('B≈ÇƒÖd pobierania szczeg√≥≈Ç√≥w faktury:', error);
                    }
                }
            }
        }

        function toggleGasBillDetails(billId) {
            const detailsRow = document.getElementById(`gas-bill-details-${billId}`);
            if (detailsRow) {
                detailsRow.classList.toggle('expanded');
            }
        }

        // Funkcje edycji
        async function editInvoice(invoiceId) {
            try {
                        const res = await fetch(`${API_BASE}/api/water/invoices/${invoiceId}`);
                if (res.ok) {
                    const invoice = await res.json();
                    // Wype≈Çnij formularz weryfikacji danymi faktury
                    const verifyForm = document.getElementById('form-invoice-verify');
                    Object.keys(invoice).forEach(key => {
                        const input = verifyForm.querySelector(`[name="${key}"]`);
                        if (input && invoice[key] !== null && invoice[key] !== undefined) {
                            if (input.type === 'date' && typeof invoice[key] === 'string') {
                                input.value = invoice[key];
                            } else if (input.type !== 'date') {
                                input.value = invoice[key];
                            }
                        }
                    });
                    // Poka≈º formularz weryfikacji
                    document.getElementById('invoice-verification').style.display = 'block';
                    // Zmie≈Ñ tytu≈Ç i przycisk
                    const verifyTitle = document.querySelector('#invoice-verification h3');
                    if (verifyTitle) verifyTitle.textContent = 'Edytuj fakturƒô';
                    const verifyBtn = document.querySelector('#invoice-verification .btn-success');
                    if (verifyBtn) verifyBtn.textContent = 'Zapisz zmiany';
                    verifyBtn.onclick = () => updateInvoice(invoiceId);
                    // Scroll do formularza
                    document.getElementById('invoice-verification').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert('B≈ÇƒÖd pobierania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function updateInvoice(invoiceId) {
            const form = document.getElementById('form-invoice-verify');
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                if (['usage', 'water_cost_m3', 'sewage_cost_m3', 'water_subscr_cost', 
                     'sewage_subscr_cost', 'vat', 'gross_sum'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else if (key === 'nr_of_subscription') {
                    data[key] = parseInt(value) || 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/invoices/${invoiceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Faktura zaktualizowana pomy≈õlnie!');
                    form.reset();
                    document.getElementById('invoice-verification').style.display = 'none';
                    // Przywr√≥ƒá oryginalny przycisk
                    const verifyTitle = document.querySelector('#invoice-verification h3');
                    if (verifyTitle) verifyTitle.textContent = 'Weryfikuj dane faktury przed zapisem';
                    const verifyBtn = document.querySelector('#invoice-verification .btn-success');
                    if (verifyBtn) {
                        verifyBtn.textContent = 'Zatwierd≈∫ i zapisz';
                        verifyBtn.onclick = verifyAndSaveInvoice;
                    }
                    loadInvoices();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function editBill(billId) {
            try {
                const res = await fetch(`${API_BASE}/api/water/bills/${billId}`);
                if (res.ok) {
                    const bill = await res.json();
                    // Utw√≥rz formularz edycji
                    const formHtml = `
                        <div style="background: #f0f9ff; border: 2px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 8px;">
                            <h3>Edytuj rachunek</h3>
                            <form id="form-bill-edit-${billId}" class="form-grid">
                                <div class="form-group">
                                    <label>Okres</label>
                                    <input type="text" name="data" value="${bill.data}" readonly>
                                </div>
                                <div class="form-group">
                                    <label data-i18n="label.local">Lokal</label>
                                    <input type="text" name="local" value="${bill.local}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Warto≈õƒá odczytu</label>
                                    <input type="number" step="0.01" name="reading_value" value="${bill.reading_value}" required>
                                </div>
                                <div class="form-group">
                                    <label>Zu≈ºycie (m¬≥)</label>
                                    <input type="number" step="0.01" name="usage_m3" value="${bill.usage_m3}" required>
                                </div>
                                <div class="form-group">
                                    <label>Koszt wody</label>
                                    <input type="number" step="0.01" name="cost_water" value="${bill.cost_water}" required>
                                </div>
                                <div class="form-group">
                                    <label>Koszt ≈õciek√≥w</label>
                                    <input type="number" step="0.01" name="cost_sewage" value="${bill.cost_sewage}" required>
                                </div>
                                <div class="form-group">
                                    <label>Koszt zu≈ºycia ≈ÇƒÖcznie</label>
                                    <input type="number" step="0.01" name="cost_usage_total" value="${bill.cost_usage_total}" required>
                                </div>
                                <div class="form-group">
                                    <label>Abonament woda</label>
                                    <input type="number" step="0.01" name="abonament_water_share" value="${bill.abonament_water_share}" required>
                                </div>
                                <div class="form-group">
                                    <label>Abonament ≈õcieki</label>
                                    <input type="number" step="0.01" name="abonament_sewage_share" value="${bill.abonament_sewage_share}" required>
                                </div>
                                <div class="form-group">
                                    <label>Abonament ≈ÇƒÖcznie</label>
                                    <input type="number" step="0.01" name="abonament_total" value="${bill.abonament_total}" required>
                                </div>
                                <div class="form-group">
                                    <label>Suma netto</label>
                                    <input type="number" step="0.01" name="net_sum" value="${bill.net_sum}" required>
                                </div>
                                <div class="form-group">
                                    <label>Suma brutto</label>
                                    <input type="number" step="0.01" name="gross_sum" value="${bill.gross_sum}" required>
                                </div>
                            </form>
                            <button class="btn btn-success" onclick="updateBill(${billId})">Zapisz zmiany</button>
                            <button class="btn btn-secondary" onclick="cancelBillEdit(${billId})">Anuluj</button>
                        </div>
                    `;
                    // Znajd≈∫ szczeg√≥≈Çy rachunku i dodaj formularz
                    const detailsRow = document.getElementById(`bill-details-${billId}`);
                    if (detailsRow) {
                        const detailsCell = detailsRow.querySelector('.details-cell');
                        if (detailsCell) {
                            const existingForm = detailsCell.querySelector(`#form-bill-edit-${billId}`);
                            if (existingForm) {
                                existingForm.parentElement.remove();
                            } else {
                                detailsCell.insertAdjacentHTML('beforeend', formHtml);
                                detailsRow.classList.add('expanded');
                            }
                        }
                    } else {
                        // Je≈õli szczeg√≥≈Çy nie istniejƒÖ, utw√≥rz wiersz szczeg√≥≈Ç√≥w
                        const billRow = document.querySelector(`tr[data-bill-id="${billId}"]`);
                        if (billRow) {
                            const newRow = document.createElement('tr');
                            newRow.className = 'details-row expanded';
                            newRow.id = `bill-details-${billId}`;
                            newRow.setAttribute('data-bill-id', billId);
                            newRow.innerHTML = `<td colspan="5" class="details-cell">${formHtml}</td>`;
                            billRow.parentElement.insertBefore(newRow, billRow.nextSibling);
                        }
                    }
                    // Scroll do formularza
                    document.getElementById(`bill-details-${billId}`)?.scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert('B≈ÇƒÖd pobierania rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function updateBill(billId) {
            const form = document.getElementById(`form-bill-edit-${billId}`);
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                if (['reading_value', 'usage_m3', 'cost_water', 'cost_sewage', 'cost_usage_total',
                     'abonament_water_share', 'abonament_sewage_share', 'abonament_total',
                     'net_sum', 'gross_sum'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/bills/${billId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Rachunek zaktualizowany pomy≈õlnie!');
                    cancelBillEdit(billId);
                    loadBills();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function cancelBillEdit(billId) {
            const formDiv = document.querySelector(`#form-bill-edit-${billId}`)?.parentElement;
            if (formDiv) {
                formDiv.remove();
            }
            // Od≈õwie≈º szczeg√≥≈Çy rachunku
            const detailsRow = document.getElementById(`bill-details-${billId}`);
            if (detailsRow && detailsRow.dataset.loaded !== 'true') {
                detailsRow.classList.remove('expanded');
            }
        }

        async function editGasInvoice(invoiceId) {
            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/${invoiceId}`);
                if (res.ok) {
                    const invoice = await res.json();
                    // Wype≈Çnij formularz weryfikacji danymi faktury
                    const verifyForm = document.getElementById('form-gas-invoice-verify');
                    Object.keys(invoice).forEach(key => {
                        const input = verifyForm.querySelector(`[name="${key}"]`);
                        if (input && invoice[key] !== null && invoice[key] !== undefined) {
                            if (input.type === 'date' && typeof invoice[key] === 'string') {
                                input.value = invoice[key].substring(0, 10);
                            } else if (input.type !== 'date') {
                                input.value = invoice[key];
                            }
                        }
                    });
                    // Poka≈º formularz weryfikacji
                    const verificationDiv = document.getElementById('gas-invoice-verification');
                    verificationDiv.style.display = 'block';
                    // Zmie≈Ñ tytu≈Ç i przycisk
                    const verifyTitle = verificationDiv.querySelector('h3');
                    if (verifyTitle) verifyTitle.textContent = 'Edytuj fakturƒô gazu';
                    const verifyBtn = verificationDiv.querySelector('.btn-success');
                    if (verifyBtn) verifyBtn.textContent = 'Zapisz zmiany';
                    verifyBtn.onclick = () => updateGasInvoice(invoiceId);
                    // Scroll do formularza
                    verificationDiv.scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert('B≈ÇƒÖd pobierania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function updateGasInvoice(invoiceId) {
            const form = document.getElementById('form-gas-invoice-verify');
            const formData = new FormData(form);
            const data = {};
            const numericFields = [
                'previous_reading', 'current_reading',
                'fuel_usage_m3', 'fuel_conversion_factor', 'fuel_usage_kwh', 'fuel_price_net', 
                'fuel_value_net', 'fuel_value_gross',
                'subscription_quantity', 'subscription_price_net', 'subscription_value_net', 
                'subscription_value_gross',
                'distribution_fixed_quantity', 'distribution_fixed_price_net', 
                'distribution_fixed_value_net', 'distribution_fixed_value_gross',
                'distribution_variable_usage_m3', 'distribution_variable_conversion_factor',
                'distribution_variable_usage_kwh', 'distribution_variable_price_net', 'distribution_variable_value_net',
                'distribution_variable_value_gross',
                'distribution_variable_2_usage_m3', 'distribution_variable_2_conversion_factor',
                'distribution_variable_2_usage_kwh', 'distribution_variable_2_price_net', 'distribution_variable_2_value_net',
                'total_net_sum', 'vat_rate', 'vat_amount', 'total_gross_sum',
                'late_payment_interest', 'amount_to_pay'
            ];
            
            for (const [key, value] of formData.entries()) {
                if (key.startsWith('distribution_variable_2_')) {
                    if (value && value.trim() !== '') {
                        const numValue = value.toString().replace(',', '.');
                        data[key] = parseFloat(numValue);
                    } else {
                        data[key] = null;
                    }
                } else if (numericFields.includes(key)) {
                    if (value) {
                        const numValue = value.toString().replace(',', '.');
                        data[key] = parseFloat(numValue) || 0;
                    } else {
                        data[key] = 0;
                    }
                } else if (key === 'subscription_quantity' || key === 'distribution_fixed_quantity') {
                    data[key] = value ? parseInt(value) : 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/${invoiceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Faktura gazu zaktualizowana pomy≈õlnie!');
                    form.reset();
                    const verificationDiv = document.getElementById('gas-invoice-verification');
                    verificationDiv.style.display = 'none';
                    // Przywr√≥ƒá oryginalny przycisk
                    const verifyTitle = verificationDiv.querySelector('h3');
                    if (verifyTitle) verifyTitle.textContent = 'Weryfikuj dane faktury przed zapisem';
                    const verifyBtn = verificationDiv.querySelector('.btn-success');
                    if (verifyBtn) {
                        verifyBtn.textContent = 'Zatwierd≈∫ i zapisz';
                        verifyBtn.onclick = verifyAndSaveGasInvoice;
                    }
                    loadGasInvoices();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function editGasBill(billId) {
            try {
                const res = await fetch(`${API_BASE}/api/gas/bills/${billId}`);
                if (res.ok) {
                    const bill = await res.json();
                    // Utw√≥rz formularz edycji
                    const formHtml = `
                        <div style="background: #f0f9ff; border: 2px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 8px;">
                            <h3>Edytuj rachunek gazu</h3>
                            <form id="form-gas-bill-edit-${billId}" class="form-grid">
                                <div class="form-group">
                                    <label>Okres</label>
                                    <input type="text" name="data" value="${bill.data}" readonly>
                                </div>
                                <div class="form-group">
                                    <label data-i18n="label.local">Lokal</label>
                                    <input type="text" name="local" value="${bill.local}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Udzia≈Ç</label>
                                    <input type="number" step="0.01" name="cost_share" value="${bill.cost_share}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Paliwo (brutto)</label>
                                    <input type="number" step="0.01" name="fuel_cost_gross" value="${bill.fuel_cost_gross}" required>
                                </div>
                                <div class="form-group">
                                    <label>Abonament (brutto)</label>
                                    <input type="number" step="0.01" name="subscription_cost_gross" value="${bill.subscription_cost_gross}" required>
                                </div>
                                <div class="form-group">
                                    <label>Dystrybucja sta≈Ça (brutto)</label>
                                    <input type="number" step="0.01" name="distribution_fixed_cost_gross" value="${bill.distribution_fixed_cost_gross}" required>
                                </div>
                                <div class="form-group">
                                    <label>Dystrybucja zmienna (brutto)</label>
                                    <input type="number" step="0.01" name="distribution_variable_cost_gross" value="${bill.distribution_variable_cost_gross}" required>
                                </div>
                                <div class="form-group">
                                    <label>Suma netto</label>
                                    <input type="number" step="0.01" name="total_net_sum" value="${bill.total_net_sum}" required>
                                </div>
                                <div class="form-group">
                                    <label>Lokal brutto</label>
                                    <input type="number" step="0.01" name="total_gross_sum" value="${bill.total_gross_sum}" required>
                                </div>
                            </form>
                            <button class="btn btn-success" onclick="updateGasBill(${billId})">Zapisz zmiany</button>
                            <button class="btn btn-secondary" onclick="cancelGasBillEdit(${billId})">Anuluj</button>
                        </div>
                    `;
                    // Znajd≈∫ szczeg√≥≈Çy rachunku i dodaj formularz
                    const detailsRow = document.getElementById(`gas-bill-details-${billId}`);
                    if (detailsRow) {
                        const detailsCell = detailsRow.querySelector('.details-cell');
                        if (detailsCell) {
                            const existingForm = detailsCell.querySelector(`#form-gas-bill-edit-${billId}`);
                            if (existingForm) {
                                existingForm.parentElement.remove();
                            } else {
                                detailsCell.insertAdjacentHTML('beforeend', formHtml);
                                detailsRow.classList.add('expanded');
                            }
                        }
                    } else {
                        // Je≈õli szczeg√≥≈Çy nie istniejƒÖ, utw√≥rz wiersz szczeg√≥≈Ç√≥w
                        const billRow = document.querySelector(`tr[data-gas-bill-id="${billId}"]`);
                        if (billRow) {
                            const newRow = document.createElement('tr');
                            newRow.className = 'details-row expanded';
                            newRow.id = `gas-bill-details-${billId}`;
                            newRow.setAttribute('data-gas-bill-id', billId);
                            newRow.innerHTML = `<td colspan="5" class="details-cell">${formHtml}</td>`;
                            billRow.parentElement.insertBefore(newRow, billRow.nextSibling);
                        }
                    }
                    // Scroll do formularza
                    document.getElementById(`gas-bill-details-${billId}`)?.scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert('B≈ÇƒÖd pobierania rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function updateGasBill(billId) {
            const form = document.getElementById(`form-gas-bill-edit-${billId}`);
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                if (['cost_share', 'fuel_cost_gross', 'subscription_cost_gross', 
                     'distribution_fixed_cost_gross', 'distribution_variable_cost_gross',
                     'total_net_sum', 'total_gross_sum'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/bills/${billId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Rachunek gazu zaktualizowany pomy≈õlnie!');
                    cancelGasBillEdit(billId);
                    loadGasBills();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function cancelGasBillEdit(billId) {
            const formDiv = document.querySelector(`#form-gas-bill-edit-${billId}`)?.parentElement;
            if (formDiv) {
                formDiv.remove();
            }
            // Od≈õwie≈º szczeg√≥≈Çy rachunku
            const detailsRow = document.getElementById(`gas-bill-details-${billId}`);
            if (detailsRow && detailsRow.dataset.loaded !== 'true') {
                detailsRow.classList.remove('expanded');
            }
        }

        async function deleteGasBill(billId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten rachunek gazu?')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/bills/${billId}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('Rachunek gazu usuniƒôty');
                    loadGasBills();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function deleteInvoice(invoiceId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô fakturƒô? Je≈õli to ostatnia faktura dla tego okresu, zostanƒÖ r√≥wnie≈º usuniƒôte wszystkie rachunki dla tego okresu.')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/water/invoices/${invoiceId}`, { method: 'DELETE' });
                if (res.ok) {
                    const result = await res.json();
                    if (result.deleted_bills_count > 0) {
                        showAlert(`Faktura usuniƒôta. Usuniƒôto r√≥wnie≈º ${result.deleted_bills_count} rachunk√≥w dla okresu ${result.period}.`);
                    } else {
                        showAlert('Faktura usuniƒôta. Rachunki pozostajƒÖ (istniejƒÖ inne faktury dla tego okresu).');
                    }
                    loadInvoices();
                    loadBills();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // ========== FUNKCJE DLA GAZU ==========
        
        // Statystyki gazu
        async function loadGasStats() {
            try {
                const res = await fetch(`${API_BASE}/api/gas/stats`);
                const stats = await res.json();
                document.getElementById('gas-stat-invoices').textContent = stats.invoices_count || 0;
                document.getElementById('gas-stat-bills').textContent = stats.bills_count || 0;
                document.getElementById('gas-stat-total').textContent = (stats.total_gross_sum || 0).toFixed(2) + ' z≈Ç';
                document.getElementById('gas-stat-latest-period').textContent = stats.latest_period || '-';
                
                // Aktualizuj listƒô dostƒôpnych okres√≥w dla rachunk√≥w gazu
                const datalist = document.getElementById('available-gas-periods');
                datalist.innerHTML = '';
                if (stats.available_periods && stats.available_periods.length > 0) {
                    stats.available_periods.forEach(period => {
                        const option = document.createElement('option');
                        option.value = period;
                        datalist.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania statystyk gazu:', error);
            }
        }
        
        // ≈Åadowanie statystyk na g≈Ç√≥wnej stronie
        async function loadMainStats() {
            try {
                // Statystyki wody
                const waterRes = await fetch(`${API_BASE}/api/water/stats`);
                if (waterRes.ok) {
                    const waterStats = await waterRes.json();
                    document.getElementById('main-water-invoices').textContent = waterStats.invoices_count || 0;
                    document.getElementById('main-water-bills').textContent = waterStats.bills_count || 0;
                    document.getElementById('main-water-total').textContent = (waterStats.total_gross_sum || 0).toFixed(2) + ' z≈Ç';
                    document.getElementById('main-water-period').textContent = waterStats.latest_period || '-';
                }
                
                // Statystyki gazu
                const gasRes = await fetch(`${API_BASE}/api/gas/stats`);
                if (gasRes.ok) {
                    const gasStats = await gasRes.json();
                    document.getElementById('main-gas-invoices').textContent = gasStats.invoices_count || 0;
                    document.getElementById('main-gas-bills').textContent = gasStats.bills_count || 0;
                    document.getElementById('main-gas-total').textContent = (gasStats.total_gross_sum || 0).toFixed(2) + ' z≈Ç';
                    document.getElementById('main-gas-period').textContent = gasStats.latest_period || '-';
                }
                
                // Statystyki prƒÖdu
                const electricityRes = await fetch(`${API_BASE}/api/electricity/stats`);
                if (electricityRes.ok) {
                    const electricityStats = await electricityRes.json();
                    document.getElementById('main-electricity-readings').textContent = electricityStats.readings_count || 0;
                    document.getElementById('main-electricity-invoices').textContent = electricityStats.invoices_count || 0;
                    document.getElementById('main-electricity-bills').textContent = electricityStats.bills_count || 0;
                    document.getElementById('main-electricity-period').textContent = electricityStats.latest_period || '-';
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania statystyk:', error);
            }
        }

        // Otwieranie medium z g≈Ç√≥wnej strony
        function openMedium(medium) {
            // Ukryj g≈Ç√≥wnƒÖ stronƒô
            document.getElementById('main-page').style.display = 'none';
            // Poka≈º sekcje medium
            document.getElementById('medium-sections').style.display = 'block';
            // Wywo≈Çaj showMedium
            showMedium(medium);
        }

        // Powr√≥t do g≈Ç√≥wnej strony
        function backToMain() {
            // Ukryj sekcje medium
            document.getElementById('medium-sections').style.display = 'none';
            // Ukryj sekcjƒô rachunk√≥w ≈ÇƒÖczonych
            document.getElementById('combined-bills-section').style.display = 'none';
            // Poka≈º g≈Ç√≥wnƒÖ stronƒô
            document.getElementById('main-page').style.display = 'block';
            // Od≈õwie≈º statystyki
            loadMainStats();
        }

        // Prze≈ÇƒÖczanie miƒôdzy medium (Woda/Gaz/PrƒÖd)
        function showMedium(medium) {
            // Usu≈Ñ klasƒô active ze wszystkich przycisk√≥w medium
            document.getElementById('tab-water')?.classList.remove('active');
            document.getElementById('tab-gas')?.classList.remove('active');
            document.getElementById('tab-electricity')?.classList.remove('active');
            
            // Dodaj klasƒô active tylko do aktywnego przycisku
            if (medium === 'water') {
                document.getElementById('tab-water')?.classList.add('active');
            } else if (medium === 'gas') {
                document.getElementById('tab-gas')?.classList.add('active');
            } else if (medium === 'electricity') {
                document.getElementById('tab-electricity')?.classList.add('active');
            }
            
            // Poka≈º odpowiedniƒÖ sekcjƒô
            document.getElementById('medium-water').style.display = medium === 'water' ? 'block' : 'none';
            document.getElementById('medium-gas').style.display = medium === 'gas' ? 'block' : 'none';
            document.getElementById('medium-electricity').style.display = medium === 'electricity' ? 'block' : 'none';
            
            // Za≈Çaduj dane
            if (medium === 'water') {
                loadWaterStats();
                loadLocals();
            } else if (medium === 'gas') {
                loadGasStats();
                loadGasInvoices();
                loadGasBills();
            } else if (medium === 'electricity') {
                loadElectricityStats();
                loadElectricityReadings();
                loadElectricityInvoices();
                loadElectricityBills();
            }
        }

        // Prze≈ÇƒÖczanie zak≈Çadek dla gazu
        function showGasTab(tabName) {
            document.querySelectorAll('#medium-gas .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#medium-gas .tab-content').forEach(t => t.classList.remove('active'));
            // Znajd≈∫ odpowiedni przycisk i ustaw go jako aktywny
            const tabButtons = document.querySelectorAll('#medium-gas .tab');
            tabButtons.forEach(btn => {
                if ((tabName === 'gas-tab-invoices' && btn.textContent.includes('Faktury')) ||
                    (tabName === 'gas-tab-bills' && btn.textContent.includes('Rachunki'))) {
                    btn.classList.add('active');
                }
            });
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'gas-tab-invoices') loadGasInvoices();
            if (tabName === 'gas-tab-bills') loadGasBills();
        }

        // Prze≈ÇƒÖczanie zak≈Çadek dla prƒÖdu
        function showElectricityTab(tabName) {
            document.querySelectorAll('#medium-electricity .tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'electricity-tab-readings') loadElectricityReadings();
            if (tabName === 'electricity-tab-invoices') loadElectricityInvoices();
            if (tabName === 'electricity-tab-bills') {
                loadElectricityBills();
                loadAvailableElectricityPeriods();
            }
        }

        // Funkcje pomocnicze dla formularza odczyt√≥w prƒÖdu
        function toggleDomMeterType() {
            const select = document.querySelector('[name="licznik_dom_jednotaryfowy"]');
            const isJednotaryfowy = select.value === 'true';
            document.getElementById('dom-jednotaryfowy-group').style.display = isJednotaryfowy ? 'flex' : 'none';
            document.getElementById('dom-dwutaryfowy-group').style.display = isJednotaryfowy ? 'none' : 'flex';
            document.getElementById('dom-dwutaryfowy-group-2').style.display = isJednotaryfowy ? 'none' : 'flex';
        }

        function toggleDolMeterType() {
            const select = document.querySelector('[name="licznik_dol_jednotaryfowy"]');
            const isJednotaryfowy = select.value === 'true';
            document.getElementById('dol-jednotaryfowy-group').style.display = isJednotaryfowy ? 'flex' : 'none';
            document.getElementById('dol-dwutaryfowy-group').style.display = isJednotaryfowy ? 'none' : 'flex';
            document.getElementById('dol-dwutaryfowy-group-2').style.display = isJednotaryfowy ? 'none' : 'flex';
        }

        // Prze≈ÇƒÖczanie trybu nocnego - funkcja zostanie nadpisana p√≥≈∫niej

        // Faktury gazu
        async function loadGasInvoices() {
            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/`);
                const invoices = await res.json();
                const listEl = document.getElementById('gas-invoices-list');
                
                if (invoices.length === 0) {
                    listEl.innerHTML = '<p>Brak faktur gazu</p>';
                    return;
                }

                let html = `<table class="data-table"><thead><tr><th data-i18n="table.period">Okres</th><th data-i18n="table.invoice_number">Numer faktury</th><th data-i18n="table.total_gross">Suma brutto</th><th data-i18n="table.actions">Akcje</th></tr></thead><tbody>`;
                invoices.forEach(i => {
                    html += `<tr class="clickable" onclick="toggleGasInvoiceDetails(${i.id})" data-gas-invoice-id="${i.id}">
                        <td>${i.data}</td>
                        <td>${i.invoice_number}</td>
                        <td>${i.total_gross_sum.toFixed(2)} z≈Ç</td>
                        <td class="actions" onclick="event.stopPropagation()">
                            <button class="btn btn-edit btn-small" onclick="editGasInvoice(${i.id})" title="Edytuj fakturƒô">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteGasInvoice(${i.id})" title="Usu≈Ñ fakturƒô i rachunki dla tego okresu (je≈õli to ostatnia faktura)">üóëÔ∏è</button>
                        </td>
                    </tr>
                    <tr class="details-row" id="gas-invoice-details-${i.id}" data-gas-invoice-id="${i.id}">
                        <td colspan="4" class="details-cell">
                            <div class="details-grid">
                                <div class="details-item"><label>Okres:</label><span class="value">${i.data}</span></div>
                                <div class="details-item"><label>Numer faktury:</label><span class="value">${i.invoice_number}</span></div>
                                <div class="details-item"><label>Suma brutto:</label><span class="value">${i.total_gross_sum.toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label>Okres od:</label><span class="value">${i.period_start || '-'}</span></div>
                                <div class="details-item"><label>Okres do:</label><span class="value">${i.period_stop || '-'}</span></div>
                            </div>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
                updateTexts();
            } catch (error) {
                document.getElementById('gas-invoices-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania faktur</p>';
            }
        }

        async function uploadGasInvoice() {
            const fileInput = document.getElementById('gas-invoice-file');
            if (!fileInput.files[0]) {
                showAlert('Wybierz plik PDF', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/parse`, {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    const result = await res.json();
                    // Wype≈Çnij formularz weryfikacji danymi
                    const verifyForm = document.getElementById('form-gas-invoice-verify');
                    Object.keys(result).forEach(key => {
                        const input = verifyForm.querySelector(`[name="${key}"]`);
                        if (input) {
                            if (result[key] !== null && result[key] !== undefined && result[key] !== '') {
                                // Dla dat (type="date") upewnij siƒô ≈ºe format jest YYYY-MM-DD
                                if (input.type === 'date') {
                                    if (typeof result[key] === 'string') {
                                        // Je≈õli data jest ju≈º w formacie YYYY-MM-DD
                                        input.value = result[key].substring(0, 10);
                                    } else if (result[key] && result[key].isoformat) {
                                        input.value = result[key].isoformat().substring(0, 10);
                                    }
                                } else {
                                    // Dla innych p√≥l po prostu przypisz warto≈õƒá
                                    // Upewnij siƒô, ≈ºe pole jest widoczne (nie ukryte przez display: none)
                                    const formGroup = input.closest('.form-group');
                                    if (formGroup && formGroup.style.display === 'none') {
                                        formGroup.style.display = 'flex';
                                    }
                                    // Wype≈Çnij pole - upewnij siƒô ≈ºe warto≈õƒá jest liczbƒÖ lub stringiem
                                    const value = result[key];
                                    if (typeof value === 'number' || (typeof value === 'string' && value.trim() !== '')) {
                                        input.value = value;
                                    }
                                }
                            }
                        }
                    });
                    
                    // Poka≈º pola dla dystrybucji zmiennej 2 je≈õli istniejƒÖ
                    if (result.distribution_variable_2_usage_m3) {
                        document.getElementById('distribution-variable-2-group').style.display = 'flex';
                        document.getElementById('distribution-variable-2-conv-group').style.display = 'flex';
                        document.getElementById('distribution-variable-2-kwh-group').style.display = 'flex';
                        document.getElementById('distribution-variable-2-price-group').style.display = 'flex';
                        document.getElementById('distribution-variable-2-value-group').style.display = 'flex';
                    } else {
                        // Ukryj wszystkie pola dystrybucji zmiennej 2
                        document.getElementById('distribution-variable-2-group').style.display = 'none';
                        document.getElementById('distribution-variable-2-conv-group').style.display = 'none';
                        document.getElementById('distribution-variable-2-kwh-group').style.display = 'none';
                        document.getElementById('distribution-variable-2-price-group').style.display = 'none';
                        document.getElementById('distribution-variable-2-value-group').style.display = 'none';
                    }
                    // Poka≈º formularz weryfikacji
                    const verificationDiv = document.getElementById('gas-invoice-verification');
                    verificationDiv.style.display = 'block';
                    showAlert('Faktura sparsowana - zweryfikuj dane przed zapisem');
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd parsowania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function verifyAndSaveGasInvoice() {
            const form = document.getElementById('form-gas-invoice-verify');
            const formData = new FormData(form);
            const data = {};
            // Lista p√≥l numerycznych
            const numericFields = [
                'previous_reading', 'current_reading',
                'fuel_usage_m3', 'fuel_conversion_factor', 'fuel_usage_kwh', 'fuel_price_net', 
                'fuel_value_net', 'fuel_value_gross',
                'subscription_quantity', 'subscription_price_net', 'subscription_value_net', 
                'subscription_value_gross',
                'distribution_fixed_quantity', 'distribution_fixed_price_net', 
                'distribution_fixed_value_net', 'distribution_fixed_value_gross',
                'distribution_variable_usage_m3', 'distribution_variable_conversion_factor',
                'distribution_variable_usage_kwh', 'distribution_variable_price_net', 'distribution_variable_value_net',
                'distribution_variable_value_gross',
                'distribution_variable_2_usage_m3', 'distribution_variable_2_conversion_factor',
                'distribution_variable_2_usage_kwh', 'distribution_variable_2_price_net', 'distribution_variable_2_value_net',
                'total_net_sum', 'vat_rate', 'vat_amount', 'total_gross_sum',
                'late_payment_interest', 'amount_to_pay'
            ];
            
            for (const [key, value] of formData.entries()) {
                if (key.startsWith('distribution_variable_2_')) {
                    // Pola dystrybucji zmiennej 2 sƒÖ opcjonalne - je≈õli sƒÖ puste, ustaw null
                    if (value && value.trim() !== '') {
                        // Zamie≈Ñ przecinki na kropki dla liczb
                        const numValue = value.toString().replace(',', '.');
                        data[key] = parseFloat(numValue);
                    } else {
                        data[key] = null;
                    }
                } else if (numericFields.includes(key)) {
                    if (value) {
                        // Zamie≈Ñ przecinki na kropki dla liczb
                        const numValue = value.toString().replace(',', '.');
                        data[key] = parseFloat(numValue) || 0;
                    } else {
                        data[key] = 0;
                    }
                } else if (key === 'subscription_quantity' || key === 'distribution_fixed_quantity') {
                    data[key] = value ? parseInt(value) : 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Faktura gazu zapisana pomy≈õlnie!');
                    form.reset();
                    const verificationDiv = document.getElementById('gas-invoice-verification');
                    verificationDiv.style.display = 'none';
                    document.getElementById('gas-invoice-file').value = '';
                    document.getElementById('gas-invoice-file-name').textContent = '';
                    // Przywr√≥ƒá oryginalny przycisk
                    const verifyTitle = verificationDiv.querySelector('h3');
                    if (verifyTitle) verifyTitle.textContent = 'Weryfikuj dane faktury przed zapisem';
                    const verifyBtn = verificationDiv.querySelector('.btn-success');
                    if (verifyBtn) {
                        verifyBtn.textContent = 'Zatwierd≈∫ i zapisz';
                        verifyBtn.onclick = verifyAndSaveGasInvoice;
                    }
                    loadGasInvoices();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd zapisywania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function cancelGasInvoiceVerification() {
            const verificationDiv = document.getElementById('gas-invoice-verification');
            verificationDiv.style.display = 'none';
            document.getElementById('form-gas-invoice-verify').reset();
            document.getElementById('gas-invoice-file').value = '';
            document.getElementById('gas-invoice-file-name').textContent = '';
            // Przywr√≥ƒá oryginalny przycisk
            const verifyTitle = verificationDiv.querySelector('h3');
            if (verifyTitle) verifyTitle.textContent = 'Weryfikuj dane faktury przed zapisem';
            const verifyBtn = verificationDiv.querySelector('.btn-success');
            if (verifyBtn) {
                verifyBtn.textContent = 'Zatwierd≈∫ i zapisz';
                verifyBtn.onclick = verifyAndSaveGasInvoice;
            }
        }

        function toggleManualGasInvoiceForm() {
            const formDiv = document.getElementById('gas-invoice-manual-form');
            const btn = document.getElementById('btn-show-manual-gas-invoice');
            
            if (formDiv.style.display === 'none' || formDiv.style.display === '') {
                formDiv.style.display = 'block';
                btn.textContent = 'Ukryj formularz rƒôczny';
            } else {
                formDiv.style.display = 'none';
                btn.textContent = 'LUB DODAJ RƒòCZNIE';
            }
        }

        async function addGasInvoice() {
            const form = document.getElementById('form-gas-invoice');
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                // Konwertuj warto≈õci numeryczne
                if (['previous_reading', 'current_reading', 'fuel_value_gross', 
                     'subscription_value_gross', 'distribution_fixed_value_gross', 
                     'distribution_variable_value_gross', 'total_gross_sum'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else {
                    data[key] = value;
                }
            }
            
            // Ustaw domy≈õlny VAT je≈õli nie podano
            if (!data.vat_rate) data.vat_rate = 0.23;

            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    showAlert('Faktura gazu dodana pomy≈õlnie!');
                    form.reset();
                    // Ukryj formularz rƒôczny po dodaniu faktury
                    const formDiv = document.getElementById('gas-invoice-manual-form');
                    const btn = document.getElementById('btn-show-manual-gas-invoice');
                    formDiv.style.display = 'none';
                    btn.textContent = 'LUB DODAJ RƒòCZNIE';
                    loadGasInvoices();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    console.error('B≈ÇƒÖd API:', error);
                    // Wy≈õwietl szczeg√≥≈Çy b≈Çƒôdu je≈õli sƒÖ dostƒôpne
                    if (error.detail) {
                        if (Array.isArray(error.detail)) {
                            showAlert(error.detail.map(e => e.msg || e).join(', '), 'error');
                        } else {
                            showAlert(error.detail, 'error');
                        }
                    } else {
                        showAlert('B≈ÇƒÖd dodawania faktury', 'error');
                    }
                }
            } catch (error) {
                console.error('B≈ÇƒÖd po≈ÇƒÖczenia:', error);
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Rachunki gazu
        async function loadGasBills() {
            try {
                const res = await fetch(`${API_BASE}/api/gas/bills/`);
                const bills = await res.json();
                const listEl = document.getElementById('gas-bills-list');
                
                if (bills.length === 0) {
                    listEl.innerHTML = '<p>Brak rachunk√≥w gazu. Wygeneruj rachunki dla okresu z fakturƒÖ.</p>';
                    return;
                }

                let html = `<table class="data-table"><thead><tr><th data-i18n="table.period">Okres</th><th data-i18n="table.local">Lokal</th><th data-i18n="table.share">Udzia≈Ç</th><th data-i18n="table.local_gross">Lokal brutto</th><th data-i18n="table.actions">Akcje</th></tr></thead><tbody>`;
                let previousPeriod = null;
                bills.forEach(b => {
                    // Dodaj separator je≈õli okres siƒô zmieni≈Ç (i to nie jest pierwszy rachunek)
                    if (previousPeriod !== null && previousPeriod !== b.data) {
                        html += `<tr><td colspan="5" style="padding: 4px 0; border-bottom: 1px solid var(--border-color);"></td></tr>`;
                    }
                    previousPeriod = b.data;
                    
                    html += `<tr class="clickable" onclick="toggleGasBillDetails(${b.id})" data-gas-bill-id="${b.id}">
                        <td>${b.data}</td>
                        <td>${b.local}</td>
                        <td>${(b.cost_share * 100).toFixed(0)}%</td>
                        <td>${(b.total_gross_sum || 0).toFixed(2)} z≈Ç</td>
                        <td class="actions" onclick="event.stopPropagation()">
                            <a href="${API_BASE}/api/gas/bills/download/${b.id}" target="_blank" class="btn btn-success btn-small">üì• PDF</a>
                            <button class="btn btn-edit btn-small" onclick="editGasBill(${b.id})" title="Edytuj rachunek">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteGasBill(${b.id})" title="Usu≈Ñ rachunek">üóëÔ∏è</button>
                        </td>
                    </tr>
                    <tr class="details-row" id="gas-bill-details-${b.id}" data-gas-bill-id="${b.id}">
                        <td colspan="5" class="details-cell">
                            <div class="details-grid">
                                <div class="details-item"><label data-i18n="details.period">Okres:</label><span class="value">${b.data}</span></div>
                                <div class="details-item"><label data-i18n="details.local">Lokal:</label><span class="value">${b.local}</span></div>
                                <div class="details-item"><label data-i18n="details.share">Udzia≈Ç:</label><span class="value">${(b.cost_share * 100).toFixed(0)}%</span></div>
                                <div class="details-item"><label data-i18n="details.fuel_cost_gross">Paliwo (brutto):</label><span class="value">${(b.fuel_cost_gross || 0).toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.subscription_cost_gross">Abonament (brutto):</label><span class="value">${(b.subscription_cost_gross || 0).toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.distribution_fixed_cost_gross">Dystrybucja sta≈Ça (brutto):</label><span class="value">${(b.distribution_fixed_cost_gross || 0).toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.distribution_variable_cost_gross">Dystrybucja zmienna (brutto):</label><span class="value">${(b.distribution_variable_cost_gross || 0).toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.total_net_sum">Suma netto:</label><span class="value">${(b.total_net_sum || 0).toFixed(2)} z≈Ç</span></div>
                                <div class="details-item"><label data-i18n="details.local_gross">Lokal brutto:</label><span class="value">${(b.total_gross_sum || 0).toFixed(2)} z≈Ç</span></div>
                            </div>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
                updateTexts();
            } catch (error) {
                document.getElementById('gas-bills-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania rachunk√≥w</p>';
            }
        }

        async function deleteGasInvoice(invoiceId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô fakturƒô gazu? Je≈õli to ostatnia faktura dla tego okresu, zostanƒÖ r√≥wnie≈º usuniƒôte wszystkie rachunki dla tego okresu.')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/${invoiceId}`, { method: 'DELETE' });
                if (res.ok) {
                    const result = await res.json();
                    if (result.deleted_bills_count > 0) {
                        showAlert(`Faktura gazu usuniƒôta. Usuniƒôto r√≥wnie≈º ${result.deleted_bills_count} rachunk√≥w dla okresu ${result.period}.`);
                    } else {
                        showAlert('Faktura gazu usuniƒôta. Rachunki pozostajƒÖ (istniejƒÖ inne faktury dla tego okresu).');
                    }
                    loadGasInvoices();
                    loadGasBills();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function generateGasBills() {
            const period = document.getElementById('gas-bill-period').value.trim();
            if (!period || !period.match(/^\d{4}-\d{2}$/)) {
                showAlert('Podaj prawid≈Çowy okres (YYYY-MM)', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/bills/generate/${period}`, { method: 'POST' });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Wygenerowano ${result.bills_count} rachunk√≥w gazu dla okresu ${period}`);
                    loadGasBills();
                    loadGasStats();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd generowania rachunk√≥w', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // ========== FUNKCJE DLA PRƒÑDU ==========
        
        // Statystyki prƒÖdu
        async function loadElectricityStats() {
            try {
                const res = await fetch(`${API_BASE}/api/electricity/stats`);
                const stats = await res.json();
                document.getElementById('electricity-stat-readings').textContent = stats.readings_count || 0;
                document.getElementById('electricity-stat-invoices').textContent = stats.invoices_count || 0;
                document.getElementById('electricity-stat-bills').textContent = stats.bills_count || 0;
                document.getElementById('electricity-stat-total').textContent = (stats.total_gross_sum || 0).toFixed(2) + ' z≈Ç';
                document.getElementById('electricity-stat-latest-period').textContent = stats.latest_period || '-';
                
                // Statystyki na g≈Ç√≥wnej stronie
                document.getElementById('main-electricity-readings').textContent = stats.readings_count || 0;
                document.getElementById('main-electricity-invoices').textContent = stats.invoices_count || 0;
                document.getElementById('main-electricity-bills').textContent = stats.bills_count || 0;
                document.getElementById('main-electricity-period').textContent = stats.latest_period || '-';
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania statystyk prƒÖdu:', error);
            }
        }

        // Odczyty prƒÖdu
        async function loadElectricityReadings() {
            try {
                const res = await fetch(`${API_BASE}/api/electricity/readings`);
                const readings = await res.json();
                const listEl = document.getElementById('electricity-readings-list');
                
                if (readings.length === 0) {
                    listEl.innerHTML = '<p>Brak odczyt√≥w prƒÖdu</p>';
                    return;
                }

                let html = `<table class="data-table"><thead><tr><th data-i18n="table.period">Okres</th><th data-i18n="table.reading_date">Data odczytu</th><th data-i18n="table.dom">DOM</th><th data-i18n="table.dol">D√ì≈Å</th><th data-i18n="table.gabinet">GABINET</th><th data-i18n="table.actions">Akcje</th></tr></thead><tbody>`;
                readings.forEach(r => {
                    // Debug - sprawd≈∫ warto≈õci
                    console.log('Reading data:', r);
                    
                    // Formatowanie DOM
                    let domStr = '-';
                    if (r.is_main_meter_single_tariff === true || r.is_main_meter_single_tariff === 1) {
                        // Licznik jednotaryfowy
                        if (r.main_reading != null && r.main_reading !== undefined && !isNaN(r.main_reading)) {
                            domStr = parseFloat(r.main_reading).toFixed(2);
                        }
                    } else {
                        // Licznik dwutaryfowy
                        const t1 = (r.main_reading_t1 != null && r.main_reading_t1 !== undefined && !isNaN(r.main_reading_t1)) 
                            ? parseFloat(r.main_reading_t1).toFixed(2) : '-';
                        const t2 = (r.main_reading_t2 != null && r.main_reading_t2 !== undefined && !isNaN(r.main_reading_t2)) 
                            ? parseFloat(r.main_reading_t2).toFixed(2) : '-';
                        domStr = `${t1} / ${t2}`;
                    }
                    
                    // Formatowanie D√ì≈Å
                    let dolStr = '-';
                    if (r.is_dol_meter_single_tariff === true || r.is_dol_meter_single_tariff === 1) {
                        // Licznik jednotaryfowy
                        if (r.dol_reading != null && r.dol_reading !== undefined && !isNaN(r.dol_reading)) {
                            dolStr = parseFloat(r.dol_reading).toFixed(2);
                        }
                    } else {
                        // Licznik dwutaryfowy
                        const t1 = (r.dol_reading_t1 != null && r.dol_reading_t1 !== undefined && !isNaN(r.dol_reading_t1)) 
                            ? parseFloat(r.dol_reading_t1).toFixed(2) : '-';
                        const t2 = (r.dol_reading_t2 != null && r.dol_reading_t2 !== undefined && !isNaN(r.dol_reading_t2)) 
                            ? parseFloat(r.dol_reading_t2).toFixed(2) : '-';
                        dolStr = `${t1} / ${t2}`;
                    }
                    
                    // Formatowanie GABINET
                    let gabinetStr = '-';
                    if (r.gabinet_reading != null && r.gabinet_reading !== undefined && !isNaN(r.gabinet_reading)) {
                        gabinetStr = parseFloat(r.gabinet_reading).toFixed(2);
                    }
                    
                    // Formatowanie daty odczytu licznika
                    let dataOdczytuStr = '-';
                    if (r.data_odczytu_licznika) {
                        const dateObj = new Date(r.data_odczytu_licznika);
                        if (!isNaN(dateObj.getTime())) {
                            dataOdczytuStr = dateObj.toLocaleDateString('pl-PL');
                        }
                    }
                    
                    html += `<tr data-reading-data="${r.data}">
                        <td>${r.data}</td>
                        <td>${dataOdczytuStr}</td>
                        <td>${domStr}</td>
                        <td>${dolStr}</td>
                        <td>${gabinetStr}</td>
                        <td class="actions" onclick="event.stopPropagation()">
                            <button class="btn btn-edit btn-small" onclick="editElectricityReading('${r.data}')" title="Edytuj odczyt">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteElectricityReading('${r.data}')" title="Usu≈Ñ odczyt">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
                updateTexts();
            } catch (error) {
                document.getElementById('electricity-readings-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania odczyt√≥w</p>';
            }
        }

        async function addElectricityReading() {
            const form = document.getElementById('form-electricity-reading');
            const formData = new FormData(form);
            const data = {};
            
            // Konwersja warto≈õci
            data['data'] = formData.get('data');
            data['data_odczytu_licznika'] = formData.get('data_odczytu_licznika') || null;
            data['is_main_meter_single_tariff'] = formData.get('licznik_dom_jednotaryfowy') === 'true';
            data['is_dol_meter_single_tariff'] = formData.get('licznik_dol_jednotaryfowy') === 'true';
            data['gabinet_reading'] = parseFloat(formData.get('odczyt_gabinet')) || 0;
            
            if (data['is_main_meter_single_tariff']) {
                data['main_reading'] = parseFloat(formData.get('odczyt_dom')) || null;
                data['main_reading_t1'] = null;
                data['main_reading_t2'] = null;
            } else {
                data['main_reading'] = null;
                data['main_reading_t1'] = parseFloat(formData.get('odczyt_dom_I')) || null;
                data['main_reading_t2'] = parseFloat(formData.get('odczyt_dom_II')) || null;
            }
            
            if (data['is_dol_meter_single_tariff']) {
                data['dol_reading'] = parseFloat(formData.get('odczyt_dol')) || null;
                data['dol_reading_t1'] = null;
                data['dol_reading_t2'] = null;
            } else {
                data['dol_reading'] = null;
                data['dol_reading_t1'] = parseFloat(formData.get('odczyt_dol_I')) || null;
                data['dol_reading_t2'] = parseFloat(formData.get('odczyt_dol_II')) || null;
            }
            
            // local_id - domy≈õlnie 1 (g≈Ç√≥wny lokal)
            data['local_id'] = 1;

            try {
                const res = await fetch(`${API_BASE}/api/electricity/readings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Odczyt prƒÖdu dodany pomy≈õlnie!');
                    form.reset();
                    loadElectricityReadings();
                    loadElectricityStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd dodawania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Edycja odczytu prƒÖdu
        async function editElectricityReading(data) {
            try {
                const res = await fetch(`${API_BASE}/api/electricity/readings/${data}`);
                if (res.ok) {
                    const reading = await res.json();
                    // Utw√≥rz formularz edycji
                    const formHtml = `
                        <div style="background: #f0f9ff; border: 2px solid #d47474; padding: 20px; margin: 20px 0; border-radius: 8px;">
                            <h3>Edytuj odczyt prƒÖdu</h3>
                            <form id="form-electricity-reading-edit-${data}" class="form-grid">
                                <div class="form-group">
                                    <label data-i18n="label.period">Okres (YYYY-MM)</label>
                                    <input type="text" name="data" value="${reading.data}" readonly>
                                </div>
                                <div class="form-group">
                                    <label data-i18n="label.reading_date">Data odczytu licznika</label>
                                    <input type="date" name="data_odczytu_licznika" value="${reading.data_odczytu_licznika || ''}">
                                </div>
                                <div class="form-group">
                                    <label data-i18n="label.meter_dom_single">Licznik DOM - Jednotaryfowy?</label>
                                    <select name="licznik_dom_jednotaryfowy" id="edit-dom-meter-type-${data}" onchange="toggleEditDomMeterType('${data}')">
                                        <option value="true" ${reading.is_main_meter_single_tariff ? 'selected' : ''}>Tak (jednotaryfowy)</option>
                                        <option value="false" ${!reading.is_main_meter_single_tariff ? 'selected' : ''}>Nie (dwutaryfowy)</option>
                                    </select>
                                </div>
                                <div class="form-group" id="edit-dom-jednotaryfowy-group-${data}" style="display: ${reading.is_main_meter_single_tariff ? 'flex' : 'none'};">
                                    <label data-i18n="label.reading_dom_single">Odczyt DOM (jednotaryfowy)</label>
                                    <input type="number" step="0.01" name="odczyt_dom" value="${reading.main_reading || ''}">
                                </div>
                                <div class="form-group" id="edit-dom-dwutaryfowy-group-${data}" style="display: ${!reading.is_main_meter_single_tariff ? 'flex' : 'none'};">
                                    <label data-i18n="label.reading_dom_tariff1">Odczyt DOM - Taryfa I</label>
                                    <input type="number" step="0.01" name="odczyt_dom_I" value="${reading.main_reading_t1 || ''}">
                                </div>
                                <div class="form-group" id="edit-dom-dwutaryfowy-group-2-${data}" style="display: ${!reading.is_main_meter_single_tariff ? 'flex' : 'none'};">
                                    <label data-i18n="label.reading_dom_tariff2">Odczyt DOM - Taryfa II</label>
                                    <input type="number" step="0.01" name="odczyt_dom_II" value="${reading.main_reading_t2 || ''}">
                                </div>
                                <div class="form-group">
                                    <label data-i18n="label.meter_dol_single">Licznik D√ì≈Å - Jednotaryfowy?</label>
                                    <select name="licznik_dol_jednotaryfowy" id="edit-dol-meter-type-${data}" onchange="toggleEditDolMeterType('${data}')">
                                        <option value="true" ${reading.is_dol_meter_single_tariff ? 'selected' : ''}>Tak (jednotaryfowy)</option>
                                        <option value="false" ${!reading.is_dol_meter_single_tariff ? 'selected' : ''}>Nie (dwutaryfowy)</option>
                                    </select>
                                </div>
                                <div class="form-group" id="edit-dol-jednotaryfowy-group-${data}" style="display: ${reading.is_dol_meter_single_tariff ? 'flex' : 'none'};">
                                    <label data-i18n="label.reading_dol_single">Odczyt D√ì≈Å (jednotaryfowy)</label>
                                    <input type="number" step="0.01" name="odczyt_dol" value="${reading.dol_reading || ''}">
                                </div>
                                <div class="form-group" id="edit-dol-dwutaryfowy-group-${data}" style="display: ${!reading.is_dol_meter_single_tariff ? 'flex' : 'none'};">
                                    <label data-i18n="label.reading_dol_tariff1">Odczyt D√ì≈Å - Taryfa I</label>
                                    <input type="number" step="0.01" name="odczyt_dol_I" value="${reading.dol_reading_t1 || ''}">
                                </div>
                                <div class="form-group" id="edit-dol-dwutaryfowy-group-2-${data}" style="display: ${!reading.is_dol_meter_single_tariff ? 'flex' : 'none'};">
                                    <label data-i18n="label.reading_dol_tariff2">Odczyt D√ì≈Å - Taryfa II</label>
                                    <input type="number" step="0.01" name="odczyt_dol_II" value="${reading.dol_reading_t2 || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Odczyt GABINET</label>
                                    <input type="number" step="0.01" name="odczyt_gabinet" value="${reading.gabinet_reading || 0}" required>
                                </div>
                            </form>
                            <button class="btn btn-success" onclick="updateElectricityReading('${data}')">Zapisz zmiany</button>
                            <button class="btn btn-secondary" onclick="cancelElectricityReadingEdit('${data}')">Anuluj</button>
                        </div>
                    `;
                    // Znajd≈∫ wiersz z odczytem i dodaj formularz
                    const readingRow = document.querySelector(`tr[data-reading-data="${data}"]`);
                    if (readingRow) {
                        const existingForm = document.getElementById(`form-electricity-reading-edit-${data}`);
                        if (existingForm) {
                            existingForm.parentElement.remove();
                        } else {
                            readingRow.insertAdjacentHTML('afterend', `<tr><td colspan="6">${formHtml}</td></tr>`);
                        }
                    } else {
                        // Je≈õli nie ma wiersza, dodaj na ko≈Ñcu listy
                        const listEl = document.getElementById('electricity-readings-list');
                        listEl.insertAdjacentHTML('beforeend', `<tr><td colspan="6">${formHtml}</td></tr>`);
                    }
                } else {
                    showAlert('B≈ÇƒÖd pobierania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function toggleEditDomMeterType(data) {
            const select = document.getElementById(`edit-dom-meter-type-${data}`);
            const isJednotaryfowy = select.value === 'true';
            document.getElementById(`edit-dom-jednotaryfowy-group-${data}`).style.display = isJednotaryfowy ? 'flex' : 'none';
            document.getElementById(`edit-dom-dwutaryfowy-group-${data}`).style.display = isJednotaryfowy ? 'none' : 'flex';
            document.getElementById(`edit-dom-dwutaryfowy-group-2-${data}`).style.display = isJednotaryfowy ? 'none' : 'flex';
        }

        function toggleEditDolMeterType(data) {
            const select = document.getElementById(`edit-dol-meter-type-${data}`);
            const isJednotaryfowy = select.value === 'true';
            document.getElementById(`edit-dol-jednotaryfowy-group-${data}`).style.display = isJednotaryfowy ? 'flex' : 'none';
            document.getElementById(`edit-dol-dwutaryfowy-group-${data}`).style.display = isJednotaryfowy ? 'none' : 'flex';
            document.getElementById(`edit-dol-dwutaryfowy-group-2-${data}`).style.display = isJednotaryfowy ? 'none' : 'flex';
        }

        async function updateElectricityReading(data) {
            const form = document.getElementById(`form-electricity-reading-edit-${data}`);
            const formData = new FormData(form);
            const readingData = {};
            
            // Konwersja warto≈õci
            readingData['data'] = formData.get('data');
            readingData['data_odczytu_licznika'] = formData.get('data_odczytu_licznika') || null;
            readingData['is_main_meter_single_tariff'] = formData.get('licznik_dom_jednotaryfowy') === 'true';
            readingData['is_dol_meter_single_tariff'] = formData.get('licznik_dol_jednotaryfowy') === 'true';
            readingData['gabinet_reading'] = parseFloat(formData.get('odczyt_gabinet')) || 0;
            
            if (readingData['is_main_meter_single_tariff']) {
                readingData['main_reading'] = parseFloat(formData.get('odczyt_dom')) || null;
                readingData['main_reading_t1'] = null;
                readingData['main_reading_t2'] = null;
            } else {
                readingData['main_reading'] = null;
                readingData['main_reading_t1'] = parseFloat(formData.get('odczyt_dom_I')) || null;
                readingData['main_reading_t2'] = parseFloat(formData.get('odczyt_dom_II')) || null;
            }
            
            if (readingData['is_dol_meter_single_tariff']) {
                readingData['dol_reading'] = parseFloat(formData.get('odczyt_dol')) || null;
                readingData['dol_reading_t1'] = null;
                readingData['dol_reading_t2'] = null;
            } else {
                readingData['dol_reading'] = null;
                readingData['dol_reading_t1'] = parseFloat(formData.get('odczyt_dol_I')) || null;
                readingData['dol_reading_t2'] = parseFloat(formData.get('odczyt_dol_II')) || null;
            }

            try {
                const res = await fetch(`${API_BASE}/api/electricity/readings/${data}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(readingData)
                });
                if (res.ok) {
                    showAlert('Odczyt prƒÖdu zaktualizowany pomy≈õlnie!');
                    cancelElectricityReadingEdit(data);
                    loadElectricityReadings();
                    loadElectricityStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function cancelElectricityReadingEdit(data) {
            const formDiv = document.getElementById(`form-electricity-reading-edit-${data}`);
            if (formDiv) {
                formDiv.closest('tr').remove();
            }
        }

        async function deleteElectricityReading(data) {
            if (!confirm(`Czy na pewno chcesz usunƒÖƒá odczyt dla okresu ${data}? ZostanƒÖ r√≥wnie≈º usuniƒôte wszystkie rachunki dla tego okresu.`)) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/electricity/readings/${data}`, { method: 'DELETE' });
                if (res.ok) {
                    const result = await res.json();
                    showAlert(`Odczyt dla okresu ${data} usuniƒôty. Usuniƒôto r√≥wnie≈º ${result.deleted_bills_count} rachunk√≥w.`);
                    loadElectricityReadings();
                    loadElectricityBills();
                    loadElectricityStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Faktury prƒÖdu
        async function loadElectricityInvoices() {
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/`);
                const invoices = await res.json();
                const listEl = document.getElementById('electricity-invoices-list');
                
                if (invoices.length === 0) {
                    listEl.innerHTML = '<p>Brak faktur prƒÖdu</p>';
                    return;
                }

                let html = `<table class="data-table"><thead><tr><th data-i18n="table.invoice_number">Nr faktury</th><th data-i18n="table.period_billing">Okres Rozliczeniowy</th><th data-i18n="table.cost_per_kwh">Koszt za 1kWh</th><th data-i18n="table.usage_kwh">Zu≈ºycie (kWh)</th><th data-i18n="table.tariff_type">Typ taryfy</th><th data-i18n="table.amount_to_pay">Do zap≈Çaty</th><th data-i18n="table.actions">Akcje</th></tr></thead><tbody>`;
                invoices.forEach(i => {
                    // Formatuj okres jako daty poczƒÖtku i ko≈Ñca: DD.MM.YYYY - DD.MM.YYYY
                    let okres = '-';
                    if (i.data_poczatku_okresu && i.data_konca_okresu) {
                        const startDate = new Date(i.data_poczatku_okresu);
                        const endDate = new Date(i.data_konca_okresu);
                        const formatDate = (date) => {
                            const day = String(date.getDate()).padStart(2, '0');
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const year = date.getFullYear();
                            return `${day}.${month}.${year}`;
                        };
                        okres = `${formatDate(startDate)} - ${formatDate(endDate)}`;
                    } else if (i.data_poczatku_okresu) {
                        const startDate = new Date(i.data_poczatku_okresu);
                        const formatDate = (date) => {
                            const day = String(date.getDate()).padStart(2, '0');
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const year = date.getFullYear();
                            return `${day}.${month}.${year}`;
                        };
                        okres = formatDate(startDate);
                    } else if (i.rok) {
                        okres = `${i.rok}`;
                    }
                    
                    // Przygotuj koszt 1 kWh - dla dwutaryfowej poka≈º dziennƒÖ i nocnƒÖ, dla ca≈Çodobowej tylko ca≈ÇodobowƒÖ
                    let koszt_kwh = '-';
                    if (i.typ_taryfy === 'DWUTARYFOWA') {
                        const dzienna = i.koszt_1kwh_dzienna !== null && i.koszt_1kwh_dzienna !== undefined ? 
                            `${i.koszt_1kwh_dzienna.toFixed(4)}` : '-';
                        const nocna = i.koszt_1kwh_nocna !== null && i.koszt_1kwh_nocna !== undefined ? 
                            `${i.koszt_1kwh_nocna.toFixed(4)}` : '-';
                        koszt_kwh = `D: ${dzienna} / N: ${nocna} z≈Ç/kWh`;
                    } else if (i.typ_taryfy === 'CA≈ÅODOBOWA') {
                        koszt_kwh = i.koszt_1kwh_calodobowa !== null && i.koszt_1kwh_calodobowa !== undefined ? 
                            `${i.koszt_1kwh_calodobowa.toFixed(4)} z≈Ç/kWh` : '-';
                    }
                    
                    html += `<tr class="clickable" onclick="showElectricityInvoiceDetails(${i.id})" data-invoice-id="${i.id}">
                        <td>${i.numer_faktury}</td>
                        <td>${okres}</td>
                        <td>${koszt_kwh}</td>
                        <td>${(i.zuzycie_kwh || 0)}</td>
                        <td>${i.typ_taryfy || '-'}</td>
                        <td>${(i.do_zaplaty || 0).toFixed(2)} z≈Ç</td>
                        <td class="actions" onclick="event.stopPropagation()">
                            <button class="btn btn-edit btn-small" onclick="editElectricityInvoice(${i.id})" title="Edytuj fakturƒô">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteElectricityInvoice(${i.id})" title="Usu≈Ñ fakturƒô">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
                updateTexts();
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania faktur:', error);
                document.getElementById('electricity-invoices-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania faktur</p>';
            }
        }
        
        async function showElectricityInvoiceDetails(invoiceId) {
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/${invoiceId}`);
                if (res.ok) {
                    const data = await res.json();
                    const invoice = data.invoice;
                    
                    // Poka≈º szczeg√≥≈Çy w modalnym oknie lub rozwi≈Ñ wiersz
                    alert(`Faktura: ${invoice.numer_faktury}\nRok: ${invoice.rok}\nOkres: ${invoice.data_poczatku_okresu} - ${invoice.data_konca_okresu}\nZu≈ºycie: ${invoice.zuzycie_kwh} kWh\nDo zap≈Çaty: ${invoice.do_zaplaty} z≈Ç`);
                }
            } catch (error) {
                console.error('B≈ÇƒÖd pobierania szczeg√≥≈Ç√≥w faktury:', error);
            }
        }

        async function uploadElectricityInvoice() {
            const fileInput = document.getElementById('electricity-invoice-file');
            if (!fileInput.files[0]) {
                showAlert('Wybierz plik PDF', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/parse`, {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    const result = await res.json();
                    console.log('Sparsowane dane faktury:', result);
                    
                    // Wype≈Çnij formularz weryfikacji
                    const verifyForm = document.getElementById('form-electricity-invoice-verify');
                    if (!verifyForm) {
                        showAlert('Nie znaleziono formularza weryfikacji', 'error');
                        return;
                    }
                    
                    // Mapowanie starych p√≥l na nowe (je≈õli parser zwraca stare nazwy)
                    const fieldMapping = {
                        'data': 'rok',  // Okres -> Rok (wyciƒÖgnij rok z okresu)
                        'invoice_number': 'numer_faktury',
                        'period_start': 'data_poczatku_okresu',
                        'period_stop': 'data_konca_okresu',
                        'usage_kwh': 'zuzycie_kwh',
                        'total_gross_sum': 'do_zaplaty',
                        'amount_to_pay': 'do_zaplaty'
                    };
                    
                    // WyciƒÖgnij rok z okresu je≈õli jest
                    if (result.data && !result.rok) {
                        const yearMatch = result.data.match(/^(\d{4})/);
                        if (yearMatch) {
                            result.rok = parseInt(yearMatch[1]);
                        }
                    }
                    
                    // Je≈õli nie ma rok, wyciƒÖgnij z daty poczƒÖtku okresu
                    if (!result.rok && result.period_start) {
                        const yearMatch = result.period_start.toString().match(/^(\d{4})/);
                        if (yearMatch) {
                            result.rok = parseInt(yearMatch[1]);
                        }
                    }
                    
                    // Je≈õli nie ma data_wystawienia, u≈ºyj data_poczatku_okresu lub period_start
                    if (!result.data_wystawienia) {
                        if (result.data_poczatku_okresu) {
                            result.data_wystawienia = result.data_poczatku_okresu;
                        } else if (result.period_start) {
                            result.data_wystawienia = result.period_start;
                        }
                    }
                    
                    // Mapuj period_start/period_stop na data_poczatku_okresu/data_konca_okresu je≈õli brakuje
                    if (!result.data_poczatku_okresu && result.period_start) {
                        result.data_poczatku_okresu = result.period_start;
                    }
                    if (!result.data_konca_okresu && result.period_stop) {
                        result.data_konca_okresu = result.period_stop;
                    }
                    
                    // Mapuj invoice_number na numer_faktury je≈õli brakuje
                    if (!result.numer_faktury && result.invoice_number) {
                        result.numer_faktury = result.invoice_number;
                    }
                    
                    // Mapuj usage_kwh na zuzycie_kwh je≈õli brakuje
                    if (!result.zuzycie_kwh && result.usage_kwh !== undefined) {
                        result.zuzycie_kwh = result.usage_kwh;
                    }
                    
                    // Mapuj amount_to_pay na do_zaplaty je≈õli brakuje
                    if (!result.do_zaplaty && result.amount_to_pay !== undefined) {
                        result.do_zaplaty = result.amount_to_pay;
                    }
                    if (!result.do_zaplaty && result.total_gross_sum !== undefined) {
                        result.do_zaplaty = result.total_gross_sum;
                    }
                    
                    // Funkcja pomocnicza do konwersji daty
                    function convertDateToISO(dateValue) {
                        if (!dateValue) return null;
                        
                        // Je≈õli to ju≈º obiekt Date
                        if (dateValue instanceof Date) {
                            return dateValue.toISOString().substring(0, 10);
                        }
                        
                        // Je≈õli to string
                        if (typeof dateValue === 'string') {
                            // Format YYYY-MM-DD
                            if (dateValue.match(/^\d{4}-\d{2}-\d{2}/)) {
                                return dateValue.substring(0, 10);
                            }
                            // Format DD/MM/YYYY
                            if (dateValue.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
                                const parts = dateValue.split('/');
                                const day = parts[0].padStart(2, '0');
                                const month = parts[1].padStart(2, '0');
                                const year = parts[2];
                                return `${year}-${month}-${day}`;
                            }
                            // Spr√≥buj sparsowaƒá jako Date
                            try {
                                const date = new Date(dateValue);
                                if (!isNaN(date.getTime())) {
                                    return date.toISOString().substring(0, 10);
                                }
                            } catch (e) {
                                console.warn(`Nie mo≈ºna sparsowaƒá daty:`, dateValue);
                            }
                        }
                        return null;
                    }
                    
                    // Wype≈Çnij wszystkie pola formularza
                    // Najpierw wype≈Çnij pola z result
                    Object.keys(result).forEach(key => {
                        // Pomi≈Ñ pola pomocnicze i szczeg√≥≈Çowe (bƒôdƒÖ obs≈Çu≈ºone osobno)
                        if (key.startsWith('_')) return;
                        if (['blankiety', 'odczyty', 'sprzedaz_energii', 'oplaty_dystrybucyjne', 'rozliczenie_okresy'].includes(key)) return;
                        
                        const fieldName = fieldMapping[key] || key;
                        const input = verifyForm.querySelector(`[name="${fieldName}"]`);
                        
                        if (input) {
                            const value = result[key];
                            
                            // Sprawd≈∫ czy warto≈õƒá istnieje (nawet je≈õli to 0 lub pusty string)
                            if (value !== null && value !== undefined) {
                                if (input.type === 'date') {
                                    const isoDate = convertDateToISO(value);
                                    if (isoDate) {
                                        input.value = isoDate;
                                    }
                                } else if (input.type === 'number') {
                                    const numValue = parseFloat(value);
                                    if (!isNaN(numValue)) {
                                        input.value = numValue;
                                    } else if (value === '' || value === 0) {
                                        // Dla p√≥l numerycznych, 0 jest wa≈ºnƒÖ warto≈õciƒÖ
                                        input.value = 0;
                                    }
                                } else if (input.tagName === 'SELECT') {
                                    // Dla select√≥w sprawd≈∫ czy warto≈õƒá pasuje
                                    const strValue = String(value);
                                    if (Array.from(input.options).some(opt => opt.value === strValue)) {
                                        input.value = strValue;
                                    }
                                } else {
                                    // Dla p√≥l tekstowych
                                    input.value = String(value);
                                }
                            }
                        }
                    });
                    
                    // Upewnij siƒô, ≈ºe wszystkie wymagane pola majƒÖ warto≈õci (nawet je≈õli 0)
                    const requiredFields = {
                        'rok': result.rok || new Date().getFullYear(),
                        'numer_faktury': result.numer_faktury || result.invoice_number || '',
                        'data_wystawienia': result.data_wystawienia || result.data_poczatku_okresu || result.period_start || '',
                        'data_poczatku_okresu': result.data_poczatku_okresu || result.period_start || '',
                        'data_konca_okresu': result.data_konca_okresu || result.period_stop || '',
                        'naleznosc_za_okres': result.naleznosc_za_okres || 0,
                        'wartosc_prognozy': result.wartosc_prognozy || 0,
                        'faktury_korygujace': result.faktury_korygujace || 0,
                        'odsetki': result.odsetki || 0,
                        'wynik_rozliczenia': result.wynik_rozliczenia || 0,
                        'kwota_nadplacona': result.kwota_nadplacona || 0,
                        'saldo_z_rozliczenia': result.saldo_z_rozliczenia || result.do_zaplaty || 0,
                        'niedoplata_nadplata': result.niedoplata_nadplata || 0,
                        'energia_do_akcyzy_kwh': result.energia_do_akcyzy_kwh || 0,
                        'akcyza': result.akcyza || 0,
                        'do_zaplaty': result.do_zaplaty || result.amount_to_pay || result.total_gross_sum || 0,
                        'zuzycie_kwh': result.zuzycie_kwh || result.usage_kwh || 0,
                        'ogolem_sprzedaz_energii': result.ogolem_sprzedaz_energii || 0,
                        'ogolem_usluga_dystrybucji': result.ogolem_usluga_dystrybucji || 0,
                        'grupa_taryfowa': result.grupa_taryfowa || 'G12',
                        'typ_taryfy': result.typ_taryfy || 'DWUTARYFOWA',
                        'energia_lacznie_zuzyta_w_roku_kwh': result.energia_lacznie_zuzyta_w_roku_kwh || 0
                    };
                    
                    // Wype≈Çnij wszystkie wymagane pola
                    Object.keys(requiredFields).forEach(fieldName => {
                        const input = verifyForm.querySelector(`[name="${fieldName}"]`);
                        if (input) {
                            const value = requiredFields[fieldName];
                            if (input.type === 'date') {
                                const isoDate = convertDateToISO(value);
                                if (isoDate) {
                                    input.value = isoDate;
                                }
                            } else if (input.type === 'number') {
                                input.value = parseFloat(value) || 0;
                            } else if (input.tagName === 'SELECT') {
                                const strValue = String(value);
                                if (Array.from(input.options).some(opt => opt.value === strValue)) {
                                    input.value = strValue;
                                }
                            } else {
                                input.value = String(value);
                            }
                        }
                    });
                    
                    // Wy≈õwietl sekcje szczeg√≥≈Çowe
                    displayElectricityInvoiceDetails(result);
                    
                    document.getElementById('electricity-invoice-verification').style.display = 'block';
                    document.getElementById('electricity-verify-btn-top').style.display = 'inline-block';
                    showAlert('Faktura sparsowana - zweryfikuj dane przed zapisem');
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd parsowania faktury', 'error');
                }
            } catch (error) {
                console.error('B≈ÇƒÖd parsowania faktury:', error);
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }

        // Funkcja pomocnicza do parsowania warto≈õci numerycznych (globalna)
        function parseNumericValue(value, isInt = false) {
            if (!value || value === '' || value === null || value === undefined) {
                return isInt ? 0 : 0.0;
            }
            // Je≈õli warto≈õƒá jest ju≈º liczbƒÖ, zwr√≥ƒá jƒÖ bezpo≈õrednio
            if (typeof value === 'number') {
                return isInt ? Math.floor(value) : value;
            }
            
            let cleaned = String(value).replace(/\s/g, '');
            
            // Je≈õli warto≈õƒá zawiera kropki, sprawd≈∫ czy sƒÖ to separatory tysiƒôcy
            // Format polski: "24.320" (kropka = separator tysiƒôcy) lub "24.320,50" (kropka = separator tysiƒôcy, przecinek = dziesiƒôtny)
            // Format angielski: "24.32" (kropka = separator dziesiƒôtny)
            if (cleaned.includes('.')) {
                // Je≈õli jest te≈º przecinek, to kropki sƒÖ separatorami tysiƒôcy
                if (cleaned.includes(',')) {
                    // Format: "24.320,50" -> usu≈Ñ kropki -> "24320,50" -> zamie≈Ñ przecinek -> "24320.50"
                    cleaned = cleaned.replace(/\./g, '').replace(',', '.');
                } else {
                    // Tylko kropki - sprawd≈∫ czy to separatory tysiƒôcy
                    // W formacie polskim separatory tysiƒôcy to kropki, a ka≈ºda grupa ma 3 cyfry
                    // Format: "24.320" lub "1.234.567" -> wszystkie kropki to separatory tysiƒôcy
                    const parts = cleaned.split('.');
                    // Je≈õli wszystkie czƒô≈õci po pierwszej majƒÖ 3 cyfry, to sƒÖ to separatory tysiƒôcy
                    if (parts.length > 1 && parts.slice(1).every(part => part.length === 3)) {
                        // Format: "24.320" lub "1.234.567" -> usu≈Ñ wszystkie kropki
                        cleaned = cleaned.replace(/\./g, '');
                    }
                    // W przeciwnym razie kropka jest separatorem dziesiƒôtnym (zostaw)
                }
            } else if (cleaned.includes(',')) {
                // Tylko przecinek - zamie≈Ñ na kropkƒô (separator dziesiƒôtny)
                cleaned = cleaned.replace(',', '.');
            }
            
            const parsed = isInt ? parseInt(cleaned) : parseFloat(cleaned);
            return isNaN(parsed) ? (isInt ? 0 : 0.0) : parsed;
        }
        
        // Funkcja pomocnicza do zbierania danych z edytowalnych formularzy szczeg√≥≈Çowych
        function collectDetailedData() {
            const detailedData = {
                blankiety: [],
                odczyty: [],
                sprzedaz_energii: [],
                oplaty_dystrybucyjne: [],
                rozliczenie_okresy: []
            };
            
            // Zbierz blankiety
            const blankietyInputs = document.querySelectorAll('[name^="blankiety["]');
            const blankietyMap = {};
            blankietyInputs.forEach(input => {
                const match = input.name.match(/blankiety\[(\d+)\]\[(.+)\]/);
                if (match) {
                    const idx = parseInt(match[1]);
                    const field = match[2];
                    if (!blankietyMap[idx]) blankietyMap[idx] = {};
                    blankietyMap[idx][field] = input.value;
                }
            });
            
            Object.keys(blankietyMap).forEach(idx => {
                const b = blankietyMap[idx];
                if (b.nr_blankietu || b.okres_od || b.okres_do) { // Tylko je≈õli sƒÖ jakie≈õ dane
                    detailedData.blankiety.push({
                        id: b.id || null,
                        nr_blankietu: b.nr_blankietu || '',
                        okres_od: b.okres_od || null,
                        okres_do: b.okres_do || null,
                        ilosc_d: b.ilosc_d ? parseNumericValue(b.ilosc_d, true) : null,
                        ilosc_c: b.ilosc_c ? parseNumericValue(b.ilosc_c, true) : null,
                        ilosc_calodobowa: b.ilosc_calodobowa ? parseNumericValue(b.ilosc_calodobowa, true) : null,
                        kwota_brutto: parseNumericValue(b.kwota_brutto, false),
                        akcyza: parseNumericValue(b.akcyza, false),
                        energia_do_akcyzy: parseNumericValue(b.energia_do_akcyzy, true),
                        nadplata_niedoplata: parseNumericValue(b.nadplata_niedoplata, false),
                        odsetki: parseNumericValue(b.odsetki, false),
                        termin_platnosci: b.termin_platnosci || null,
                        do_zaplaty: parseNumericValue(b.do_zaplaty, false)
                    });
                }
            });
            
            // Zbierz odczyty
            const odczytyInputs = document.querySelectorAll('[name^="odczyty["]');
            const odczytyMap = {};
            odczytyInputs.forEach(input => {
                const match = input.name.match(/odczyty\[(\d+)\]\[(.+)\]/);
                if (match) {
                    const idx = parseInt(match[1]);
                    const field = match[2];
                    if (!odczytyMap[idx]) odczytyMap[idx] = {};
                    odczytyMap[idx][field] = input.value;
                }
            });
            Object.keys(odczytyMap).forEach(idx => {
                const o = odczytyMap[idx];
                if (o.data || o.biezace || o.poprzednie) { // Tylko je≈õli sƒÖ jakie≈õ dane
                    detailedData.odczyty.push({
                        id: o.id || null,
                        typ: o.typ || 'pobrana',
                        strefa: o.strefa || null,
                        data: o.data || null,
                        biezace: parseNumericValue(o.biezace, true),
                        poprzednie: parseNumericValue(o.poprzednie, true),
                        mnozna: parseNumericValue(o.mnozna, true) || 1,
                        ilosc: parseNumericValue(o.ilosc, true),
                        straty: parseNumericValue(o.straty, true),
                        razem: parseNumericValue(o.razem, true)
                    });
                }
            });
            
            // Zbierz sprzeda≈º energii
            const sprzedazInputs = document.querySelectorAll('[name^="sprzedaz_energii["]');
            const sprzedazMap = {};
            sprzedazInputs.forEach(input => {
                const match = input.name.match(/sprzedaz_energii\[(\d+)\]\[(.+)\]/);
                if (match) {
                    const idx = parseInt(match[1]);
                    const field = match[2];
                    if (!sprzedazMap[idx]) sprzedazMap[idx] = {};
                    sprzedazMap[idx][field] = input.value;
                }
            });
            Object.keys(sprzedazMap).forEach(idx => {
                const s = sprzedazMap[idx];
                // Sprawd≈∫ czy sƒÖ jakie≈õ dane (nawet je≈õli warto≈õci to 0)
                if (s.ilosc_kwh !== undefined && s.ilosc_kwh !== '' || 
                    s.cena !== undefined && s.cena !== '' || 
                    s.naleznosc !== undefined && s.naleznosc !== '') {
                    detailedData.sprzedaz_energii.push({
                        id: s.id || null,
                        strefa: s.strefa || null,
                        ilosc_kwh: parseNumericValue(s.ilosc_kwh, true),
                        cena: parseNumericValue(s.cena, false),
                        naleznosc: parseNumericValue(s.naleznosc, false),
                        vat: parseNumericValue(s.vat, false) || 23.0
                    });
                }
            });
            
            // Zbierz op≈Çaty dystrybucyjne
            const oplatyInputs = document.querySelectorAll('[name^="oplaty_dystrybucyjne["]');
            const oplatyMap = {};
            oplatyInputs.forEach(input => {
                const match = input.name.match(/oplaty_dystrybucyjne\[(\d+)\]\[(.+)\]/);
                if (match) {
                    const idx = parseInt(match[1]);
                    const field = match[2];
                    if (!oplatyMap[idx]) oplatyMap[idx] = {};
                    oplatyMap[idx][field] = input.value;
                }
            });
            Object.keys(oplatyMap).forEach(idx => {
                const op = oplatyMap[idx];
                // Sprawd≈∫ czy sƒÖ jakie≈õ dane (nawet je≈õli warto≈õci to 0)
                if (op.nazwa !== undefined && op.nazwa !== '' || 
                    op.cena !== undefined && op.cena !== '' || 
                    op.naleznosc !== undefined && op.naleznosc !== '') {
                    detailedData.oplaty_dystrybucyjne.push({
                        id: op.id || null,
                        nazwa: op.nazwa || '',
                        strefa: op.strefa || null,
                        jednostka: op.jednostka || 'kWh',
                        data: op.data || null,
                        ilosc_kwh: op.ilosc_kwh ? parseNumericValue(op.ilosc_kwh, true) : null,
                        ilosc_miesiecy: op.ilosc_miesiecy ? parseNumericValue(op.ilosc_miesiecy, false) : null,
                        wspolczynnik: op.wspolczynnik ? parseNumericValue(op.wspolczynnik, false) : null,
                        cena: parseNumericValue(op.cena, false),
                        naleznosc: parseNumericValue(op.naleznosc, false),
                        vat: parseNumericValue(op.vat, false) || 23.0
                    });
                }
            });
            
            // Zbierz rozliczenie okres√≥w
            const rozliczenieInputs = document.querySelectorAll('[name^="rozliczenie_okresy["]');
            const rozliczenieMap = {};
            rozliczenieInputs.forEach(input => {
                const match = input.name.match(/rozliczenie_okresy\[(\d+)\]\[(.+)\]/);
                if (match) {
                    const idx = parseInt(match[1]);
                    const field = match[2];
                    if (!rozliczenieMap[idx]) rozliczenieMap[idx] = {};
                    rozliczenieMap[idx][field] = input.value;
                }
            });
            Object.keys(rozliczenieMap).forEach(idx => {
                const r = rozliczenieMap[idx];
                if (r.data_okresu || r.numer_okresu) { // Tylko je≈õli sƒÖ jakie≈õ dane
                    detailedData.rozliczenie_okresy.push({
                        id: r.id || null,
                        numer_okresu: r.numer_okresu ? parseInt(r.numer_okresu) : parseInt(idx) + 1,
                        data_okresu: r.data_okresu || null
                    });
                }
            });
            
            return detailedData;
        }
        
        async function verifyAndSaveElectricityInvoice() {
            const form = document.getElementById('form-electricity-invoice-verify');
            const formData = new FormData(form);
            const data = {};
            
            // Funkcja pomocnicza do parsowania warto≈õci numerycznych
            function parseNumericValue(value, isInt = false) {
                if (!value || value === '' || value === null || value === undefined) {
                    return isInt ? 0 : 0.0;
                }
                // Usu≈Ñ spacje i zamie≈Ñ przecinki na kropki
                const cleaned = String(value).replace(/\s/g, '').replace(',', '.');
                const parsed = isInt ? parseInt(cleaned) : parseFloat(cleaned);
                return isNaN(parsed) ? (isInt ? 0 : 0.0) : parsed;
            }
            
            // Lista p√≥l numerycznych
            const numericFields = ['rok', 'naleznosc_za_okres', 'wartosc_prognozy', 'faktury_korygujace', 
                'odsetki', 'wynik_rozliczenia', 'kwota_nadplacona', 'saldo_z_rozliczenia', 
                'niedoplata_nadplata', 'energia_do_akcyzy_kwh', 'akcyza', 'do_zaplaty', 
                'zuzycie_kwh', 'ogolem_sprzedaz_energii', 'ogolem_usluga_dystrybucji', 
                'energia_lacznie_zuzyta_w_roku_kwh'];
            
            for (const [key, value] of formData.entries()) {
                // Pomi≈Ñ pola szczeg√≥≈Çowe (bƒôdƒÖ zbierane osobno)
                if (key.startsWith('blankiety[') || key.startsWith('odczyty[') || 
                    key.startsWith('sprzedaz_energii[') || key.startsWith('oplaty_dystrybucyjne[') ||
                    key.startsWith('rozliczenie_okresy[')) {
                    continue;
                }
                
                if (numericFields.includes(key)) {
                    if (key.includes('kwh') || key === 'rok') {
                        data[key] = parseNumericValue(value, true);
                    } else {
                        data[key] = parseNumericValue(value, false);
                    }
                } else {
                    data[key] = value || '';
                }
            }
            
            // Upewnij siƒô, ≈ºe wszystkie wymagane pola majƒÖ warto≈õci
            if (!data.rok) data.rok = new Date().getFullYear();
            if (!data.numer_faktury) data.numer_faktury = '';
            if (!data.grupa_taryfowa) data.grupa_taryfowa = '';
            if (!data.typ_taryfy) data.typ_taryfy = 'DWUTARYFOWA';
            
            // Zbierz szczeg√≥≈Çowe dane z edytowalnych formularzy
            const detailedData = collectDetailedData();
            data.blankiety = detailedData.blankiety;
            data.odczyty = detailedData.odczyty;
            data.sprzedaz_energii = detailedData.sprzedaz_energii;
            data.oplaty_dystrybucyjne = detailedData.oplaty_dystrybucyjne;
            data.rozliczenie_okresy = detailedData.rozliczenie_okresy;

            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                // Sprawd≈∫ typ odpowiedzi
                const contentType = res.headers.get('content-type');
                let errorData = null;
                
                if (res.ok) {
                    showAlert('Faktura prƒÖdu zapisana pomy≈õlnie ze wszystkimi szczeg√≥≈Çami!');
                    form.reset();
                    document.getElementById('electricity-invoice-verification').style.display = 'none';
                    document.getElementById('electricity-verify-btn-top').style.display = 'none';
                    document.getElementById('electricity-invoice-file').value = '';
                    document.getElementById('electricity-invoice-file-name').textContent = '';
                    
                    // Wyczy≈õƒá zmiennƒÖ globalnƒÖ
                    currentInvoiceDetails = null;
                    
                    // Wyczy≈õƒá sekcje szczeg√≥≈Çowe
                    cancelElectricityInvoiceVerification();
                    
                    loadElectricityInvoices();
                    loadElectricityStats();
                } else {
                    // Spr√≥buj sparsowaƒá odpowied≈∫ jako JSON
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            errorData = await res.json();
                            showAlert(errorData?.detail || errorData?.message || `B≈ÇƒÖd zapisywania faktury (${res.status})`, 'error');
                        } catch (e) {
                            const text = await res.text();
                            showAlert(`B≈ÇƒÖd serwera (${res.status}): ${text.substring(0, 200)}`, 'error');
                            console.error('B≈ÇƒÖd odpowiedzi:', text);
                        }
                    } else {
                        const text = await res.text();
                        showAlert(`B≈ÇƒÖd serwera (${res.status}): ${text.substring(0, 200)}`, 'error');
                        console.error('B≈ÇƒÖd odpowiedzi (nie JSON):', text);
                    }
                }
            } catch (error) {
                console.error('B≈ÇƒÖd zapisywania faktury:', error);
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }

        function cancelElectricityInvoiceVerification() {
            document.getElementById('electricity-invoice-verification').style.display = 'none';
            document.getElementById('electricity-verify-btn-top').style.display = 'none';
            document.getElementById('form-electricity-invoice-verify').reset();
            document.getElementById('electricity-invoice-file').value = '';
            document.getElementById('electricity-invoice-file-name').textContent = '';
            
            // Wyczy≈õƒá zmiennƒÖ globalnƒÖ
            currentInvoiceDetails = null;
            window.editingInvoiceId = null;
            
            // Przywr√≥ƒá przycisk zapisu
            const saveBtn = document.querySelector('#electricity-invoice-verification .btn-success');
            if (saveBtn) {
                saveBtn.textContent = 'Zatwierd≈∫ i zapisz';
                saveBtn.onclick = verifyAndSaveElectricityInvoice;
            }
            
            // Przywr√≥ƒá przycisk na g√≥rze
            const topBtn = document.getElementById('electricity-verify-btn-top');
            if (topBtn) {
                topBtn.textContent = 'ZATWIERD≈π I ZAPISZ';
                topBtn.onclick = verifyAndSaveElectricityInvoice;
            }
            
            // Ukryj sekcje szczeg√≥≈Çowe
            document.getElementById('electricity-blankiety-section').style.display = 'none';
            document.getElementById('electricity-odczyty-section').style.display = 'none';
            document.getElementById('electricity-sprzedaz-section').style.display = 'none';
            document.getElementById('electricity-oplaty-section').style.display = 'none';
            document.getElementById('electricity-rozliczenie-section').style.display = 'none';
            
            // Wyczy≈õƒá kontenery edytowalne
            document.getElementById('electricity-blankiety-editable').innerHTML = '';
            document.getElementById('electricity-odczyty-editable').innerHTML = '';
            document.getElementById('electricity-sprzedaz-editable').innerHTML = '';
            document.getElementById('electricity-oplaty-editable').innerHTML = '';
            document.getElementById('electricity-rozliczenie-editable').innerHTML = '';
        }

        // Zmienna globalna do przechowywania szczeg√≥≈Çowych danych faktury
        let currentInvoiceDetails = null;
        
        // Funkcja pomocnicza do konwersji daty DD/MM/YYYY na ISO
        function convertDDMMYYYYToISO(dateStr) {
            if (!dateStr) return '';
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
            }
            // Je≈õli ju≈º w formacie ISO, zwr√≥ƒá jak jest
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}/)) {
                return dateStr.substring(0, 10);
            }
            return dateStr;
        }
        
        // Funkcja pomocnicza do konwersji warto≈õci numerycznej z formatu polskiego (przecinek) na format angielski (kropka)
        function convertNumericValue(value) {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            // Je≈õli to ju≈º liczba, zwr√≥ƒá jako string
            if (typeof value === 'number') {
                return String(value);
            }
            // Je≈õli to string, zamie≈Ñ przecinki na kropki i usu≈Ñ spacje
            const str = String(value).replace(/\s/g, '').replace(',', '.');
            // Sprawd≈∫ czy to poprawna liczba
            const num = parseFloat(str);
            if (!isNaN(num)) {
                return String(num);
            }
            return str;
        }
        
        // Funkcja do wy≈õwietlania szczeg√≥≈Çowych danych faktury jako edytowalnych formularzy
        function displayElectricityInvoiceDetails(invoiceData) {
            // Zapisz szczeg√≥≈Çowe dane do zmiennej globalnej
            currentInvoiceDetails = {
                blankiety: invoiceData.blankiety || [],
                odczyty: invoiceData.odczyty || [],
                sprzedaz_energii: invoiceData.sprzedaz_energii || [],
                oplaty_dystrybucyjne: invoiceData.oplaty_dystrybucyjne || [],
                rozliczenie_okresy: invoiceData.rozliczenie_okresy || []
            };
            
            // Blankiety prognozowe - edytowalne formularze
            const blankietyContainer = document.getElementById('electricity-blankiety-editable');
            if (invoiceData.blankiety && invoiceData.blankiety.length > 0) {
                blankietyContainer.innerHTML = '';
                invoiceData.blankiety.forEach((blankiet, idx) => {
                    if (blankiet.ogolem) return; // Pomi≈Ñ "Og√≥≈Çem"
                    
                    const blankietDiv = document.createElement('div');
                    blankietDiv.className = 'editable-record';
                    blankietDiv.style.cssText = 'border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px; border-radius: 5px; background: var(--hover-bg);';
                    blankietDiv.innerHTML = `
                        <h6 style="margin-top: 0; color: var(--primary-color);">Blankiet ${idx + 1}</h6>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div class="form-group">
                                <label>Nr blankietu</label>
                                <input type="text" name="blankiety[${idx}][nr_blankietu]" value="${blankiet.nr_blankietu || ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Okres od</label>
                                <input type="date" name="blankiety[${idx}][okres_od]" value="${blankiet.okres_od ? convertDDMMYYYYToISO(blankiet.okres_od) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Okres do</label>
                                <input type="date" name="blankiety[${idx}][okres_do]" value="${blankiet.okres_do ? convertDDMMYYYYToISO(blankiet.okres_do) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Ilo≈õƒá dzienna (kWh)</label>
                                <input type="number" name="blankiety[${idx}][ilosc_d]" value="${blankiet.ilosc_d ? convertNumericValue(blankiet.ilosc_d) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Ilo≈õƒá nocna (kWh)</label>
                                <input type="number" name="blankiety[${idx}][ilosc_c]" value="${blankiet.ilosc_c ? convertNumericValue(blankiet.ilosc_c) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Ilo≈õƒá ca≈Çodobowa (kWh)</label>
                                <input type="number" name="blankiety[${idx}][ilosc_calodobowa]" value="${blankiet.ilosc_calodobowa ? convertNumericValue(blankiet.ilosc_calodobowa) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Kwota brutto</label>
                                <input type="number" step="0.01" name="blankiety[${idx}][kwota_brutto]" value="${blankiet.kwota_brutto ? convertNumericValue(blankiet.kwota_brutto) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Akcyza</label>
                                <input type="number" step="0.01" name="blankiety[${idx}][akcyza]" value="${blankiet.akcyza ? convertNumericValue(blankiet.akcyza) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Energia do akcyzy (kWh)</label>
                                <input type="number" name="blankiety[${idx}][energia_do_akcyzy]" value="${blankiet.energia_do_akcyzy ? convertNumericValue(blankiet.energia_do_akcyzy) : '0'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Nadp≈Çata/Niedop≈Çata</label>
                                <input type="number" step="0.01" name="blankiety[${idx}][nadplata_niedoplata]" value="${blankiet.nadplata_niedoplata ? convertNumericValue(blankiet.nadplata_niedoplata) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Odsetki</label>
                                <input type="number" step="0.01" name="blankiety[${idx}][odsetki]" value="${blankiet.odsetki ? convertNumericValue(blankiet.odsetki) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.payment_due_date">Termin p≈Çatno≈õci</label>
                                <input type="date" name="blankiety[${idx}][termin_platnosci]" value="${blankiet.termin_platnosci ? convertDDMMYYYYToISO(blankiet.termin_platnosci) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label data-i18n="label.amount_to_pay">Do zap≈Çaty</label>
                                <input type="number" step="0.01" name="blankiety[${idx}][do_zaplaty]" value="${blankiet.do_zaplaty ? convertNumericValue(blankiet.do_zaplaty) : '0.00'}" class="form-control">
                            </div>
                        </div>
                        <input type="hidden" name="blankiety[${idx}][id]" value="${blankiet.id || ''}">
                    `;
                    blankietyContainer.appendChild(blankietDiv);
                });
                document.getElementById('electricity-blankiety-section').style.display = 'block';
            }
            
            // Odczyty licznik√≥w - edytowalne formularze
            const odczytyContainer = document.getElementById('electricity-odczyty-editable');
            if (invoiceData.odczyty && invoiceData.odczyty.length > 0) {
                odczytyContainer.innerHTML = '';
                invoiceData.odczyty.forEach((odczyt, idx) => {
                    const odczytDiv = document.createElement('div');
                    odczytDiv.className = 'editable-record';
                    odczytDiv.style.cssText = 'border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px; border-radius: 5px; background: var(--hover-bg);';
                    odczytDiv.innerHTML = `
                        <h6 style="margin-top: 0; color: var(--primary-color);">Odczyt ${idx + 1}</h6>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div class="form-group">
                                <label>Typ energii</label>
                                <select name="odczyty[${idx}][typ]" class="form-control">
                                    <option value="pobrana" ${odczyt.typ === 'pobrana' ? 'selected' : ''}>POBRANA</option>
                                    <option value="oddana" ${odczyt.typ === 'oddana' ? 'selected' : ''}>ODDANA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Strefa</label>
                                <select name="odczyty[${idx}][strefa]" class="form-control">
                                    <option value="">-</option>
                                    <option value="dzienna" ${odczyt.strefa && odczyt.strefa.toLowerCase() === 'dzienna' ? 'selected' : ''}>DZIENNA</option>
                                    <option value="nocna" ${odczyt.strefa && odczyt.strefa.toLowerCase() === 'nocna' ? 'selected' : ''}>NOCNA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Data odczytu</label>
                                <input type="date" name="odczyty[${idx}][data]" value="${odczyt.data ? convertDDMMYYYYToISO(odczyt.data) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Bie≈ºƒÖcy odczyt</label>
                                <input type="number" name="odczyty[${idx}][biezace]" value="${odczyt.biezace || '0'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Poprzedni odczyt</label>
                                <input type="number" name="odczyty[${idx}][poprzednie]" value="${odczyt.poprzednie || '0'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Mno≈ºna</label>
                                <input type="number" name="odczyty[${idx}][mnozna]" value="${odczyt.mnozna || '1'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Ilo≈õƒá (kWh)</label>
                                <input type="number" name="odczyty[${idx}][ilosc]" value="${odczyt.ilosc || '0'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Straty (kWh)</label>
                                <input type="number" name="odczyty[${idx}][straty]" value="${odczyt.straty || '0'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Razem (kWh)</label>
                                <input type="number" name="odczyty[${idx}][razem]" value="${odczyt.razem || '0'}" class="form-control">
                            </div>
                        </div>
                        <input type="hidden" name="odczyty[${idx}][id]" value="${odczyt.id || ''}">
                    `;
                    odczytyContainer.appendChild(odczytDiv);
                });
                document.getElementById('electricity-odczyty-section').style.display = 'block';
            }
            
            // Sprzeda≈º energii - edytowalne formularze
            const sprzedazContainer = document.getElementById('electricity-sprzedaz-editable');
            if (invoiceData.sprzedaz_energii && invoiceData.sprzedaz_energii.length > 0) {
                sprzedazContainer.innerHTML = '';
                invoiceData.sprzedaz_energii.forEach((sprzedaz, idx) => {
                    if (sprzedaz.typ === 'upust') return; // Pomi≈Ñ upusty
                    
                    const sprzedazDiv = document.createElement('div');
                    sprzedazDiv.className = 'editable-record';
                    sprzedazDiv.style.cssText = 'border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px; border-radius: 5px; background: var(--hover-bg);';
                    sprzedazDiv.innerHTML = `
                        <h6 style="margin-top: 0; color: var(--primary-color);">Pozycja sprzeda≈ºy ${idx + 1}</h6>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div class="form-group">
                                <label>Strefa</label>
                                <select name="sprzedaz_energii[${idx}][strefa]" class="form-control">
                                    <option value="">-</option>
                                    <option value="dzienna" ${sprzedaz.strefa && sprzedaz.strefa.toLowerCase() === 'dzienna' ? 'selected' : ''}>DZIENNA</option>
                                    <option value="nocna" ${sprzedaz.strefa && sprzedaz.strefa.toLowerCase() === 'nocna' ? 'selected' : ''}>NOCNA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ilo≈õƒá (kWh)</label>
                                <input type="number" name="sprzedaz_energii[${idx}][ilosc_kwh]" value="${(sprzedaz.ilosc_kwh || sprzedaz.ilosc) ? convertNumericValue(sprzedaz.ilosc_kwh || sprzedaz.ilosc) : '0'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Cena za kWh</label>
                                <input type="number" step="0.0001" name="sprzedaz_energii[${idx}][cena]" value="${sprzedaz.cena ? convertNumericValue(sprzedaz.cena) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Nale≈ºno≈õƒá</label>
                                <input type="number" step="0.01" name="sprzedaz_energii[${idx}][naleznosc]" value="${sprzedaz.naleznosc ? convertNumericValue(sprzedaz.naleznosc) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>VAT (%)</label>
                                <input type="number" step="0.01" name="sprzedaz_energii[${idx}][vat]" value="${sprzedaz.vat ? convertNumericValue(sprzedaz.vat) : '23'}" class="form-control">
                            </div>
                        </div>
                        <input type="hidden" name="sprzedaz_energii[${idx}][id]" value="${sprzedaz.id || ''}">
                    `;
                    sprzedazContainer.appendChild(sprzedazDiv);
                });
                document.getElementById('electricity-sprzedaz-section').style.display = 'block';
            }
            
            // Op≈Çaty dystrybucyjne - edytowalne formularze
            const oplatyContainer = document.getElementById('electricity-oplaty-editable');
            if (invoiceData.oplaty_dystrybucyjne && invoiceData.oplaty_dystrybucyjne.length > 0) {
                oplatyContainer.innerHTML = '';
                invoiceData.oplaty_dystrybucyjne.forEach((oplata, idx) => {
                    const oplataDiv = document.createElement('div');
                    oplataDiv.className = 'editable-record';
                    oplataDiv.style.cssText = 'border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px; border-radius: 5px; background: var(--hover-bg);';
                    oplataDiv.innerHTML = `
                        <h6 style="margin-top: 0; color: var(--primary-color);">Op≈Çata ${idx + 1}</h6>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div class="form-group">
                                <label>Typ op≈Çaty</label>
                                <input type="text" name="oplaty_dystrybucyjne[${idx}][nazwa]" value="${oplata.nazwa || ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Strefa</label>
                                <select name="oplaty_dystrybucyjne[${idx}][strefa]" class="form-control">
                                    <option value="">-</option>
                                    <option value="dzienna" ${oplata.strefa && oplata.strefa.toLowerCase() === 'dzienna' ? 'selected' : ''}>DZIENNA</option>
                                    <option value="nocna" ${oplata.strefa && oplata.strefa.toLowerCase() === 'nocna' ? 'selected' : ''}>NOCNA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Jednostka</label>
                                <select name="oplaty_dystrybucyjne[${idx}][jednostka]" class="form-control">
                                    <option value="kWh" ${oplata.jednostka === 'kWh' ? 'selected' : ''}>kWh</option>
                                    <option value="z≈Ç/mc" ${oplata.jednostka === 'z≈Ç/mc' ? 'selected' : ''}>z≈Ç/mc</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Data</label>
                                <input type="date" name="oplaty_dystrybucyjne[${idx}][data]" value="${oplata.data ? convertDDMMYYYYToISO(oplata.data) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Ilo≈õƒá kWh</label>
                                <input type="number" name="oplaty_dystrybucyjne[${idx}][ilosc_kwh]" value="${(oplata.ilosc_kwh || oplata.ilosc) ? convertNumericValue(oplata.ilosc_kwh || oplata.ilosc) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Ilo≈õƒá miesiƒôcy</label>
                                <input type="number" step="0.0001" name="oplaty_dystrybucyjne[${idx}][ilosc_miesiecy]" value="${oplata.ilosc_miesiecy ? convertNumericValue(oplata.ilosc_miesiecy) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Wsp√≥≈Çczynnik</label>
                                <input type="number" step="0.0001" name="oplaty_dystrybucyjne[${idx}][wspolczynnik]" value="${(oplata.wspolczynnik || oplata.wspolczynnik1) ? convertNumericValue(oplata.wspolczynnik || oplata.wspolczynnik1) : ''}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Cena</label>
                                <input type="number" step="0.0001" name="oplaty_dystrybucyjne[${idx}][cena]" value="${oplata.cena ? convertNumericValue(oplata.cena) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Nale≈ºno≈õƒá</label>
                                <input type="number" step="0.01" name="oplaty_dystrybucyjne[${idx}][naleznosc]" value="${oplata.naleznosc ? convertNumericValue(oplata.naleznosc) : '0.00'}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>VAT (%)</label>
                                <input type="number" step="0.01" name="oplaty_dystrybucyjne[${idx}][vat]" value="${oplata.vat ? convertNumericValue(oplata.vat) : '23'}" class="form-control">
                            </div>
                        </div>
                        <input type="hidden" name="oplaty_dystrybucyjne[${idx}][id]" value="${oplata.id || ''}">
                    `;
                    oplatyContainer.appendChild(oplataDiv);
                });
                document.getElementById('electricity-oplaty-section').style.display = 'block';
            }
            
            // Rozliczenie okres√≥w - edytowalne formularze
            const rozliczenieContainer = document.getElementById('electricity-rozliczenie-editable');
            if (invoiceData.rozliczenie_okresy && invoiceData.rozliczenie_okresy.length > 0) {
                rozliczenieContainer.innerHTML = '';
                invoiceData.rozliczenie_okresy.forEach((okres, idx) => {
                    const okresDiv = document.createElement('div');
                    okresDiv.className = 'editable-record';
                    okresDiv.style.cssText = 'border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px; border-radius: 5px; background: var(--hover-bg);';
                    okresDiv.innerHTML = `
                        <h6 style="margin-top: 0; color: var(--primary-color);">Okres ${idx + 1}</h6>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <div class="form-group">
                                <label>Numer okresu</label>
                                <input type="number" name="rozliczenie_okresy[${idx}][numer_okresu]" value="${okres.numer_okresu || idx + 1}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Data okresu</label>
                                <input type="date" name="rozliczenie_okresy[${idx}][data_okresu]" value="${okres.data_okresu ? convertDDMMYYYYToISO(okres.data_okresu) : ''}" class="form-control">
                            </div>
                        </div>
                        <input type="hidden" name="rozliczenie_okresy[${idx}][id]" value="${okres.id || ''}">
                    `;
                    rozliczenieContainer.appendChild(okresDiv);
                });
                document.getElementById('electricity-rozliczenie-section').style.display = 'block';
            } else if (invoiceData.blankiety && invoiceData.blankiety.length > 0) {
                // Fallback: generuj z blankiet√≥w je≈õli nie ma rozliczenie_okresy
                rozliczenieContainer.innerHTML = '';
                let okresNum = 1;
                invoiceData.blankiety.forEach((blankiet, idx) => {
                    if (blankiet.ogolem || !blankiet.okres_do) return;
                    const okresDiv = document.createElement('div');
                    okresDiv.className = 'editable-record';
                    okresDiv.style.cssText = 'border: 1px solid var(--border-color); padding: 15px; margin-bottom: 10px; border-radius: 5px; background: var(--hover-bg);';
                    okresDiv.innerHTML = `
                        <h6 style="margin-top: 0; color: var(--primary-color);">Okres ${okresNum}</h6>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <div class="form-group">
                                <label>Numer okresu</label>
                                <input type="number" name="rozliczenie_okresy[${idx}][numer_okresu]" value="${okresNum}" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Data okresu</label>
                                <input type="date" name="rozliczenie_okresy[${idx}][data_okresu]" value="${blankiet.okres_do ? convertDDMMYYYYToISO(blankiet.okres_do) : ''}" class="form-control">
                            </div>
                        </div>
                    `;
                    rozliczenieContainer.appendChild(okresDiv);
                    okresNum++;
                });
                if (okresNum > 1) {
                    document.getElementById('electricity-rozliczenie-section').style.display = 'block';
                }
            }
        }
        
        // Funkcje edycji i usuwania faktur
        async function editElectricityInvoice(invoiceId) {
            try {
                // Pobierz dane faktury
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/${invoiceId}`);
                if (!res.ok) {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd pobierania faktury', 'error');
                    return;
                }
                
                const invoiceData = await res.json();
                
                // Endpoint zwraca dane w formacie {invoice: {...}, blankiety: [...], odczyty: [...], etc.}
                const invoice = invoiceData.invoice || invoiceData;
                
                // Wype≈Çnij formularz weryfikacji danymi faktury
                const verifyForm = document.getElementById('form-electricity-invoice-verify');
                if (!verifyForm) {
                    showAlert('Nie znaleziono formularza weryfikacji', 'error');
                    return;
                }
                
                // Funkcja pomocnicza do konwersji daty
                function convertDateToISO(dateValue) {
                    if (!dateValue) return null;
                    if (typeof dateValue === 'string') {
                        if (dateValue.match(/^\d{4}-\d{2}-\d{2}/)) {
                            return dateValue.substring(0, 10);
                        }
                    }
                    return dateValue;
                }
                
                // Wype≈Çnij wszystkie pola formularza
                Object.keys(invoice).forEach(key => {
                    if (key.startsWith('_')) return;
                    
                    const input = verifyForm.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (input.type === 'date') {
                            const isoDate = convertDateToISO(invoice[key]);
                            if (isoDate) {
                                input.value = isoDate;
                            }
                        } else if (input.type === 'number') {
                            const numValue = parseFloat(invoice[key]);
                            if (!isNaN(numValue)) {
                                input.value = numValue;
                            }
                        } else if (input.tagName === 'SELECT') {
                            const value = String(invoice[key]);
                            if (Array.from(input.options).some(opt => opt.value === value)) {
                                input.value = value;
                            }
                        } else {
                            input.value = String(invoice[key] || '');
                        }
                    }
                });
                
                // Funkcja pomocnicza do formatowania daty DD/MM/YYYY (globalna)
                window.formatDateDDMMYYYY = function(dateStr) {
                    if (!dateStr) return null;
                    const date = new Date(dateStr);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                };
                
                // Funkcja pomocnicza do formatowania daty DD/MM/YYYY
                function formatDateDDMMYYYY(dateStr) {
                    return window.formatDateDDMMYYYY(dateStr);
                }
                
                // Przygotuj dane szczeg√≥≈Çowe w formacie dla displayElectricityInvoiceDetails
                const detailsData = {
                    blankiety: invoiceData.blankiety ? invoiceData.blankiety.map(b => ({
                        id: b.id,
                        nr_blankietu: b.numer_blankietu,
                        okres_od: formatDateDDMMYYYY(b.poczatek_podokresu),
                        okres_do: formatDateDDMMYYYY(b.koniec_podokresu),
                        ilosc_d: b.ilosc_dzienna_kwh,
                        ilosc_c: b.ilosc_nocna_kwh,
                        ilosc_calodobowa: b.ilosc_calodobowa_kwh,
                        kwota_brutto: b.kwota_brutto,
                        akcyza: b.akcyza,
                        energia_do_akcyzy: b.energia_do_akcyzy_kwh,
                        nadplata_niedoplata: b.nadplata_niedoplata,
                        odsetki: b.odsetki,
                        termin_platnosci: formatDateDDMMYYYY(b.termin_platnosci),
                        do_zaplaty: b.do_zaplaty
                    })) : [],
                    odczyty: invoiceData.odczyty ? invoiceData.odczyty.map(o => ({
                        id: o.id,
                        typ: o.typ_energii === 'POBRANA' ? 'pobrana' : 'oddana',
                        strefa: o.strefa ? o.strefa.toLowerCase() : null,
                        data: formatDateDDMMYYYY(o.data_odczytu),
                        biezace: o.biezacy_odczyt,
                        poprzednie: o.poprzedni_odczyt,
                        mnozna: o.mnozna,
                        ilosc: o.ilosc_kwh,
                        straty: o.straty_kwh,
                        razem: o.razem_kwh
                    })) : [],
                    sprzedaz_energii: invoiceData.sprzedaz_energii ? invoiceData.sprzedaz_energii.map(s => ({
                        id: s.id,
                        strefa: s.strefa ? s.strefa.toLowerCase() : null,
                        ilosc_kwh: s.ilosc_kwh,
                        cena: s.cena_za_kwh,
                        naleznosc: s.naleznosc,
                        vat: s.vat_procent
                    })) : [],
                    oplaty_dystrybucyjne: invoiceData.oplaty_dystrybucyjne ? invoiceData.oplaty_dystrybucyjne.map(op => ({
                        id: op.id,
                        nazwa: op.typ_oplaty,
                        strefa: op.strefa ? op.strefa.toLowerCase() : null,
                        jednostka: op.jednostka,
                        data: formatDateDDMMYYYY(op.data),
                        ilosc_kwh: op.ilosc_kwh,
                        ilosc_miesiecy: op.ilosc_miesiecy,
                        wspolczynnik: op.wspolczynnik,
                        cena: op.cena,
                        naleznosc: op.naleznosc,
                        vat: op.vat_procent
                    })) : [],
                    rozliczenie_okresy: invoiceData.rozliczenie_okresy ? invoiceData.rozliczenie_okresy.map(r => ({
                        id: r.id,
                        numer_okresu: r.numer_okresu,
                        data_okresu: r.data_okresu
                    })) : []
                };
                
                // Zapisz szczeg√≥≈Çowe dane do zmiennej globalnej
                currentInvoiceDetails = detailsData;
                
                // Wy≈õwietl szczeg√≥≈Çowe dane
                displayElectricityInvoiceDetails(detailsData);
                
                // Zapisz ID faktury do zmiennej globalnej (dla zapisu)
                window.editingInvoiceId = invoiceId;
                
                // Poka≈º formularz weryfikacji
                document.getElementById('electricity-invoice-verification').style.display = 'block';
                document.getElementById('electricity-verify-btn-top').style.display = 'inline-block';
                
                // Zmie≈Ñ przycisk zapisu na "Zaktualizuj"
                const saveBtn = document.querySelector('#electricity-invoice-verification .btn-success');
                if (saveBtn) {
                    saveBtn.textContent = 'Zaktualizuj fakturƒô';
                    saveBtn.onclick = () => updateElectricityInvoice(invoiceId);
                }
                
                // Zmie≈Ñ r√≥wnie≈º przycisk na g√≥rze
                const topBtn = document.getElementById('electricity-verify-btn-top');
                if (topBtn) {
                    topBtn.textContent = 'ZAKTUALIZUJ FAKTURƒò';
                    topBtn.onclick = () => updateElectricityInvoice(invoiceId);
                }
                
                showAlert('Faktura za≈Çadowana do edycji');
                
                // Przewi≈Ñ do formularza
                document.getElementById('electricity-invoice-verification').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('B≈ÇƒÖd pobierania faktury:', error);
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        async function updateElectricityInvoice(invoiceId) {
            const form = document.getElementById('form-electricity-invoice-verify');
            const formData = new FormData(form);
            const data = {};
            
            // Lista p√≥l numerycznych
            const numericFields = ['rok', 'naleznosc_za_okres', 'wartosc_prognozy', 'faktury_korygujace', 
                'odsetki', 'wynik_rozliczenia', 'kwota_nadplacona', 'saldo_z_rozliczenia', 
                'niedoplata_nadplata', 'energia_do_akcyzy_kwh', 'akcyza', 'do_zaplaty', 
                'zuzycie_kwh', 'ogolem_sprzedaz_energii', 'ogolem_usluga_dystrybucji', 
                'energia_lacznie_zuzyta_w_roku_kwh'];
            
            for (const [key, value] of formData.entries()) {
                // Pomi≈Ñ pola szczeg√≥≈Çowe (bƒôdƒÖ zbierane osobno)
                if (key.startsWith('blankiety[') || key.startsWith('odczyty[') || 
                    key.startsWith('sprzedaz_energii[') || key.startsWith('oplaty_dystrybucyjne[') ||
                    key.startsWith('rozliczenie_okresy[')) {
                    continue;
                }
                
                if (numericFields.includes(key)) {
                    if (key.includes('kwh') || key === 'rok') {
                        data[key] = parseInt(value) || 0;
                    } else {
                        data[key] = parseFloat(value) || 0;
                    }
                } else {
                    data[key] = value;
                }
            }
            
            // Zbierz szczeg√≥≈Çowe dane z edytowalnych formularzy
            const detailedData = collectDetailedData();
            data.blankiety = detailedData.blankiety;
            data.odczyty = detailedData.odczyty;
            data.sprzedaz_energii = detailedData.sprzedaz_energii;
            data.oplaty_dystrybucyjne = detailedData.oplaty_dystrybucyjne;
            data.rozliczenie_okresy = detailedData.rozliczenie_okresy;
            
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/${invoiceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Faktura zaktualizowana pomy≈õlnie!');
                    form.reset();
                    document.getElementById('electricity-invoice-verification').style.display = 'none';
                    document.getElementById('electricity-verify-btn-top').style.display = 'none';
                    
                    // Wyczy≈õƒá zmiennƒÖ globalnƒÖ
                    currentInvoiceDetails = null;
                    window.editingInvoiceId = null;
                    
                    // Przywr√≥ƒá przycisk zapisu
                    const saveBtn = document.querySelector('#electricity-invoice-verification .btn-success');
                    if (saveBtn) {
                        saveBtn.textContent = 'Zatwierd≈∫ i zapisz';
                        saveBtn.onclick = verifyAndSaveElectricityInvoice;
                    }
                    
                    // Wyczy≈õƒá sekcje szczeg√≥≈Çowe
                    cancelElectricityInvoiceVerification();
                    
                    loadElectricityInvoices();
                    loadElectricityStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji faktury', 'error');
                }
            } catch (error) {
                console.error('B≈ÇƒÖd aktualizacji faktury:', error);
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        async function deleteElectricityInvoice(invoiceId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô fakturƒô? ZostanƒÖ r√≥wnie≈º usuniƒôte wszystkie powiƒÖzane dane (blankiety, odczyty, sprzeda≈º, op≈Çaty, rozliczenia).')) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/${invoiceId}`, {
                    method: 'DELETE'
                });
                if (res.ok) {
                    const result = await res.json();
                    showAlert(result.message || 'Faktura usuniƒôta pomy≈õlnie!');
                    loadElectricityInvoices();
                    loadElectricityStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania faktury', 'error');
                }
            } catch (error) {
                console.error('B≈ÇƒÖd usuwania faktury:', error);
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        // Funkcje edycji/usuwania dla blankiet√≥w
        async function editElectricityBlankiet(blankietId, invoiceId) {
            if (typeof blankietId === 'string' && blankietId.startsWith('new-')) {
                showAlert('Nowe blankiety mo≈ºna edytowaƒá tylko po zapisaniu faktury', 'error');
                return;
            }
            
            // Pobierz dane blankietu z currentInvoiceDetails
            const blankiet = currentInvoiceDetails?.blankiety?.find(b => b.id === blankietId);
            if (!blankiet) {
                showAlert('Nie znaleziono blankietu', 'error');
                return;
            }
            
            // Poka≈º formularz edycji inline
            const row = document.querySelector(`tr[data-blankiet-id="${blankietId}"]`);
            if (!row) return;
            
            const formHtml = `
                <td colspan="9">
                    <form id="form-edit-blankiet-${blankietId}" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; background: var(--hover-bg);">
                        <div class="form-group">
                            <label>Nr blankietu</label>
                            <input type="text" name="numer_blankietu" value="${blankiet.nr_blankietu || ''}" required>
                        </div>
                        <div class="form-group">
                            <label>Okres od</label>
                            <input type="date" name="poczatek_podokresu" value="${blankiet.okres_od ? convertDDMMYYYYToISO(blankiet.okres_od) : ''}">
                        </div>
                        <div class="form-group">
                            <label>Okres do</label>
                            <input type="date" name="koniec_podokresu" value="${blankiet.okres_do ? convertDDMMYYYYToISO(blankiet.okres_do) : ''}">
                        </div>
                        <div class="form-group">
                            <label>Ilo≈õƒá dzienna (kWh)</label>
                            <input type="number" name="ilosc_dzienna_kwh" value="${blankiet.ilosc_d || ''}">
                        </div>
                        <div class="form-group">
                            <label>Ilo≈õƒá nocna (kWh)</label>
                            <input type="number" name="ilosc_nocna_kwh" value="${blankiet.ilosc_c || ''}">
                        </div>
                        <div class="form-group">
                            <label>Ilo≈õƒá ca≈Çodobowa (kWh)</label>
                            <input type="number" name="ilosc_calodobowa_kwh" value="${blankiet.ilosc_calodobowa || ''}">
                        </div>
                        <div class="form-group">
                            <label>Kwota brutto</label>
                            <input type="number" step="0.01" name="kwota_brutto" value="${blankiet.kwota_brutto || '0.00'}" required>
                        </div>
                        <div class="form-group">
                            <label>Akcyza</label>
                            <input type="number" step="0.01" name="akcyza" value="${blankiet.akcyza || '0.00'}" required>
                        </div>
                        <div class="form-group">
                            <label>Energia do akcyzy (kWh)</label>
                            <input type="number" name="energia_do_akcyzy_kwh" value="${blankiet.energia_do_akcyzy || '0'}" required>
                        </div>
                        <div class="form-group">
                            <label>Nadp≈Çata/Niedop≈Çata</label>
                            <input type="number" step="0.01" name="nadplata_niedoplata" value="${blankiet.nadplata_niedoplata || '0.00'}" required>
                        </div>
                        <div class="form-group">
                            <label>Odsetki</label>
                            <input type="number" step="0.01" name="odsetki" value="${blankiet.odsetki || '0.00'}" required>
                        </div>
                        <div class="form-group">
                            <label>Termin p≈Çatno≈õci</label>
                            <input type="date" name="termin_platnosci" value="${blankiet.termin_platnosci ? convertDDMMYYYYToISO(blankiet.termin_platnosci) : ''}" required>
                        </div>
                        <div class="form-group">
                            <label>Do zap≈Çaty</label>
                            <input type="number" step="0.01" name="do_zaplaty" value="${blankiet.do_zaplaty || '0.00'}" required>
                        </div>
                        <div class="form-group" style="grid-column: span 3;">
                            <button type="button" class="btn btn-success" onclick="saveElectricityBlankiet(${blankietId}, ${invoiceId})">Zapisz</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEditElectricityBlankiet(${blankietId})">Anuluj</button>
                        </div>
                    </form>
                </td>
            `;
            
            const editRow = document.createElement('tr');
            editRow.id = `edit-blankiet-${blankietId}`;
            editRow.innerHTML = formHtml;
            row.insertAdjacentElement('afterend', editRow);
            row.style.display = 'none';
        }
        
        function convertDDMMYYYYToISO(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return dateStr;
        }
        
        async function saveElectricityBlankiet(blankietId, invoiceId) {
            const form = document.getElementById(`form-edit-blankiet-${blankietId}`);
            const formData = new FormData(form);
            const data = {};
            
            for (const [key, value] of formData.entries()) {
                if (key.includes('kwh') || key === 'energia_do_akcyzy_kwh') {
                    data[key] = parseInt(value) || null;
                } else if (key.includes('date') || key.includes('podokresu') || key.includes('platnosci')) {
                    data[key] = value || null;
                } else {
                    data[key] = parseFloat(value) || 0;
                }
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/blankiety/${blankietId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Blankiet zaktualizowany!');
                    cancelEditElectricityBlankiet(blankietId);
                    // Od≈õwie≈º dane faktury
                    if (invoiceId) {
                        editElectricityInvoice(invoiceId);
                    }
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd aktualizacji blankietu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        function cancelEditElectricityBlankiet(blankietId) {
            const editRow = document.getElementById(`edit-blankiet-${blankietId}`);
            const row = document.querySelector(`tr[data-blankiet-id="${blankietId}"]`);
            if (editRow) editRow.remove();
            if (row) row.style.display = '';
        }
        
        async function deleteElectricityBlankiet(blankietId, invoiceId) {
            if (typeof blankietId === 'string' && blankietId.startsWith('new-')) {
                // Usu≈Ñ z currentInvoiceDetails
                if (currentInvoiceDetails?.blankiety) {
                    currentInvoiceDetails.blankiety = currentInvoiceDetails.blankiety.filter(b => b.id !== blankietId);
                    displayElectricityInvoiceDetails(currentInvoiceDetails);
                }
                return;
            }
            
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten blankiet?')) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/blankiety/${blankietId}`, {
                    method: 'DELETE'
                });
                if (res.ok) {
                    showAlert('Blankiet usuniƒôty!');
                    if (invoiceId) {
                        editElectricityInvoice(invoiceId);
                    }
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania blankietu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        // Podobne funkcje dla pozosta≈Çych tabel - uproszczone wersje
        async function editElectricityOdczyt(odczytId, invoiceId) {
            if (typeof odczytId === 'string' && odczytId.startsWith('new-')) {
                showAlert('Nowe odczyty mo≈ºna edytowaƒá tylko po zapisaniu faktury', 'error');
                return;
            }
            showAlert('Edycja odczyt√≥w - funkcja w przygotowaniu. U≈ºyj edycji ca≈Çej faktury.', 'info');
        }
        
        async function deleteElectricityOdczyt(odczytId, invoiceId) {
            if (typeof odczytId === 'string' && odczytId.startsWith('new-')) {
                if (currentInvoiceDetails?.odczyty) {
                    currentInvoiceDetails.odczyty = currentInvoiceDetails.odczyty.filter(o => o.id !== odczytId);
                    displayElectricityInvoiceDetails(currentInvoiceDetails);
                }
                return;
            }
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten odczyt?')) return;
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/odczyty/${odczytId}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('Odczyt usuniƒôty!');
                    if (invoiceId) editElectricityInvoice(invoiceId);
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        async function editElectricitySprzedaz(sprzedazId, invoiceId) {
            if (typeof sprzedazId === 'string' && sprzedazId.startsWith('new-')) {
                showAlert('Nowe pozycje mo≈ºna edytowaƒá tylko po zapisaniu faktury', 'error');
                return;
            }
            showAlert('Edycja sprzeda≈ºy - funkcja w przygotowaniu. U≈ºyj edycji ca≈Çej faktury.', 'info');
        }
        
        async function deleteElectricitySprzedaz(sprzedazId, invoiceId) {
            if (typeof sprzedazId === 'string' && sprzedazId.startsWith('new-')) {
                if (currentInvoiceDetails?.sprzedaz_energii) {
                    currentInvoiceDetails.sprzedaz_energii = currentInvoiceDetails.sprzedaz_energii.filter(s => s.id !== sprzedazId);
                    displayElectricityInvoiceDetails(currentInvoiceDetails);
                }
                return;
            }
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô pozycjƒô sprzeda≈ºy?')) return;
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/sprzedaz/${sprzedazId}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('Pozycja sprzeda≈ºy usuniƒôta!');
                    if (invoiceId) editElectricityInvoice(invoiceId);
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania pozycji', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        async function editElectricityOplata(oplataId, invoiceId) {
            if (typeof oplataId === 'string' && oplataId.startsWith('new-')) {
                showAlert('Nowe op≈Çaty mo≈ºna edytowaƒá tylko po zapisaniu faktury', 'error');
                return;
            }
            showAlert('Edycja op≈Çat - funkcja w przygotowaniu. U≈ºyj edycji ca≈Çej faktury.', 'info');
        }
        
        async function deleteElectricityOplata(oplataId, invoiceId) {
            if (typeof oplataId === 'string' && oplataId.startsWith('new-')) {
                if (currentInvoiceDetails?.oplaty_dystrybucyjne) {
                    currentInvoiceDetails.oplaty_dystrybucyjne = currentInvoiceDetails.oplaty_dystrybucyjne.filter(op => op.id !== oplataId);
                    displayElectricityInvoiceDetails(currentInvoiceDetails);
                }
                return;
            }
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô op≈Çatƒô?')) return;
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/oplaty/${oplataId}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('Op≈Çata usuniƒôta!');
                    if (invoiceId) editElectricityInvoice(invoiceId);
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania op≈Çaty', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        async function editElectricityRozliczenieOkres(okresId, invoiceId) {
            if (typeof okresId === 'string' && okresId.startsWith('new-')) {
                showAlert('Nowe okresy mo≈ºna edytowaƒá tylko po zapisaniu faktury', 'error');
                return;
            }
            showAlert('Edycja okres√≥w - funkcja w przygotowaniu. U≈ºyj edycji ca≈Çej faktury.', 'info');
        }
        
        async function deleteElectricityRozliczenieOkres(okresId, invoiceId) {
            if (typeof okresId === 'string' && okresId.startsWith('new-')) {
                // Okresy sƒÖ generowane z blankiet√≥w, wiƒôc nie ma sensu ich usuwaƒá osobno
                return;
            }
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten okres?')) return;
            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices-detailed/rozliczenie-okresy/${okresId}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('Okres usuniƒôty!');
                    if (invoiceId) editElectricityInvoice(invoiceId);
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania okresu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
            }
        }
        
        // Funkcje dodawania nowych rekord√≥w (placeholder)
        function addElectricityBlankiet() {
            showAlert('Aby dodaƒá blankiet, edytuj fakturƒô i dodaj go rƒôcznie w formularzu weryfikacji', 'info');
        }
        
        function addElectricityOdczyt() {
            showAlert('Aby dodaƒá odczyt, edytuj fakturƒô i dodaj go rƒôcznie w formularzu weryfikacji', 'info');
        }
        
        function addElectricitySprzedaz() {
            showAlert('Aby dodaƒá pozycjƒô sprzeda≈ºy, edytuj fakturƒô i dodaj jƒÖ rƒôcznie w formularzu weryfikacji', 'info');
        }
        
        function addElectricityOplata() {
            showAlert('Aby dodaƒá op≈Çatƒô, edytuj fakturƒô i dodaj jƒÖ rƒôcznie w formularzu weryfikacji', 'info');
        }
        
        function addElectricityRozliczenieOkres() {
            showAlert('Okresy sƒÖ automatycznie generowane z blankiet√≥w', 'info');
        }
        
        function toggleManualElectricityInvoiceForm() {
            const formDiv = document.getElementById('electricity-invoice-manual-form');
            const btn = document.getElementById('btn-show-manual-electricity-invoice');
            if (formDiv.style.display === 'none' || formDiv.style.display === '') {
                formDiv.style.display = 'block';
                btn.textContent = 'Ukryj formularz rƒôczny';
            } else {
                formDiv.style.display = 'none';
                btn.textContent = 'LUB DODAJ RƒòCZNIE';
            }
        }

        async function addElectricityInvoice() {
            const form = document.getElementById('form-electricity-invoice');
            const formData = new FormData(form);
            const data = {};
            
            for (const [key, value] of formData.entries()) {
                if (['usage_kwh', 'energy_price_net', 'energy_value_net', 'energy_vat_amount',
                     'energy_value_gross', 'distribution_fees_net', 'distribution_fees_vat',
                     'distribution_fees_gross', 'vat_rate', 'vat_amount', 'total_net_sum',
                     'total_gross_sum', 'amount_to_pay'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/api/electricity/invoices/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Faktura prƒÖdu dodana pomy≈õlnie!');
                    form.reset();
                    toggleManualElectricityInvoiceForm();
                    loadElectricityInvoices();
                    loadElectricityStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd dodawania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Rachunki prƒÖdu
        async function loadElectricityBills() {
            try {
                const res = await fetch(`${API_BASE}/api/electricity/bills/`);
                const bills = await res.json();
                const listEl = document.getElementById('electricity-bills-list');
                
                if (bills.length === 0) {
                    listEl.innerHTML = '<p>Brak rachunk√≥w prƒÖdu. Wygeneruj rachunki dla okresu z fakturƒÖ i odczytami.</p>';
                    return;
                }
                
                let html = `<table class="data-table"><thead><tr><th data-i18n="table.period_billing">Okres Rozliczeniowy</th><th data-i18n="table.invoice_number">Nr faktury</th><th data-i18n="table.local">Lokal</th><th data-i18n="table.cost_per_kwh">Koszt za 1kWh</th><th data-i18n="table.usage_kwh">Zu≈ºycie (kWh)</th><th data-i18n="table.amount_to_pay">Do zap≈Çaty</th><th data-i18n="table.actions">Akcje</th></tr></thead><tbody>`;
                let previousPeriod = null;
                bills.forEach(b => {
                    const currentPeriod = b.okres_rozliczeniowy || b.data;
                    
                    // Dodaj separator je≈õli okres siƒô zmieni≈Ç (i to nie jest pierwszy rachunek)
                    if (previousPeriod !== null && previousPeriod !== currentPeriod) {
                        html += `<tr><td colspan="7" style="padding: 4px 0; border-bottom: 1px solid var(--border-color);"></td></tr>`;
                    }
                    previousPeriod = currentPeriod;
                    
                    // Przygotuj nazwƒô lokalu (DOM to ca≈Çy dom)
                    let localName = b.local || '-';
                    if (localName === 'dom') {
                        localName = '<strong>DOM (ca≈Çy dom)</strong>';
                    } else {
                        localName = localName.toUpperCase();
                    }
                    
                    // Przygotuj koszt 1 kWh
                    let koszt_kwh = '-';
                    if (b.koszt_1kwh_dzienna !== null && b.koszt_1kwh_dzienna !== undefined) {
                        const dzienna = b.koszt_1kwh_dzienna.toFixed(4);
                        const nocna = b.koszt_1kwh_nocna !== null && b.koszt_1kwh_nocna !== undefined ? 
                            b.koszt_1kwh_nocna.toFixed(4) : '-';
                        koszt_kwh = `D: ${dzienna} / N: ${nocna} z≈Ç/kWh`;
                    } else if (b.koszt_1kwh_calodobowa !== null && b.koszt_1kwh_calodobowa !== undefined) {
                        koszt_kwh = `${b.koszt_1kwh_calodobowa.toFixed(4)} z≈Ç/kWh`;
                    }
                    
                    html += `<tr>
                        <td>${currentPeriod}</td>
                        <td>${b.numer_faktury || '-'}</td>
                        <td>${localName}</td>
                        <td>${koszt_kwh}</td>
                        <td>
                            ${b.usage_kwh_dzienna !== null && b.usage_kwh_dzienna !== undefined && b.usage_kwh_nocna !== null && b.usage_kwh_nocna !== undefined
                                ? `D: ${b.usage_kwh_dzienna.toFixed(4)} / N: ${b.usage_kwh_nocna.toFixed(4)} kWh`
                                : `${(b.usage_kwh || 0).toFixed(4)} kWh`
                            }
                        </td>
                        <td>${(b.total_gross_sum || 0).toFixed(4)} z≈Ç</td>
                        <td class="actions">
                            ${b.pdf_path ? `<a href="${b.pdf_path}" target="_blank" class="btn btn-success btn-small" title="Pobierz PDF">üì• PDF</a>` : ''}
                            <button class="btn btn-edit btn-small" onclick="editElectricityBill(${b.id})" title="Edytuj rachunek">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="deleteElectricityBill(${b.id})" title="Usu≈Ñ rachunek">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
                updateTexts();
            } catch (error) {
                document.getElementById('electricity-bills-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania rachunk√≥w</p>';
            }
        }

        let availableElectricityPeriods = [];
        
        async function loadAvailableElectricityPeriods() {
            try {
                const res = await fetch(`${API_BASE}/api/electricity/available-periods`);
                const data = await res.json();
                availableElectricityPeriods = data.available_periods || [];
                
                const statusEl = document.getElementById('electricity-periods-status');
                const calendarEl = document.getElementById('electricity-periods-calendar');
                const buttonsEl = document.getElementById('electricity-periods-buttons');
                
                const periodsWithoutBills = data.available_periods_without_bills || [];
                const periodsWithBills = data.available_periods_with_bills || [];
                
                if (availableElectricityPeriods.length > 0) {
                    const diagnostics = data.diagnostics || {};
                    const missingCount = data.periods_without_readings?.length || 0;
                    
                    const availableText = translate('info.available_periods');
                    const selectText = translate('info.available_periods_select');
                    let statusText = `<span style="text-transform: uppercase; font-size: 0.85em; font-weight: normal; color: #666;">${availableText}: <strong>${periodsWithoutBills.length}</strong> do wygenerowania - ${selectText}:</span>`;
                    if (periodsWithBills.length > 0) {
                        statusText += ` <span style="color: #999; font-size: 0.85em;">(${periodsWithBills.length} ju≈º wygenerowane)</span>`;
                    }
                    if (missingCount > 0) {
                        const warningText = translate('info.warning_missing_readings').replace('{count}', missingCount);
                        statusText += `<br><span style="color: #dc3545; font-size: 0.85em; text-transform: uppercase; font-weight: normal;">${warningText}</span>`;
                    }
                    statusEl.innerHTML = statusText;
                    
                    // Utw√≥rz przyciski - tylko dla okres√≥w bez rachunk√≥w jako aktywne
                    buttonsEl.innerHTML = '';
                    
                    // Najpierw dodaj okresy bez rachunk√≥w (aktywne, zielone)
                    periodsWithoutBills.forEach(period => {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-success';
                        btn.textContent = period;
                        btn.onclick = () => {
                            // Ustaw warto≈õƒá w ukrytym input
                            document.getElementById('electricity-bill-period').value = period;
                            
                            // Pod≈õwietl wybrany przycisk
                            buttonsEl.querySelectorAll('button').forEach(b => {
                                b.classList.remove('btn-selected');
                            });
                            btn.classList.add('btn-selected');
                        };
                        buttonsEl.appendChild(btn);
                    });
                    
                    // Dodaj okresy z rachunkami (szary kontur i tekst, nieaktywne)
                    periodsWithBills.forEach(period => {
                        const btn = document.createElement('button');
                        btn.className = 'btn';
                        btn.style.cursor = 'not-allowed';
                        btn.style.backgroundColor = 'transparent';
                        btn.style.border = '2px solid #999';
                        btn.style.color = '#999';
                        btn.textContent = period + ' ‚úì';
                        btn.title = 'Rachunki ju≈º wygenerowane';
                        btn.onclick = () => {
                            // Nie pozw√≥l na wyb√≥r ju≈º wygenerowanych okres√≥w
                            showAlert('Rachunki dla tego okresu zosta≈Çy ju≈º wygenerowane', 'info');
                        };
                        buttonsEl.appendChild(btn);
                    });
                    
                    calendarEl.style.display = 'block';
                } else {
                    const diagnostics = data.diagnostics || {};
                    const missingCount = data.periods_without_readings?.length || 0;
                    
                    const noPeriodsText = translate('info.no_available_periods');
                    let statusText = `<span style="text-transform: uppercase; font-size: 0.85em; font-weight: normal;">${noPeriodsText}</span>`;
                    if (missingCount > 0) {
                        const missingText = translate('info.missing_readings_count').replace('{count}', missingCount);
                        statusText += `<br><span style="color: #dc3545; font-size: 0.85em; text-transform: uppercase; font-weight: normal;">${missingText}</span>`;
                    }
                    statusEl.innerHTML = statusText;
                    calendarEl.style.display = 'none';
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania dostƒôpnych okres√≥w:', error);
                const errorText = translate('info.error_loading_periods');
                document.getElementById('electricity-periods-status').innerHTML = `<span style="text-transform: uppercase; font-size: 0.85em; font-weight: normal;">${errorText}</span>`;
            }
        }
        
        async function generateElectricityBills() {
            const periodInput = document.getElementById('electricity-bill-period');
            const period = periodInput.value;
            
            if (!period) {
                showAlert('Wybierz okres z dostƒôpnych poni≈ºej', 'error');
                return;
            }
            
            // Sprawd≈∫ czy okres jest dostƒôpny (powinien byƒá, bo pokazujemy tylko dostƒôpne)
            if (!availableElectricityPeriods.includes(period)) {
                showAlert(`Okres ${period} nie jest dostƒôpny. Wybierz okres z dostƒôpnych okres√≥w.`, 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/electricity/generate-bills?data=${period}`, { method: 'POST' });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Wygenerowano ${result.bills_count || 0} rachunk√≥w prƒÖdu dla okresu ${period}`);
                    loadElectricityBills();
                    loadElectricityStats();
                    // Od≈õwie≈º listƒô dostƒôpnych okres√≥w, aby wyszarzyƒá wygenerowany okres
                    loadAvailableElectricityPeriods();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd generowania rachunk√≥w', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }
        
        async function editElectricityBill(billId) {
            try {
                const res = await fetch(`${API_BASE}/api/electricity/bills/${billId}`);
                const bill = await res.json();
                
                if (!res.ok) {
                    showAlert(bill.detail || 'B≈ÇƒÖd ≈Çadowania rachunku', 'error');
                    return;
                }
                
                // Utw√≥rz formularz edycji
                const formHtml = `
                    <div style="max-width: 600px; margin: 20px auto; padding: 20px; background: var(--card-bg); border-radius: 10px;">
                        <h3>Edytuj rachunek - ${bill.local.toUpperCase()}</h3>
                        <form id="edit-electricity-bill-form" onsubmit="saveElectricityBill(${billId}); return false;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Okres</label>
                                    <input type="text" value="${bill.data}" disabled style="background: var(--hover-bg);">
                                </div>
                                <div class="form-group">
                                    <label data-i18n="label.local">Lokal</label>
                                    <input type="text" value="${bill.local}" disabled style="background: var(--hover-bg);">
                                </div>
                                <div class="form-group">
                                    <label>Zu≈ºycie ≈ÇƒÖcznie (kWh)</label>
                                    <input type="number" step="0.01" name="usage_kwh" value="${bill.usage_kwh || 0}" required>
                                </div>
                                <div class="form-group">
                                    <label>Zu≈ºycie dzienne (kWh)</label>
                                    <input type="number" step="0.01" name="usage_kwh_dzienna" value="${bill.usage_kwh_dzienna || ''}" placeholder="Brak">
                                </div>
                                <div class="form-group">
                                    <label>Zu≈ºycie nocne (kWh)</label>
                                    <input type="number" step="0.01" name="usage_kwh_nocna" value="${bill.usage_kwh_nocna || ''}" placeholder="Brak">
                                </div>
                                <div class="form-group">
                                    <label>Koszt energii brutto (z≈Ç)</label>
                                    <input type="number" step="0.01" name="energy_cost_gross" value="${bill.energy_cost_gross || 0}" required>
                                </div>
                                <div class="form-group">
                                    <label>Koszt dystrybucji brutto (z≈Ç)</label>
                                    <input type="number" step="0.01" name="distribution_cost_gross" value="${bill.distribution_cost_gross || 0}" required>
                                </div>
                                <div class="form-group">
                                    <label>Suma netto (z≈Ç)</label>
                                    <input type="number" step="0.01" name="total_net_sum" value="${bill.total_net_sum || 0}" required>
                                </div>
                                <div class="form-group">
                                    <label>Suma brutto (z≈Ç)</label>
                                    <input type="number" step="0.01" name="total_gross_sum" value="${bill.total_gross_sum || 0}" required>
                                </div>
                            </div>
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-success">Zapisz</button>
                                <button type="button" class="btn btn-secondary" onclick="closeEditElectricityBillForm()">Anuluj</button>
                            </div>
                        </form>
                    </div>
                `;
                
                // Poka≈º formularz w modalnym oknie
                const formContainer = document.createElement('div');
                formContainer.id = 'edit-electricity-bill-container';
                formContainer.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto; padding: 20px;';
                formContainer.innerHTML = formHtml;
                document.body.appendChild(formContainer);
            } catch (error) {
                showAlert('B≈ÇƒÖd ≈Çadowania rachunku', 'error');
            }
        }
        
        function closeEditElectricityBillForm() {
            const container = document.getElementById('edit-electricity-bill-container');
            if (container) {
                container.remove();
            }
        }
        
        async function saveElectricityBill(billId) {
            const form = document.getElementById('edit-electricity-bill-form');
            const formData = new FormData(form);
            
            const billData = {
                usage_kwh: parseFloat(formData.get('usage_kwh')) || 0,
                usage_kwh_dzienna: formData.get('usage_kwh_dzienna') ? parseFloat(formData.get('usage_kwh_dzienna')) : null,
                usage_kwh_nocna: formData.get('usage_kwh_nocna') ? parseFloat(formData.get('usage_kwh_nocna')) : null,
                energy_cost_gross: parseFloat(formData.get('energy_cost_gross')) || 0,
                distribution_cost_gross: parseFloat(formData.get('distribution_cost_gross')) || 0,
                total_net_sum: parseFloat(formData.get('total_net_sum')) || 0,
                total_gross_sum: parseFloat(formData.get('total_gross_sum')) || 0
            };
            
            try {
                const res = await fetch(`${API_BASE}/api/electricity/bills/${billId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(billData)
                });
                
                const result = await res.json();
                if (res.ok) {
                    showAlert('Rachunek zaktualizowany');
                    closeEditElectricityBillForm();
                    loadElectricityBills();
                    loadElectricityStats();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd aktualizacji rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }
        
        async function deleteElectricityBill(billId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten rachunek?')) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/electricity/bills/${billId}`, { method: 'DELETE' });
                const result = await res.json();
                if (res.ok) {
                    showAlert('Rachunek usuniƒôty');
                    loadElectricityBills();
                    loadElectricityStats();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd usuwania rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function deleteAllElectricityBills() {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá WSZYSTKIE rachunki prƒÖdu? Ta operacja jest nieodwracalna!')) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/electricity/bills`, { method: 'DELETE' });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Usuniƒôto ${result.deleted_count} rachunk√≥w`);
                    loadElectricityBills();
                    loadElectricityStats();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd usuwania rachunk√≥w', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Inicjalizacja - za≈Çaduj statystyki na g≈Ç√≥wnej stronie
        loadMainStats();
        
        // Od≈õwie≈ºanie statystyk
        setInterval(() => {
            // Je≈õli g≈Ç√≥wna strona jest widoczna, od≈õwie≈º jej statystyki
            if (document.getElementById('main-page').style.display !== 'none') {
                loadMainStats();
            }
            // Je≈õli sekcja wody jest widoczna, od≈õwie≈º jej statystyki
            if (document.getElementById('medium-water').style.display !== 'none') {
                loadWaterStats();
            }
            // Je≈õli sekcja gazu jest widoczna, od≈õwie≈º jej statystyki
            if (document.getElementById('medium-gas').style.display !== 'none') {
                loadGasStats();
            }
            // Je≈õli sekcja prƒÖdu jest widoczna, od≈õwie≈º jej statystyki
            if (document.getElementById('medium-electricity').style.display !== 'none') {
                loadElectricityStats();
            }
        }, 30000); // Od≈õwie≈º statystyki co 30 sekund

        // Sprawdzanie autentykacji
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }

        // Wylogowanie
        function logout() {
            const confirmMessage = currentLanguage === 'pl' 
                ? 'Czy na pewno chcesz siƒô wylogowaƒá?' 
                : 'Are you sure you want to logout?';
            
            if (confirm(confirmMessage)) {
                // Usu≈Ñ token z localStorage
                localStorage.removeItem('token');
                // Przekieruj do strony logowania
                window.location.href = '/login';
            }
        }

        // Prze≈ÇƒÖczanie jƒôzyka
        let currentLanguage = localStorage.getItem('language') || 'pl';
        const translations = {
            pl: {
                'header.title': 'Billing System',
                'header.subtitle': 'System rozliczania rachunk√≥w za wodƒô, ≈õcieki, gaz i prƒÖd',
                'header.api_docs': 'üìö Dokumentacja API (Swagger UI)',
                'header.author': 'Autor',
                'main.select_medium': 'Wybierz medium do zarzƒÖdzania',
                'medium.water': 'Woda',
                'medium.gas': 'Gaz',
                'medium.electricity': 'PrƒÖd',
                'stats.invoices': 'Faktury',
                'stats.bills': 'Rachunki',
                'stats.total_gross': 'Suma brutto',
                'stats.latest_period': 'Najnowszy okres',
                'stats.locals': 'Lokale',
                'stats.readings': 'Odczyty',
                'button.back': 'POWR√ìT DO G≈Å√ìWNEJ STRONY',
                'button.water': '‚óØ WODA',
                'button.gas': '‚ñ≥ GAZ',
                'button.electricity': 'PRƒÑD',
                'section.locals': 'Lokale',
                'section.readings': 'Odczyty licznik√≥w',
                'section.invoices': 'Faktury',
                'section.bills': 'Rachunki',
                'label.meter_name': 'Nazwa licznika',
                'label.tenant': 'Najemca',
                'label.local': 'Lokal',
                'label.period': 'Okres (YYYY-MM)',
                'label.main_meter': 'Licznik g≈Ç√≥wny (DOM)',
                'label.meter_5': 'Licznik 5 (gora)',
                'label.meter_5a': 'Licznik 5a (gabinet)',
                'label.meter_5b': 'LICZNIK 5B (DOL) - AUTOM.',
                'button.add_local': 'DODAJ LOKAL',
                'button.add_reading': 'DODAJ ODCZYT',
                'button.send_to_provider': 'Wy≈õlij stan licznika do dostawcy',
                'button.show_credentials': 'Poka≈º dane logowania',
                'button.upload_pdf': 'WCZYTAJ PDF',
                'button.select_file': 'WYBIERZ PLIK',
                'button.verify_save': 'Zatwierd≈∫ i zapisz',
                'button.cancel': 'Anuluj',
                'button.add_manual': 'LUB DODAJ RƒòCZNIE',
                'button.add_invoice': 'Dodaj fakturƒô',
                'button.generate_bills': 'GENERUJ RACHUNKI',
                'button.regenerate_bills': 'REGENERUJ RACHUNKI',
                'section.gas_invoices': 'Faktury gazu (PGNiG)',
                'section.gas_bills': 'Rachunki gazu',
                'section.electricity_readings': 'Odczyty prƒÖdu',
                'section.electricity_invoices': 'Faktury prƒÖdu (ENEA)',
                'section.electricity_bills': 'Rachunki prƒÖdu',
                'label.invoice_number': 'Numer faktury',
                'label.period_start': 'Data poczƒÖtku okresu',
                'label.period_end': 'Data ko≈Ñca okresu',
                'label.fuel_usage_m3': 'Paliwo zu≈ºycie (m¬≥)',
                'label.previous_reading': 'Odczyt poprzedni (m¬≥)',
                'label.current_reading': 'Odczyt obecny (m¬≥)',
                'label.fuel_conversion_factor': 'Paliwo - Wsp√≥≈Çczynnik konwersji (kWh/m¬≥)',
                'label.fuel_usage_kwh': 'Paliwo - Zu≈ºycie (kWh)',
                'label.fuel_price_net': 'Paliwo - Cena netto za kWh',
                'label.fuel_value_net': 'Paliwo - Warto≈õƒá netto',
                'label.subscription_quantity': 'Abonament - Ilo≈õƒá miesiƒôcy',
                'label.subscription_price_net': 'Abonament - Cena netto za miesiƒÖc',
                'label.subscription_value_net': 'Abonament - Warto≈õƒá netto',
                'label.distribution_fixed_quantity': 'Dystrybucja sta≈Ça - Ilo≈õƒá miesiƒôcy',
                'label.distribution_fixed_price_net': 'Dystrybucja sta≈Ça - Cena netto za miesiƒÖc',
                'label.distribution_fixed_value_net': 'Dystrybucja sta≈Ça - Warto≈õƒá netto',
                'label.distribution_variable_usage_m3': 'Dystrybucja zmienna - Zu≈ºycie (m¬≥)',
                'label.distribution_variable_conversion': 'Dystrybucja zmienna - Wsp. konw.',
                'label.distribution_variable_usage_kwh': 'Dystrybucja zmienna - Zu≈ºycie (kWh)',
                'label.distribution_variable_price_net': 'Dystrybucja zmienna - Cena netto za kWh',
                'label.distribution_variable_value_net': 'Dystrybucja zmienna - Warto≈õƒá netto',
                'label.total_net_sum': 'Warto≈õƒá netto og√≥≈Çem',
                'label.vat_rate': 'VAT (np. 0.23 dla 23%)',
                'label.vat_amount': 'Kwota VAT og√≥≈Çem',
                'label.total_gross_sum': 'Warto≈õƒá brutto ca≈Ço≈õƒá',
                'label.late_payment_interest': 'Odsetki za nieterminowe wp≈Çaty',
                'label.payment_due_date': 'Termin p≈Çatno≈õci',
                'label.amount_to_pay': 'Do zap≈Çaty',
                'label.verify_invoice': 'Weryfikuj dane faktury przed zapisem',
                'stats.gas_invoices': 'Faktury gazu',
                'stats.gas_bills': 'Rachunki gazu',
                'label.reading_date': 'Data odczytu licznika',
                'label.meter_dom_single': 'Licznik DOM - Jednotaryfowy?',
                'label.yes_single': 'Tak (jednotaryfowy)',
                'label.no_dual': 'Nie (dwutaryfowy)',
                'label.reading_dom_single': 'Odczyt DOM (jednotaryfowy)',
                'label.reading_dom_tariff1': 'Odczyt DOM - Taryfa I',
                'label.reading_dom_tariff2': 'Odczyt DOM - Taryfa II',
                'label.meter_dol_single': 'Licznik D√ì≈Å - Jednotaryfowy?',
                'label.reading_dol_single': 'Odczyt D√ì≈Å (jednotaryfowy)',
                'label.reading_dol_tariff1': 'Odczyt D√ì≈Å - Taryfa I',
                'label.reading_dol_tariff2': 'Odczyt D√ì≈Å - Taryfa II',
                'label.reading_gabinet': 'Odczyt GABINET (zawsze jednotaryfowy)',
                'button.hide_form': 'Ukryj formularz',
                'section.add_manual_invoice': 'Dodaj fakturƒô rƒôcznie',
                'table.meter': 'Licznik',
                'table.tenant': 'Najemca',
                'table.local': 'Lokal',
                'table.period': 'Okres',
                'table.invoice_number': 'Numer faktury',
                'table.usage': 'Zu≈ºycie (m¬≥)',
                'table.water_cost_m3': 'Koszt wody/m¬≥',
                'table.sewage_cost_m3': 'Koszt ≈õciek√≥w/m¬≥',
                'table.total_gross': 'Suma brutto',
                'table.actions': 'Akcje',
                'table.main_meter': 'Licznik g≈Ç√≥wny',
                'table.meter_5': 'Licznik 5 (gora)',
                'table.meter_5a': 'Licznik 5a (gabinet)',
                'table.share': 'Udzia≈Ç',
                'table.local_gross': 'Lokal brutto',
                'table.reading_date': 'Data odczytu',
                'table.dom': 'DOM',
                'table.dol': 'D√ì≈Å',
                'table.gabinet': 'GABINET',
                'table.period_billing': 'Okres Rozliczeniowy',
                'table.cost_per_kwh': 'Koszt za 1kWh',
                'table.usage_kwh': 'Zu≈ºycie (kWh)',
                'table.amount_to_pay': 'Do zap≈Çaty',
                'table.tariff_type': 'Typ taryfy',
                'preferences.title': 'Preferencje',
                'preferences.menu.account': 'Konto u≈ºytkownika',
                'preferences.menu.backup': 'Backup bazy danych',
                'preferences.menu.aquanet': 'Aquanet',
                'preferences.back': 'Powr√≥t',
                'preferences.user.email': 'Email',
                'preferences.user.email.desc': 'Email u≈ºywany do wysy≈Çki backup√≥w',
                'preferences.password.change_title': 'Zmiana has≈Ça',
                'preferences.password.old': 'Stare has≈Ço',
                'preferences.password.new': 'Nowe has≈Ço',
                'preferences.password.new.desc': 'Has≈Ço musi mieƒá co najmniej 6 znak√≥w',
                'preferences.password.confirm': 'Potwierd≈∫ nowe has≈Ço',
                'preferences.password.change_button': 'Zmie≈Ñ has≈Ço',
                'preferences.password.reset_title': 'Nie pamiƒôtam has≈Ça',
                'preferences.password.reset_desc': 'Je≈õli nie pamiƒôtasz has≈Ça, mo≈ºemy wys≈Çaƒá kod resetujƒÖcy na Tw√≥j email.',
                'preferences.password.reset_email': 'Email',
                'preferences.password.reset_button': 'Wy≈õlij kod resetujƒÖcy',
                'preferences.password.reset_code': 'Kod resetujƒÖcy',
                'preferences.password.reset_code.desc': 'Sprawd≈∫ swojƒÖ skrzynkƒô email',
                'preferences.password.reset_submit': 'Zresetuj has≈Ço',
                'preferences.aquanet.username': 'Nazwa u≈ºytkownika Aquanet',
                'preferences.aquanet.password': 'Has≈Ço Aquanet',
                'preferences.backup.title': 'Backup bazy danych',
                'preferences.backup.create.period': 'Utw√≥rz backup okresowy',
                'preferences.backup.send.email': 'Wy≈õlij backup na email',
                'preferences.backup.info': 'Backup jest automatycznie tworzony po rozliczeniu ca≈Çego okresu',
                'preferences.save': 'Zapisz',
                'preferences.cancel': 'Anuluj',
                'info.multiple_invoices': 'WA≈ªNE: WIELE FAKTUR DLA JEDNEGO OKRESU',
                'info.multiple_invoices_desc': 'Gdy okres rozliczeniowy (2 miesiƒÖce) ma zmianƒô stawki w po≈Çowie:',
                'info.multiple_invoices_period': 'Okres (YYYY-MM) - u≈ºywaj tego samego dla obu faktur (np. "2025-02")',
                'info.multiple_invoices_dates': 'Data poczƒÖtku/ko≈Ñca - wpisz faktyczne daty ka≈ºdej faktury',
                'info.multiple_invoices_weighted': 'System automatycznie obliczy ≈õredniƒÖ wa≈ºonƒÖ koszt√≥w z obu faktur',
                'info.multiple_invoices_subscription': 'Abonamenty zostanƒÖ zsumowane z wszystkich faktur',
                'info.multiple_invoices_example': 'Przyk≈Çad: Okres "2025-02" ma dwie faktury:',
                'info.multiple_invoices_example1': 'Faktura 1: 01.01-31.01, koszt 10 z≈Ç/m¬≥, zu≈ºycie 20 m¬≥',
                'info.multiple_invoices_example2': 'Faktura 2: 01.02-28.02, koszt 12 z≈Ç/m¬≥, zu≈ºycie 25 m¬≥',
                'info.multiple_invoices_example3': '‚Üí System u≈ºyje ≈õredniej wa≈ºonej: (10√ó20 + 12√ó25) / 45 = 11.11 z≈Ç/m¬≥',
                'info.verification': 'WERYFIKACJA FAKTUR',
                'info.verification_text': 'Po wczytaniu faktury PDF, dane zostanƒÖ wy≈õwietlone poni≈ºej do weryfikacji i ewentualnej zmiany przed zapisem do bazy danych.',
                'info.period_format_water': 'Podaj okres w formacie YYYY-MM. System automatycznie wygeneruje rachunki dla wszystkich lokali na podstawie faktur i odczyt√≥w.',
                'info.period_format_gas': 'Podaj okres w formacie YYYY-MM. System automatycznie wygeneruje rachunki dla wszystkich lokali na podstawie faktur gazu (58% gora, 25% dol, 17% gabinet).',
                'info.period_format_electricity': 'Wybierz okres z dostƒôpnych powy≈ºej. Pokazane sƒÖ tylko okresy, dla kt√≥rych istniejƒÖ zar√≥wno faktury jak i odczyty.',
                'info.available_periods': 'Dostƒôpne okresy',
                'info.available_periods_select': 'wybierz jeden z poni≈ºszych',
                'info.warning_missing_readings': 'Uwaga: {count} okres√≥w ma faktury, ale brakuje odczyt√≥w. Wprowad≈∫ odczyty, aby m√≥c generowaƒá rachunki.',
                'info.no_available_periods': 'Brak dostƒôpnych okres√≥w (wymagane sƒÖ zar√≥wno faktury jak i odczyty)',
                'info.missing_readings_count': 'Brakuje odczyt√≥w dla {count} okres√≥w, kt√≥re majƒÖ faktury. Wprowad≈∫ odczyty w zak≈Çadce "Odczyty", aby m√≥c generowaƒá rachunki.',
                'info.error_loading_periods': 'B≈ÇƒÖd ≈Çadowania dostƒôpnych okres√≥w',
                'details.period': 'Okres:',
                'details.invoice_number': 'Numer faktury:',
                'details.usage_m3': 'Zu≈ºycie (m¬≥):',
                'details.water_cost_m3': 'Koszt wody/m¬≥:',
                'details.sewage_cost_m3': 'Koszt ≈õciek√≥w/m¬≥:',
                'details.subscription_months': 'Abonament (miesiƒôcy):',
                'details.subscription_water': 'Abonament woda/miesiƒÖc:',
                'details.subscription_sewage': 'Abonament ≈õcieki/miesiƒÖc:',
                'details.vat': 'VAT:',
                'details.period_start': 'Okres od:',
                'details.period_end': 'Okres do:',
                'details.total_gross': 'Suma brutto:',
                'details.local': 'Lokal:',
                'details.reading_value': 'Warto≈õƒá odczytu:',
                'details.water_cost': 'Koszt wody:',
                'details.sewage_cost': 'Koszt ≈õciek√≥w:',
                'details.usage_total': 'Koszt zu≈ºycia ≈ÇƒÖcznie:',
                'details.subscription_water_share': 'Abonament woda:',
                'details.subscription_sewage_share': 'Abonament ≈õcieki:',
                'details.subscription_total': 'Abonament ≈ÇƒÖcznie:',
                'details.total_net': 'Suma netto:',
                'details.main_meter': 'Licznik g≈Ç√≥wny (DOM):',
                'details.meter_5': 'Licznik 5 (gora):',
                'details.meter_5a': 'Licznik 5a (gabinet):',
                'details.previous_reading': 'Odczyt poprzedni:',
                'details.current_reading': 'Odczyt obecny:',
                'details.fuel_usage_m3': 'Zu≈ºycie paliwa:',
                'details.fuel_usage_kwh': 'Zu≈ºycie paliwa (kWh):',
                'details.fuel_value_net': 'Paliwo - Warto≈õƒá netto:',
                'details.fuel_value_gross': 'Paliwo - Warto≈õƒá brutto:',
                'details.subscription_value_net': 'Abonament - Warto≈õƒá netto:',
                'details.subscription_value_gross': 'Abonament - Warto≈õƒá brutto:',
                'details.distribution_fixed_value_net': 'Dystrybucja sta≈Ça - Warto≈õƒá netto:',
                'details.distribution_fixed_value_gross': 'Dystrybucja sta≈Ça - Warto≈õƒá brutto:',
                'details.distribution_variable_value_net': 'Dystrybucja zmienna - Warto≈õƒá netto:',
                'details.distribution_variable_value_gross': 'Dystrybucja zmienna - Warto≈õƒá brutto:',
                'details.total_net_sum': 'Suma netto:',
                'details.vat_amount': 'Kwota VAT:',
                'details.late_payment_interest': 'Odsetki za sp√≥≈∫nienie:',
                'details.payment_due_date': 'Termin p≈Çatno≈õci:',
                'details.amount_to_pay': 'Do zap≈Çaty:',
                'details.share': 'Udzia≈Ç:',
                'details.fuel_cost_gross': 'Paliwo (brutto):',
                'details.subscription_cost_gross': 'Abonament (brutto):',
                'details.distribution_fixed_cost_gross': 'Dystrybucja sta≈Ça (brutto):',
                'details.distribution_variable_cost_gross': 'Dystrybucja zmienna (brutto):',
                'details.local_gross': 'Lokal brutto:',
                'section.combined_bills': 'RACHUNKI ≈ÅƒÑCZONE (WODA, GAZ, PRƒÑD)',
                'button.combined_bills': 'RACHUNKI ≈ÅƒÑCZONE',
                'status.generated': 'WYGENEROWANE',
                'status.available': 'DOSTƒòPNY DO GENEROWANIA',
                'status.unavailable': 'NIEDOSTƒòPNY',
                'status.no_data': 'BRAK DANYCH',
                'table.period': 'OKRES',
                'table.status': 'STATUS',
                'table.actions': 'AKCJE'
            },
            en: {
                'header.title': 'Billing System',
                'header.subtitle': 'Billing system for water, sewage, gas and electricity',
                'header.api_docs': 'üìö API Documentation (Swagger UI)',
                'header.author': 'Author',
                'main.select_medium': 'Select medium to manage',
                'medium.water': 'Water',
                'medium.gas': 'Gas',
                'medium.electricity': 'Electricity',
                'stats.invoices': 'Invoices',
                'stats.bills': 'Bills',
                'stats.total_gross': 'Total gross',
                'stats.latest_period': 'Latest period',
                'stats.locals': 'Locals',
                'stats.readings': 'Readings',
                'button.back': 'BACK TO MAIN PAGE',
                'button.water': '‚óØ WATER',
                'button.gas': '‚ñ≥ GAS',
                'button.electricity': 'ELECTRICITY',
                'section.locals': 'Locals',
                'section.readings': 'Meter readings',
                'section.invoices': 'Invoices',
                'section.bills': 'Bills',
                'label.meter_name': 'Meter name',
                'label.tenant': 'Tenant',
                'label.local': 'Local',
                'label.period': 'Period (YYYY-MM)',
                'label.main_meter': 'Main meter (DOM)',
                'label.meter_5': 'Meter 5 (gora)',
                'label.meter_5a': 'Meter 5a (gabinet)',
                'label.meter_5b': 'METER 5B (DOL) - AUTO',
                'button.add_local': 'ADD LOCAL',
                'button.add_reading': 'ADD READING',
                'button.send_to_provider': 'Send meter reading to provider',
                'button.show_credentials': 'Show login credentials',
                'button.upload_pdf': 'UPLOAD PDF',
                'button.select_file': 'SELECT FILE',
                'button.verify_save': 'Verify and save',
                'button.cancel': 'Cancel',
                'button.add_manual': 'OR ADD MANUALLY',
                'button.add_invoice': 'Add invoice',
                'button.generate_bills': 'GENERATE BILLS',
                'button.regenerate_bills': 'REGENERATE BILLS',
                'section.gas_invoices': 'Gas invoices (PGNiG)',
                'section.gas_bills': 'Gas bills',
                'section.electricity_readings': 'Electricity readings',
                'section.electricity_invoices': 'Electricity invoices (ENEA)',
                'section.electricity_bills': 'Electricity bills',
                'label.invoice_number': 'Invoice number',
                'label.period_start': 'Period start date',
                'label.period_end': 'Period end date',
                'label.fuel_usage_m3': 'Fuel usage (m¬≥)',
                'label.previous_reading': 'Previous reading (m¬≥)',
                'label.current_reading': 'Current reading (m¬≥)',
                'label.fuel_conversion_factor': 'Fuel - Conversion factor (kWh/m¬≥)',
                'label.fuel_usage_kwh': 'Fuel - Usage (kWh)',
                'label.fuel_price_net': 'Fuel - Net price per kWh',
                'label.fuel_value_net': 'Fuel - Net value',
                'label.subscription_quantity': 'Subscription - Number of months',
                'label.subscription_price_net': 'Subscription - Net price per month',
                'label.subscription_value_net': 'Subscription - Net value',
                'label.distribution_fixed_quantity': 'Fixed distribution - Number of months',
                'label.distribution_fixed_price_net': 'Fixed distribution - Net price per month',
                'label.distribution_fixed_value_net': 'Fixed distribution - Net value',
                'label.distribution_variable_usage_m3': 'Variable distribution - Usage (m¬≥)',
                'label.distribution_variable_conversion': 'Variable distribution - Conv. factor',
                'label.distribution_variable_usage_kwh': 'Variable distribution - Usage (kWh)',
                'label.distribution_variable_price_net': 'Variable distribution - Net price per kWh',
                'label.distribution_variable_value_net': 'Variable distribution - Net value',
                'label.total_net_sum': 'Total net value',
                'label.vat_rate': 'VAT (e.g. 0.23 for 23%)',
                'label.vat_amount': 'Total VAT amount',
                'label.total_gross_sum': 'Total gross value',
                'label.late_payment_interest': 'Late payment interest',
                'label.payment_due_date': 'Payment due date',
                'label.amount_to_pay': 'Amount to pay',
                'label.verify_invoice': 'Verify invoice data before saving',
                'stats.gas_invoices': 'Gas invoices',
                'stats.gas_bills': 'Gas bills',
                'label.reading_date': 'Meter reading date',
                'label.meter_dom_single': 'Meter DOM - Single tariff?',
                'label.yes_single': 'Yes (single tariff)',
                'label.no_dual': 'No (dual tariff)',
                'label.reading_dom_single': 'Reading DOM (single tariff)',
                'label.reading_dom_tariff1': 'Reading DOM - Tariff I',
                'label.reading_dom_tariff2': 'Reading DOM - Tariff II',
                'label.meter_dol_single': 'Meter D√ì≈Å - Single tariff?',
                'label.reading_dol_single': 'Reading D√ì≈Å (single tariff)',
                'label.reading_dol_tariff1': 'Reading D√ì≈Å - Tariff I',
                'label.reading_dol_tariff2': 'Reading D√ì≈Å - Tariff II',
                'label.reading_gabinet': 'Reading GABINET (always single tariff)',
                'button.hide_form': 'Hide form',
                'section.add_manual_invoice': 'Add invoice manually',
                'table.meter': 'Meter',
                'table.tenant': 'Tenant',
                'table.local': 'Local',
                'table.period': 'Period',
                'table.invoice_number': 'Invoice number',
                'table.usage': 'Usage (m¬≥)',
                'table.water_cost_m3': 'Water cost/m¬≥',
                'table.sewage_cost_m3': 'Sewage cost/m¬≥',
                'table.total_gross': 'Total gross',
                'table.actions': 'Actions',
                'table.main_meter': 'Main meter',
                'table.meter_5': 'Meter 5 (gora)',
                'table.meter_5a': 'Meter 5a (gabinet)',
                'table.share': 'Share',
                'table.local_gross': 'Local gross',
                'table.reading_date': 'Reading date',
                'table.dom': 'DOM',
                'table.dol': 'D√ì≈Å',
                'table.gabinet': 'GABINET',
                'table.period_billing': 'Billing Period',
                'table.cost_per_kwh': 'Cost per 1kWh',
                'table.usage_kwh': 'Usage (kWh)',
                'table.amount_to_pay': 'Amount to pay',
                'table.tariff_type': 'Tariff type',
                'preferences.title': 'Preferences',
                'preferences.menu.account': 'User Account',
                'preferences.menu.backup': 'Database Backup',
                'preferences.menu.aquanet': 'Aquanet',
                'preferences.back': 'Back',
                'preferences.user.email': 'Email',
                'preferences.user.email.desc': 'Email used for sending backups',
                'preferences.password.change_title': 'Change Password',
                'preferences.password.old': 'Old Password',
                'preferences.password.new': 'New Password',
                'preferences.password.new.desc': 'Password must be at least 6 characters',
                'preferences.password.confirm': 'Confirm New Password',
                'preferences.password.change_button': 'Change Password',
                'preferences.password.reset_title': 'Forgot Password',
                'preferences.password.reset_desc': 'If you forgot your password, we can send a reset code to your email.',
                'preferences.password.reset_email': 'Email',
                'preferences.password.reset_button': 'Send Reset Code',
                'preferences.password.reset_code': 'Reset Code',
                'preferences.password.reset_code.desc': 'Check your email inbox',
                'preferences.password.reset_submit': 'Reset Password',
                'preferences.aquanet.username': 'Aquanet Username',
                'preferences.aquanet.password': 'Aquanet Password',
                'preferences.backup.title': 'Database Backup',
                'preferences.backup.create.period': 'Create period backup',
                'preferences.backup.send.email': 'Send backup to email',
                'preferences.backup.info': 'Backup is automatically created after full period settlement',
                'preferences.save': 'Save',
                'preferences.cancel': 'Cancel',
                'info.multiple_invoices': 'IMPORTANT: MULTIPLE INVOICES FOR ONE PERIOD',
                'info.multiple_invoices_desc': 'When the billing period (2 months) has a rate change in the middle:',
                'info.multiple_invoices_period': 'Period (YYYY-MM) - use the same for both invoices (e.g. "2025-02")',
                'info.multiple_invoices_dates': 'Start/end date - enter the actual dates of each invoice',
                'info.multiple_invoices_weighted': 'The system will automatically calculate the weighted average of costs from both invoices',
                'info.multiple_invoices_subscription': 'Subscriptions will be summed from all invoices',
                'info.multiple_invoices_example': 'Example: Period "2025-02" has two invoices:',
                'info.multiple_invoices_example1': 'Invoice 1: 01.01-31.01, cost 10 PLN/m¬≥, usage 20 m¬≥',
                'info.multiple_invoices_example2': 'Invoice 2: 01.02-28.02, cost 12 PLN/m¬≥, usage 25 m¬≥',
                'info.multiple_invoices_example3': '‚Üí The system will use weighted average: (10√ó20 + 12√ó25) / 45 = 11.11 PLN/m¬≥',
                'info.verification': 'INVOICE VERIFICATION',
                'info.verification_text': 'After uploading the invoice PDF, the data will be displayed below for verification and possible changes before saving to the database.',
                'info.period_format_water': 'Enter period in YYYY-MM format. The system will automatically generate bills for all locals based on invoices and readings.',
                'info.period_format_gas': 'Enter period in YYYY-MM format. The system will automatically generate bills for all locals based on gas invoices (58% gora, 25% dol, 17% gabinet).',
                'info.period_format_electricity': 'Select period from available above. Only periods with both invoices and readings are shown.',
                'info.available_periods': 'Available periods',
                'info.available_periods_select': 'select one from below',
                'info.warning_missing_readings': 'Warning: {count} periods have invoices, but readings are missing. Enter readings to generate bills.',
                'info.no_available_periods': 'No available periods (both invoices and readings are required)',
                'info.missing_readings_count': 'Missing readings for {count} periods that have invoices. Enter readings in the "Readings" tab to generate bills.',
                'info.error_loading_periods': 'Error loading available periods',
                'details.period': 'Period:',
                'details.invoice_number': 'Invoice number:',
                'details.usage_m3': 'Usage (m¬≥):',
                'details.water_cost_m3': 'Water cost/m¬≥:',
                'details.sewage_cost_m3': 'Sewage cost/m¬≥:',
                'details.subscription_months': 'Subscription (months):',
                'details.subscription_water': 'Subscription water/month:',
                'details.subscription_sewage': 'Subscription sewage/month:',
                'details.vat': 'VAT:',
                'details.period_start': 'Period from:',
                'details.period_end': 'Period to:',
                'details.total_gross': 'Total gross:',
                'details.local': 'Local:',
                'details.reading_value': 'Reading value:',
                'details.water_cost': 'Water cost:',
                'details.sewage_cost': 'Sewage cost:',
                'details.usage_total': 'Total usage cost:',
                'details.subscription_water_share': 'Subscription water:',
                'details.subscription_sewage_share': 'Subscription sewage:',
                'details.subscription_total': 'Subscription total:',
                'details.total_net': 'Total net:',
                'details.main_meter': 'Main meter (DOM):',
                'details.meter_5': 'Meter 5 (gora):',
                'details.meter_5a': 'Meter 5a (gabinet):',
                'details.previous_reading': 'Previous reading:',
                'details.current_reading': 'Current reading:',
                'details.fuel_usage_m3': 'Fuel usage:',
                'details.fuel_usage_kwh': 'Fuel usage (kWh):',
                'details.fuel_value_net': 'Fuel - Net value:',
                'details.fuel_value_gross': 'Fuel - Gross value:',
                'details.subscription_value_net': 'Subscription - Net value:',
                'details.subscription_value_gross': 'Subscription - Gross value:',
                'details.distribution_fixed_value_net': 'Fixed distribution - Net value:',
                'details.distribution_fixed_value_gross': 'Fixed distribution - Gross value:',
                'details.distribution_variable_value_net': 'Variable distribution - Net value:',
                'details.distribution_variable_value_gross': 'Variable distribution - Gross value:',
                'details.total_net_sum': 'Total net:',
                'details.vat_amount': 'VAT amount:',
                'details.late_payment_interest': 'Late payment interest:',
                'details.payment_due_date': 'Payment due date:',
                'details.amount_to_pay': 'Amount to pay:',
                'details.share': 'Share:',
                'details.fuel_cost_gross': 'Fuel (gross):',
                'details.subscription_cost_gross': 'Subscription (gross):',
                'details.distribution_fixed_cost_gross': 'Fixed distribution (gross):',
                'details.distribution_variable_cost_gross': 'Variable distribution (gross):',
                'details.local_gross': 'Local gross:',
                'section.combined_bills': 'COMBINED BILLS (WATER, GAS, ELECTRICITY)',
                'button.combined_bills': 'COMBINED BILLS',
                'status.generated': 'GENERATED',
                'status.available': 'AVAILABLE FOR GENERATION',
                'status.unavailable': 'UNAVAILABLE',
                'status.no_data': 'NO DATA',
                'table.period': 'PERIOD',
                'table.status': 'STATUS',
                'table.actions': 'ACTIONS'
            }
        };

        function translate(key) {
            return translations[currentLanguage][key] || key;
        }

        function updateTexts() {
            // Aktualizuj wszystkie elementy z atrybutem data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (key && translations[currentLanguage][key]) {
                    el.textContent = translate(key);
                }
            });
            
            // Aktualizuj opcje w selectach
            document.querySelectorAll('select option[data-i18n]').forEach(option => {
                const key = option.getAttribute('data-i18n');
                if (key && translations[currentLanguage][key]) {
                    option.textContent = translate(key);
                }
            });
            
            // Aktualizuj ikonƒô jƒôzyka
            const langIcon = document.getElementById('language-icon');
            if (langIcon) {
                langIcon.textContent = currentLanguage === 'pl' ? 'EN' : 'PL';
            }
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'pl' ? 'en' : 'pl';
            localStorage.setItem('language', currentLanguage);
            updateTexts();
            if (document.getElementById('settingsSidebar').classList.contains('open')) {
                updatePreferencesSidebar();
            }
        }

        // Sidebar preferencji
        function openPreferences() {
            const sidebar = document.getElementById('settingsSidebar');
            const overlay = document.getElementById('settingsOverlay');
            sidebar.classList.add('open');
            overlay.classList.add('open');
            loadPreferences();
            showSettingsMenu(); // Poka≈º menu zamiast sekcji
        }

        function closePreferences() {
            const sidebar = document.getElementById('settingsSidebar');
            const overlay = document.getElementById('settingsOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            showSettingsMenu(); // Wr√≥ƒá do menu przy zamykaniu
        }

        function showSettingsMenu() {
            // Ukryj wszystkie sekcje
            document.querySelectorAll('.settings-content').forEach(section => {
                section.classList.remove('active');
            });
            // Poka≈º menu
            document.getElementById('settingsMenu').style.display = 'block';
            // Usu≈Ñ aktywno≈õƒá z wszystkich element√≥w menu
            document.querySelectorAll('.settings-menu-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        function showSettingsSection(sectionId) {
            // Ukryj menu
            document.getElementById('settingsMenu').style.display = 'none';
            // Ukryj wszystkie sekcje
            document.querySelectorAll('.settings-content').forEach(section => {
                section.classList.remove('active');
            });
            // Poka≈º wybranƒÖ sekcjƒô
            const section = document.getElementById('settings' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1));
            if (section) {
                section.classList.add('active');
            }
            // Oznacz aktywny element menu
            document.querySelectorAll('.settings-menu-item').forEach(item => {
                item.classList.remove('active');
                // Sprawd≈∫ czy ten element ma onclick z tƒÖ sekcjƒÖ
                if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(`'${sectionId}'`)) {
                    item.classList.add('active');
                }
            });
        }

        function togglePasswordSection() {
            const section = document.getElementById('change-password-section');
            const icon = document.getElementById('password-toggle-icon');
            if (section.style.display === 'none' || !section.style.display) {
                section.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                section.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        function toggleForgotPasswordSection() {
            const section = document.getElementById('forgot-password-section');
            const icon = document.getElementById('forgot-password-toggle-icon');
            if (section.style.display === 'none' || !section.style.display) {
                section.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                section.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        function updatePreferencesSidebar() {
            // Aktualizuj teksty w sidebar (je≈õli potrzeba)
            const title = document.querySelector('#settingsSidebar h2');
            if (title) title.textContent = translate('preferences.title');
        }

        async function loadPreferences() {
            // Za≈Çaduj dane logowania AQUANET z API
            try {
                const credRes = await fetch(`${API_BASE}/api/water/credentials/exists/`);
                if (credRes.ok) {
                    const credData = await credRes.json();
                    if (credData.exists) {
                        // Pobierz dane logowania (tylko do wy≈õwietlenia - has≈Ço bƒôdzie puste dla bezpiecze≈Ñstwa)
                        const getCredRes = await fetch(`${API_BASE}/api/water/credentials/`);
                        if (getCredRes.ok) {
                            const credentials = await getCredRes.json();
                            document.getElementById('aquanet-username').value = credentials.username || '';
                            // Nie wy≈õwietlamy has≈Ça dla bezpiecze≈Ñstwa - u≈ºytkownik musi je ponownie wprowadziƒá
                            document.getElementById('aquanet-password').value = '';
                        }
                    } else {
                        document.getElementById('aquanet-username').value = '';
                        document.getElementById('aquanet-password').value = '';
                    }
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania danych AQUANET:', error);
                document.getElementById('aquanet-username').value = '';
                document.getElementById('aquanet-password').value = '';
            }
            
            // Za≈Çaduj email u≈ºytkownika z API
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (response.ok) {
                    const userData = await response.json();
                    if (userData.email) {
                        document.getElementById('user-email').value = userData.email;
                    }
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania danych u≈ºytkownika:', error);
            }
        }

        async function savePreferences() {
            // Zapisz dane logowania AQUANET przez API
            const aquanetUsername = document.getElementById('aquanet-username').value;
            const aquanetPassword = document.getElementById('aquanet-password').value;
            
            if (aquanetUsername && aquanetPassword) {
                try {
                    const credResponse = await fetch(`${API_BASE}/api/water/credentials/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: aquanetUsername,
                            password: aquanetPassword
                        })
                    });
                    
                    if (!credResponse.ok) {
                        const error = await credResponse.json();
                        showAlert(error.detail || 'B≈ÇƒÖd zapisywania danych AQUANET', 'error');
                        return;
                    }
                } catch (error) {
                    console.error('B≈ÇƒÖd zapisywania danych AQUANET:', error);
                    showAlert('B≈ÇƒÖd zapisywania danych AQUANET: ' + error.message, 'error');
                    return;
                }
            }
            
            // Zapisz email u≈ºytkownika
            const userEmail = document.getElementById('user-email').value;
            if (userEmail) {
                try {
                    const response = await fetch('/api/auth/me/email', {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email: userEmail })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        showAlert(error.detail || 'B≈ÇƒÖd aktualizacji email', 'error');
                        return;
                    }
                } catch (error) {
                    console.error('B≈ÇƒÖd aktualizacji email:', error);
                    showAlert('B≈ÇƒÖd aktualizacji email: ' + error.message, 'error');
                    return;
                }
            }
            
            showAlert('Preferencje zapisane', 'success');
            closePreferences();
        }

        async function changePassword() {
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // Walidacja
            if (!oldPassword || !newPassword || !confirmPassword) {
                showAlert('Wype≈Çnij wszystkie pola', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showAlert('Nowe has≈Ço musi mieƒá co najmniej 6 znak√≥w', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('Nowe has≈Ça nie sƒÖ identyczne', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/me/password', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    showAlert(error.detail || 'B≈ÇƒÖd zmiany has≈Ça', 'error');
                    return;
                }
                
                // Wyczy≈õƒá pola
                document.getElementById('old-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
                
                showAlert('Has≈Ço zosta≈Ço zmienione pomy≈õlnie', 'success');
            } catch (error) {
                console.error('B≈ÇƒÖd zmiany has≈Ça:', error);
                showAlert('B≈ÇƒÖd zmiany has≈Ça: ' + error.message, 'error');
            }
        }

        async function requestPasswordReset() {
            const email = document.getElementById('reset-email').value;
            
            if (!email) {
                showAlert('Wprowad≈∫ adres email', 'error');
                return;
            }
            
            try {
                showAlert('Wysy≈Çanie kodu resetujƒÖcego...', 'info');
                
                const response = await fetch('/api/auth/password-reset/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    showAlert(error.detail || 'B≈ÇƒÖd wysy≈Çania kodu resetujƒÖcego', 'error');
                    return;
                }
                
                const data = await response.json();
                
                // Je≈õli SMTP nie jest skonfigurowany, kod mo≈ºe byƒá w odpowiedzi
                if (data.code) {
                    showAlert(`Kod resetujƒÖcy: ${data.code} (sprawd≈∫ te≈º konsolƒô serwera lub plik password_reset_code.txt)`, 'info');
                } else {
                    showAlert(data.message || 'Kod resetujƒÖcy zosta≈Ç wys≈Çany na email', 'success');
                }
                
                // Poka≈º formularz resetu has≈Ça
                document.getElementById('reset-password-form').style.display = 'block';
                
                // Je≈õli kod jest w odpowiedzi (lokalne ≈õrodowisko), wype≈Çnij pole
                if (data.code) {
                    document.getElementById('reset-code').value = data.code;
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈ºƒÖdania resetu has≈Ça:', error);
                showAlert('B≈ÇƒÖd wysy≈Çania kodu resetujƒÖcego: ' + error.message, 'error');
            }
        }

        async function resetPassword() {
            const email = document.getElementById('reset-email').value;
            const code = document.getElementById('reset-code').value;
            const newPassword = document.getElementById('reset-new-password').value;
            const confirmPassword = document.getElementById('reset-confirm-password').value;
            
            // Walidacja
            if (!email || !code || !newPassword || !confirmPassword) {
                showAlert('Wype≈Çnij wszystkie pola', 'error');
                return;
            }
            
            if (code.length !== 6) {
                showAlert('Kod resetujƒÖcy musi mieƒá 6 cyfr', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showAlert('Nowe has≈Ço musi mieƒá co najmniej 6 znak√≥w', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('Nowe has≈Ça nie sƒÖ identyczne', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/password-reset/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        code: code,
                        new_password: newPassword
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    showAlert(error.detail || 'B≈ÇƒÖd resetowania has≈Ça', 'error');
                    return;
                }
                
                const data = await response.json();
                showAlert(data.message || 'Has≈Ço zosta≈Ço zresetowane pomy≈õlnie', 'success');
                
                // Wyczy≈õƒá pola i ukryj formularz
                document.getElementById('reset-email').value = '';
                document.getElementById('reset-code').value = '';
                document.getElementById('reset-new-password').value = '';
                document.getElementById('reset-confirm-password').value = '';
                document.getElementById('reset-password-form').style.display = 'none';
            } catch (error) {
                console.error('B≈ÇƒÖd resetowania has≈Ça:', error);
                showAlert('B≈ÇƒÖd resetowania has≈Ça: ' + error.message, 'error');
            }
        }

        async function createBackup(backupType) {
            try {
                showAlert('Tworzenie backupu...', 'info');
                const response = await fetch(`/api/backup/create?backup_type=${backupType}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert(result.message || 'Backup utworzony pomy≈õlnie', 'success');
                } else {
                    const error = await response.json();
                    showAlert(error.detail || 'B≈ÇƒÖd tworzenia backupu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd tworzenia backupu: ' + error.message, 'error');
            }
        }

        async function sendBackupEmail() {
            try {
                showAlert('Wysy≈Çanie backupu na email...', 'info');
                const response = await fetch('/api/backup/send-email', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert(result.message || 'Backup wys≈Çany pomy≈õlnie', 'success');
                } else {
                    const error = await response.json();
                    showAlert(error.detail || 'B≈ÇƒÖd wysy≈Çania email', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd wysy≈Çania email: ' + error.message, 'error');
            }
        }

        // Zaktualizuj funkcjƒô toggleTheme
        const originalToggleTheme = window.toggleTheme;
        window.toggleTheme = function() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const isDark = body.classList.contains('dark-mode');
            
            if (isDark) {
                body.classList.remove('dark-mode');
                themeIcon.textContent = '‚òæ';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-mode');
                themeIcon.textContent = '‚òÄ';
                localStorage.setItem('theme', 'dark');
            }
        };

        // Inicjalizacja przy za≈Çadowaniu strony - dodajemy do istniejƒÖcego DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAuthAndPreferences);
        } else {
            initAuthAndPreferences();
        }

        // ========== RACHUNKI ≈ÅƒÑCZONE ==========
        
        function openCombinedBills() {
            // Ukryj g≈Ç√≥wnƒÖ stronƒô
            document.getElementById('main-page').style.display = 'none';
            // Ukryj sekcje medium
            document.getElementById('medium-sections').style.display = 'none';
            // Poka≈º sekcjƒô rachunk√≥w ≈ÇƒÖczonych
            document.getElementById('combined-bills-section').style.display = 'block';
            // Za≈Çaduj dostƒôpne okresy
            loadAvailableCombinedPeriods();
        }
        
        let availableCombinedPeriods = [];
        
        async function loadAvailableCombinedPeriods() {
            try {
                const res = await fetch(`${API_BASE}/api/combined/available-periods`);
                const data = await res.json();
                availableCombinedPeriods = data.available_periods || [];
                
                // Za≈Çaduj listƒô wszystkich okres√≥w z rachunkami
                loadCombinedBills();
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania dostƒôpnych okres√≥w:', error);
                // Nawet przy b≈Çƒôdzie spr√≥buj za≈Çadowaƒá listƒô rachunk√≥w
                loadCombinedBills();
            }
        }
        
        async function loadCombinedBills() {
            try {
                // Pobierz dostƒôpne okresy i wygenerowane rachunki
                const [periodsRes, billsRes] = await Promise.all([
                    fetch(`${API_BASE}/api/combined/available-periods`),
                    fetch(`${API_BASE}/api/combined/bills`)
                ]);
                
                const periodsData = await periodsRes.json();
                const bills = await billsRes.json();
                const listEl = document.getElementById('combined-bills-list');
                
                // Utw√≥rz mapƒô wygenerowanych rachunk√≥w wed≈Çug okresu
                const billsByPeriod = {};
                bills.forEach(bill => {
                    const periodKey = `${bill.period_start}_${bill.period_end}`;
                    if (!billsByPeriod[periodKey]) {
                        billsByPeriod[periodKey] = [];
                    }
                    billsByPeriod[periodKey].push(bill);
                });
                
                // Pobierz wszystkie mo≈ºliwe okresy (z diagnostyki lub z dostƒôpnych)
                const allPossiblePeriods = periodsData.diagnostics?.possible_consecutive_pairs || [];
                const availablePeriods = periodsData.available_periods || [];
                const periodsWithBills = periodsData.available_periods_with_bills || [];
                const periodsWithoutBills = periodsData.available_periods_without_bills || [];
                
                // Utw√≥rz zbi√≥r wszystkich okres√≥w (dostƒôpne + wygenerowane)
                const allPeriodsSet = new Set();
                availablePeriods.forEach(p => allPeriodsSet.add(`${p[0]}_${p[1]}`));
                Object.keys(billsByPeriod).forEach(p => allPeriodsSet.add(p));
                
                // Je≈õli nie ma ≈ºadnych okres√≥w, poka≈º komunikat
                if (allPeriodsSet.size === 0 && bills.length === 0) {
                    listEl.innerHTML = '<p style="text-transform: uppercase; color: #666;">Brak dostƒôpnych okres√≥w do wygenerowania rachunk√≥w ≈ÇƒÖczonych.</p>';
                    return;
                }
                
                // Utw√≥rz listƒô wszystkich okres√≥w do wy≈õwietlenia
                const periodHeader = translate('table.period');
                const statusHeader = translate('table.status');
                const actionsHeader = translate('table.actions');
                let html = `<table class="data-table"><thead><tr><th style="text-transform: uppercase;">${periodHeader}</th><th style="text-transform: uppercase;">${statusHeader}</th><th style="text-transform: uppercase;">${actionsHeader}</th></tr></thead><tbody>`;
                
                // Sortuj wszystkie okresy (najnowsze pierwsze)
                const allPeriods = Array.from(allPeriodsSet).sort().reverse();
                
                allPeriods.forEach(periodKey => {
                    const [start, end] = periodKey.split('_');
                    const periodTuple = [start, end];
                    const hasBills = billsByPeriod[periodKey] && billsByPeriod[periodKey].length > 0;
                    const isAvailable = availablePeriods.some(p => p[0] === start && p[1] === end);
                    const isInWithoutBills = periodsWithoutBills.some(p => p[0] === start && p[1] === end);
                    const isInWithBills = periodsWithBills.some(p => p[0] === start && p[1] === end);
                    
                    let statusText = '';
                    let actionsHtml = '';
                    
                    if (hasBills) {
                        // Okres ma wygenerowane rachunki
                        const periodBills = billsByPeriod[periodKey];
                        const allHavePDF = periodBills.every(b => b.pdf_path);
                        
                        const generatedText = translate('status.generated');
                        statusText = `<span style="color: white; font-weight: normal; text-transform: uppercase;">${generatedText}</span>`;
                        
                        // Przyciski zawsze w tych samych kolumnach
                        actionsHtml = `
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <div style="width: 40px; display: flex; justify-content: center;">
                                    <button class="btn btn-success btn-small" onclick="generateCombinedBillsForPeriod('${start}', '${end}')" title="Regeneruj rachunki">üîÑ</button>
                                </div>
                                <div style="width: 40px; display: flex; justify-content: center;">
                                    ${allHavePDF ? '' : `<button class="btn btn-primary btn-small" onclick="generateCombinedBillsPDFForPeriod('${start}', '${end}')" title="Generuj PDF">üìÑ</button>`}
                                </div>
                                <div style="width: 40px; display: flex; justify-content: center;">
                                    <button class="btn btn-info btn-small" onclick="sendAllCombinedBillsEmails('${start}', '${end}')" title="Wy≈õlij wszystkie rachunki na email">üìß</button>
                                </div>
                            </div>
                        `;
                    } else if (isInWithoutBills || isAvailable) {
                        // Okres jest dostƒôpny do generowania
                        statusText = `<span style="color: white; font-weight: normal; text-transform: uppercase;">${translate('status.available')}</span>`;
                        // Przyciski zawsze w tych samych kolumnach
                        actionsHtml = `
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <div style="width: 40px; display: flex; justify-content: center;">
                                    <button class="btn btn-success btn-small" onclick="generateCombinedBillsForPeriod('${start}', '${end}')" title="Generuj rachunki">‚ûï</button>
                                </div>
                                <div style="width: 40px; display: flex; justify-content: center;">
                                    <!-- Puste miejsce dla przycisku Generuj PDF -->
                                </div>
                                <div style="width: 40px; display: flex; justify-content: center;">
                                    <!-- Puste miejsce dla przycisku Szczeg√≥≈Çy -->
                                </div>
                            </div>
                        `;
                    } else {
                        // Okres nie jest dostƒôpny
                        const unavailableText = translate('status.unavailable');
                        statusText = `<span style="color: white; font-weight: normal; text-transform: uppercase;">${unavailableText}</span>`;
                        // Przyciski zawsze w tych samych kolumnach (puste)
                        actionsHtml = `
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <div style="width: 40px; display: flex; justify-content: center;">
                                    <!-- Puste miejsce -->
                                </div>
                                <div style="width: 40px; display: flex; justify-content: center;">
                                    <!-- Puste miejsce -->
                                </div>
                                <div style="width: 40px; display: flex; justify-content: center;">
                                    <!-- Puste miejsce -->
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `<tr class="clickable" onclick="toggleCombinedBillsDetails('${start}', '${end}')" data-period-start="${start}" data-period-end="${end}" style="cursor: pointer;">
                        <td style="text-transform: uppercase;"><strong>${start} DO ${end}</strong></td>
                        <td>${statusText}</td>
                        <td class="actions" onclick="event.stopPropagation()">${actionsHtml}</td>
                    </tr>
                    <tr class="details-row" id="combined-bills-details-${start}-${end}" data-period-start="${start}" data-period-end="${end}" style="display: none;">
                        <td colspan="3" class="details-cell">
                            <div id="combined-bills-details-content-${start}-${end}" style="padding: 20px;">
                                <p style="text-align: center; color: #999;">≈Åadowanie szczeg√≥≈Ç√≥w...</p>
                            </div>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania rachunk√≥w ≈ÇƒÖczonych:', error);
                document.getElementById('combined-bills-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania rachunk√≥w</p>';
            }
        }
        
        async function generateCombinedBillsForPeriod(periodStart, periodEnd) {
            try {
                const res = await fetch(`${API_BASE}/api/combined/generate-bills?period_start=${periodStart}&period_end=${periodEnd}`, {
                    method: 'POST'
                });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Wygenerowano ${result.bills_count || 0} rachunk√≥w ≈ÇƒÖczonych dla okresu ${periodStart} - ${periodEnd}`);
                    loadCombinedBills();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd generowania rachunk√≥w', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }
        
        async function generateCombinedBillsPDFForPeriod(periodStart, periodEnd) {
            try {
                const res = await fetch(`${API_BASE}/api/combined/generate-pdf?period_start=${periodStart}&period_end=${periodEnd}`, {
                    method: 'POST'
                });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Wygenerowano ${result.pdf_files?.length || 0} plik√≥w PDF dla okresu ${periodStart} - ${periodEnd}`);
                    loadCombinedBills();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd generowania PDF', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }
        
        function toggleCombinedBillsDetails(periodStart, periodEnd) {
            const detailsRow = document.getElementById(`combined-bills-details-${periodStart}-${periodEnd}`);
            const detailsContent = document.getElementById(`combined-bills-details-content-${periodStart}-${periodEnd}`);
            const periodRow = document.querySelector(`tr[data-period-start="${periodStart}"][data-period-end="${periodEnd}"]`);
            
            if (!detailsRow) return;
            
            if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
                // Zwi≈Ñ wszystkie inne rozwiniƒôte wiersze
                document.querySelectorAll('#combined-bills-section .data-table tr.clickable.expanded').forEach(row => {
                    row.classList.remove('expanded');
                });
                document.querySelectorAll('#combined-bills-section .details-row').forEach(row => {
                    row.style.display = 'none';
                });
                
                // Rozwi≈Ñ szczeg√≥≈Çy
                detailsRow.style.display = 'table-row';
                if (periodRow) {
                    periodRow.classList.add('expanded');
                }
                
                // Je≈õli szczeg√≥≈Çy nie sƒÖ jeszcze za≈Çadowane, pobierz je
                if (detailsContent.innerHTML.includes('≈Åadowanie szczeg√≥≈Ç√≥w')) {
                    loadCombinedBillsDetails(periodStart, periodEnd);
                }
            } else {
                // Zwi≈Ñ szczeg√≥≈Çy
                detailsRow.style.display = 'none';
                if (periodRow) {
                    periodRow.classList.remove('expanded');
                }
            }
        }
        
        function loadCombinedBillsDetails(periodStart, periodEnd) {
            const detailsContent = document.getElementById(`combined-bills-details-content-${periodStart}-${periodEnd}`);
            if (!detailsContent) return;
            
            fetch(`${API_BASE}/api/combined/bills?period_start=${periodStart}&period_end=${periodEnd}`)
                .then(res => res.json())
                .then(bills => {
                    if (bills.length === 0) {
                        detailsContent.innerHTML = '<p style="text-align: center; color: #999;">Brak rachunk√≥w dla tego okresu</p>';
                        return;
                    }
                    
                    let detailsHtml = '<table class="data-table"><thead><tr><th style="text-transform: uppercase;">LOKAL</th><th style="text-transform: uppercase;">SUMA NETTO</th><th style="text-transform: uppercase;">SUMA BRUTTO</th><th style="text-transform: uppercase;">EMAIL</th><th style="text-transform: uppercase;">WYS≈ÅANO</th><th style="text-transform: uppercase;">AKCJE</th></tr></thead><tbody>';
                    
                    bills.forEach(bill => {
                        const localName = bill.local === 'gora' ? 'G√≥ra' : bill.local === 'dol' ? 'D√≥≈Ç' : 'Gabinet';
                        const emailSentDate = bill.email_sent_date ? new Date(bill.email_sent_date).toLocaleDateString('pl-PL') : '-';
                        // Email jest pobierany z bazy danych lokali przez endpoint API
                        const currentEmail = (bill.local_email || '').trim();
                        const hasEmail = currentEmail !== '';
                        
                        detailsHtml += `<tr>
                            <td style="text-transform: uppercase;"><strong>${localName}</strong></td>
                            <td>${(bill.total_net_sum || 0).toFixed(2)} z≈Ç</td>
                            <td>${(bill.total_gross_sum || 0).toFixed(2)} z≈Ç</td>
                            <td>${hasEmail ? currentEmail : '<span style="color: #999;">-</span>'}</td>
                            <td>${emailSentDate !== '-' ? emailSentDate : '<span style="color: #999;">-</span>'}</td>
                            <td class="actions">
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <div style="width: 40px; display: flex; justify-content: center;">
                                        ${bill.pdf_path ? `<button class="btn btn-success btn-small" onclick="openCombinedBillPDF(${bill.id}, '${bill.pdf_path}')" title="PodglƒÖd PDF">üëÅÔ∏è</button>` : '<span style="color: #999;">-</span>'}
                                    </div>
                                    <div style="width: 40px; display: flex; justify-content: center;">
                                        <button class="btn btn-primary btn-small" onclick="sendSingleCombinedBillEmail(${bill.id})" title="Wy≈õlij na email" ${!hasEmail ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>üìß</button>
                                    </div>
                                </div>
                            </td>
                        </tr>`;
                    });
                    
                    detailsHtml += '</tbody></table>';
                    detailsContent.innerHTML = detailsHtml;
                })
                .catch(error => {
                    detailsContent.innerHTML = '<p style="text-align: center; color: #dc3545;">B≈ÇƒÖd ≈Çadowania szczeg√≥≈Ç√≥w</p>';
                    console.error('B≈ÇƒÖd ≈Çadowania szczeg√≥≈Ç√≥w:', error);
                });
        }
        
        async function sendAllCombinedBillsEmails(periodStart, periodEnd) {
            if (!confirm(`Czy na pewno chcesz wys≈Çaƒá wszystkie rachunki z okresu ${periodStart} - ${periodEnd} na emaile?`)) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/combined/send-emails?period_start=${periodStart}&period_end=${periodEnd}`, {
                    method: 'POST'
                });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Wys≈Çano ${result.sent_count} z ${result.total_count} rachunk√≥w. ${result.errors_count > 0 ? `B≈Çƒôdy: ${result.errors_count}` : ''}`);
                    loadCombinedBills();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd wysy≈Çania emaili', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }
        
        async function sendSingleCombinedBillEmail(billId) {
            try {
                const res = await fetch(`${API_BASE}/api/combined/bills/${billId}/send-email`, {
                    method: 'POST'
                });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Rachunek wys≈Çany na email: ${result.email}`);
                    // Od≈õwie≈º szczeg√≥≈Çy
                    const bill = await fetch(`${API_BASE}/api/combined/bills?id=${billId}`).then(r => r.json());
                    if (bill.length > 0) {
                        const periodStart = bill[0].period_start;
                        const periodEnd = bill[0].period_end;
                        loadCombinedBillsDetails(periodStart, periodEnd);
                    }
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd wysy≈Çania emaila', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }
        
        function editLocalEmailFromCombinedBill(billId, currentEmail) {
            const newEmail = prompt('Wprowad≈∫ nowy email:', currentEmail || '');
            if (newEmail === null) {
                return; // U≈ºytkownik anulowa≈Ç
            }
            
            // Walidacja emaila (podstawowa)
            if (newEmail && !newEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                showAlert('Nieprawid≈Çowy format emaila', 'error');
                return;
            }
            
            // Pobierz local_id z rachunku
            fetch(`${API_BASE}/api/combined/bills?id=${billId}`)
                .then(res => res.json())
                .then(bills => {
                    if (bills.length === 0) {
                        showAlert('Nie znaleziono rachunku', 'error');
                        return;
                    }
                    
                    const localId = bills[0].local_id;
                    if (!localId) {
                        showAlert('Nie znaleziono ID lokalu', 'error');
                        return;
                    }
                    
                    // Wy≈õlij ≈ºƒÖdanie PUT
                    const params = new URLSearchParams();
                    params.append('email', newEmail || '');
                    
                    fetch(`${API_BASE}/api/water/locals/${localId}?${params}`, {
                        method: 'PUT'
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.message) {
                            showAlert('Email zaktualizowany pomy≈õlnie!');
                            // Od≈õwie≈º szczeg√≥≈Çy
                            const periodStart = bills[0].period_start;
                            const periodEnd = bills[0].period_end;
                            loadCombinedBillsDetails(periodStart, periodEnd);
                        } else {
                            showAlert('B≈ÇƒÖd aktualizacji emaila', 'error');
                        }
                    })
                    .catch(error => {
                        showAlert('B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
                    });
                })
                .catch(error => {
                    showAlert('B≈ÇƒÖd pobierania danych rachunku', 'error');
                });
        }
        
        function updateLocalEmailFromCombinedBill(billId, newEmail) {
            // Automatyczna aktualizacja przy zmianie w polu input
            if (!newEmail || newEmail.trim() === '') {
                return; // Nie aktualizuj je≈õli pole jest puste
            }
            
            // Walidacja emaila
            if (!newEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                return; // Nie aktualizuj je≈õli format jest nieprawid≈Çowy
            }
            
            // Pobierz local_id z rachunku
            fetch(`${API_BASE}/api/combined/bills?id=${billId}`)
                .then(res => res.json())
                .then(bills => {
                    if (bills.length === 0) {
                        return;
                    }
                    
                    const localId = bills[0].local_id;
                    if (!localId) {
                        return;
                    }
                    
                    // Wy≈õlij ≈ºƒÖdanie PUT
                    const params = new URLSearchParams();
                    params.append('email', newEmail || '');
                    
                    fetch(`${API_BASE}/api/water/locals/${localId}?${params}`, {
                        method: 'PUT'
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.message) {
                            // Od≈õwie≈º szczeg√≥≈Çy
                            const periodStart = bills[0].period_start;
                            const periodEnd = bills[0].period_end;
                            loadCombinedBillsDetails(periodStart, periodEnd);
                        }
                    })
                    .catch(error => {
                        console.error('B≈ÇƒÖd aktualizacji emaila:', error);
                    });
                })
                .catch(error => {
                    console.error('B≈ÇƒÖd pobierania danych rachunku:', error);
                });
        }
        
        function openCombinedBillPDF(billId, pdfPath) {
            if (pdfPath) {
                window.open(`${API_BASE}/api/combined/bills/download/${billId}`, '_blank');
            } else {
                showAlert('PDF nie zosta≈Ç jeszcze wygenerowany. Kliknij "GENERUJ PDF" dla tego okresu.', 'warning');
            }
        }
        
        async function generateCombinedBills() {
            const periodStart = document.getElementById('combined-bill-period-start').value;
            const periodEnd = document.getElementById('combined-bill-period-end').value;
            
            if (!periodStart || !periodEnd) {
                showAlert('Wybierz okres z dostƒôpnych poni≈ºej', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/combined/generate-bills?period_start=${periodStart}&period_end=${periodEnd}`, {
                    method: 'POST'
                });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Wygenerowano ${result.bills_count || 0} rachunk√≥w ≈ÇƒÖczonych dla okresu ${periodStart} - ${periodEnd}`);
                    loadAvailableCombinedPeriods();
                    loadCombinedBills();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd generowania rachunk√≥w', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }
        
        async function generateCombinedBillsPDF() {
            const periodStart = document.getElementById('combined-bill-period-start').value;
            const periodEnd = document.getElementById('combined-bill-period-end').value;
            
            if (!periodStart || !periodEnd) {
                showAlert('Wybierz okres z dostƒôpnych poni≈ºej', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/combined/generate-pdf?period_start=${periodStart}&period_end=${periodEnd}`, {
                    method: 'POST'
                });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Wygenerowano ${result.pdf_files?.length || 0} plik√≥w PDF dla okresu ${periodStart} - ${periodEnd}`);
                    loadCombinedBills();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd generowania PDF', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }
        
        // ========== KONIEC RACHUNK√ìW ≈ÅƒÑCZONYCH ==========

        function initAuthAndPreferences() {
            // Sprawd≈∫ autentykacjƒô
            if (!checkAuth()) {
                return;
            }

            // Za≈Çaduj zapisany tryb
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const themeIcon = document.getElementById('theme-icon');
                if (themeIcon) themeIcon.textContent = '‚òÄ';
            } else {
                const themeIcon = document.getElementById('theme-icon');
                if (themeIcon) themeIcon.textContent = '‚òæ';
            }

            // Za≈Çaduj jƒôzyk
            currentLanguage = localStorage.getItem('language') || 'pl';
            updateTexts();
        }
    </script>

    <!-- Sidebar ustawie≈Ñ -->
    <div class="settings-sidebar-overlay" id="settingsOverlay" onclick="closePreferences()"></div>
    <div class="settings-sidebar" id="settingsSidebar">
        <div class="settings-sidebar-header">
            <h2 data-i18n="preferences.title">Preferencje</h2>
            <button class="close-sidebar" onclick="closePreferences()">&times;</button>
        </div>
        
        <!-- Menu opcji -->
        <ul class="settings-menu" id="settingsMenu">
            <li class="settings-menu-item" onclick="showSettingsSection('account')">
                <span data-i18n="preferences.menu.account">Konto u≈ºytkownika</span>
            </li>
            <li class="settings-menu-item" onclick="showSettingsSection('backup')">
                <span data-i18n="preferences.menu.backup">Backup bazy danych</span>
            </li>
            <li class="settings-menu-item" onclick="showSettingsSection('aquanet')">
                <span data-i18n="preferences.menu.aquanet">Aquanet</span>
            </li>
        </ul>

        <!-- Sekcja: Konto u≈ºytkownika -->
        <div class="settings-content" id="settingsAccount">
            <button class="settings-back-button" onclick="showSettingsMenu()" data-i18n="preferences.back">Powr√≥t</button>
            <div class="settings-content-header">
                <h3 style="text-transform: uppercase; letter-spacing: 1px;">USER ACCOUNT</h3>
            </div>
            
            <!-- Email (zawsze widoczny) -->
            <div class="form-group">
                <label for="user-email" data-i18n="preferences.user.email">Email</label>
                <input type="email" id="user-email" name="user-email" autocomplete="email" placeholder="twoj@email.com">
                <small style="color: var(--text-secondary); font-size: 0.85em;" data-i18n="preferences.user.email.desc">Email u≈ºywany do wysy≈Çki backup√≥w</small>
            </div>
            <div class="modal-actions">
                <button class="btn-modal btn-modal-primary" onclick="savePreferences()" data-i18n="preferences.save">Zapisz</button>
            </div>
            
            <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">
            
            <!-- CHANGE PASSWORD - zwijane -->
            <div style="margin-top: 20px;">
                <div class="collapsible-header" onclick="togglePasswordSection()" style="cursor: pointer; padding: 15px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='var(--border-color)'">
                    <h4 style="margin: 0; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">CHANGE PASSWORD</h4>
                    <span id="password-toggle-icon" style="font-size: 1.2em; transition: transform 0.3s;">‚ñº</span>
                </div>
                <div id="change-password-section" style="display: none; margin-top: 15px; padding: 20px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                    <div class="form-group">
                        <label for="old-password" data-i18n="preferences.password.old">Stare has≈Ço</label>
                        <input type="password" id="old-password" name="old-password" autocomplete="current-password" placeholder="Wprowad≈∫ stare has≈Ço">
                    </div>
                    <div class="form-group">
                        <label for="new-password" data-i18n="preferences.password.new">Nowe has≈Ço</label>
                        <input type="password" id="new-password" name="new-password" autocomplete="new-password" placeholder="Wprowad≈∫ nowe has≈Ço">
                        <small style="color: var(--text-secondary); font-size: 0.85em;" data-i18n="preferences.password.new.desc">Has≈Ço musi mieƒá co najmniej 6 znak√≥w</small>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password" data-i18n="preferences.password.confirm">Potwierd≈∫ nowe has≈Ço</label>
                        <input type="password" id="confirm-password" name="confirm-password" autocomplete="new-password" placeholder="Potwierd≈∫ nowe has≈Ço">
                    </div>
                    <div class="modal-actions">
                        <button class="btn-modal btn-modal-primary" onclick="changePassword()" data-i18n="preferences.password.change_button">Zmie≈Ñ has≈Ço</button>
                    </div>
                </div>
            </div>
            
            <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">
            
            <!-- FORGOT PASSWORD - zwijane -->
            <div style="margin-top: 20px;">
                <div class="collapsible-header" onclick="toggleForgotPasswordSection()" style="cursor: pointer; padding: 15px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="this.style.borderColor='var(--border-color)'">
                    <h4 style="margin: 0; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">FORGOT PASSWORD</h4>
                    <span id="forgot-password-toggle-icon" style="font-size: 1.2em; transition: transform 0.3s;">‚ñº</span>
                </div>
                <div id="forgot-password-section" style="display: none; margin-top: 15px; padding: 20px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                    <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 15px;" data-i18n="preferences.password.reset_desc">Je≈õli nie pamiƒôtasz has≈Ça, mo≈ºemy wys≈Çaƒá kod resetujƒÖcy na Tw√≥j email.</p>
                    <div class="form-group">
                        <label for="reset-email" data-i18n="preferences.password.reset_email">Email</label>
                        <input type="email" id="reset-email" name="reset-email" autocomplete="email" placeholder="twoj@email.com">
                    </div>
                    <div class="modal-actions">
                        <button class="btn-modal btn-modal-secondary" onclick="requestPasswordReset()" data-i18n="preferences.password.reset_button">Wy≈õlij kod resetujƒÖcy</button>
                    </div>
                    
                    <!-- Formularz resetu has≈Ça z kodem (ukryty domy≈õlnie) -->
                    <div id="reset-password-form" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <div class="form-group">
                            <label for="reset-code" data-i18n="preferences.password.reset_code">Kod resetujƒÖcy</label>
                            <input type="text" id="reset-code" name="reset-code" placeholder="Wprowad≈∫ 6-cyfrowy kod" maxlength="6" pattern="[0-9]{6}">
                            <small style="color: var(--text-secondary); font-size: 0.85em;" data-i18n="preferences.password.reset_code.desc">Sprawd≈∫ swojƒÖ skrzynkƒô email</small>
                        </div>
                        <div class="form-group">
                            <label for="reset-new-password" data-i18n="preferences.password.new">Nowe has≈Ço</label>
                            <input type="password" id="reset-new-password" name="reset-new-password" autocomplete="new-password" placeholder="Wprowad≈∫ nowe has≈Ço">
                        </div>
                        <div class="form-group">
                            <label for="reset-confirm-password" data-i18n="preferences.password.confirm">Potwierd≈∫ nowe has≈Ço</label>
                            <input type="password" id="reset-confirm-password" name="reset-confirm-password" autocomplete="new-password" placeholder="Potwierd≈∫ nowe has≈Ço">
                        </div>
                        <div class="modal-actions">
                            <button class="btn-modal btn-modal-primary" onclick="resetPassword()" data-i18n="preferences.password.reset_submit">Zresetuj has≈Ço</button>
                            <button class="btn-modal btn-modal-secondary" onclick="document.getElementById('reset-password-form').style.display='none'" style="margin-left: 10px;" data-i18n="button.cancel">Anuluj</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sekcja: Backup -->
        <div class="settings-content" id="settingsBackup">
            <button class="settings-back-button" onclick="showSettingsMenu()" data-i18n="preferences.back">Powr√≥t</button>
            <div class="settings-content-header">
                <h3 data-i18n="preferences.backup.title">Backup bazy danych</h3>
            </div>
            <div class="form-group">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn-modal btn-modal-secondary" onclick="createBackup('period')" data-i18n="preferences.backup.create.period">Utw√≥rz backup okresowy</button>
                    <button class="btn-modal btn-modal-secondary" onclick="sendBackupEmail()" data-i18n="preferences.backup.send.email">Wy≈õlij backup na email</button>
                </div>
                <small style="color: var(--text-secondary); font-size: 0.85em; display: block; margin-top: 10px;" data-i18n="preferences.backup.info">Backup jest automatycznie tworzony po rozliczeniu ca≈Çego okresu</small>
            </div>
        </div>

        <!-- Sekcja: Aquanet -->
        <div class="settings-content" id="settingsAquanet">
            <button class="settings-back-button" onclick="showSettingsMenu()" data-i18n="preferences.back">Powr√≥t</button>
            <div class="settings-content-header">
                <h3 data-i18n="preferences.menu.aquanet">Aquanet</h3>
            </div>
            <div class="form-group">
                <label for="aquanet-username" data-i18n="preferences.aquanet.username">Nazwa u≈ºytkownika Aquanet</label>
                <input type="text" id="aquanet-username" name="aquanet-username" autocomplete="username">
            </div>
            <div class="form-group">
                <label for="aquanet-password" data-i18n="preferences.aquanet.password">Has≈Ço Aquanet</label>
                <input type="password" id="aquanet-password" name="aquanet-password" autocomplete="current-password">
            </div>
            <div class="modal-actions">
                <button class="btn-modal btn-modal-primary" onclick="savePreferences()" data-i18n="preferences.save">Zapisz</button>
            </div>
        </div>
    </div>
</body>
</html>
