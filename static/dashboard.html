<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíß Water Billing System - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #666;
            font-size: 0.9em;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Specjalny layout dla formularza weryfikacji faktury gazu - 4 kolumny */
        #form-gas-invoice-verify {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        /* Puste miejsca w formularzu */
        .form-group.empty {
            visibility: hidden;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .alert.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .period-selector input {
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 1em;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üíß Water Billing System</h1>
            <p>System rozliczania rachunk√≥w za wodƒô i ≈õcieki</p>
            <div style="margin-top: 15px;">
                <a href="/docs" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 500;">üìö Dokumentacja API (Swagger UI)</a>
            </div>
        </header>

        <div id="alert" class="alert"></div>

        <!-- G≈Ç√≥wne sekcje -->
        <div class="section">
            <!-- Zak≈Çadki wyboru medium -->
            <div class="tabs" style="margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                <button class="tab active" onclick="showMedium('water')">üíß Woda</button>
                <button class="tab" onclick="showMedium('gas')">üî• Gaz</button>
            </div>

            <!-- Sekcje dla Wody -->
            <div id="medium-water" class="medium-content">
                <!-- Statystyki wody -->
                <div class="stats-grid" id="water-stats" style="margin-bottom: 25px;">
                    <div class="stat-card">
                        <h3 id="water-stat-locals">-</h3>
                        <p>Lokale</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="water-stat-readings">-</h3>
                        <p>Odczyty</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="water-stat-invoices">-</h3>
                        <p>Faktury</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="water-stat-bills">-</h3>
                        <p>Rachunki</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="water-stat-total">-</h3>
                        <p>Suma brutto</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="water-stat-latest-period">-</h3>
                        <p>Najnowszy okres</p>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="showTab('locals')">üè† Lokale</button>
                    <button class="tab" onclick="showTab('readings')">üìä Odczyty</button>
                    <button class="tab" onclick="showTab('invoices')">üìÑ Faktury</button>
                    <button class="tab" onclick="showTab('bills')">üí∞ Rachunki</button>
                </div>

            <!-- Sekcja Lokale -->
            <div id="tab-locals" class="tab-content active">
                <h2>Lokale</h2>
                <form id="form-local" class="form-grid">
                    <div class="form-group">
                        <label>Nazwa licznika</label>
                        <select name="water_meter_name" required>
                            <option value="water_meter_5">water_meter_5</option>
                            <option value="water_meter_5b">water_meter_5b</option>
                            <option value="water_meter_5a">water_meter_5a</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Najemca</label>
                        <input type="text" name="tenant" required>
                    </div>
                    <div class="form-group">
                        <label>Lokal</label>
                        <input type="text" name="local" required>
                    </div>
                </form>
                <button class="btn btn-primary" onclick="addLocal()">Dodaj lokal</button>
                
                <div id="locals-list" class="loading">≈Åadowanie...</div>
            </div>

            <!-- Sekcja Odczyty -->
            <div id="tab-readings" class="tab-content">
                <h2>Odczyty licznik√≥w</h2>
                <form id="form-reading" class="form-grid">
                    <div class="form-group">
                        <label>Okres (YYYY-MM)</label>
                        <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                    </div>
                    <div class="form-group">
                        <label>Licznik g≈Ç√≥wny</label>
                        <input type="number" step="0.01" name="water_meter_main" required>
                    </div>
                    <div class="form-group">
                        <label>Licznik 5</label>
                        <input type="number" step="0.01" name="water_meter_5" required>
                    </div>
                    <div class="form-group">
                        <label>Licznik 5b</label>
                        <input type="number" step="0.01" name="water_meter_5b" required>
                    </div>
                </form>
                <button class="btn btn-primary" onclick="addReading()">Dodaj odczyt</button>
                
                <div id="readings-list" class="loading">≈Åadowanie...</div>
            </div>

            <!-- Sekcja Faktury -->
            <div id="tab-invoices" class="tab-content">
                <h2>Faktury</h2>
                
                <div style="background: #f0f9ff; border-left: 4px solid #667eea; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                    <h3 style="margin-top: 0; color: #667eea;">üí° Wa≈ºne: Wiele faktur dla jednego okresu</h3>
                    <p style="margin-bottom: 10px; color: #333;">
                        <strong>Gdy okres rozliczeniowy (2 miesiƒÖce) ma zmianƒô stawki w po≈Çowie:</strong>
                    </p>
                    <ul style="margin-left: 20px; color: #555;">
                        <li><strong>Okres (YYYY-MM)</strong> - u≈ºywaj tego samego dla obu faktur (np. "2025-02")</li>
                        <li><strong>Data poczƒÖtku/ko≈Ñca</strong> - wpisz faktyczne daty ka≈ºdej faktury</li>
                        <li>System automatycznie obliczy <strong>≈õredniƒÖ wa≈ºonƒÖ koszt√≥w</strong> z obu faktur</li>
                        <li>Abonamenty zostanƒÖ <strong>zsumowane</strong> z wszystkich faktur</li>
                    </ul>
                    <p style="margin-top: 10px; margin-bottom: 0; color: #666; font-size: 0.9em;">
                        <strong>Przyk≈Çad:</strong> Okres "2025-02" ma dwie faktury:<br>
                        Faktura 1: 01.01-31.01, koszt 10 z≈Ç/m¬≥, zu≈ºycie 20 m¬≥<br>
                        Faktura 2: 01.02-28.02, koszt 12 z≈Ç/m¬≥, zu≈ºycie 25 m¬≥<br>
                        ‚Üí System u≈ºyje ≈õredniej wa≈ºonej: (10√ó20 + 12√ó25) / 45 = 11.11 z≈Ç/m¬≥
                    </p>
                </div>
                
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                    <h3 style="margin-top: 0; color: #856404;">‚ö†Ô∏è Weryfikacja faktur</h3>
                    <p style="margin-bottom: 10px; color: #333;">
                        Po wczytaniu faktury PDF, dane zostanƒÖ wy≈õwietlone poni≈ºej do weryfikacji i ewentualnej zmiany przed zapisem do bazy danych.
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3>Wczytaj fakturƒô PDF</h3>
                    <input type="file" id="invoice-file" accept=".pdf" style="margin-bottom: 10px;">
                    <button class="btn btn-primary" onclick="uploadInvoice()">Wczytaj PDF</button>
                </div>

                <!-- Formularz weryfikacji faktury (ukryty do momentu parsowania) -->
                <div id="invoice-verification" style="display: none; background: #f0f9ff; border: 2px solid #667eea; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                    <h3>Weryfikuj dane faktury przed zapisem</h3>
                    <form id="form-invoice-verify" class="form-grid">
                        <div class="form-group">
                            <label>Okres (YYYY-MM)</label>
                            <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                        </div>
                        <div class="form-group">
                            <label>Zu≈ºycie (m¬≥)</label>
                            <input type="number" step="0.01" name="usage" required>
                        </div>
                        <div class="form-group">
                            <label>Koszt wody za m¬≥</label>
                            <input type="number" step="0.01" name="water_cost_m3" required>
                        </div>
                        <div class="form-group">
                            <label>Koszt ≈õciek√≥w za m¬≥</label>
                            <input type="number" step="0.01" name="sewage_cost_m3" required>
                        </div>
                        <div class="form-group">
                            <label>Liczba miesiƒôcy abonamentu</label>
                            <input type="number" name="nr_of_subscription" required>
                        </div>
                        <div class="form-group">
                            <label>Abonament woda (za miesiƒÖc)</label>
                            <input type="number" step="0.01" name="water_subscr_cost" required>
                        </div>
                        <div class="form-group">
                            <label>Abonament ≈õcieki (za miesiƒÖc)</label>
                            <input type="number" step="0.01" name="sewage_subscr_cost" required>
                        </div>
                        <div class="form-group">
                            <label>VAT (np. 0.08 dla 8%)</label>
                            <input type="number" step="0.01" name="vat" required>
                        </div>
                        <div class="form-group">
                            <label>Data poczƒÖtku okresu</label>
                            <input type="date" name="period_start" required>
                        </div>
                        <div class="form-group">
                            <label>Data ko≈Ñca okresu</label>
                            <input type="date" name="period_stop" required>
                        </div>
                        <div class="form-group">
                            <label>Numer faktury</label>
                            <input type="text" name="invoice_number" required>
                        </div>
                        <div class="form-group">
                            <label>Suma brutto</label>
                            <input type="number" step="0.01" name="gross_sum" required>
                        </div>
                    </form>
                    <button class="btn btn-success" onclick="verifyAndSaveInvoice()">Zatwierd≈∫ i zapisz</button>
                    <button class="btn btn-secondary" onclick="cancelInvoiceVerification()">Anuluj</button>
                </div>
                
                <h3>Lub dodaj rƒôcznie</h3>
                <form id="form-invoice" class="form-grid">
                    <div class="form-group">
                        <label>Okres (YYYY-MM)</label>
                        <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                    </div>
                    <div class="form-group">
                        <label>Zu≈ºycie (m¬≥)</label>
                        <input type="number" step="0.01" name="usage" required>
                    </div>
                    <div class="form-group">
                        <label>Koszt wody za m¬≥</label>
                        <input type="number" step="0.01" name="water_cost_m3" required>
                    </div>
                    <div class="form-group">
                        <label>Koszt ≈õciek√≥w za m¬≥</label>
                        <input type="number" step="0.01" name="sewage_cost_m3" required>
                    </div>
                    <div class="form-group">
                        <label>Liczba miesiƒôcy abonamentu</label>
                        <input type="number" name="nr_of_subscription" required>
                    </div>
                    <div class="form-group">
                        <label>Abonament woda (za miesiƒÖc)</label>
                        <input type="number" step="0.01" name="water_subscr_cost" required>
                    </div>
                    <div class="form-group">
                        <label>Abonament ≈õcieki (za miesiƒÖc)</label>
                        <input type="number" step="0.01" name="sewage_subscr_cost" required>
                    </div>
                    <div class="form-group">
                        <label>VAT (np. 0.08 dla 8%)</label>
                        <input type="number" step="0.01" name="vat" required>
                    </div>
                    <div class="form-group">
                        <label>Data poczƒÖtku okresu</label>
                        <input type="date" name="period_start" required>
                    </div>
                    <div class="form-group">
                        <label>Data ko≈Ñca okresu</label>
                        <input type="date" name="period_stop" required>
                    </div>
                    <div class="form-group">
                        <label>Numer faktury</label>
                        <input type="text" name="invoice_number" required>
                    </div>
                    <div class="form-group">
                        <label>Suma brutto</label>
                        <input type="number" step="0.01" name="gross_sum" required>
                    </div>
                </form>
                <button class="btn btn-primary" onclick="addInvoice()">Dodaj fakturƒô</button>
                
                <div id="invoices-list" class="loading">≈Åadowanie...</div>
            </div>

            <!-- Sekcja Rachunki -->
            <div id="tab-bills" class="tab-content">
                <h2>Rachunki</h2>
                <div class="period-selector">
                    <label>Okres (YYYY-MM):</label>
                    <input type="text" id="bill-period" placeholder="2025-02" pattern="\d{4}-\d{2}" list="available-periods">
                    <datalist id="available-periods"></datalist>
                    <button class="btn btn-success" onclick="generateBills()">Generuj rachunki</button>
                    <button class="btn btn-secondary" onclick="regenerateBills()">Regeneruj rachunki</button>
                </div>
                <p style="color: #666; margin-bottom: 20px; font-size: 0.9em;">
                    üí° Podaj okres w formacie YYYY-MM. System automatycznie wygeneruje rachunki dla wszystkich lokali na podstawie faktur i odczyt√≥w.
                </p>
                
                <div id="bills-list" class="loading">≈Åadowanie...</div>
            </div>
            </div>  <!-- koniec medium-water -->

            <!-- Sekcje dla Gazu -->
            <div id="medium-gas" class="medium-content" style="display: none;">
                <!-- Statystyki gazu -->
                <div class="stats-grid" id="gas-stats" style="margin-bottom: 25px;">
                    <div class="stat-card">
                        <h3 id="gas-stat-invoices">-</h3>
                        <p>Faktury gazu</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="gas-stat-bills">-</h3>
                        <p>Rachunki gazu</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="gas-stat-total">-</h3>
                        <p>Suma brutto</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="gas-stat-latest-period">-</h3>
                        <p>Najnowszy okres</p>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="showGasTab('gas-tab-invoices')">üìÑ Faktury gazu</button>
                    <button class="tab" onclick="showGasTab('gas-tab-bills')">üí∞ Rachunki gazu</button>
                </div>

                <!-- Sekcja Faktury gazu -->
                <div id="gas-tab-invoices" class="tab-content active">
                    <h2>Faktury gazu (PGNiG)</h2>
                    
                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #856404;">‚ö†Ô∏è Weryfikacja faktur</h3>
                        <p style="margin-bottom: 10px; color: #333;">
                            Po wczytaniu faktury PDF, dane zostanƒÖ wy≈õwietlone poni≈ºej do weryfikacji i ewentualnej zmiany przed zapisem do bazy danych.
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3>Wczytaj fakturƒô PDF</h3>
                        <input type="file" id="gas-invoice-file" accept=".pdf" style="margin-bottom: 10px;">
                        <button class="btn btn-primary" onclick="uploadGasInvoice()">Wczytaj PDF</button>
                    </div>

                    <!-- Formularz weryfikacji faktury (ukryty do momentu parsowania) -->
                    <div id="gas-invoice-verification" style="display: none !important; background: #f0f9ff; border: 2px solid #667eea; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                        <h3>Weryfikuj dane faktury przed zapisem</h3>
                        <form id="form-gas-invoice-verify" class="form-grid">
                            <!-- RzƒÖd 1: Okres, Numer Faktury, Data poczƒÖtku okresu, Data ko≈Ñca okresu -->
                            <div class="form-group">
                                <label>Okres (YYYY-MM)</label>
                                <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                            </div>
                            <div class="form-group">
                                <label>Numer faktury</label>
                                <input type="text" name="invoice_number" required>
                            </div>
                            <div class="form-group">
                                <label>Data poczƒÖtku okresu</label>
                                <input type="date" name="period_start" required>
                            </div>
                            <div class="form-group">
                                <label>Data ko≈Ñca okresu</label>
                                <input type="date" name="period_stop" required>
                            </div>
                            
                            <!-- RzƒÖd 2: puste, Paliwo zu≈ºycie (m¬≥), Odczyt poprzedni, Odczyt obecny -->
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label>Paliwo zu≈ºycie (m¬≥)</label>
                                <input type="number" step="0.01" name="fuel_usage_m3" required>
                            </div>
                            <div class="form-group">
                                <label>Odczyt poprzedni (m¬≥)</label>
                                <input type="number" step="0.01" name="previous_reading" required>
                            </div>
                            <div class="form-group">
                                <label>Odczyt obecny (m¬≥)</label>
                                <input type="number" step="0.01" name="current_reading" required>
                            </div>
                            
                            <!-- RzƒÖd 3: Paliwo - Wsp√≥≈Çczynnik konwersji, Paliwo - Zu≈ºycie (kWh), Paliwo - Cena netto za kWh, Paliwo - Warto≈õƒá netto -->
                            <div class="form-group">
                                <label>Paliwo - Wsp√≥≈Çczynnik konwersji (kWh/m¬≥)</label>
                                <input type="number" step="0.0001" name="fuel_conversion_factor" required>
                            </div>
                            <div class="form-group">
                                <label>Paliwo - Zu≈ºycie (kWh)</label>
                                <input type="number" step="0.01" name="fuel_usage_kwh" required>
                            </div>
                            <div class="form-group">
                                <label>Paliwo - Cena netto za kWh</label>
                                <input type="number" step="0.00001" name="fuel_price_net" required>
                            </div>
                            <div class="form-group">
                                <label>Paliwo - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="fuel_value_net" required>
                            </div>
                            
                            <!-- RzƒÖd 4: puste, Abonament - Ilo≈õƒá miesiƒôcy, Abonament - Cena netto za miesiƒÖc, Abonament - Warto≈õƒá netto -->
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label>Abonament - Ilo≈õƒá miesiƒôcy</label>
                                <input type="number" name="subscription_quantity" required>
                            </div>
                            <div class="form-group">
                                <label>Abonament - Cena netto za miesiƒÖc</label>
                                <input type="number" step="0.01" name="subscription_price_net" required>
                            </div>
                            <div class="form-group">
                                <label>Abonament - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="subscription_value_net" required>
                            </div>
                            
                            <!-- RzƒÖd 5: puste, Dystrybucja sta≈Ça - Ilo≈õƒá miesiƒôcy, Dystrybucja sta≈Ça - Cena netto za miesiƒÖc, Dystrybucja sta≈Ça - Warto≈õƒá netto -->
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label>Dystrybucja sta≈Ça - Ilo≈õƒá miesiƒôcy</label>
                                <input type="number" name="distribution_fixed_quantity" required>
                            </div>
                            <div class="form-group">
                                <label>Dystrybucja sta≈Ça - Cena netto za miesiƒÖc</label>
                                <input type="number" step="0.01" name="distribution_fixed_price_net" required>
                            </div>
                            <div class="form-group">
                                <label>Dystrybucja sta≈Ça - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="distribution_fixed_value_net" required>
                            </div>
                            
                            <!-- RzƒÖd 6: puste, Dystrybucja zmienna - Zu≈ºycie (m¬≥), Dystrybucja zmienna - Wsp. konw., Dystrybucja zmienna - Zu≈ºycie (kWh) -->
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label>Dystrybucja zmienna - Zu≈ºycie (m¬≥)</label>
                                <input type="number" step="0.01" name="distribution_variable_usage_m3" required>
                            </div>
                            <div class="form-group">
                                <label>Dystrybucja zmienna - Wsp. konw.</label>
                                <input type="number" step="0.0001" name="distribution_variable_conversion_factor" required>
                            </div>
                            <div class="form-group">
                                <label>Dystrybucja zmienna - Zu≈ºycie (kWh)</label>
                                <input type="number" step="0.01" name="distribution_variable_usage_kwh" required>
                            </div>
                            
                            <!-- RzƒÖd 7: puste, puste, Dystrybucja zmienna - Cena netto za kWh, Dystrybucja zmienna - Warto≈õƒá netto -->
                            <div class="form-group empty"></div>
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label>Dystrybucja zmienna - Cena netto za kWh</label>
                                <input type="number" step="0.00001" name="distribution_variable_price_net" required>
                            </div>
                            <div class="form-group">
                                <label>Dystrybucja zmienna - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="distribution_variable_value_net" required>
                            </div>
                            
                            <!-- RzƒÖd 8: puste, Dystrybucja zmienna 2 - Zu≈ºycie (m¬≥), Dystrybucja zmienna 2 - Wsp. konw., Dystrybucja zmienna 2 - Zu≈ºycie (kWh) -->
                            <div class="form-group empty" id="dist-var-2-empty-1"></div>
                            <div class="form-group" id="distribution-variable-2-group" style="display: none;">
                                <label>Dystrybucja zmienna 2 - Zu≈ºycie (m¬≥)</label>
                                <input type="number" step="0.01" name="distribution_variable_2_usage_m3">
                            </div>
                            <div class="form-group" id="distribution-variable-2-conv-group" style="display: none;">
                                <label>Dystrybucja zmienna 2 - Wsp. konw.</label>
                                <input type="number" step="0.0001" name="distribution_variable_2_conversion_factor">
                            </div>
                            <div class="form-group" id="distribution-variable-2-kwh-group" style="display: none;">
                                <label>Dystrybucja zmienna 2 - Zu≈ºycie (kWh)</label>
                                <input type="number" step="0.01" name="distribution_variable_2_usage_kwh">
                            </div>
                            
                            <!-- RzƒÖd 9: puste, puste, Dystr. zm. 2 - cena netto za kWh, Dystrybucja zmienna 2 - Warto≈õƒá netto -->
                            <div class="form-group empty"></div>
                            <div class="form-group empty"></div>
                            <div class="form-group" id="distribution-variable-2-price-group" style="display: none;">
                                <label>Dystr. zm. 2 - cena netto za kWh</label>
                                <input type="number" step="0.00001" name="distribution_variable_2_price_net">
                            </div>
                            <div class="form-group" id="distribution-variable-2-value-group" style="display: none;">
                                <label>Dystrybucja zmienna 2 - Warto≈õƒá netto</label>
                                <input type="number" step="0.01" name="distribution_variable_2_value_net">
                            </div>
                            
                            <!-- RzƒÖd 11: Warto≈õƒá netto og√≥≈Çem, VAT, Kwota VAT, Warto≈õƒá brutto ca≈Ço≈õƒá -->
                            <div class="form-group">
                                <label>Warto≈õƒá netto og√≥≈Çem</label>
                                <input type="number" step="0.01" name="total_net_sum" required>
                            </div>
                            <div class="form-group">
                                <label>VAT (np. 0.23 dla 23%)</label>
                                <input type="number" step="0.01" name="vat_rate" value="0.23" required>
                            </div>
                            <div class="form-group">
                                <label>Kwota VAT og√≥≈Çem</label>
                                <input type="number" step="0.01" name="vat_amount" required>
                            </div>
                            <div class="form-group">
                                <label>Warto≈õƒá brutto ca≈Ço≈õƒá</label>
                                <input type="number" step="0.01" name="total_gross_sum" required>
                            </div>
                            
                            <!-- RzƒÖd 12: Odsetki za nieterminowe wp≈Çaty, Termin p≈Çatno≈õci, puste, Do zap≈Çaty -->
                            <div class="form-group">
                                <label>Odsetki za nieterminowe wp≈Çaty</label>
                                <input type="number" step="0.01" name="late_payment_interest" value="0" required>
                            </div>
                            <div class="form-group">
                                <label>Termin p≈Çatno≈õci</label>
                                <input type="date" name="payment_due_date" required>
                            </div>
                            <div class="form-group empty"></div>
                            <div class="form-group">
                                <label>Do zap≈Çaty</label>
                                <input type="number" step="0.01" name="amount_to_pay" required>
                            </div>
                        </form>
                        <button class="btn btn-success" onclick="verifyAndSaveGasInvoice()">Zatwierd≈∫ i zapisz</button>
                        <button class="btn btn-secondary" onclick="cancelGasInvoiceVerification()">Anuluj</button>
                    </div>

                    <!-- Przycisk do pokazania formularza rƒôcznego -->
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="toggleManualGasInvoiceForm()" id="btn-show-manual-gas-invoice">
                            Lub dodaj rƒôcznie
                        </button>
                    </div>

                    <!-- Formularz rƒôcznego dodawania faktury (ukryty domy≈õlnie) -->
                    <div id="gas-invoice-manual-form" style="display: none;">
                        <h3>Dodaj fakturƒô rƒôcznie</h3>
                        <form id="form-gas-invoice" class="form-grid">
                        <div class="form-group">
                            <label>Okres (YYYY-MM)</label>
                            <input type="text" name="data" placeholder="2025-02" pattern="\d{4}-\d{2}" required>
                        </div>
                        <div class="form-group">
                            <label>Data poczƒÖtku okresu</label>
                            <input type="date" name="period_start" required>
                        </div>
                        <div class="form-group">
                            <label>Data ko≈Ñca okresu</label>
                            <input type="date" name="period_stop" required>
                        </div>
                        <div class="form-group">
                            <label>Odczyt poprzedni (m¬≥)</label>
                            <input type="number" step="0.01" name="previous_reading" required>
                        </div>
                        <div class="form-group">
                            <label>Odczyt obecny (m¬≥)</label>
                            <input type="number" step="0.01" name="current_reading" required>
                        </div>
                        <div class="form-group">
                            <label>Numer faktury</label>
                            <input type="text" name="invoice_number" required>
                        </div>
                        <div class="form-group">
                            <label>Paliwo - Warto≈õƒá brutto</label>
                            <input type="number" step="0.01" name="fuel_value_gross" required>
                        </div>
                        <div class="form-group">
                            <label>Abonament - Warto≈õƒá brutto</label>
                            <input type="number" step="0.01" name="subscription_value_gross" required>
                        </div>
                        <div class="form-group">
                            <label>Dystrybucja sta≈Ça - Warto≈õƒá brutto</label>
                            <input type="number" step="0.01" name="distribution_fixed_value_gross" required>
                        </div>
                        <div class="form-group">
                            <label>Dystrybucja zmienna - Warto≈õƒá brutto</label>
                            <input type="number" step="0.01" name="distribution_variable_value_gross" required>
                        </div>
                        <div class="form-group">
                            <label>Suma brutto ca≈Çej faktury</label>
                            <input type="number" step="0.01" name="total_gross_sum" required>
                        </div>
                        </form>
                        <button class="btn btn-primary" onclick="addGasInvoice()">Dodaj fakturƒô</button>
                        <button class="btn btn-secondary" onclick="toggleManualGasInvoiceForm()" style="margin-left: 10px;">Ukryj formularz</button>
                    </div>
                    
                    <div id="gas-invoices-list" class="loading">≈Åadowanie...</div>
                </div>

                <!-- Sekcja Rachunki gazu -->
                <div id="gas-tab-bills" class="tab-content">
                    <h2>Rachunki gazu</h2>
                    <div class="period-selector">
                        <label>Okres (YYYY-MM):</label>
                        <input type="text" id="gas-bill-period" placeholder="2025-02" pattern="\d{4}-\d{2}" list="available-gas-periods">
                        <datalist id="available-gas-periods"></datalist>
                        <button class="btn btn-success" onclick="generateGasBills()">Generuj rachunki</button>
                    </div>
                    <p style="color: #666; margin-bottom: 20px; font-size: 0.9em;">
                        üí° Podaj okres w formacie YYYY-MM. System automatycznie wygeneruje rachunki dla wszystkich lokali na podstawie faktur gazu (58% gora, 25% dol, 17% gabinet).
                    </p>
                    
                    <div id="gas-bills-list" class="loading">≈Åadowanie...</div>
                </div>
            </div>  <!-- koniec medium-gas -->
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Od≈õwie≈º dane dla aktywnej zak≈Çadki
            if (tabName === 'locals') loadLocals();
            if (tabName === 'readings') loadReadings();
            if (tabName === 'invoices') loadInvoices();
            if (tabName === 'bills') loadBills();
        }

        // Alerty
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type} show`;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        // Statystyki wody
        async function loadWaterStats() {
            try {
                const res = await fetch(`${API_BASE}/api/stats`);
                const stats = await res.json();
                document.getElementById('water-stat-locals').textContent = stats.locals_count || 0;
                document.getElementById('water-stat-readings').textContent = stats.readings_count || 0;
                document.getElementById('water-stat-invoices').textContent = stats.invoices_count || 0;
                document.getElementById('water-stat-bills').textContent = stats.bills_count || 0;
                document.getElementById('water-stat-total').textContent = (stats.total_gross_sum || 0).toFixed(2) + ' z≈Ç';
                document.getElementById('water-stat-latest-period').textContent = stats.latest_period || '-';
                
                // Aktualizuj listƒô dostƒôpnych okres√≥w
                const datalist = document.getElementById('available-periods');
                datalist.innerHTML = '';
                if (stats.available_periods && stats.available_periods.length > 0) {
                    stats.available_periods.forEach(period => {
                        const option = document.createElement('option');
                        option.value = period;
                        datalist.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania statystyk wody:', error);
            }
        }

        // Lokale
        async function loadLocals() {
            try {
                const res = await fetch(`${API_BASE}/locals/`);
                const locals = await res.json();
                const listEl = document.getElementById('locals-list');
                
                if (locals.length === 0) {
                    listEl.innerHTML = '<p>Brak lokali</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Licznik</th><th>Najemca</th><th>Lokal</th><th>Akcje</th></tr></thead><tbody>';
                locals.forEach(l => {
                    html += `<tr>
                        <td>${l.water_meter_name}</td>
                        <td>${l.tenant}</td>
                        <td>${l.local}</td>
                        <td class="actions">
                            <button class="btn btn-danger btn-small" onclick="deleteLocal(${l.id})" title="Usu≈Ñ lokal">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                document.getElementById('locals-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania lokali</p>';
            }
        }

        async function addLocal() {
            const form = document.getElementById('form-local');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                params.append(key, value);
            }

            try {
                const res = await fetch(`${API_BASE}/locals/?${params}`, { method: 'POST' });
                if (res.ok) {
                    showAlert('Lokal dodany pomy≈õlnie!');
                    form.reset();
                    loadLocals();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd dodawania lokalu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Odczyty
        async function loadReadings() {
            try {
                const res = await fetch(`${API_BASE}/readings/`);
                const readings = await res.json();
                const listEl = document.getElementById('readings-list');
                
                if (readings.length === 0) {
                    listEl.innerHTML = '<p>Brak odczyt√≥w</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Okres</th><th>Licznik g≈Ç√≥wny</th><th>Licznik 5 (gora)</th><th>Licznik 5b (dol)</th><th>Akcje</th></tr></thead><tbody>';
                readings.forEach(r => {
                    html += `<tr>
                        <td>${r.data}</td>
                        <td>${r.water_meter_main}</td>
                        <td>${r.water_meter_5}</td>
                        <td>${r.water_meter_5b}</td>
                        <td class="actions">
                            <button class="btn btn-danger btn-small" onclick="deleteReading('${r.data}')" title="Usu≈Ñ odczyt i rachunki dla tego okresu">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                document.getElementById('readings-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania odczyt√≥w</p>';
            }
        }

        async function addReading() {
            const form = document.getElementById('form-reading');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                params.append(key, value);
            }

            try {
                const res = await fetch(`${API_BASE}/readings/?${params}`, { method: 'POST' });
                if (res.ok) {
                    showAlert('Odczyt dodany pomy≈õlnie!');
                    form.reset();
                    loadReadings();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd dodawania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Faktury
        async function loadInvoices() {
            try {
                const res = await fetch(`${API_BASE}/invoices/`);
                const invoices = await res.json();
                const listEl = document.getElementById('invoices-list');
                
                if (invoices.length === 0) {
                    listEl.innerHTML = '<p>Brak faktur</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Okres</th><th>Numer faktury</th><th>Zu≈ºycie (m¬≥)</th><th>Koszt wody/m¬≥</th><th>Koszt ≈õciek√≥w/m¬≥</th><th>Suma brutto</th><th>Akcje</th></tr></thead><tbody>';
                invoices.forEach(i => {
                    html += `<tr>
                        <td>${i.data}</td>
                        <td>${i.invoice_number}</td>
                        <td>${i.usage}</td>
                        <td>${i.water_cost_m3}</td>
                        <td>${i.sewage_cost_m3}</td>
                        <td>${i.gross_sum.toFixed(2)} z≈Ç</td>
                        <td class="actions">
                            <button class="btn btn-danger btn-small" onclick="deleteInvoice(${i.id})" title="Usu≈Ñ fakturƒô i rachunki dla tego okresu (je≈õli to ostatnia faktura)">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                document.getElementById('invoices-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania faktur</p>';
            }
        }

        async function uploadInvoice() {
            const fileInput = document.getElementById('invoice-file');
            if (!fileInput.files[0]) {
                showAlert('Wybierz plik PDF', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch(`${API_BASE}/invoices/parse`, {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    const result = await res.json();
                    // Wype≈Çnij formularz weryfikacji danymi
                    const verifyForm = document.getElementById('form-invoice-verify');
                    Object.keys(result).forEach(key => {
                        const input = verifyForm.querySelector(`[name="${key}"]`);
                        if (input && result[key] !== null && result[key] !== undefined) {
                            // Dla p√≥l typu date, upewnij siƒô ≈ºe format jest poprawny
                            if (input.type === 'date' && typeof result[key] === 'string') {
                                input.value = result[key];
                            } else if (input.type !== 'date') {
                                input.value = result[key];
                            }
                        }
                    });
                    // Poka≈º formularz weryfikacji
                    document.getElementById('invoice-verification').style.display = 'block';
                    showAlert('Faktura sparsowana - zweryfikuj dane przed zapisem');
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd parsowania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function verifyAndSaveInvoice() {
            const form = document.getElementById('form-invoice-verify');
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                // Konwertuj warto≈õci numeryczne
                if (['usage', 'water_cost_m3', 'sewage_cost_m3', 'water_subscr_cost', 
                     'sewage_subscr_cost', 'vat', 'gross_sum'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else if (key === 'nr_of_subscription') {
                    data[key] = parseInt(value) || 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/invoices/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Faktura zapisana pomy≈õlnie!');
                    form.reset();
                    document.getElementById('invoice-verification').style.display = 'none';
                    document.getElementById('invoice-file').value = '';
                    loadInvoices();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd zapisywania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function cancelInvoiceVerification() {
            document.getElementById('invoice-verification').style.display = 'none';
            document.getElementById('form-invoice-verify').reset();
            document.getElementById('invoice-file').value = '';
        }

        async function addInvoice() {
            const form = document.getElementById('form-invoice');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                params.append(key, value);
            }

            try {
                const res = await fetch(`${API_BASE}/invoices/?${params}`, { method: 'POST' });
                if (res.ok) {
                    showAlert('Faktura dodana pomy≈õlnie!');
                    form.reset();
                    loadInvoices();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd dodawania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Rachunki
        async function loadBills() {
            try {
                const res = await fetch(`${API_BASE}/bills/`);
                const bills = await res.json();
                const listEl = document.getElementById('bills-list');
                
                if (bills.length === 0) {
                    listEl.innerHTML = '<p>Brak rachunk√≥w. Wygeneruj rachunki dla okresu z fakturƒÖ i odczytami.</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Okres</th><th>Lokal</th><th>Zu≈ºycie (m¬≥)</th><th>Suma brutto</th><th>Akcje</th></tr></thead><tbody>';
                bills.forEach(b => {
                    html += `<tr>
                        <td>${b.data}</td>
                        <td>${b.local}</td>
                        <td>${b.usage_m3}</td>
                        <td>${b.gross_sum.toFixed(2)} z≈Ç</td>
                        <td class="actions">
                            <a href="${API_BASE}/bills/download/${b.id}" target="_blank" class="btn btn-success btn-small">üì• PDF</a>
                            <button class="btn btn-danger btn-small" onclick="deleteBill(${b.id})" title="Usu≈Ñ rachunek">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                document.getElementById('bills-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania rachunk√≥w</p>';
            }
        }

        async function generateBills() {
            const period = document.getElementById('bill-period').value.trim();
            if (!period || !period.match(/^\d{4}-\d{2}$/)) {
                showAlert('Podaj prawid≈Çowy okres (YYYY-MM)', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/bills/generate/${period}`, { method: 'POST' });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Wygenerowano ${result.bills_count} rachunk√≥w dla okresu ${period}`);
                    loadBills();
                    loadWaterStats();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd generowania rachunk√≥w', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function regenerateBills() {
            const period = document.getElementById('bill-period').value.trim();
            if (!period || !period.match(/^\d{4}-\d{2}$/)) {
                showAlert('Podaj prawid≈Çowy okres (YYYY-MM)', 'error');
                return;
            }

            if (!confirm(`Czy na pewno chcesz zregenerowaƒá rachunki dla okresu ${period}?`)) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/bills/regenerate/${period}`, { method: 'POST' });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Zregenerowano ${result.bills_count} rachunk√≥w dla okresu ${period}`);
                    loadBills();
                    loadWaterStats();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd regenerowania rachunk√≥w', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function deleteBill(billId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten rachunek?')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/bills/${billId}`, { method: 'DELETE' });
                if (res.ok) {
                    showAlert('Rachunek usuniƒôty');
                    loadBills();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania rachunku', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function deleteLocal(localId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten lokal? ZostanƒÖ r√≥wnie≈º usuniƒôte wszystkie powiƒÖzane rachunki.')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/locals/${localId}`, { method: 'DELETE' });
                if (res.ok) {
                    const result = await res.json();
                    showAlert(`Lokal usuniƒôty. Usuniƒôto r√≥wnie≈º ${result.deleted_bills_count} powiƒÖzanych rachunk√≥w.`);
                    loadLocals();
                    loadBills();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania lokalu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function deleteReading(period) {
            if (!confirm(`Czy na pewno chcesz usunƒÖƒá odczyt dla okresu ${period}? ZostanƒÖ r√≥wnie≈º usuniƒôte wszystkie rachunki dla tego okresu.`)) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/readings/${period}`, { method: 'DELETE' });
                if (res.ok) {
                    const result = await res.json();
                    showAlert(`Odczyt dla okresu ${period} usuniƒôty. Usuniƒôto r√≥wnie≈º ${result.deleted_bills_count} rachunk√≥w.`);
                    loadReadings();
                    loadBills();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania odczytu', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function deleteInvoice(invoiceId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô fakturƒô? Je≈õli to ostatnia faktura dla tego okresu, zostanƒÖ r√≥wnie≈º usuniƒôte wszystkie rachunki dla tego okresu.')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/invoices/${invoiceId}`, { method: 'DELETE' });
                if (res.ok) {
                    const result = await res.json();
                    if (result.deleted_bills_count > 0) {
                        showAlert(`Faktura usuniƒôta. Usuniƒôto r√≥wnie≈º ${result.deleted_bills_count} rachunk√≥w dla okresu ${result.period}.`);
                    } else {
                        showAlert('Faktura usuniƒôta. Rachunki pozostajƒÖ (istniejƒÖ inne faktury dla tego okresu).');
                    }
                    loadInvoices();
                    loadBills();
                    loadWaterStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // ========== FUNKCJE DLA GAZU ==========
        
        // Statystyki gazu
        async function loadGasStats() {
            try {
                const res = await fetch(`${API_BASE}/api/gas/stats`);
                const stats = await res.json();
                document.getElementById('gas-stat-invoices').textContent = stats.invoices_count || 0;
                document.getElementById('gas-stat-bills').textContent = stats.bills_count || 0;
                document.getElementById('gas-stat-total').textContent = (stats.total_gross_sum || 0).toFixed(2) + ' z≈Ç';
                document.getElementById('gas-stat-latest-period').textContent = stats.latest_period || '-';
                
                // Aktualizuj listƒô dostƒôpnych okres√≥w dla rachunk√≥w gazu
                const datalist = document.getElementById('available-gas-periods');
                datalist.innerHTML = '';
                if (stats.available_periods && stats.available_periods.length > 0) {
                    stats.available_periods.forEach(period => {
                        const option = document.createElement('option');
                        option.value = period;
                        datalist.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania statystyk gazu:', error);
            }
        }
        
        // Prze≈ÇƒÖczanie miƒôdzy medium (Woda/Gaz)
        function showMedium(medium) {
            document.querySelectorAll('.tab').forEach(t => {
                if (t.textContent.includes('Woda') || t.textContent.includes('Gaz')) {
                    t.classList.remove('active');
                }
            });
            event.target.classList.add('active');
            
            document.getElementById('medium-water').style.display = medium === 'water' ? 'block' : 'none';
            document.getElementById('medium-gas').style.display = medium === 'gas' ? 'block' : 'none';
            
            if (medium === 'water') {
                loadWaterStats();
                loadLocals();
            } else if (medium === 'gas') {
                loadGasStats();
                loadGasInvoices();
                loadGasBills();
            }
        }

        // Prze≈ÇƒÖczanie zak≈Çadek dla gazu
        function showGasTab(tabName) {
            document.querySelectorAll('#medium-gas .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#medium-gas .tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'gas-tab-invoices') loadGasInvoices();
            if (tabName === 'gas-tab-bills') loadGasBills();
        }

        // Faktury gazu
        async function loadGasInvoices() {
            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/`);
                const invoices = await res.json();
                const listEl = document.getElementById('gas-invoices-list');
                
                if (invoices.length === 0) {
                    listEl.innerHTML = '<p>Brak faktur gazu</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Okres</th><th>Numer faktury</th><th>Suma brutto</th><th>Akcje</th></tr></thead><tbody>';
                invoices.forEach(i => {
                    html += `<tr>
                        <td>${i.data}</td>
                        <td>${i.invoice_number}</td>
                        <td>${i.total_gross_sum.toFixed(2)} z≈Ç</td>
                        <td class="actions">
                            <button class="btn btn-danger btn-small" onclick="deleteGasInvoice(${i.id})" title="Usu≈Ñ fakturƒô i rachunki dla tego okresu (je≈õli to ostatnia faktura)">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                document.getElementById('gas-invoices-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania faktur</p>';
            }
        }

        async function uploadGasInvoice() {
            const fileInput = document.getElementById('gas-invoice-file');
            if (!fileInput.files[0]) {
                showAlert('Wybierz plik PDF', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/parse`, {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    const result = await res.json();
                    // Wype≈Çnij formularz weryfikacji danymi
                    const verifyForm = document.getElementById('form-gas-invoice-verify');
                    Object.keys(result).forEach(key => {
                        const input = verifyForm.querySelector(`[name="${key}"]`);
                        if (input) {
                            if (result[key] !== null && result[key] !== undefined && result[key] !== '') {
                                // Dla dat (type="date") upewnij siƒô ≈ºe format jest YYYY-MM-DD
                                if (input.type === 'date') {
                                    if (typeof result[key] === 'string') {
                                        // Je≈õli data jest ju≈º w formacie YYYY-MM-DD
                                        input.value = result[key].substring(0, 10);
                                    } else if (result[key] && result[key].isoformat) {
                                        input.value = result[key].isoformat().substring(0, 10);
                                    }
                                } else {
                                    // Dla innych p√≥l po prostu przypisz warto≈õƒá
                                    // Upewnij siƒô, ≈ºe pole jest widoczne (nie ukryte przez display: none)
                                    const formGroup = input.closest('.form-group');
                                    if (formGroup && formGroup.style.display === 'none') {
                                        formGroup.style.display = 'flex';
                                    }
                                    // Wype≈Çnij pole - upewnij siƒô ≈ºe warto≈õƒá jest liczbƒÖ lub stringiem
                                    const value = result[key];
                                    if (typeof value === 'number' || (typeof value === 'string' && value.trim() !== '')) {
                                        input.value = value;
                                    }
                                }
                            }
                        }
                    });
                    
                    // Poka≈º pola dla dystrybucji zmiennej 2 je≈õli istniejƒÖ
                    if (result.distribution_variable_2_usage_m3) {
                        document.getElementById('distribution-variable-2-group').style.display = 'flex';
                        document.getElementById('distribution-variable-2-conv-group').style.display = 'flex';
                        document.getElementById('distribution-variable-2-kwh-group').style.display = 'flex';
                        document.getElementById('distribution-variable-2-price-group').style.display = 'flex';
                        document.getElementById('distribution-variable-2-value-group').style.display = 'flex';
                    } else {
                        // Ukryj wszystkie pola dystrybucji zmiennej 2
                        document.getElementById('distribution-variable-2-group').style.display = 'none';
                        document.getElementById('distribution-variable-2-conv-group').style.display = 'none';
                        document.getElementById('distribution-variable-2-kwh-group').style.display = 'none';
                        document.getElementById('distribution-variable-2-price-group').style.display = 'none';
                        document.getElementById('distribution-variable-2-value-group').style.display = 'none';
                    }
                    // Poka≈º formularz weryfikacji
                    const verificationDiv = document.getElementById('gas-invoice-verification');
                    verificationDiv.style.display = 'block';
                    showAlert('Faktura sparsowana - zweryfikuj dane przed zapisem');
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd parsowania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function verifyAndSaveGasInvoice() {
            const form = document.getElementById('form-gas-invoice-verify');
            const formData = new FormData(form);
            const data = {};
            // Lista p√≥l numerycznych
            const numericFields = [
                'previous_reading', 'current_reading',
                'fuel_usage_m3', 'fuel_conversion_factor', 'fuel_usage_kwh', 'fuel_price_net', 
                'fuel_value_net', 'fuel_value_gross',
                'subscription_quantity', 'subscription_price_net', 'subscription_value_net', 
                'subscription_value_gross',
                'distribution_fixed_quantity', 'distribution_fixed_price_net', 
                'distribution_fixed_value_net', 'distribution_fixed_value_gross',
                'distribution_variable_usage_m3', 'distribution_variable_conversion_factor',
                'distribution_variable_usage_kwh', 'distribution_variable_price_net', 'distribution_variable_value_net',
                'distribution_variable_value_gross',
                'distribution_variable_2_usage_m3', 'distribution_variable_2_conversion_factor',
                'distribution_variable_2_usage_kwh', 'distribution_variable_2_price_net', 'distribution_variable_2_value_net',
                'total_net_sum', 'vat_rate', 'vat_amount', 'total_gross_sum',
                'late_payment_interest', 'amount_to_pay'
            ];
            
            for (const [key, value] of formData.entries()) {
                if (key.startsWith('distribution_variable_2_')) {
                    // Pola dystrybucji zmiennej 2 sƒÖ opcjonalne - je≈õli sƒÖ puste, ustaw null
                    if (value && value.trim() !== '') {
                        // Zamie≈Ñ przecinki na kropki dla liczb
                        const numValue = value.toString().replace(',', '.');
                        data[key] = parseFloat(numValue);
                    } else {
                        data[key] = null;
                    }
                } else if (numericFields.includes(key)) {
                    if (value) {
                        // Zamie≈Ñ przecinki na kropki dla liczb
                        const numValue = value.toString().replace(',', '.');
                        data[key] = parseFloat(numValue) || 0;
                    } else {
                        data[key] = 0;
                    }
                } else if (key === 'subscription_quantity' || key === 'distribution_fixed_quantity') {
                    data[key] = value ? parseInt(value) : 0;
                } else {
                    data[key] = value;
                }
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showAlert('Faktura gazu zapisana pomy≈õlnie!');
                    form.reset();
                    const verificationDiv = document.getElementById('gas-invoice-verification');
                    verificationDiv.style.display = 'none';
                    document.getElementById('gas-invoice-file').value = '';
                    loadGasInvoices();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd zapisywania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        function cancelGasInvoiceVerification() {
            const verificationDiv = document.getElementById('gas-invoice-verification');
            verificationDiv.style.display = 'none';
            document.getElementById('form-gas-invoice-verify').reset();
            document.getElementById('gas-invoice-file').value = '';
        }

        function toggleManualGasInvoiceForm() {
            const formDiv = document.getElementById('gas-invoice-manual-form');
            const btn = document.getElementById('btn-show-manual-gas-invoice');
            
            if (formDiv.style.display === 'none' || formDiv.style.display === '') {
                formDiv.style.display = 'block';
                btn.textContent = 'Ukryj formularz rƒôczny';
            } else {
                formDiv.style.display = 'none';
                btn.textContent = 'Lub dodaj rƒôcznie';
            }
        }

        async function addGasInvoice() {
            const form = document.getElementById('form-gas-invoice');
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                // Konwertuj warto≈õci numeryczne
                if (['previous_reading', 'current_reading', 'fuel_value_gross', 
                     'subscription_value_gross', 'distribution_fixed_value_gross', 
                     'distribution_variable_value_gross', 'total_gross_sum'].includes(key)) {
                    data[key] = parseFloat(value) || 0;
                } else {
                    data[key] = value;
                }
            }
            
            // Ustaw domy≈õlny VAT je≈õli nie podano
            if (!data.vat_rate) data.vat_rate = 0.23;

            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    showAlert('Faktura gazu dodana pomy≈õlnie!');
                    form.reset();
                    // Ukryj formularz rƒôczny po dodaniu faktury
                    const formDiv = document.getElementById('gas-invoice-manual-form');
                    const btn = document.getElementById('btn-show-manual-gas-invoice');
                    formDiv.style.display = 'none';
                    btn.textContent = 'Lub dodaj rƒôcznie';
                    loadGasInvoices();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    console.error('B≈ÇƒÖd API:', error);
                    // Wy≈õwietl szczeg√≥≈Çy b≈Çƒôdu je≈õli sƒÖ dostƒôpne
                    if (error.detail) {
                        if (Array.isArray(error.detail)) {
                            showAlert(error.detail.map(e => e.msg || e).join(', '), 'error');
                        } else {
                            showAlert(error.detail, 'error');
                        }
                    } else {
                        showAlert('B≈ÇƒÖd dodawania faktury', 'error');
                    }
                }
            } catch (error) {
                console.error('B≈ÇƒÖd po≈ÇƒÖczenia:', error);
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Rachunki gazu
        async function loadGasBills() {
            try {
                const res = await fetch(`${API_BASE}/api/gas/bills/`);
                const bills = await res.json();
                const listEl = document.getElementById('gas-bills-list');
                
                if (bills.length === 0) {
                    listEl.innerHTML = '<p>Brak rachunk√≥w gazu. Wygeneruj rachunki dla okresu z fakturƒÖ.</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>Okres</th><th>Lokal</th><th>Udzia≈Ç</th><th>Suma brutto</th></tr></thead><tbody>';
                bills.forEach(b => {
                    html += `<tr>
                        <td>${b.data}</td>
                        <td>${b.local}</td>
                        <td>${(b.cost_share * 100).toFixed(0)}%</td>
                        <td>${b.total_gross_sum.toFixed(2)} z≈Ç</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (error) {
                document.getElementById('gas-bills-list').innerHTML = '<p class="error">B≈ÇƒÖd ≈Çadowania rachunk√≥w</p>';
            }
        }

        async function deleteGasInvoice(invoiceId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô fakturƒô gazu? Je≈õli to ostatnia faktura dla tego okresu, zostanƒÖ r√≥wnie≈º usuniƒôte wszystkie rachunki dla tego okresu.')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/invoices/${invoiceId}`, { method: 'DELETE' });
                if (res.ok) {
                    const result = await res.json();
                    if (result.deleted_bills_count > 0) {
                        showAlert(`Faktura gazu usuniƒôta. Usuniƒôto r√≥wnie≈º ${result.deleted_bills_count} rachunk√≥w dla okresu ${result.period}.`);
                    } else {
                        showAlert('Faktura gazu usuniƒôta. Rachunki pozostajƒÖ (istniejƒÖ inne faktury dla tego okresu).');
                    }
                    loadGasInvoices();
                    loadGasBills();
                    loadGasStats();
                } else {
                    const error = await res.json();
                    showAlert(error.detail || 'B≈ÇƒÖd usuwania faktury', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        async function generateGasBills() {
            const period = document.getElementById('gas-bill-period').value.trim();
            if (!period || !period.match(/^\d{4}-\d{2}$/)) {
                showAlert('Podaj prawid≈Çowy okres (YYYY-MM)', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/gas/bills/generate/${period}`, { method: 'POST' });
                const result = await res.json();
                if (res.ok) {
                    showAlert(`Wygenerowano ${result.bills_count} rachunk√≥w gazu dla okresu ${period}`);
                    loadGasBills();
                    loadGasStats();
                } else {
                    showAlert(result.detail || 'B≈ÇƒÖd generowania rachunk√≥w', 'error');
                }
            } catch (error) {
                showAlert('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            }
        }

        // Inicjalizacja
        loadWaterStats();
        loadLocals();
        
        // Od≈õwie≈ºanie statystyk gdy zak≈Çadka jest aktywna
        setInterval(() => {
            if (document.getElementById('medium-water').style.display !== 'none') {
                loadWaterStats();
            }
            if (document.getElementById('medium-gas').style.display !== 'none') {
                loadGasStats();
            }
        }, 30000); // Od≈õwie≈º statystyki co 30 sekund
    </script>
</body>
</html>
